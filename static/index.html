<!-- static/index.html -->
<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ReviewCash — Кабинет</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <style>
    :root{
      --accent1:#00e7c0; --accent2:#00d4ff; --muted:#9ee8ff;
      --glass:#ffffff33;
    }
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto;background:linear-gradient(180deg,#05040a,#000000);color:#dff7ff;margin:0;min-height:100vh;transition:background .3s,color .3s}
    body.light{background:linear-gradient(180deg,#f6fbff,#ffffff);color:#062029}
    /* Loader */
    #loader{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;z-index:9999;background:linear-gradient(180deg,rgba(0,0,0,0.5),rgba(0,0,0,0.8))}
    #loader.hidden{display:none}
    .brand{font-weight:900;font-size:28px;color:var(--accent1);text-shadow:0 6px 40px rgba(0,0,0,0.6)}
    .wrap{max-width:960px;margin:24px auto;padding:18px}
    .card{background:rgba(255,255,255,0.04);backdrop-filter:blur(8px);padding:16px;border-radius:16px;border:1px solid rgba(255,255,255,0.03)}
    body.light .card{background:rgba(255,255,255,0.9);border:1px solid rgba(0,0,0,0.06)}
    .header{display:flex;align-items:center;gap:12px}
    .avatar{width:72px;height:72px;border-radius:50%;overflow:hidden;border:2px solid var(--accent1)}
    .avatar img{width:100%;height:100%;object-fit:cover}
    .name{font-weight:800}
    .uid{color:var(--muted);font-size:13px}
    .balance{font-weight:900;font-size:28px;background:linear-gradient(90deg,var(--accent1),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .row{display:flex;gap:10px;align-items:center}
    .btn{padding:10px 12px;border-radius:12px;border:none;background:linear-gradient(90deg,var(--accent1),var(--accent2));font-weight:800;cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:inherit}
    .fab{position:fixed;right:18px;bottom:98px;width:64px;height:64px;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;background:linear-gradient(90deg,var(--accent1),var(--accent2));font-weight:900}
    .tabbar{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:rgba(255,255,255,0.04);padding:10px;border-radius:999px;display:flex;gap:8px;border:1px solid rgba(255,255,255,0.03)}
    .nav-item{padding:10px 14px;border-radius:999px;cursor:pointer;color:var(--muted);font-weight:800}
    .nav-item.active{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#001}
    .modal-bg{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:999}
    .modal-bg.open{display:flex}
    .modal{width:94%;max-width:720px;background:var(--glass);padding:18px;border-radius:16px}
    input,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit}
    .types-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    .type-btn{padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,0.06);cursor:pointer;background:transparent}
    .type-btn.active{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#001}
    .url-check{display:inline-block;width:18px;height:18px;border:3px solid var(--accent1);border-top:3px solid transparent;border-radius:50%;animation:spin .9s linear infinite;vertical-align:middle;margin-left:8px}
    @keyframes spin{to{transform:rotate(360deg)}}
    .small{font-size:13px;color:var(--muted)}
    /* light tweaks */
    body.light .tabbar{background:rgba(0,0,0,0.03);border:1px solid rgba(0,0,0,0.06)}
    body.light .url-check{border-color: #0055ff}
    /* accessibility */
    [role="button"]{cursor:pointer}
  </style>
</head>
<body>
  <div id="loader">
    <div class="brand">ReviewCash</div>
    <div class="small" style="margin-top:8px;color:#fff">Загрузка приложения…</div>
  </div>

  <div class="wrap" id="app" style="display:none">
    <div class="card header">
      <div class="avatar"><img id="avatarImg" src="" alt="avatar"></div>
      <div style="flex:1">
        <div class="name" id="userName">Загрузка…</div>
        <div class="uid" id="userUid">—</div>
        <div style="margin-top:10px" class="small">Баланс</div>
        <div class="balance" id="userBalance">0 ₽</div>
      </div>
      <div style="text-align:right">
        <button id="topupBtn" class="btn">Пополнить</button><br>
        <button id="withdrawBtn" class="btn ghost" style="margin-top:10px">Вывести</button>
      </div>
    </div>

    <div id="tasksCard" class="card" style="margin-top:14px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:900">Задания</div>
        <div class="row">
          <button id="supportBtn" class="btn ghost small">Поддержка</button>
          <button id="themeToggle" class="btn ghost small">Тема</button>
        </div>
      </div>

      <div style="margin-top:12px" id="tasksList">
        <div class="small">Загрузка…</div>
      </div>
    </div>
  </div>

  <div class="fab" id="fab">+</div>

  <div class="tabbar" role="tablist">
    <div class="nav-item active" data-nav="tasks">Задания</div>
    <div class="nav-item" data-nav="profile">Профиль</div>
  </div>

  <!-- Topup modal -->
  <div id="topupModal" class="modal-bg" aria-hidden="true">
    <div class="modal scale-in card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>Пополнение</strong>
        <button id="closeTopup" class="btn ghost">✕</button>
      </div>
      <div class="small" style="margin-top:8px">Мин. 150 ₽</div>
      <div style="display:flex;gap:8px;margin-top:12px">
        <input id="topupAmount" type="number" min="150" value="150">
        <button id="createTopupBtn" class="btn">Создать</button>
      </div>
      <div id="topupStep" style="display:none;margin-top:12px">
        <div class="small">Ссылка/QR</div>
        <img id="topupQR" style="max-width:220px;border-radius:10px;display:block;margin:10px 0" src="">
        <input id="topupManual" readonly>
        <div style="margin-top:8px"><a id="payOpen" class="btn" target="_blank">Открыть банк</a> <button id="iPaid" class="btn ghost">Я оплатил</button></div>
        <div id="topupMsg" class="small" style="margin-top:8px"></div>
      </div>
    </div>
  </div>

  <!-- Create task modal (FAB) -->
  <div id="createModal" class="modal-bg" aria-hidden="true">
    <div class="modal scale-in card">
      <div style="display:flex;justify-content:space-between;align-items:center"><strong>Создать задание</strong><button id="closeCreate" class="btn ghost">✕</button></div>
      <div class="small" style="margin-top:8px">Выберите тип</div>
      <div class="types-row" id="typesBox"></div>
      <div style="margin-top:10px;position:relative">
        <input id="taskUrl" placeholder="Ссылка (http:// или https://)">
        <span id="urlChecker" style="display:none" class="url-check"></span><span id="urlStatus" style="margin-left:8px" class="small"></span>
      </div>
      <div style="display:flex;gap:8px;margin-top:10px;align-items:center">
        <input id="taskQty" type="number" min="1" value="1" style="width:120px">
        <div id="unitPrice" class="small">Цена: —</div>
        <div id="totalPrice" style="margin-left:auto;font-weight:900">Итого: —</div>
      </div>
      <div style="display:flex;gap:8px;margin-top:12px">
        <button id="submitTask" class="btn">Создать</button>
        <button id="cancelCreateBtn" class="btn ghost">Отмена</button>
      </div>
      <div id="createMsg" class="small" style="margin-top:8px"></div>
    </div>
  </div>

<script>
(() => {
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const loader = $('#loader'), app = $('#app');
  const avatarImg = $('#avatarImg'), userName = $('#userName'), userUid = $('#userUid'), userBalance = $('#userBalance');
  const topupBtn = $('#topupBtn'), withdrawBtn = $('#withdrawBtn'), supportBtn = $('#supportBtn'), themeToggle = $('#themeToggle');
  const fab = $('#fab');
  const navItems = $$('.nav-item');
  const topupModal = $('#topupModal'), closeTopup = $('#closeTopup'), createTopupBtn = $('#createTopupBtn'), topupAmount = $('#topupAmount');
  const topupStep = $('#topupStep'), topupQR = $('#topupQR'), topupManual = $('#topupManual'), payOpen = $('#payOpen'), iPaid = $('#iPaid'), topupMsg = $('#topupMsg');
  const createModal = $('#createModal'), closeCreate = $('#closeCreate'), cancelCreateBtn = $('#cancelCreateBtn');
  const typesBox = $('#typesBox'), taskUrl = $('#taskUrl'), urlChecker = $('#urlChecker'), urlStatus = $('#urlStatus');
  const taskQty = $('#taskQty'), unitPrice = $('#unitPrice'), totalPrice = $('#totalPrice'), submitTask = $('#submitTask'), createMsg = $('#createMsg');
  const tasksList = $('#tasksList');

  // parse uid from url or random
  const uid = (new URLSearchParams(location.search)).get('uid') || ('u'+Math.floor(Math.random()*999999));
  userUid.textContent = uid;

  // initial render
  avatarImg.src = `https://api.dicebear.com/8.x/thumbs/svg?seed=${encodeURIComponent(uid)}`;
  userName.textContent = 'Пользователь';

  // socket
  let socket;
  try {
    socket = io({transports:['websocket'], upgrade:false});
    socket.on('connect', ()=> console.log('socket connected'));
    socket.on('task_update', ()=> loadTasks());
    socket.on('user_update', d => { if (d && String(d.user_id) === String(uid)) renderBalance(d.balance); });
  } catch(e){ console.warn('socket failed', e); }

  // theme
  function applyTheme(){
    const t = localStorage.getItem('theme') || 'dark';
    document.body.classList.toggle('light', t === 'light');
  }
  applyTheme();
  themeToggle.addEventListener('click', () => {
    const next = document.body.classList.toggle('light') ? 'light' : 'dark';
    localStorage.setItem('theme', next);
  });

  // loader
  function hideLoader(){ loader.classList.add('hidden'); app.style.display = 'block'; }
  function showLoader(){ loader.classList.remove('hidden'); app.style.display = 'none'; }

  // profile load
  async function loadProfile(){
    try {
      const res = await fetch(`/api/profile_me?uid=${encodeURIComponent(uid)}`);
      const j = await res.json();
      if (j && j.ok){
        const u = j.user;
        avatarImg.src = u.avatar || avatarImg.src;
        userName.textContent = u.first_name || u.name || userName.textContent;
        renderBalance(u.balance || 0);
      } else renderBalance(0);
    } catch (e) { console.warn('profile err', e); renderBalance(0); }
  }
  function renderBalance(b){ userBalance.textContent = Number(b||0).toLocaleString('ru-RU') + ' ₽'; window.__USER_BALANCE = Number(b||0); }

  // tasks
  let tasks = [];
  async function loadTasks(){
    try {
      const r = await fetch('/api/tasks/list');
      const j = await r.json();
      tasks = j.tasks || [];
      renderTasks();
    } catch (e) { tasksList.innerHTML = '<div class="small">Не удалось загрузить задания</div>'; }
  }
  function renderTasks(){
    if (!tasks.length) { tasksList.innerHTML = '<div class="small">Нет заданий</div>'; return; }
    tasksList.innerHTML = '';
    tasks.forEach(t => {
      const el = document.createElement('div');
      el.className = 'task-item';
      el.style.padding = '12px';
      el.style.borderRadius = '10px';
      el.style.marginBottom = '8px';
      el.style.background = 'rgba(255,255,255,0.02)';
      el.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
        <div style="flex:1">
          <div style="font-weight:800">${escapeHtml(t.title||t.name||'Задание')}</div>
          <div class="small" style="margin-top:6px">${escapeHtml(t.description||'')}</div>
        </div>
        <div style="text-align:right;margin-left:12px">
          <div style="font-weight:900">${Number(t.unit_price||0).toLocaleString('ru-RU')} ₽</div>
          <div class="small">${(t.qty||1)} шт</div>
          <button class="btn" style="margin-top:8px" onclick="claimTask('${t.id}')">Выполнить</button>
        </div>
      </div>`;
      tasksList.appendChild(el);
    });
  }

  window.claimTask = async (tid) => {
    try {
      const res = await fetch('/api/tasks/claim', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({task_id:tid, uid})});
      const j = await res.json();
      if (j.ok) alert('Задание помечено — отправьте доказательство в чат модератору (или ждите автоматическую проверку).');
      else alert('Ошибка: ' + (j.errmsg||''));
    } catch (e) { alert('Ошибка сети'); }
  };

  // create modal
  const localTypes = [
    {id:'ya_review', name:'Отзыв — Яндекс Карты', unit_price:100, max_qty:500},
    {id:'gmaps_review', name:'Отзыв — Google Maps', unit_price:50, max_qty:500},
    {id:'tg_sub', name:'Подписка — Telegram канал', unit_price:5, max_qty:100000}
  ];
  function renderTypes(){
    typesBox.innerHTML = '';
    localTypes.forEach((t,i)=> {
      const b = document.createElement('button');
      b.className = 'type-btn';
      b.textContent = `${t.name} — ${t.unit_price} ₽`;
      b.onclick = ()=> {
        selectedType = t;
        $$('.type-btn').forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        updatePrices();
      };
      if (i===0){ b.classList.add('active'); selectedType = t; }
      typesBox.appendChild(b);
    });
    updatePrices();
  }
  let selectedType = localTypes[0];
  function updatePrices(){
    const qty = Number(taskQty.value||1);
    unitPrice.textContent = `Цена: ${selectedType.unit_price} ₽`;
    totalPrice.textContent = `Итого: ${(selectedType.unit_price*qty).toLocaleString('ru-RU')} ₽`;
  }

  // url checker with spinner & result
  let urlTimer = null;
  taskUrl.addEventListener('input', ()=>{
    clearTimeout(urlTimer);
    urlStatus.textContent = '';
    if (!taskUrl.value.trim()){ urlChecker.style.display='none'; return; }
    urlChecker.style.display='inline-block';
    urlStatus.textContent = 'Проверка…';
    urlTimer = setTimeout(async ()=>{
      const res = await checkUrl(taskUrl.value.trim());
      urlChecker.style.display='none';
      if (res.ok === true){ urlStatus.textContent = '✅'; urlStatus.style.color = '#22c55e'; }
      else if (res.ok === false){ urlStatus.textContent = '❌ ' + (res.msg||'Недоступно'); urlStatus.style.color = '#ff4d6d'; }
      else { urlStatus.textContent = '⚠ ' + (res.msg||'CORS'); urlStatus.style.color = '#d7a700'; }
    }, 600);
  });

  async function checkUrl(u){
    if (!/^https?:\/\//i.test(u)) return {ok:false, msg:'Должна начинаться с http(s)://'};
    try {
      const r = await fetch(u, {method:'HEAD', mode:'cors'});
      return {ok:r.ok};
    } catch(e){
      try { await fetch(u, {method:'GET', mode:'no-cors'}); return {ok:null, msg:'CORS — откройте вручную'}; } catch(e2){ return {ok:false, msg:'Не удалось'}; }
    }
  }

  // submit task
  submitTask.addEventListener('click', async ()=>{
    const url = taskUrl.value.trim();
    const qty = Number(taskQty.value||1);
    if (!selectedType) return alert('Выберите тип');
    if (!url) return alert('Введите ссылку');
    if (!qty || qty<1) return alert('Количество >= 1');
    // check balance
    if ((window.__USER_BALANCE || 0) < (selectedType.unit_price * qty)) return alert('Недостаточно средств');
    const chk = await checkUrl(url);
    if (chk.ok === false) {
      if (!confirm('Ссылка не прошла проверку. Создать всё равно?')) return;
    }
    try {
      const body = { title: selectedType.name, description: selectedType.name, unit_price: selectedType.unit_price, qty, url, type_id: selectedType.id, owner_uid: uid };
      const r = await fetch('/api/tasks/create', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
      const j = await r.json();
      if (j && j.ok){ createModal.classList.remove('open'); createModal.style.display='none'; await loadTasks(); alert('Задание создано'); }
      else alert('Ошибка: ' + (j.errmsg||''));
    } catch (e){ alert('Ошибка сети'); }
  });

  // topup flow
  topupBtn.addEventListener('click', ()=> {
    topupModal.classList.add('open'); topupModal.style.display='flex';
    topupStep.style.display='none'; topupMsg.textContent=''; topupAmount.value = 150;
  });
  closeTopup.addEventListener('click', ()=> { topupModal.classList.remove('open'); topupModal.style.display='none'; });

  createTopupBtn.addEventListener('click', async ()=>{
    const amount = Number(topupAmount.value||0);
    if (!amount || amount<150) return alert('Мин. 150 ₽');
    try {
      const r = await fetch('/api/user/topup-link', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({uid,amount})});
      const j = await r.json();
      if (j && j.ok){
        topupStep.style.display='block';
        topupQR.src = j.qr_url || '';
        topupManual.value = j.manual_code || '';
        payOpen.href = j.pay_link || '#';
        topupMsg.textContent = 'Скопируйте комментарий и оплатите. Затем нажмите "Я оплатил".';
      } else alert('Ошибка: '+(j.errmsg||''));
    } catch (e){ alert('Ошибка сети'); }
  });
  iPaid.addEventListener('click', async ()=>{
    // tell server to confirm -> admin will manually approve
    try {
      const r = await fetch('/api/user/topup-confirm', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({topup_id:undefined, uid})});
      // in our app, topup_confirm expects topup_id — but for demo we send notification already when created
      alert('Запрос отправлен на проверку администратору (реализация demo).');
      topupModal.classList.remove('open'); topupModal.style.display='none';
    } catch (e){ alert('Ошибка сети'); }
  });

  // withdraw
  withdrawBtn.addEventListener('click', ()=> {
    window.open('/static/index.html#withdraw', '_self'); // quick jump — you can implement modal similar to topup
    alert('Откроется модалка вывода (реализация demo) — используйте кнопку Вывести в профиле.');
  });

  // create modal (FAB)
  fab.addEventListener('click', ()=> {
    createModal.classList.add('open'); createModal.style.display='flex';
    taskUrl.value=''; taskQty.value=1; urlStatus.textContent=''; urlChecker.style.display='none';
    renderTypes();
  });
  closeCreate.addEventListener('click', ()=> { createModal.classList.remove('open'); createModal.style.display='none'; });
  cancelCreateBtn.addEventListener('click', ()=> { createModal.classList.remove('open'); createModal.style.display='none'; });

  // nav
  navItems.forEach(n => n.addEventListener('click', ()=>{
    navItems.forEach(x=>x.classList.remove('active'));
    n.classList.add('active');
    const nav = n.dataset.nav;
    if (nav === 'tasks'){ $('#tasksCard').scrollIntoView({behavior:'smooth'}); }
    else { window.scrollTo({top:0,behavior:'smooth'}); }
  }));

  // support (open chat)
  supportBtn.addEventListener('click', ()=>{
    // open chat with user @LolikMoney
    window.open('https://t.me/LolikMoney', '_blank');
  });

  // start
  (async function init(){
    try {
      showLoader();
      await Promise.allSettled([ loadProfile(), loadTasks() ]);
    } catch(e){}
    setTimeout(()=> hideLoader(), 600);
  })();

  // helpers
  function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  window.escapeHtml = escapeHtml;

})();
</script>
</body>
</html>
