<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>ReviewCash ‚Ä¢ –ö–∞–±–∏–Ω–µ—Ç</title>
  <!-- Telegram WebApp -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <!-- Socket.IO from CDN for stability -->
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --radius: 18px;
      --transition: 260ms ease;
      --accent-dark-1: #00eaff;
      --accent-dark-2: #0077ff;
      --accent-light-1: #00c26b;
      --accent-light-2: #f9a825;
    }
    /* Light theme variables */
    body {
      --bg: linear-gradient(180deg, #f6fbff, #ffffff);
      --panel: rgba(255, 255, 255, 0.95);
      --text: #0b1820;
      --muted: #6f8b95;
      --accent1: var(--accent-light-1);
      --accent2: var(--accent-light-2);
      --button-border: rgba(0, 0, 0, 0.12);
    }
    body.dark {
      --bg: linear-gradient(180deg, #05040a, #000000);
      --panel: rgba(2, 6, 11, 0.75);
      --text: #cfeff6;
      --muted: #7fcfda;
      --accent1: var(--accent-dark-1);
      --accent2: var(--accent-dark-2);
      --button-border: rgba(255, 255, 255, 0.24);
    }
    * {
      box-sizing: border-box;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
    }
    html, body {
      height: 100%;
      margin: 0;
      background: var(--bg);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
    }
    .wrap {
      max-width: 920px;
      margin: 0 auto;
      padding: 16px 14px 100px;
    }
    .card {
      background: var(--panel);
      border-radius: var(--radius);
      padding: 16px;
      margin-bottom: 14px;
      border: 1px solid rgba(255, 255, 255, 0.04);
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.06);
      transition: var(--transition);
    }
    /* Loader */
    .loader {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      background: linear-gradient(180deg, rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.85));
      color: white;
      flex-direction: column;
      gap: 12px;
    }
    .loader.hidden {
      display: none;
    }
    .brand {
      font-weight: 900;
      font-size: 30px;
      letter-spacing: 1px;
      color: var(--accent1);
      text-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
    }
    .loader-sub {
      color: rgba(255, 255, 255, 0.85);
      opacity: 0.9;
    }
    /* Header / profile */
    .header-row {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .avatar {
      width: 84px;
      height: 84px;
      border-radius: 50%;
      overflow: hidden;
      border: 3px solid var(--accent1);
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
      flex-shrink: 0;
    }
    .avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    .profile-info {
      flex: 1;
    }
    .name {
      font-weight: 800;
      font-size: 20px;
    }
    .uid {
      font-size: 13px;
      color: var(--muted);
    }
    .balance {
      font-weight: 900;
      font-size: 30px;
      background: linear-gradient(90deg, var(--accent1), var(--accent2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    /* Buttons */
    .row {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .btn {
      padding: 12px 16px;
      border-radius: 12px;
      border: 1px solid var(--button-border);
      cursor: pointer;
      font-weight: 800;
      background: linear-gradient(90deg, var(--accent1), var(--accent2));
      color: #001;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
      transition: transform 160ms ease, border-color 200ms;
    }
    .btn:hover {
      transform: translateY(-4px);
      border-color: var(--accent1);
    }
    .btn.ghost {
      background: transparent;
      border: 1px solid var(--button-border);
      color: var(--text);
      box-shadow: none;
    }
    .btn.small {
      padding: 8px 10px;
      border-radius: 10px;
      font-weight: 700;
    }
    /* make only topup pulse */
    .btn.pulse {
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0% {
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
      }
      70% {
        box-shadow: 0 18px 45px rgba(0, 0, 0, 0.04);
      }
      100% {
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
      }
    }
    /* tasks list */
    .sub-tabs {
      display: flex;
      gap: 8px;
      margin: 10px 0 4px;
    }
    .sub-tab {
      padding: 10px 14px;
      border-radius: 999px;
      background: transparent;
      border: 1px solid var(--button-border);
      cursor: pointer;
      font-weight: 800;
    }
    .sub-tab.active {
      background: linear-gradient(90deg, var(--accent1), var(--accent2));
      color: #001;
    }
    .task-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      padding: 12px;
      border-radius: 12px;
      background: rgba(0, 0, 0, 0.02);
    }
    body.dark .task-item {
      background: rgba(255, 255, 255, 0.02);
    }
    /* FAB (create) */
    .fab {
      position: fixed;
      right: 18px;
      bottom: 98px;
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background: linear-gradient(90deg, var(--accent1), var(--accent2));
      color: #001;
      font-weight: 900;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.18);
      z-index: 70;
      border: 1px solid var(--button-border);
    }
    .fab:hover {
      transform: scale(1.08) rotate(10deg);
    }
    /* bottom nav */
    .tabbar {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 18px;
      background: var(--panel);
      padding: 10px;
      border-radius: 999px;
      border: 1px solid var(--button-border);
      display: flex;
      gap: 8px;
      z-index: 70;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
    }
    .nav-item {
      padding: 10px 14px;
      border-radius: 999px;
      cursor: pointer;
      font-weight: 800;
      color: var(--muted);
      border: 1px solid var(--button-border);
    }
    .nav-item.active {
      background: linear-gradient(90deg, var(--accent1), var(--accent2));
      color: #001;
    }
    /* modal */
    .modal-bg {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
    }
    .modal-bg.open {
      display: flex;
    }
    .modal {
      width: 95%;
      max-width: 720px;
      background: var(--panel);
      border-radius: 16px;
      padding: 18px;
      border: 1px solid var(--button-border);
      box-shadow: 0 18px 50px rgba(0, 0, 0, 0.25);
      transform-origin: center;
      animation: modalIn 260ms var(--transition);
    }
    @keyframes modalIn {
      from {
        transform: translateY(8px) scale(0.98);
        opacity: 0;
      }
      to {
        transform: translateY(0) scale(1);
        opacity: 1;
      }
    }
    .types-row {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    .type-btn {
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--button-border);
      cursor: pointer;
      min-width: 160px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: transparent;
    }
    .type-btn.active {
      background: linear-gradient(90deg, var(--accent1), var(--accent2));
      color: #001;
    }
    /* url checker visuals */
    .url-check {
      display: inline-block;
      width: 18px;
      height: 18px;
      border: 3px solid var(--accent1);
      border-top: 3px solid transparent;
      border-radius: 50%;
      animation: spin 0.9s linear infinite;
      vertical-align: middle;
      margin-left: 8px;
    }
    @keyframes spin {
      0% {
        transform: rotate(0);
      }
      100% {
        transform: rotate(360deg);
      }
    }
    .url-status {
      margin-left: 8px;
      font-weight: 800;
      vertical-align: middle;
    }
    /* small */
    .small {
      font-size: 13px;
      color: var(--muted);
    }
    input, textarea {
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid var(--button-border);
      background: transparent;
      color: var(--text);
      margin-top: 8px;
    }
    input:focus, textarea:focus {
      outline: none;
      border-color: var(--accent1);
      box-shadow: 0 0 14px rgba(0, 0, 0, 0.06);
    }
    /* responsive */
    @media (max-width: 520px) {
      .avatar {
        width: 64px;
        height: 64px;
      }
      .fab {
        right: 12px;
        bottom: 92px;
        width: 56px;
        height: 56px;
      }
      .wrap {
        padding: 12px 10px 120px;
      }
    }
    /* Accessibility improvements */
    [role="button"] {
      cursor: pointer;
    }
    label {
      display: block;
      font-weight: 600;
      margin-bottom: 4px;
    }
  </style>
</head>
<body>
  <!-- Loader -->
  <div id="loader" class="loader" role="status" aria-live="polite">
    <div class="brand">ReviewCash</div>
    <div class="loader-sub">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è‚Ä¶</div>
  </div>
  <main class="wrap" id="app" aria-hidden="true" style="display: none;">
    <!-- PROFILE CARD (shows when Profile tab active) -->
    <section id="profileCard" class="card" style="display: none;" aria-labelledby="profile-heading">
      <h2 id="profile-heading" class="sr-only">–ü—Ä–æ—Ñ–∏–ª—å</h2>
      <div class="header-row">
        <div class="avatar"><img id="avatar" src="" alt="–ê–≤–∞—Ç–∞—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" loading="lazy"></div>
        <div class="profile-info">
          <div class="name" id="userName">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
          <div class="uid small" id="userHandle">‚Äî</div>
          <div style="margin-top: 12px;">
            <div class="small">–ë–∞–ª–∞–Ω—Å</div>
            <div class="balance" id="balance" aria-live="polite">0 ‚ÇΩ</div>
          </div>
        </div>
        <div style="text-align: right">
          <button id="topupBtn" class="btn pulse">–ü–æ–ø–æ–ª–Ω–∏—Ç—å</button><br>
          <button id="withdrawBtn" class="btn ghost small" style="margin-top: 10px;">–í—ã–≤–µ—Å—Ç–∏</button>
        </div>
      </div>
    </section>
    <!-- TASKS CARD -->
    <section id="tasksCard" class="card" aria-labelledby="tasks-heading">
      <h2 id="tasks-heading" style="font-weight: 900; font-size: 20px;">–ó–∞–¥–∞–Ω–∏—è</h2>
      <div style="display: flex; justify-content: space-between; align-items: center; margin-top: -20px;">
        <div style="display: flex; gap: 8px; align-items: center">
          <button id="supportBtn" title="–ü–æ–¥–¥–µ—Ä–∂–∫–∞" class="btn small" style="background: transparent; border: 1px solid rgba(0, 0, 0, 0.05);">üéß –ü–æ–¥–¥–µ—Ä–∂–∫–∞</button>
          <button id="themeToggle" class="btn ghost small">–¢–µ–º–∞</button>
        </div>
      </div>
      <nav class="sub-tabs" id="subTabs" role="tablist">
        <button class="sub-tab active" data-sub="available" role="tab" aria-selected="true">–î–æ—Å—Ç—É–ø–Ω—ã–µ</button>
        <button class="sub-tab" data-sub="my" role="tab" aria-selected="false">–ú–æ–∏</button>
      </nav>
      <div id="tasksList" style="margin-top: 12px" role="list" aria-live="polite">
        <div class="small">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
      </div>
    </section>
  </main>
  <button class="fab" id="fab" aria-label="–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ">+</button>
  <nav class="tabbar" role="tablist">
    <button class="nav-item active" data-nav="tasks" role="tab" aria-selected="true">–ó–∞–¥–∞–Ω–∏—è</button>
    <button class="nav-item" data-nav="profile" role="tab" aria-selected="false">–ü—Ä–æ—Ñ–∏–ª—å</button>
  </nav>
  <!-- TOPUP Modal -->
  <dialog id="topupModal" class="modal-bg" aria-modal="true" aria-labelledby="topup-heading">
    <div class="modal">
      <button id="closeTopup" aria-label="–ó–∞–∫—Ä—ã—Ç—å" style="float: right; background: transparent; border: none; color: var(--muted); font-size: 24px; cursor: pointer">√ó</button>
      <h3 id="topup-heading">–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ</h3>
      <div class="small">–ú–∏–Ω–∏–º—É–º <b id="minTopup">150</b> ‚ÇΩ</div>
      <div style="display: flex; gap: 10px; margin-top: 12px">
        <label class="sr-only" for="topupAmount">–°—É–º–º–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è</label>
        <input id="topupAmount" type="number" placeholder="–°—É–º–º–∞" min="150" style="flex: 1" />
        <button class="btn" id="createTopupBtn">–°–æ–∑–¥–∞—Ç—å</button>
      </div>
      <div id="topupStep" style="display: none; margin-top: 14px">
        <div class="small">–°—Å—ã–ª–∫–∞ –¥–ª—è –æ–ø–ª–∞—Ç—ã / QR (—Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π)</div>
        <img id="qrImg" style="display: block; margin: 12px auto; max-width: 260px; border-radius: 10px" src="" alt="QR-–∫–æ–¥ –¥–ª—è –æ–ø–ª–∞—Ç—ã" loading="lazy" />
        <label class="sr-only" for="manualCode">–ö–æ–¥ –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –≤–≤–æ–¥–∞</label>
        <input id="manualCode" readonly />
        <div style="display: flex; gap: 10px; margin-top: 10px">
          <a id="payLink" class="btn" target="_blank" rel="noopener noreferrer">–û—Ç–∫—Ä—ã—Ç—å –±–∞–Ω–∫</a>
          <button class="btn ghost" id="confirmPaidBtn">–Ø –æ–ø–ª–∞—Ç–∏–ª</button>
        </div>
        <div class="small" id="topupMsg" aria-live="polite"></div>
      </div>
    </div>
  </dialog>
  <!-- WITHDRAW Modal -->
  <dialog id="withdrawModal" class="modal-bg" aria-modal="true" aria-labelledby="withdraw-heading">
    <div class="modal">
      <button id="closeWithdraw" aria-label="–ó–∞–∫—Ä—ã—Ç—å" style="float: right; background: transparent; border: none; color: var(--muted); font-size: 24px; cursor: pointer">√ó</button>
      <h3 id="withdraw-heading">–í—ã–≤–µ—Å—Ç–∏ —Å—Ä–µ–¥—Å—Ç–≤–∞</h3>
      <div class="small">–ú–∏–Ω. 300 ‚ÇΩ</div>
      <label class="sr-only" for="wAmount">–°—É–º–º–∞ –≤—ã–≤–æ–¥–∞</label>
      <input id="wAmount" type="number" placeholder="–°—É–º–º–∞" />
      <label class="sr-only" for="wName">–§–ò–û –∏–ª–∏ –Ω–∏–∫ (–ø–æ–ª—É—á–∞—Ç–µ–ª—å)</label>
      <input id="wName" type="text" placeholder="–§–ò–û –∏–ª–∏ –Ω–∏–∫ (–ø–æ–ª—É—á–∞—Ç–µ–ª—å)" />
      <label class="sr-only" for="wDetails">–†–µ–∫–≤–∏–∑–∏—Ç—ã (–∫–∞—Ä—Ç–∞ / –°–ë–ü)</label>
      <input id="wDetails" type="text" placeholder="–†–µ–∫–≤–∏–∑–∏—Ç—ã (–∫–∞—Ä—Ç–∞ / –°–ë–ü)" />
      <div style="display: flex; gap: 10px; margin-top: 10px">
        <button class="btn" id="sendWithdraw">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É</button>
        <button class="btn ghost" id="cancelWithdraw">–û—Ç–º–µ–Ω–∞</button>
      </div>
      <div id="withdrawMsg" class="small" style="margin-top: 8px" aria-live="polite"></div>
    </div>
  </dialog>
  <!-- CREATE TASK Modal -->
  <dialog id="createModal" class="modal-bg" aria-modal="true" aria-labelledby="create-heading">
    <div class="modal">
      <button id="closeCreate" aria-label="–ó–∞–∫—Ä—ã—Ç—å" style="float: right; background: transparent; border: none; color: var(--muted); font-size: 24px; cursor: pointer">√ó</button>
      <h3 id="create-heading">–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ</h3>
      <div class="small">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø ‚Äî —Ü–µ–Ω–∞ –ø—Ä–æ—Å—Ç–∞–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</div>
      <div class="types-row" id="typesBox" role="radiogroup" aria-label="–¢–∏–ø—ã –∑–∞–¥–∞–Ω–∏–π"></div>
      <div style="margin-top: 10px; position: relative">
        <label class="sr-only" for="taskUrl">–°—Å—ã–ª–∫–∞ (http:// –∏–ª–∏ https://)</label>
        <input id="taskUrl" placeholder="–°—Å—ã–ª–∫–∞ (http:// –∏–ª–∏ https://)" />
        <span id="urlChecker" style="display: none" class="url-check" aria-hidden="true"></span>
        <span id="urlStatus" class="url-status" aria-live="polite"></span>
      </div>
      <div style="display: flex; gap: 10px; margin-top: 10px; align-items: center">
        <label class="sr-only" for="taskQty">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
        <input id="taskQty" type="number" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ" min="1" value="1" style="width: 140px" />
        <div id="unitPrice" class="small">–¶–µ–Ω–∞ –∑–∞ —à—Ç: ‚Äî</div>
        <div id="totalPrice" class="small" style="margin-left: auto; font-weight: 900">–û–±—â–∞—è —Ü–µ–Ω–∞: ‚Äî</div>
      </div>
      <div style="display: flex; gap: 10px; margin-top: 12px">
        <button class="btn" id="submitTask">–°–æ–∑–¥–∞—Ç—å</button>
        <button class="btn ghost" id="cancelCreate">–û—Ç–º–µ–Ω–∞</button>
      </div>
      <div id="createMsg" class="small" style="margin-top: 8px" aria-live="polite"></div>
    </div>
  </dialog>
  <script>
    (() => {
      // Helpers
      const $ = s => document.querySelector(s);
      const $$ = s => Array.from(document.querySelectorAll(s));
      const tg = window.Telegram?.WebApp || null;
      try { tg?.ready?.(); tg?.expand?.(); } catch (e) {}
      // DOM references
      const loader = $('#loader');
      const app = $('#app');
      const profileCard = $('#profileCard');
      const tasksCard = $('#tasksCard');
      const tasksList = $('#tasksList');
      const avatar = $('#avatar');
      const userName = $('#userName');
      const userHandle = $('#userHandle');
      const balanceEl = $('#balance');
      const topupBtn = $('#topupBtn');
      const withdrawBtn = $('#withdrawBtn');
      const supportBtn = $('#supportBtn');
      const themeToggle = $('#themeToggle');
      const fab = $('#fab');
      const tabItems = $$('.nav-item');
      const subTabs = $$('.sub-tab');
      // Modals
      const topupModal = $('#topupModal'), closeTopup = $('#closeTopup');
      const withdrawModal = $('#withdrawModal'), closeWithdraw = $('#closeWithdraw'), cancelWithdraw = $('#cancelWithdraw');
      const createModal = $('#createModal'), closeCreate = $('#closeCreate'), cancelCreate = $('#cancelCreate');
      // Topup elements
      const minTopup = 150;
      $('#minTopup').textContent = minTopup;
      const topupAmount = $('#topupAmount'), createTopupBtn = $('#createTopupBtn');
      const topupStep = $('#topupStep'), qrImg = $('#qrImg'), manualCode = $('#manualCode'), payLink = $('#payLink'), confirmPaidBtn = $('#confirmPaidBtn'), topupMsg = $('#topupMsg');
      // Withdraw elements
      const wAmount = $('#wAmount'), wName = $('#wName'), wDetails = $('#wDetails'), sendWithdraw = $('#sendWithdraw'), withdrawMsg = $('#withdrawMsg');
      // Create task elements
      const typesBox = $('#typesBox'), taskUrl = $('#taskUrl'), taskQty = $('#taskQty'), unitPrice = $('#unitPrice'), totalPrice = $('#totalPrice');
      const urlChecker = $('#urlChecker'), urlStatus = $('#urlStatus'), submitTask = $('#submitTask'), createMsg = $('#createMsg');
      // Data
      const tgUser = tg?.initDataUnsafe?.user || {};
      const uid = tgUser.id ? String(tgUser.id) : (new URLSearchParams(location.search)).get('uid') || 'guest_' + String(Math.floor(Math.random() * 99999));
      avatar.src = tgUser.photo_url || `https://api.dicebear.com/8.x/thumbs/svg?seed=${encodeURIComponent(uid)}`;
      userName.textContent = (tgUser.first_name || '') + (tgUser.last_name ? (' ' + tgUser.last_name) : '');
      userHandle.textContent = tgUser.username ? ('@' + tgUser.username) : `ID: ${uid}`;
      // Status
      let allTasks = [];
      let currentSub = 'available';
      let types = [];
      let selectedType = null;
      // Socket
      let socket;
      try {
        socket = io({transports: ['websocket'], upgrade: false});
        socket.on('connect', () => console.log('Socket connected'));
        socket.on('connect_error', (err) => console.error('Socket connect error:', err));
        socket.on('task_update', () => loadTasks());
        socket.on('user_update', d => {
          if (d && String(d.user_id) === String(uid) && typeof d.balance !== 'undefined') renderBalance(d.balance);
        });
      } catch (e) { console.warn('Socket failed', e); }
      // Theme
      function applyTheme() {
        const t = localStorage.getItem('theme') || 'dark';
        document.body.classList.toggle('dark', t === 'dark');
      }
      applyTheme();
      themeToggle.addEventListener('click', () => {
        const isDark = document.body.classList.toggle('dark');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
      });
      // Navigation
      tabItems.forEach(t => t.addEventListener('click', () => {
        tabItems.forEach(x => x.classList.remove('active'));
        t.classList.add('active');
        t.setAttribute('aria-selected', 'true');
        tabItems.forEach(x => { if (x !== t) x.setAttribute('aria-selected', 'false'); });
        const nav = t.dataset.nav;
        profileCard.style.display = nav === 'profile' ? 'block' : 'none';
        tasksCard.style.display = nav === 'tasks' ? 'block' : 'none';
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }));
      subTabs.forEach(st => st.addEventListener('click', () => {
        subTabs.forEach(x => x.classList.remove('active'));
        st.classList.add('active');
        st.setAttribute('aria-selected', 'true');
        subTabs.forEach(x => { if (x !== st) x.setAttribute('aria-selected', 'false'); });
        currentSub = st.dataset.sub;
        renderTasks();
      }));
      // Initial show/hide: show tasks by default
      profileCard.style.display = 'none';
      tasksCard.style.display = 'block';
      // Loader/hide app
      function hideLoader() {
        loader.classList.add('hidden');
        app.style.display = 'block';
        app.removeAttribute('aria-hidden');
      }
      function showLoader() {
        loader.classList.remove('hidden');
        app.style.display = 'none';
        app.setAttribute('aria-hidden', 'true');
      }
      // Fetch profile
      async function loadProfile() {
        try {
          const res = await fetch(`/api/profile_me?uid=${encodeURIComponent(uid)}`);
          if (!res.ok) throw new Error('Failed to fetch profile');
          const j = await res.json();
          if (j?.ok && j.user) {
            const u = j.user;
            renderBalance(u.balance || 0);
            const name = u.name || u.first_name || userName.textContent || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
            userName.textContent = name;
            userHandle.textContent = u.username ? ('@' + u.username) : `ID: ${u.id || uid}`;
          } else {
            renderBalance(0);
          }
        } catch (e) {
          console.warn('profile load error', e);
          renderBalance(0);
        }
      }
      function renderBalance(b) {
        balanceEl.textContent = Number(b || 0).toLocaleString('ru-RU') + ' ‚ÇΩ';
        window.__USER_BALANCE = Number(b || 0);
      }
      // Load tasks
      async function loadTasks() {
        try {
          let res = await fetch('/api/tasks/list');
          if (!res.ok) res = await fetch('/api/tasks_public');
          const j = await res.json();
          allTasks = j.tasks || j || [];
          renderTasks();
        } catch (e) {
          console.warn('loadTasks', e);
          tasksList.innerHTML = '<div class="small">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–¥–∞–Ω–∏—è</div>';
        }
      }
      function renderTasks() {
        const arr = currentSub === 'my' ? allTasks.filter(t => String(t.owner_uid) === String(uid)) : allTasks.filter(t => String(t.owner_uid) !== String(uid));
        if (!arr.length) {
          tasksList.innerHTML = '<div class="small">–ù–µ—Ç –∑–∞–¥–∞–Ω–∏–π</div>';
          return;
        }
        tasksList.innerHTML = '';
        arr.forEach(t => {
          const row = document.createElement('div');
          row.className = 'task-item';
          row.role = 'listitem';
          const left = document.createElement('div');
          left.style.flex = '1';
          const title = document.createElement('div');
          title.style.fontWeight = '800';
          title.textContent = t.title || t.name || '–ó–∞–¥–∞–Ω–∏–µ';
          const desc = document.createElement('div');
          desc.className = 'small';
          desc.textContent = t.description || t.desc || '';
          left.appendChild(title);
          left.appendChild(desc);
          const right = document.createElement('div');
          right.style.textAlign = 'right';
          const price = document.createElement('div');
          price.style.fontWeight = '900';
          price.textContent = Number(t.unit_price || t.reward || 0).toLocaleString('ru-RU') + ' ‚ÇΩ';
          const qty = document.createElement('div');
          qty.className = 'small';
          qty.textContent = (t.qty || 1) + ' —à—Ç';
          right.appendChild(price);
          right.appendChild(qty);
          row.appendChild(left);
          row.appendChild(right);
          tasksList.appendChild(row);
        });
      }
      // Load types
      async function loadTypes() {
        try {
          let res = await fetch('/api/task_types');
          if (!res.ok) res = await fetch('/task_types.json');
          types = await res.json();
        } catch (e) {
          console.warn('types load', e);
          types = [
            { id: 'ya_review', name: '–û—Ç–∑—ã–≤ ‚Äî –Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç—ã', unit_price: 120, max_qty: 500 },
            { id: 'gmaps_review', name: '–û—Ç–∑—ã–≤ ‚Äî Google Maps', unit_price: 65, max_qty: 500 },
            { id: 'tg_sub', name: '–ü–æ–¥–ø–∏—Å–∫–∞ ‚Äî Telegram –∫–∞–Ω–∞–ª', unit_price: 10, max_qty: 100000 }
          ];
        }
        renderTypes();
      }
      function renderTypes() {
        typesBox.innerHTML = '';
        types.forEach((t, idx) => {
          const b = document.createElement('button');
          b.className = 'type-btn';
          b.type = 'button';
          b.role = 'radio';
          b.ariaChecked = idx === 0 ? 'true' : 'false';
          b.innerHTML = `<div style="font-weight:800">${t.name}</div><div style="text-align:right"><div style="font-weight:900">${t.unit_price} ‚ÇΩ</div><div class="small">max ${t.max_qty || '‚àû'}</div></div>`;
          b.addEventListener('click', () => {
            selectedType = t;
            $$('.type-btn').forEach(x => x.classList.remove('active'));
            b.classList.add('active');
            $$('.type-btn').forEach(x => x.setAttribute('aria-checked', x === b ? 'true' : 'false'));
            updatePrices();
          });
          typesBox.appendChild(b);
          if (idx === 0 && !selectedType) {
            selectedType = t;
            b.classList.add('active');
          }
        });
        updatePrices();
      }
      function updatePrices() {
        if (!selectedType) {
          unitPrice.textContent = '–¶–µ–Ω–∞ –∑–∞ —à—Ç: ‚Äî';
          totalPrice.textContent = '–û–±—â–∞—è —Ü–µ–Ω–∞: ‚Äî';
          return;
        }
        const qty = Number(taskQty.value || 1);
        unitPrice.textContent = `–¶–µ–Ω–∞ –∑–∞ —à—Ç: ${selectedType.unit_price} ‚ÇΩ`;
        totalPrice.textContent = `–û–±—â–∞—è —Ü–µ–Ω–∞: ${((selectedType.unit_price || 0) * qty).toLocaleString('ru-RU')} ‚ÇΩ`;
      }
      // Debounce for taskQty input
      let qtyDebounce;
      taskQty.addEventListener('input', () => {
        clearTimeout(qtyDebounce);
        qtyDebounce = setTimeout(updatePrices, 300);
      });
      // URL checker with debounce
      let urlCheckTimer = null;
      taskUrl.addEventListener('input', () => {
        clearTimeout(urlCheckTimer);
        urlStatus.textContent = '';
        if (!taskUrl.value.trim()) {
          urlChecker.style.display = 'none';
          urlStatus.textContent = '';
          return;
        }
        urlChecker.style.display = 'inline-block';
        urlStatus.textContent = '–ü—Ä–æ–≤–µ—Ä–∫–∞‚Ä¶';
        urlCheckTimer = setTimeout(async () => {
          const res = await checkUrl(taskUrl.value.trim());
          urlChecker.style.display = 'none';
          if (res.ok === true) {
            urlStatus.textContent = '‚úÖ';
            urlStatus.style.color = '#28a745';
          } else if (res.ok === false) {
            urlStatus.textContent = '‚ùå ' + (res.message || '–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ');
            urlStatus.style.color = '#ff4d6d';
          } else {
            urlStatus.textContent = '‚ö† ' + (res.message || '–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ (CORS)');
            urlStatus.style.color = '#d7a700';
          }
        }, 600);
      });
      async function checkUrl(url) {
        if (!url) return { ok: false, message: '–ü—É—Å—Ç–∞—è —Å—Å—ã–ª–∫–∞' };
        if (!/^https?:\/\//i.test(url)) return { ok: false, message: '–î–æ–ª–∂–Ω–∞ –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å http:// –∏–ª–∏ https://' };
        if (url.length > 4096) return { ok: false, message: '–°–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–∞—è' };
        try {
          const r = await fetch(url, { method: 'HEAD', mode: 'cors' });
          if (r && typeof r.status === 'number') {
            return { ok: r.ok, message: r.ok ? '' : '–û—à–∏–±–∫–∞ ' + r.status };
          }
        } catch (e) {
          try {
            await fetch(url, { method: 'GET', mode: 'no-cors' });
            return { ok: null, message: '–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∞ (CORS) ‚Äî –æ—Ç–∫—Ä–æ–π—Ç–µ —Å—Å—ã–ª–∫—É –≤—Ä—É—á–Ω—É—é' };
          } catch (e2) {
            return { ok: false, message: '–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å' };
          }
        }
        return { ok: null, message: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ' };
      }
      // Create task handler
      submitTask.addEventListener('click', async () => {
        const url = taskUrl.value.trim();
        const qty = Number(taskQty.value || 0);
        if (!selectedType) return alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∑–∞–¥–∞–Ω–∏—è');
        if (!url) return alert('–í–≤–µ–¥–∏—Ç–µ —Å—Å—ã–ª–∫—É');
        if (!qty || qty < 1) return alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ');
        if (selectedType.max_qty && qty > selectedType.max_qty) return alert('–ü—Ä–µ–≤—ã—à–µ–Ω–æ –º–∞–∫—Å. –∫–æ–ª-–≤–æ –¥–ª—è —ç—Ç–æ–≥–æ —Ç–∏–ø–∞');
        const chk = await checkUrl(url);
        if (chk.ok === false) return alert('–°—Å—ã–ª–∫–∞ –Ω–µ—Ä–∞–±–æ—á–∞—è: ' + (chk.message || ''));
        if (chk.ok === null && !confirm('–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Å—ã–ª–∫—É (CORS). –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ –≤—Å—ë —Ä–∞–≤–Ω–æ?')) return;
        try {
          const body = {
            title: selectedType.name,
            description: selectedType.name,
            unit_price: selectedType.unit_price,
            qty,
            url,
            type_id: selectedType.id,
            owner_uid: uid
          };
          const r = await fetch('/api/tasks/create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
          });
          const j = await r.json();
          if (j && j.ok) {
            createModal.close();
            await loadTasks();
            alert('–ó–∞–¥–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ');
          } else {
            alert((j && j.errmsg) || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è');
          }
        } catch (e) {
          console.error(e);
          alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∏–ª–∏ —Å–µ—Ä–≤–µ—Ä.');
        }
      });
      // Open/close modals
      function openTopup() {
        topupModal.showModal();
        topupStep.style.display = 'none';
        topupAmount.value = minTopup;
        topupMsg.textContent = '';
      }
      function closeTopupFunc() { topupModal.close(); }
      function openWithdraw() {
        withdrawModal.showModal();
        withdrawMsg.textContent = '';
      }
      function closeWithdrawFunc() { withdrawModal.close(); }
      function openCreate() {
        createModal.showModal();
        createMsg.textContent = '';
        loadTypes();
      }
      function closeCreateFunc() {
        createModal.close();
        selectedType = null;
        taskUrl.value = '';
        taskQty.value = 1;
        updatePrices();
        urlChecker.style.display = 'none';
        urlStatus.textContent = '';
      }
      // Topup create flow
      let topupState = { current: null, amount: 0, manual_code: '' };
      createTopupBtn.addEventListener('click', async () => {
        const amount = Number(topupAmount.value || 0);
        if (!amount || amount < minTopup) return alert('–ú–∏–Ω. ' + minTopup + ' ‚ÇΩ');
        try {
          const res = await fetch('/api/user/topup-link', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ uid, amount })
          });
          if (!res.ok) throw new Error('Server responded with ' + res.status);
          const j = await res.json();
          if (j && j.ok) {
            topupStep.style.display = 'block';
            qrImg.src = j.qr_base64 ? `data:image/png;base64,${j.qr_base64}` : (j.qr_url || '');
            manualCode.value = j.manual_code || (j.topup && j.topup.manual_code) || '';
            payLink.href = j.pay_link || '#';
            topupState.current = (j.topup && j.topup.id) || j.id || null;
            topupState.amount = amount;
            topupMsg.textContent = '–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∏ –æ–ø–ª–∞—Ç–∏—Ç–µ. –ù–∞–∂–º–∏—Ç–µ "–Ø –æ–ø–ª–∞—Ç–∏–ª" –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏.';
          } else {
            alert((j && j.errmsg) || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏');
          }
        } catch (e) {
          console.error(e);
          alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.');
        }
      });
      confirmPaidBtn.addEventListener('click', async () => {
        if (!topupState.current) return alert('–°–æ–∑–¥–∞–π—Ç–µ –∑–∞—è–≤–∫—É');
        try {
          const r = await fetch('/api/user/topup-confirm', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ topup_id: topupState.current, uid })
          });
          if (!r.ok) throw new Error('Server responded with ' + r.status);
          const j = await r.json();
          if (j && j.ok) {
            alert('–ó–∞–ø—Ä–æ—Å –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω');
            closeTopupFunc();
            loadProfile();
          } else {
            alert((j && j.errmsg) || '–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏');
          }
        } catch (e) {
          console.error(e);
          alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.');
        }
      });
      // Withdraw
      sendWithdraw.addEventListener('click', async () => {
        const amount = Number(wAmount.value || 0);
        if (!amount || amount < 300) return alert('–ú–∏–Ω. 300 ‚ÇΩ');
        if (amount > (window.__USER_BALANCE || 0)) return alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤');
        const name = wName.value.trim(), details = wDetails.value.trim();
        if (!name || !details) return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è');
        try {
          const r = await fetch('/api/user/withdraw', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ uid, amount, name, details })
          });
          if (!r.ok) throw new Error('Server responded with ' + r.status);
          const j = await r.json();
          if (j && j.ok) {
            withdrawMsg.textContent = '–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞';
            closeWithdrawFunc();
            loadProfile();
          } else {
            withdrawMsg.textContent = (j && j.errmsg) || '–û—à–∏–±–∫–∞';
          }
        } catch (e) {
          withdrawMsg.textContent = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.';
        }
      });
      // Support
      supportBtn.addEventListener('click', () => {
        const tgLink = 'tg://resolve?domain=LolikMoney';
        const httpLink = 'https://t.me/LolikMoney';
        if (tg && tg.openTelegramLink) {
          try {
            tg.openTelegramLink(tgLink);
            return;
          } catch (e) {}
        }
        window.open(httpLink, '_blank');
      });
      // Button wiring
      topupBtn.addEventListener('click', openTopup);
      closeTopup.addEventListener('click', closeTopupFunc);
      withdrawBtn.addEventListener('click', openWithdraw);
      closeWithdraw.addEventListener('click', closeWithdrawFunc);
      cancelWithdraw.addEventListener('click', closeWithdrawFunc);
      fab.addEventListener('click', openCreate);
      closeCreate.addEventListener('click', closeCreateFunc);
      cancelCreate.addEventListener('click', closeCreateFunc);
      // Initial load orchestration
      (async function init() {
        showLoader();
        await Promise.allSettled([loadProfile(), loadTasks(), loadTypes()]);
        // Smooth startup
        setTimeout(() => { hideLoader(); }, 700);
      })();
      // Expose for debugging
      window.loadProfile = loadProfile;
      window.loadTasks = loadTasks;
      window.loadTypes = loadTypes;
    })();
  </script>
</body>
</html>
