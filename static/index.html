<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>ReviewCash — Личный кабинет</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Telegram WebApp -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<!-- Socket.io — Railway совместимый -->
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

<style>

/* ------------------------------
    ГЛОБАЛЬНЫЕ НАСТРОЙКИ / ТЕМЫ
--------------------------------*/
:root {
    --bg: #000;
    --card-bg: rgba(0,0,0,0.55);
    --text: #dffcff;
    --text2: #9ee8ff;
    --accent: #00eaff;
    --accent2: #008cff;
    --border: rgba(0,255,255,0.25);
}

/* светлая тема */
body.white {
    --bg: #f8fdff;
    --card-bg: rgba(255,255,255,0.8);
    --text: #003344;
    --text2: #005577;
    --accent: #009dff;
    --accent2: #0055ff;
    --border: rgba(0,110,255,0.3);
}

body {
    background: var(--bg);
    margin: 0;
    font-family: "Inter", sans-serif;
    color: var(--text);
    transition: background .35s ease, color .35s ease;
}

/* --------------------------------
             АНИМАЦИИ
---------------------------------*/
.fade-in {
    animation: fadeIn .45s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(12px); }
    to   { opacity: 1; transform: translateY(0); }
}

.scale-in {
    animation: scaleIn .3s ease;
}

@keyframes scaleIn {
    from { opacity: 0; transform: scale(.8); }
    to   { opacity: 1; transform: scale(1); }
}

/* --------------------------------
             КНОПКИ
---------------------------------*/

.btn {
    width: 100%;
    padding: 15px;
    border-radius: 14px;
    background: linear-gradient(90deg, var(--accent), var(--accent2));
    color: #000;
    font-weight: 700;
    border: none;
    cursor: pointer;
    margin-top: 12px;
    box-shadow: 0 0 18px var(--accent2);
    transition: .2s;
}

.btn:active {
    transform: scale(.98);
}

.btn-outline {
    width: 100%;
    padding: 14px;
    border-radius: 14px;
    border: 2px solid var(--accent);
    background: transparent;
    color: var(--accent);
    font-weight: 700;
    margin-top: 12px;
    cursor: pointer;
}

/* --------------------------------
             КАРТОЧКИ
---------------------------------*/

.card {
    padding: 18px;
    margin: 15px;
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: 20px;
    backdrop-filter: blur(14px);
    box-shadow: 0 0 22px rgba(0,255,255,0.15);
    transition: .35s ease;
}

.neon {
    color: var(--accent);
    text-shadow: 0 0 12px var(--accent);
}

/* --------------------------------
     ПРОФИЛЬ / АВАТАР / ИМЯ
---------------------------------*/
#avatar {
    width: 75px;
    height: 75px;
    border-radius: 50%;
    border: 2px solid var(--accent);
    object-fit: cover;
    box-shadow: 0 0 18px var(--accent);
}

/* --------------------------------
             НАВИГАЦИЯ
---------------------------------*/

.tabbar {
    position: fixed;
    bottom: 0;
    left: 0; width: 100%;
    background: var(--card-bg);
    border-top: 1px solid var(--border);
    backdrop-filter: blur(12px);
    padding: 12px 0;
    display: flex;
    justify-content: space-around;
}

.tab-item {
    color: var(--text2);
    font-weight: 700;
    padding: 8px 20px;
    border-radius: 12px;
    cursor: pointer;
    transition: .2s;
}

.tab-item.active {
    background: linear-gradient(90deg,var(--accent),var(--accent2));
    color: #000;
}

/* --------------------------------
             МОДАЛКИ
---------------------------------*/

.modal-bg {
    position: fixed;
    inset: 0;
    display: none;
    justify-content: center;
    align-items: center;
    backdrop-filter: blur(8px);
    background: rgba(0,0,0,.65);
    z-index: 9999;
}

.modal {
    background: var(--card-bg);
    border-radius: 20px;
    border: 1px solid var(--border);
    padding: 20px;
    width: 90%;
    box-shadow: 0 0 25px var(--accent2);
}

/* --------------------------------
            ЗАДАНИЯ
---------------------------------*/

.task {
    padding: 12px;
    border-radius: 14px;
    background: rgba(255,255,255,0.04);
    margin-bottom: 10px;
    border: 1px solid var(--border);
}

</style>
</head>
<body class="fade-in">

<!-- =========================
         КНОПКИ ВЕРХА
========================= -->
<button id="themeBtn" style="
    position:fixed; left:14px; top:14px;
    background:var(--card-bg); border:1px solid var(--border);
    padding:8px 14px; border-radius:12px; color:var(--accent);
    font-weight:700; backdrop-filter:blur(8px); z-index:999;">
    Тема
</button>

<button id="supportBtn" style="
    position:fixed; right:14px; top:14px;
    background:var(--card-bg); border:1px solid var(--border);
    padding:8px 14px; border-radius:12px; color:var(--accent);
    font-weight:700; backdrop-filter:blur(8px); z-index:999;">
    Поддержка
</button>

<!-- =========================
         БЛОК ПРОФИЛЯ
========================= -->
<div id="profilePage" class="fade-in card">
    <div style="display:flex;align-items:center;">
        <img id="avatar">
        <div style="margin-left:15px;">
            <div id="name" class="neon" style="font-size:20px;">Загрузка...</div>
            <div style="color:var(--text2); font-size:14px;">ID: <span id="uid"></span></div>
        </div>
    </div>

    <div style="margin-top:18px;">
        <div style="font-size:14px;color:var(--text2);">Баланс</div>
        <div id="balance" class="neon" style="font-size:30px;">0 ₽</div>
    </div>

    <button class="btn" id="topupBtn">Пополнить</button>
    <button class="btn-outline" id="withdrawBtn">Вывести</button>
</div>

<!-- =========================
         ЗАДАНИЯ
========================= -->
<div id="tasksPage" class="card fade-in" style="display:none;">
    <div style="font-size:20px;font-weight:800;">Задания</div>
    <div id="tasksList" style="margin-top:12px;">Загрузка...</div>
</div>

<!-- =========================
         НАВИГАЦИЯ
========================= -->
<div class="tabbar">
    <div class="tab-item active" data-tab="profilePage">Профиль</div>
    <div class="tab-item" data-tab="tasksPage">Задания</div>
</div>

<!-- =========================
         МОДАЛ: ПОПОЛНЕНИЕ
========================= -->
<div class="modal-bg" id="topupModal">
    <div class="modal scale-in">
        <h3>Пополнение</h3>
        <input id="topupAmount" type="number" min="150" placeholder="Сумма" style="width:100%;padding:14px;border-radius:12px;border:1px solid var(--border);margin-top:10px;">
        <button class="btn" id="createTopup">Создать</button>
        <button class="btn-outline" id="closeTopup">Закрыть</button>
    </div>
</div>

<!-- =========================
         МОДАЛ: ВЫВОД
========================= -->
<div class="modal-bg" id="withdrawModal">
    <div class="modal scale-in">
        <h3>Вывод</h3>
        <input id="wAmount" type="number" placeholder="Сумма" style="width:100%;padding:14px;border-radius:12px;border:1px solid var(--border);margin-top:10px;">
        <input id="wName" type="text" placeholder="Имя" style="width:100%;padding:14px;border-radius:12px;border:1px solid var(--border);margin-top:10px;">
        <input id="wDetails" type="text" placeholder="Реквизиты" style="width:100%;padding:14px;border-radius:12px;border:1px solid var(--border);margin-top:10px;">

        <button class="btn" id="sendWithdraw">Отправить</button>
        <button class="btn-outline" id="closeWithdraw">Закрыть</button>
    </div>
</div>

<script>
/* Telegram WebApp */
let tg = window.Telegram.WebApp;
try { tg.ready(); tg.expand(); } catch(e){}

/* UI Shortcuts */
const $ = sel => document.querySelector(sel);
const $$ = sel => document.querySelectorAll(sel);

/* USER */
const uid = tg.initDataUnsafe?.user?.id || "0";
$("#uid").textContent = uid;
$("#name").textContent = tg.initDataUnsafe?.user?.first_name || "Пользователь";
$("#avatar").src = tg.initDataUnsafe?.user?.photo_url || "https://api.dicebear.com/7.x/thumbs/png?seed=" + uid;

/* SOCKET — Railway */
const socket = io();

/* NAVIGATION */
$$(".tab-item").forEach(btn=>{
    btn.addEventListener("click", ()=>{
        $$(".tab-item").forEach(x=>x.classList.remove("active"));
        btn.classList.add("active");

        let tab = btn.dataset.tab;
        $("#profilePage").style.display = "none";
        $("#tasksPage").style.display = "none";

        $("#"+tab).style.display = "block";
    });
});

/* THEME SWITCHER */
$("#themeBtn").onclick = ()=>{
    document.body.classList.toggle("white");
    localStorage.setItem("theme", document.body.classList.contains("white") ? "white" : "dark");
};

if(localStorage.getItem("theme")==="white") document.body.classList.add("white");

/* SUPPORT */
$("#supportBtn").onclick = ()=>{
    tg.openTelegramLink("https://t.me/LolikMoney");
};

/* LOAD PROFILE */
async function loadProfile() {
    let r = await fetch(`/api/profile_me?uid=${uid}`);
    let j = await r.json();
    if(j.ok){
        $("#balance").textContent = j.user.balance + " ₽";
    }
}
loadProfile();

/* LOAD TASKS */
async function loadTasks(){
    let r = await fetch("/api/tasks/list");
    let j = await r.json();
    if(j.ok){
        $("#tasksList").innerHTML = "";
        j.tasks.forEach(t=>{
            let div = document.createElement("div");
            div.className = "task";
            div.innerHTML = `
                <div style="font-weight:700">${t.title}</div>
                <div style="color:var(--text2);font-size:13px;margin-top:4px">${t.description}</div>
                <div style="margin-top:8px;font-weight:800">${t.unit_price} ₽ × ${t.qty}</div>
            `;
            $("#tasksList").appendChild(div);
        });
    }
}
loadTasks();

/* SOCKET EVENTS */
socket.on("task_update", loadTasks);
socket.on("user_update", (d)=>{
    if(d.user_id==uid) loadProfile();
});

/* TOPUP */
$("#topupBtn").onclick = ()=>$("#topupModal").style.display="flex";
$("#closeTopup").onclick = ()=>$("#topupModal").style.display="none";

$("#createTopup").onclick = async()=>{
    let amount = Number($("#topupAmount").value);
    if(amount<150) return alert("Минимум 150 ₽");

    let r = await fetch("/api/user/topup-link",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({uid,amount})
    });
    let j = await r.json();
    if(j.ok){
        tg.openLink(j.pay_link);
        alert("Заявка создана, после оплаты нажмите в меню «Я оплатил»");
        $("#topupModal").style.display="none";
    }
};

/* WITHDRAW */
$("#withdrawBtn").onclick = ()=>$("#withdrawModal").style.display="flex";
$("#closeWithdraw").onclick = ()=>$("#withdrawModal").style.display="none";

$("#sendWithdraw").onclick = async()=>{
    let amount = Number($("#wAmount").value);
    let name = $("#wName").value.trim();
    let details = $("#wDetails").value.trim();
    if(amount<300) return alert("Минимум 300 ₽");

    let r = await fetch("/api/user/withdraw",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({uid,amount,name,details})
    });
    let j = await r.json();
    if(j.ok){
        alert("Заявка отправлена");
        $("#withdrawModal").style.display="none";
    }
};

</script>
</body>
</html>
