<!-- static/index.html -->
<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ReviewCash ‚Äî –ö–∞–±–∏–Ω–µ—Ç</title>

  <!-- Socket.IO (CDN) -->
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --radius:16px;
      --accent-neon: #00eaff;
      --accent-neon-2: #0077ff;
      --glass-1: rgba(255,255,255,0.78);
      --glass-2: rgba(255,255,255,0.95);
      --muted-dark: #9ee8ff;
    }
    /* Hybrid themes */
    body { margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto; background:linear-gradient(180deg,#071724,#00121a); color:#dffcff; min-height:100vh; -webkit-font-smoothing:antialiased; }
    body.light { background: linear-gradient(180deg,#f6fbff,#ffffff); color:#05232f; }
    /* Loader */
    #loader { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:9999; flex-direction:column; gap:12px; background:linear-gradient(180deg, rgba(0,0,0,0.6), rgba(0,0,0,0.85)); color:white; }
    #loader.hidden { display:none; }
    .brand { font-weight:900; font-size:28px; color:var(--accent-neon); text-shadow:0 0 18px rgba(0,230,255,0.12); }
    .loader-sub { opacity:0.9; }

    /* container */
    .wrap { max-width:980px; margin:18px auto; padding:18px; }

    /* cards */
    .card { border-radius:var(--radius); padding:16px; margin-bottom:14px; backdrop-filter: blur(8px); box-shadow:0 12px 40px rgba(0,0,0,0.25); transition:all .28s ease; border:1px solid rgba(255,255,255,0.04); }
    body.light .card { background: linear-gradient(180deg, var(--glass-1), var(--glass-2)); border:1px solid rgba(0,112,255,0.06); box-shadow: 0 8px 30px rgba(12, 80, 140, 0.06); color: #05232f; }

    /* neon dark card */
    .card.dark { background: rgba(0,6,12,0.7); border:1px solid rgba(0,255,255,0.06); box-shadow: 0 12px 60px rgba(0,160,200,0.06); }

    .header-row { display:flex; gap:12px; align-items:center; }
    .avatar { width:72px; height:72px; border-radius:50%; border:3px solid var(--accent-neon); overflow:hidden; object-fit:cover; }
    .name { font-weight:800; font-size:18px; }
    .uid { color: rgba(255,255,255,0.7); font-size:13px; }

    .balance { font-weight:900; font-size:28px; background: linear-gradient(90deg,var(--accent-neon),var(--accent-neon-2)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }

    .row { display:flex; gap:10px; align-items:center; }
    .btn { padding:10px 14px; border-radius:12px; border:none; cursor:pointer; font-weight:800; background:linear-gradient(90deg,var(--accent-neon),var(--accent-neon-2)); color:#001; box-shadow:0 10px 30px rgba(0,0,0,0.15); transition:.18s; }
    .btn.ghost { background:transparent; border:1px solid rgba(255,255,255,0.06); color:inherit; box-shadow:none; }
    .btn.small { padding:8px 10px; border-radius:10px; font-weight:700; }

    /* tabs */
    .tabbar { position:fixed; left:50%; transform:translateX(-50%); bottom:18px; background: rgba(2,6,11,0.85); padding:8px; border-radius:999px; display:flex; gap:8px; z-index:80; border:1px solid rgba(255,255,255,0.04); }
    body.light .tabbar { background: rgba(255,255,255,0.9); border:1px solid rgba(0,112,255,0.06); }
    .nav-item { padding:10px 14px; border-radius:999px; cursor:pointer; font-weight:800; color: rgba(255,255,255,0.7); border:1px solid rgba(255,255,255,0.04); }
    .nav-item.active { background: linear-gradient(90deg,var(--accent-neon),var(--accent-neon-2)); color:#001; }

    /* tasks */
    .task { padding:12px; border-radius:12px; background: rgba(255,255,255,0.02); margin-bottom:8px; display:flex; justify-content:space-between; align-items:center; }
    body.light .task { background: rgba(0,0,0,0.02); }

    /* modal */
    .modal-bg { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background: rgba(0,0,0,0.6); z-index:9999; }
    .modal-bg.open { display:flex; }
    .modal { width:92%; max-width:720px; border-radius:12px; padding:16px; background:var(--card-bg); border:1px solid rgba(255,255,255,0.06); box-shadow:0 18px 50px rgba(0,0,0,0.25); }

    input, textarea { width:100%; padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,0.06); background:transparent; color:inherit; margin-top:8px; box-sizing:border-box; }

    /* url checker */
    .url-check { display:inline-block; width:16px; height:16px; border:3px solid var(--accent-neon); border-top:3px solid transparent; border-radius:50%; animation:spin .9s linear infinite; vertical-align:middle; margin-left:8px; }
    @keyframes spin { to { transform:rotate(360deg); } }
    .url-status { margin-left:10px; font-weight:800; }

    /* small */
    .small { font-size:13px; color: rgba(255,255,255,0.75); }

    /* responsiveness */
    @media (max-width:520px){
      .wrap { padding:10px; }
      .avatar { width:64px; height:64px; }
    }
  </style>
</head>
<body>
  <!-- Loader -->
  <div id="loader" role="status" aria-live="polite">
    <div class="brand">ReviewCash</div>
    <div class="loader-sub">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è‚Ä¶</div>
  </div>

  <main class="wrap" id="app" style="display:none">
    <!-- Profile card -->
    <section id="profileCard" class="card dark">
      <div class="header-row">
        <img id="avatar" class="avatar" src="" alt="–ê–≤–∞—Ç–∞—Ä">
        <div style="flex:1">
          <div class="name" id="userName">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
          <div class="uid small" id="userHandle">‚Äî</div>
          <div style="margin-top:12px">
            <div class="small">–ë–∞–ª–∞–Ω—Å</div>
            <div class="balance" id="balance">0 ‚ÇΩ</div>
          </div>
        </div>
        <div style="text-align:right">
          <button id="topupBtn" class="btn">–ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>
          <div style="height:10px"></div>
          <button id="withdrawBtn" class="btn ghost small">–í—ã–≤–µ—Å—Ç–∏</button>
        </div>
      </div>
      <div style="margin-top:12px; display:flex; gap:8px;">
        <button id="supportBtn" class="btn ghost small">üîî –ü–æ–¥–¥–µ—Ä–∂–∫–∞</button>
        <button id="themeToggle" class="btn ghost small">üåó –¢–µ–º–∞</button>
      </div>
    </section>

    <!-- Tasks card -->
    <section id="tasksCard" class="card dark" style="display:none">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div style="font-weight:900; font-size:18px">–ó–∞–¥–∞–Ω–∏—è</div>
        <div class="small" id="tasksCount">‚Äî</div>
      </div>
      <div id="tasksList" style="margin-top:12px">
        <div class="small">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
      </div>
    </section>
  </main>

  <!-- FAB create -->
  <button id="fab" title="–°–æ–∑–¥–∞—Ç—å" style="position:fixed; right:18px; bottom:98px; width:64px; height:64px; border-radius:50%; background:linear-gradient(90deg,var(--accent-neon),var(--accent-neon-2)); color:#001; font-weight:900; z-index:70; border:none;">+</button>

  <!-- bottom tab -->
  <nav class="tabbar" role="tablist">
    <div class="nav-item active" data-nav="profile">–ü—Ä–æ—Ñ–∏–ª—å</div>
    <div class="nav-item" data-nav="tasks">–ó–∞–¥–∞–Ω–∏—è</div>
  </nav>

  <!-- Topup modal -->
  <div id="topupModal" class="modal-bg" aria-hidden="true">
    <div class="modal">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:900">–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ</div>
        <button id="closeTopup" class="btn ghost small">‚úï</button>
      </div>
      <div class="small" style="margin-top:8px">–ú–∏–Ω. 150 ‚ÇΩ</div>
      <div style="display:flex; gap:8px; margin-top:10px;">
        <input id="topupAmount" type="number" min="150" value="150" />
        <button id="createTopupBtn" class="btn">–°–æ–∑–¥–∞—Ç—å</button>
      </div>
      <div id="topupStep" style="display:none; margin-top:12px">
        <div class="small">–°—Å—ã–ª–∫–∞ / QR</div>
        <img id="qrImg" style="display:block; max-width:220px; margin:8px 0; border-radius:8px" src="" alt="QR"/>
        <input id="manualCode" readonly />
        <div style="display:flex; gap:8px; margin-top:10px;">
          <a id="payLink" class="btn" target="_blank" rel="noopener">–û—Ç–∫—Ä—ã—Ç—å</a>
          <button id="confirmPaidBtn" class="btn ghost">–Ø –æ–ø–ª–∞—Ç–∏–ª</button>
        </div>
        <div id="topupMsg" class="small" style="margin-top:8px"></div>
      </div>
    </div>
  </div>

  <!-- Withdraw modal -->
  <div id="withdrawModal" class="modal-bg" aria-hidden="true">
    <div class="modal">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:900">–í—ã–≤–æ–¥</div>
        <button id="closeWithdraw" class="btn ghost small">‚úï</button>
      </div>
      <div class="small" style="margin-top:8px">–ú–∏–Ω. 300 ‚ÇΩ</div>
      <input id="wAmount" type="number" placeholder="–°—É–º–º–∞" />
      <input id="wName" type="text" placeholder="–§–ò–û –∏–ª–∏ –Ω–∏–∫ (–ø–æ–ª—É—á–∞—Ç–µ–ª—å)" />
      <input id="wDetails" type="text" placeholder="–†–µ–∫–≤–∏–∑–∏—Ç—ã (–∫–∞—Ä—Ç–∞ / –°–ë–ü)" />
      <div style="display:flex; gap:8px; margin-top:10px">
        <button id="sendWithdraw" class="btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É</button>
        <button id="cancelWithdraw" class="btn ghost">–û—Ç–º–µ–Ω–∞</button>
      </div>
      <div id="withdrawMsg" class="small" style="margin-top:8px"></div>
    </div>
  </div>

  <!-- Create task modal -->
  <div id="createModal" class="modal-bg" aria-hidden="true">
    <div class="modal">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:900">–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ</div>
        <button id="closeCreate" class="btn ghost small">‚úï</button>
      </div>
      <div class="small" style="margin-top:8px">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∏ –≤—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É</div>
      <div id="typesBox" style="display:flex; gap:8px; margin-top:10px; flex-wrap:wrap"></div>
      <div style="position:relative; margin-top:10px;">
        <input id="taskUrl" placeholder="–°—Å—ã–ª–∫–∞ (http:// –∏–ª–∏ https://)" />
        <div style="position:absolute; right:8px; top:8px; display:flex; align-items:center;">
          <div id="urlChecker" class="url-check" style="display:none"></div>
          <div id="urlStatus" class="url-status small"></div>
        </div>
      </div>
      <div style="display:flex; gap:8px; align-items:center; margin-top:10px;">
        <input id="taskQty" type="number" min="1" value="1" style="width:120px" />
        <div id="unitPrice" class="small">–¶–µ–Ω–∞ –∑–∞ —à—Ç: ‚Äî</div>
        <div id="totalPrice" style="margin-left:auto; font-weight:900">–û–±—â–∞—è —Ü–µ–Ω–∞: ‚Äî</div>
      </div>
      <div style="display:flex; gap:8px; margin-top:12px">
        <button id="submitTask" class="btn">–°–æ–∑–¥–∞—Ç—å</button>
        <button id="cancelCreateBtn" class="btn ghost">–û—Ç–º–µ–Ω–∞</button>
      </div>
      <div id="createMsg" class="small" style="margin-top:8px"></div>
    </div>
  </div>

<script>
(() => {
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const loader = $('#loader');
  const app = document.getElementById('app');
  const profileCard = $('#profileCard');
  const tasksCard = $('#tasksCard');
  const avatar = $('#avatar');
  const userName = $('#userName');
  const userHandle = $('#userHandle');
  const balanceEl = $('#balance');
  const topupBtn = $('#topupBtn');
  const withdrawBtn = $('#withdrawBtn');
  const supportBtn = $('#supportBtn');
  const themeToggle = $('#themeToggle');
  const fab = $('#fab');
  const navItems = $$('.nav-item');

  const topupModal = $('#topupModal'), closeTopup = $('#closeTopup');
  const topupAmount = $('#topupAmount'), createTopupBtn = $('#createTopupBtn'), topupStep = $('#topupStep'), qrImg = $('#qrImg'), manualCode = $('#manualCode'), payLink = $('#payLink'), confirmPaidBtn = $('#confirmPaidBtn'), topupMsg = $('#topupMsg');

  const withdrawModal = $('#withdrawModal'), closeWithdraw = $('#closeWithdraw'), cancelWithdraw = $('#cancelWithdraw');
  const wAmount = $('#wAmount'), wName = $('#wName'), wDetails = $('#wDetails'), sendWithdraw = $('#sendWithdraw'), withdrawMsg = $('#withdrawMsg');

  const createModal = $('#createModal'), closeCreate = $('#closeCreate'), cancelCreateBtn = $('#cancelCreateBtn');
  const typesBox = $('#typesBox'), taskUrl = $('#taskUrl'), urlChecker = $('#urlChecker'), urlStatus = $('#urlStatus');
  const taskQty = $('#taskQty'), unitPrice = $('#unitPrice'), totalPrice = $('#totalPrice'), submitTask = $('#submitTask'), createMsg = $('#createMsg');

  // Telegram WebApp access if available
  const tg = window.Telegram?.WebApp || null;
  try { tg?.ready?.(); tg?.expand?.(); } catch(e){}

  // uid from Telegram init or random
  const tgUser = tg?.initDataUnsafe?.user || {};
  const uid = tgUser.id ? String(tgUser.id) : (new URLSearchParams(location.search)).get('uid') || 'guest_' + Math.floor(Math.random()*99999);
  avatar.src = tgUser.photo_url || `https://api.dicebear.com/8.x/thumbs/svg?seed=${encodeURIComponent(uid)}`;
  userName.textContent = (tgUser.first_name || '') + (tgUser.last_name ? ' ' + tgUser.last_name : '');
  userHandle.textContent = tgUser.username ? ('@' + tgUser.username) : `ID: ${uid}`;

  // Socket
  let socket;
  try {
    socket = io({transports:['websocket'], upgrade:false});
    socket.on('connect', ()=>console.log('socket connected'));
    socket.on('task_update', ()=>loadTasks());
    socket.on('user_update', d => {
      if (d && String(d.user_id) === String(uid) && typeof d.balance !== 'undefined') renderBalance(d.balance);
    });
    socket.on('connect_error', err => console.warn('socket err', err));
  } catch(e){ console.warn('socket failed', e); }

  // theme
  function applyTheme() {
    const t = localStorage.getItem('theme') || 'dark';
    if (t === 'light') document.body.classList.add('light'); else document.body.classList.remove('light');
    // adjust card styles
    const cards = $$('.card');
    cards.forEach(c => c.classList.toggle('dark', !document.body.classList.contains('light')));
  }
  applyTheme();
  themeToggle.addEventListener('click', () => {
    const isLight = document.body.classList.toggle('light');
    localStorage.setItem('theme', isLight ? 'light' : 'dark');
    applyTheme();
  });

  // navigation
  navItems.forEach(n => n.addEventListener('click', ()=>{
    navItems.forEach(x=>x.classList.remove('active'));
    n.classList.add('active');
    const nav = n.dataset.nav;
    profileCard.style.display = nav === 'profile' ? 'block' : 'none';
    tasksCard.style.display = nav === 'tasks' ? 'block' : 'none';
    window.scrollTo({top:0, behavior:'smooth'});
  }));

  // loader
  function hideLoader(){ loader.classList.add('hidden'); app.style.display='block'; }
  function showLoader(){ loader.classList.remove('hidden'); app.style.display='none'; }

  // Profile
  function renderBalance(b){ balanceEl.textContent = Number(b||0).toLocaleString('ru-RU') + ' ‚ÇΩ'; window.__USER_BALANCE = Number(b||0); }
  async function loadProfile(){
    try {
      const res = await fetch(`/api/profile_me?uid=${encodeURIComponent(uid)}`);
      if (!res.ok) throw new Error('profile fetch failed');
      const j = await res.json();
      if (j?.ok && j.user) {
        renderBalance(j.user.balance || 0);
      } else renderBalance(0);
    } catch(e){ console.warn('profile err', e); renderBalance(0); }
  }

  // Tasks
  let allTasks = [];
  async function loadTasks() {
    try {
      const res = await fetch('/api/tasks/list');
      if (!res.ok) throw new Error('tasks fetch failed');
      const j = await res.json();
      allTasks = j.tasks || [];
      renderTasks();
    } catch(e) { console.warn('tasks err', e); $('#tasksList').innerHTML = '<div class="small">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–¥–∞–Ω–∏—è</div>'; }
  }
  function renderTasks() {
    const arr = allTasks || [];
    $('#tasksCount').textContent = (arr.length) ? (arr.length + ' —à—Ç') : '0 —à—Ç';
    if (!arr.length) { $('#tasksList').innerHTML = '<div class="small">–ù–µ—Ç –∑–∞–¥–∞–Ω–∏–π</div>'; return; }
    $('#tasksList').innerHTML = '';
    arr.forEach(t => {
      const el = document.createElement('div');
      el.className = 'task';
      el.innerHTML = `<div style="flex:1"><div style="font-weight:800">${escapeHtml(t.title || t.name || '–ó–∞–¥–∞–Ω–∏–µ')}</div><div class="small" style="margin-top:6px">${escapeHtml(t.description || t.desc || '')}</div></div>
                      <div style="text-align:right;margin-left:12px"><div style="font-weight:900">${Number(t.unit_price||t.reward||0).toLocaleString('ru-RU')} ‚ÇΩ</div><div class="small">${(t.qty||1)} —à—Ç</div></div>`;
      $('#tasksList').appendChild(el);
    });
  }

  // helpers
  function escapeHtml(s=''){ if(!s) return ''; return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]); }

  // Create: types
  let types = [];
  let selectedType = null;
  async function loadTypes(){
    try {
      let res = await fetch('/task_types.json');
      if (!res.ok) throw new Error('no local types');
      types = await res.json();
    } catch(e) {
      types = [
        { id:'ya_review', name:'–û—Ç–∑—ã–≤ ‚Äî –Ø–Ω–¥–µ–∫—Å', unit_price:120, max_qty:500 },
        { id:'gmaps_review', name:'–û—Ç–∑—ã–≤ ‚Äî Google', unit_price:65, max_qty:500 },
        { id:'tg_sub', name:'–ü–æ–¥–ø–∏—Å–∫–∞ ‚Äî Telegram', unit_price:10, max_qty:100000 }
      ];
    }
    renderTypes();
  }
  function renderTypes(){
    typesBox.innerHTML = '';
    selectedType = selectedType || types[0] || null;
    types.forEach((t, idx) => {
      const b = document.createElement('button');
      b.className = 'btn ghost small';
      b.style.minWidth = '160px';
      b.innerHTML = `<div style="text-align:left;font-weight:800">${t.name}</div><div class="small" style="text-align:right">${t.unit_price} ‚ÇΩ</div>`;
      b.addEventListener('click', ()=>{ selectedType = t; $$('.btn.ghost.small').forEach(x=>x.classList.remove('active')); b.classList.add('active'); updatePrices(); });
      typesBox.appendChild(b);
      if (idx === 0) b.classList.add('active');
    });
    updatePrices();
  }
  function updatePrices(){
    if (!selectedType) { unitPrice.textContent='–¶–µ–Ω–∞ –∑–∞ —à—Ç: ‚Äî'; totalPrice.textContent='–û–±—â–∞—è —Ü–µ–Ω–∞: ‚Äî'; return; }
    const qty = Number(taskQty.value||1);
    unitPrice.textContent = `–¶–µ–Ω–∞ –∑–∞ —à—Ç: ${selectedType.unit_price} ‚ÇΩ`;
    totalPrice.textContent = `–û–±—â–∞—è —Ü–µ–Ω–∞: ${((selectedType.unit_price||0)*qty).toLocaleString('ru-RU')} ‚ÇΩ`;
  }
  taskQty.addEventListener('input', ()=> setTimeout(updatePrices, 120));

  // URL checker with spinner
  let urlCheckTimer = null;
  taskUrl.addEventListener('input', ()=>{
    clearTimeout(urlCheckTimer);
    urlStatus.textContent = '';
    if (!taskUrl.value.trim()) { urlChecker.style.display = 'none'; return; }
    urlChecker.style.display = 'inline-block';
    urlStatus.textContent = '–ü—Ä–æ–≤–µ—Ä–∫–∞‚Ä¶';
    urlCheckTimer = setTimeout(async ()=>{
      const res = await checkUrl(taskUrl.value.trim());
      urlChecker.style.display = 'none';
      if (res.ok === true) { urlStatus.textContent = '‚úÖ'; urlStatus.style.color = '#28a745'; }
      else if (res.ok === false) { urlStatus.textContent = '‚ùå ' + (res.message || '–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ'); urlStatus.style.color = '#ff4d6d'; }
      else { urlStatus.textContent = '‚ö† ' + (res.message || '–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∞ (CORS)'); urlStatus.style.color = '#d7a700'; }
    }, 600);
  });

  async function checkUrl(url){
    if (!/^https?:\/\//i.test(url)) return { ok:false, message:'–î–æ–ª–∂–Ω–∞ –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å http(s)://' };
    try {
      // try HEAD with no-cors (may be opaque)
      const r = await fetch(url, { method:'HEAD', mode:'no-cors' });
      return { ok:true };
    } catch(e){
      try {
        const controller = new AbortController();
        setTimeout(()=>controller.abort(), 3000);
        const r2 = await fetch(url, { method:'GET', signal: controller.signal });
        return { ok: r2.ok, message: r2.ok ? '' : 'HTTP ' + r2.status };
      } catch(_){ return { ok:false, message:'–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å' }; }
    }
  }

  // Create task
  submitTask.addEventListener('click', async ()=>{
    const url = taskUrl.value.trim();
    const qty = Number(taskQty.value || 0);
    if (!selectedType) return alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø');
    if (!url) return alert('–í–≤–µ–¥–∏—Ç–µ —Å—Å—ã–ª–∫—É');
    if (!qty || qty < 1) return alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ');
    if (selectedType.max_qty && qty > selectedType.max_qty) return alert('–ü—Ä–µ–≤—ã—à–µ–Ω–æ –º–∞–∫—Å. –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ');
    const chk = await checkUrl(url);
    if (chk.ok === false) { if (!confirm('–°—Å—ã–ª–∫–∞ –Ω–µ—Ä–∞–±–æ—á–∞—è. –°–æ–∑–¥–∞—Ç—å –≤—Å—ë —Ä–∞–≤–Ω–æ?')) return; }
    if (chk.ok === null && !confirm('–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Å—ã–ª–∫—É (CORS). –°–æ–∑–¥–∞—Ç—å?')) return;
    try {
      const body = { title: selectedType.name, description: selectedType.name, unit_price: selectedType.unit_price, qty, url, type_id: selectedType.id, owner_uid: uid };
      const r = await fetch('/api/tasks/create', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
      const j = await r.json();
      if (j && j.ok) { createModal.classList.remove('open'); createModal.style.display='none'; await loadTasks(); alert('–ó–∞–¥–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ'); }
      else alert((j && j.errmsg) || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è');
    } catch(e){ console.error(e); alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'); }
  });

  // Topup flows
  let topupState = { current:null, amount:0, manual_code:'' };
  $('#topupBtn').addEventListener('click', ()=>{ topupModal.classList.add('open'); topupModal.style.display='flex'; topupStep.style.display='none'; topupAmount.value = 150; topupMsg.textContent=''; });
  closeTopup.addEventListener('click', ()=>{ topupModal.classList.remove('open'); topupModal.style.display='none'; });

  createTopupBtn.addEventListener('click', async ()=>{
    const amount = Number(topupAmount.value || 0);
    if (!amount || amount < 150) return alert('–ú–∏–Ω. 150 ‚ÇΩ');
    try {
      const res = await fetch('/api/user/topup-link', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ uid, amount }) });
      const j = await res.json();
      if (j && j.ok) {
        topupStep.style.display = 'block';
        qrImg.src = j.qr_url || (j.qr_base64 ? (j.qr_base64.startsWith('data:') ? j.qr_base64 : ('data:image/png;base64,' + j.qr_base64)) : '');
        manualCode.value = j.manual_code || (j.topup && j.topup.manual_code) || '';
        payLink.href = j.pay_link || '#';
        topupState.current = (j.topup && j.topup.id) || j.id || null;
        topupState.amount = amount;
        topupState.manual_code = manualCode.value;
        topupMsg.textContent = '–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∏ –æ–ø–ª–∞—Ç–∏—Ç–µ. –ù–∞–∂–º–∏—Ç–µ "–Ø –æ–ø–ª–∞—Ç–∏–ª" –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏.';
      } else alert((j && j.errmsg) || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è');
    } catch(e){ console.error(e); alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'); }
  });

  confirmPaidBtn.addEventListener('click', async ()=>{
    if (!topupState.current) return alert('–°–æ–∑–¥–∞–π—Ç–µ –∑–∞—è–≤–∫—É');
    try {
      const r = await fetch('/api/user/topup-confirm', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ topup_id: topupState.current, uid }) });
      const j = await r.json();
      if (j && j.ok) { alert('–ó–∞–ø—Ä–æ—Å –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω'); topupModal.classList.remove('open'); topupModal.style.display='none'; loadProfile(); }
      else alert((j && j.errmsg) || '–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏');
    } catch(e){ console.error(e); alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'); }
  });

  // Withdraw
  $('#withdrawBtn').addEventListener('click', ()=>{ withdrawModal.classList.add('open'); withdrawModal.style.display='flex'; withdrawMsg.textContent=''; });
  $('#closeWithdraw').addEventListener('click', ()=>{ withdrawModal.classList.remove('open'); withdrawModal.style.display='none'; });
  $('#cancelWithdraw').addEventListener('click', ()=>{ withdrawModal.classList.remove('open'); withdrawModal.style.display='none'; });

  sendWithdraw.addEventListener('click', async ()=>{
    const amount = Number(wAmount.value || 0);
    const name = (wName.value || '').trim();
    const details = (wDetails.value || '').trim();
    if (!amount || amount < 300) return alert('–ú–∏–Ω. 300 ‚ÇΩ');
    if (amount > (window.__USER_BALANCE || 0)) return alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤');
    if (!name || !details) return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è');
    try {
      const r = await fetch('/api/user/withdraw', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ uid, amount, name, details }) });
      const j = await r.json();
      if (j && j.ok) { withdrawMsg.textContent = '–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞'; withdrawModal.classList.remove('open'); withdrawModal.style.display='none'; loadProfile(); }
      else withdrawMsg.textContent = (j && j.errmsg) || '–û—à–∏–±–∫–∞';
    } catch(e){ withdrawMsg.textContent = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'; }
  });

  // Support
  supportBtn.addEventListener('click', ()=>{
    const tgLink = 'tg://resolve?domain=ReviewCashNews';
    const httpLink = 'https://t.me/ReviewCashNews';
    try { if (tg && tg.openTelegramLink) tg.openTelegramLink(tgLink); else window.open(httpLink, '_blank'); } catch(e){ window.open(httpLink, '_blank'); }
  });

  // FAB / Create modal wiring
  fab.addEventListener('click', ()=> { createModal.classList.add('open'); createModal.style.display='flex'; loadTypes(); });
  closeCreate.addEventListener('click', ()=> { createModal.classList.remove('open'); createModal.style.display='none'; selectedType = null; });
  cancelCreateBtn.addEventListener('click', ()=> { createModal.classList.remove('open'); createModal.style.display='none'; selectedType = null; });

  // initial
  (async function init(){
    try {
      // simultaneous requests
      await Promise.allSettled([ loadProfile(), loadTasks(), loadTypes() ]);
    } catch(e){}
    setTimeout(()=> hideLoader(), 600);
  })();

  // expose for debug
  window.loadProfile = loadProfile;
  window.loadTasks = loadTasks;
  window.loadTypes = loadTypes;
})();
</script>
</body>
</html>
