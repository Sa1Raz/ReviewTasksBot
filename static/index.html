<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ReviewCash — Кабинет (исправлено)</title>

  <!-- Socket.IO клиент (совместимая 4.x версия) -->
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --radius:16px;
      --accent-neon: #00eaff;
      --accent-2: #00c26b;
      --muted: #7aa8b1;
      --panel-light: rgba(255,255,255,0.95);
      --panel-dark: rgba(2,8,12,0.8);
    }
    *{box-sizing:border-box;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#e8f7fb,#ffffff);color:#072126}
    body.dark{background:linear-gradient(180deg,#051018,#000);color:#cfeff6}

    /* Loader overlay */
    .loader{
      position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
      background:linear-gradient(180deg, rgba(0,0,0,0.55), rgba(0,0,0,0.7));
      z-index:9999;flex-direction:column;gap:12px;color:#fff;transition:opacity .25s ease;
    }
    .loader.hidden{opacity:0;pointer-events:none;display:none}
    .brand{font-weight:900;font-size:28px;letter-spacing:1px}
    .loader-sub{opacity:.95}

    .wrap{max-width:980px;margin:18px auto;padding:18px}
    .card{
      background:var(--panel-light);border-radius:var(--radius);padding:14px;margin-bottom:14px;
      box-shadow:0 12px 40px rgba(6,18,28,0.06);border:1px solid rgba(0,0,0,0.04);
    }
    body.dark .card{background:var(--panel-dark);border:1px solid rgba(255,255,255,0.04)}

    .header{display:flex;gap:12px;align-items:center}
    .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(90deg,var(--accent-neon),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:900;color:#001}
    .title{font-weight:900}

    .small{font-size:13px;color:var(--muted)}
    .profile-row{display:flex;gap:12px;align-items:center}
    .avatar{width:84px;height:84px;border-radius:50%;overflow:hidden;border:3px solid var(--accent-neon)}
    .avatar img{width:100%;height:100%;object-fit:cover}
    .balance{font-size:28px;font-weight:900;background:linear-gradient(90deg,var(--accent-neon),var(--accent-2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}

    .row{display:flex;gap:8px;align-items:center}
    .btn{padding:10px 12px;border-radius:12px;border:1px solid rgba(0,0,0,0.06);cursor:pointer;font-weight:800;background:linear-gradient(90deg,var(--accent-neon),var(--accent-2));color:#001}
    .btn.ghost{background:transparent;border:1px solid rgba(0,0,0,0.08);box-shadow:none;color:inherit}
    .btn.small{padding:8px 10px;font-weight:700}
    .fab{position:fixed;right:20px;bottom:110px;width:64px;height:64px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:900;z-index:60}
    .tabbar{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:var(--panel-light);padding:8px;border-radius:999px;display:flex;gap:8px;border:1px solid rgba(0,0,0,0.05)}
    body.dark .tabbar{background:var(--panel-dark)}
    .nav-item{padding:10px 14px;border-radius:999px;cursor:pointer;font-weight:800;color:var(--muted);border:1px solid rgba(0,0,0,0.04)}
    .nav-item.active{background:linear-gradient(90deg,var(--accent-neon),var(--accent-2));color:#001}

    .modal-bg{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:999}
    .modal-bg.open{display:flex}
    .modal{width:94%;max-width:720px;background:var(--panel-light);border-radius:14px;padding:16px;box-shadow:0 18px 50px rgba(0,0,0,0.25)}
    body.dark .modal{background:var(--panel-dark)}

    .type-btn{padding:10px 12px;border-radius:12px;border:1px solid rgba(0,0,0,0.06);cursor:pointer;background:transparent}
    .type-btn.active{background:linear-gradient(90deg,var(--accent-neon),var(--accent-2));color:#001}

    .task-item{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:12px;margin-bottom:8px;background:rgba(0,0,0,0.02)}
    body.dark .task-item{background:rgba(255,255,255,0.02)}

    .url-check{display:inline-block;width:18px;height:18px;border:3px solid var(--accent-neon);border-top:3px solid transparent;border-radius:50%;animation:spin .9s linear infinite;vertical-align:middle;margin-left:8px}
    @keyframes spin{to{transform:rotate(360deg)}}
    .url-status{margin-left:10px;font-weight:800}

    input,textarea,select{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);background:transparent;color:inherit}
    .small-note{font-size:13px;color:var(--muted);margin-top:8px}

    /* nice background neon decoration */
    .bg-decor{
      position:fixed;inset:0;z-index:-1;pointer-events:none;
      background:
        radial-gradient(800px 400px at 10% 10%, rgba(0,234,255,0.06), transparent 12%),
        radial-gradient(600px 300px at 90% 80%, rgba(0,194,107,0.04), transparent 14%);
      mix-blend-mode:screen;
    }
    body.dark .bg-decor{background:
      radial-gradient(700px 350px at 10% 10%, rgba(0,234,255,0.09), transparent 12%),
      radial-gradient(500px 300px at 90% 80%, rgba(0,120,200,0.07), transparent 14%);}
    .sr-only{position:absolute;left:-9999px}
  </style>
</head>
<body>
  <!-- Loader -->
  <div id="loader" class="loader" role="status" aria-live="polite">
    <div class="brand">ReviewCash</div>
    <div class="loader-sub">Загрузка приложения…</div>
  </div>

  <div class="bg-decor" aria-hidden="true"></div>

  <main class="wrap" id="app" style="display:none;">
    <div class="header card">
      <div class="logo">RC</div>
      <div style="flex:1">
        <div class="title">Панель — ReviewCash</div>
        <div class="small">Задания · Пополнение · Вывод</div>
      </div>
      <div class="row">
        <button id="themeToggle" class="btn small ghost" aria-pressed="false">Тема</button>
      </div>
    </div>

    <section id="profileCard" class="card" aria-labelledby="profile-heading">
      <h2 id="profile-heading" class="sr-only">Профиль</h2>
      <div class="profile-row">
        <div class="avatar"><img id="avatar" src="" alt="Аватар пользователя"></div>
        <div style="flex:1">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div id="userName" style="font-weight:900">Загрузка…</div>
              <div id="userHandle" class="small">—</div>
            </div>
            <div style="text-align:right">
              <div class="small">Баланс</div>
              <div class="balance" id="balance">0 ₽</div>
            </div>
          </div>
          <div style="margin-top:12px" class="row">
            <button id="topupBtn" class="btn">Пополнить</button>
            <button id="withdrawBtn" class="btn ghost">Вывести</button>
            <button id="supportBtn" class="btn ghost small">Поддержка</button>
          </div>
        </div>
      </div>
    </section>

    <section id="tasksCard" class="card" aria-labelledby="tasks-heading">
      <h2 id="tasks-heading" style="font-weight:900;font-size:20px;">Задания</h2>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:6px;">
        <div>
          <button id="tabAvailable" class="type-btn active">Доступные</button>
          <button id="tabMy" class="type-btn">Мои</button>
        </div>
        <div class="small-note" id="tasksCount">—</div>
      </div>
      <div id="tasksList" style="margin-top:12px" role="list" aria-live="polite">
        <div class="small">Загрузка…</div>
      </div>
    </section>
  </main>

  <button class="fab" id="fab" aria-label="Создать задание">+</button>

  <nav class="tabbar" role="tablist">
    <button class="nav-item active" data-nav="tasks" aria-selected="true">Задания</button>
    <button class="nav-item" data-nav="profile" aria-selected="false">Профиль</button>
  </nav>

  <!-- TOPUP Modal -->
  <div id="topupModal" class="modal-bg" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="topup-heading">
      <button id="closeTopup" aria-label="Закрыть" style="float:right;background:transparent;border:none;color:var(--muted);font-size:22px;cursor:pointer">×</button>
      <h3 id="topup-heading">Пополнение</h3>
      <div class="small-note">Мин. <b id="minTopup">150</b> ₽</div>
      <div style="display:flex;gap:8px;margin-top:12px">
        <input id="topupAmount" type="number" min="150" value="150" aria-label="Сумма" />
        <button id="createTopupBtn" class="btn">Создать</button>
      </div>
      <div id="topupStep" style="display:none;margin-top:12px">
        <div class="small-note">Ссылка / QR (скопируйте комментарий)</div>
        <img id="qrImg" style="display:block;margin:12px auto;max-width:260px;border-radius:10px" src="" alt="QR"/>
        <input id="manualCode" readonly aria-label="Ручной код"/>
        <div style="display:flex;gap:8px;margin-top:10px">
          <a id="payLink" class="btn" target="_blank" rel="noopener noreferrer">Открыть банк</a>
          <button id="confirmPaidBtn" class="btn ghost">Я оплатил</button>
        </div>
        <div id="topupMsg" class="small-note" aria-live="polite"></div>
      </div>
    </div>
  </div>

  <!-- WITHDRAW Modal -->
  <div id="withdrawModal" class="modal-bg" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <button id="closeWithdraw" aria-label="Закрыть" style="float:right;background:transparent;border:none;color:var(--muted);font-size:22px;cursor:pointer">×</button>
      <h3>Вывести</h3>
      <div class="small-note">Мин. 300 ₽</div>
      <input id="wAmount" type="number" placeholder="Сумма" />
      <input id="wName" type="text" placeholder="ФИО / ник" />
      <input id="wDetails" type="text" placeholder="Реквизиты (карта / СБП)" />
      <div style="display:flex;gap:8px;margin-top:10px">
        <button id="sendWithdraw" class="btn">Отправить</button>
        <button id="cancelWithdraw" class="btn ghost">Отмена</button>
      </div>
      <div id="withdrawMsg" class="small-note"></div>
    </div>
  </div>

  <!-- CREATE TASK Modal (красивее) -->
  <div id="createModal" class="modal-bg" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="create-heading">
      <button id="closeCreate" aria-label="Закрыть" style="float:right;background:transparent;border:none;color:var(--muted);font-size:22px;cursor:pointer">×</button>
      <h3 id="create-heading">Создать задание</h3>
      <div class="small-note">Выберите тип — цена будет проставлена автоматически</div>
      <div id="typesBox" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px"></div>

      <div style="margin-top:12px;position:relative">
        <input id="taskUrl" placeholder="Ссылка (http:// или https://)" aria-label="Ссылка" />
        <span id="urlChecker" style="display:none" class="url-check" aria-hidden="true"></span>
        <span id="urlStatus" class="url-status" aria-live="polite"></span>
      </div>

      <div style="display:flex;gap:8px;align-items:center;margin-top:10px">
        <input id="taskQty" type="number" value="1" min="1" style="width:140px" />
        <div id="unitPrice" class="small-note">Цена за шт: —</div>
        <div id="totalPrice" class="small-note" style="margin-left:auto;font-weight:900">Общая: —</div>
      </div>

      <div style="display:flex;gap:8px;margin-top:12px">
        <button id="submitTask" class="btn">Создать</button>
        <button id="cancelCreate" class="btn ghost">Отмена</button>
      </div>
      <div id="createMsg" class="small-note" style="margin-top:8px"></div>
    </div>
  </div>

  <script>
  (function(){
    // utilities
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const loader = $('#loader');
    const app = $('#app');

    // UI elements
    const avatar = $('#avatar'), userName = $('#userName'), userHandle = $('#userHandle'), balanceEl = $('#balance');
    const topupBtn = $('#topupBtn'), withdrawBtn = $('#withdrawBtn'), supportBtn = $('#supportBtn'), themeToggle = $('#themeToggle');
    const fab = $('#fab'), navItems = $$('.nav-item');
    const tasksList = $('#tasksList'), tasksCount = $('#tasksCount'), tabAvailable = $('#tabAvailable'), tabMy = $('#tabMy');

    const topupModal = $('#topupModal'), closeTopup = $('#closeTopup'), topupAmount = $('#topupAmount'), createTopupBtn = $('#createTopupBtn');
    const topupStep = $('#topupStep'), qrImg = $('#qrImg'), manualCode = $('#manualCode'), payLink = $('#payLink'), confirmPaidBtn = $('#confirmPaidBtn'), topupMsg = $('#topupMsg');
    const withdrawModal = $('#withdrawModal'), closeWithdraw = $('#closeWithdraw'), cancelWithdraw = $('#cancelWithdraw'), sendWithdraw = $('#sendWithdraw'), withdrawMsg = $('#withdrawMsg');
    const createModal = $('#createModal'), closeCreate = $('#closeCreate'), cancelCreate = $('#cancelCreate'), typesBox = $('#typesBox');
    const taskUrl = $('#taskUrl'), urlChecker = $('#urlChecker'), urlStatus = $('#urlStatus'), taskQty = $('#taskQty'), unitPrice = $('#unitPrice'), totalPrice = $('#totalPrice'), submitTask = $('#submitTask'), createMsg = $('#createMsg');

    // user (telegram or fallback)
    const tg = window.Telegram?.WebApp || null;
    try { tg?.ready?.(); tg?.expand?.(); } catch(e){}
    const tgUser = tg?.initDataUnsafe?.user || {};
    const uid = tgUser.id ? String(tgUser.id) : (new URLSearchParams(location.search)).get('uid') || 'guest_' + Math.floor(Math.random()*99999);
    avatar.src = tgUser.photo_url || `https://api.dicebear.com/8.x/thumbs/svg?seed=${encodeURIComponent(uid)}`;
    userName.textContent = (tgUser.first_name || '') + (tgUser.last_name ? ' ' + tgUser.last_name : 'Пользователь');
    userHandle.textContent = tgUser.username ? ('@' + tgUser.username) : `ID: ${uid}`;

    // theme
    function applyThemeFromStorage(){ const t=localStorage.getItem('theme')||'dark'; document.body.classList.toggle('dark', t==='dark'); themeToggle.setAttribute('aria-pressed', t==='dark'); }
    applyThemeFromStorage();
    themeToggle.addEventListener('click', ()=>{ const isDark = document.body.classList.toggle('dark'); localStorage.setItem('theme', isDark ? 'dark' : 'light'); themeToggle.setAttribute('aria-pressed', isDark); });

    // socket - graceful init
    let socket = null;
    try {
      socket = io({transports:['websocket'], upgrade:false});
      socket.on('connect', ()=> console.log('Socket connected', socket.id));
      socket.on('connect_error', err => console.warn('Socket error', err));
      socket.on('task_update', () => loadTasks());
      socket.on('user_update', d => { if (d && String(d.user_id) === String(uid) && typeof d.balance !== 'undefined') renderBalance(d.balance); });
    } catch(e){ console.warn('Socket init failed', e); }

    // helpers
    function fmtRub(n){ return Number(n||0).toLocaleString('ru-RU') + ' ₽'; }
    function renderBalance(b){ balanceEl.textContent = fmtRub(b); window.__USER_BALANCE = Number(b||0); }

    // Fetch wrappers with timeout to avoid hangs
    async function fetchWithTimeout(url, opts = {}, timeout = 7000){
      const controller = new AbortController();
      const id = setTimeout(()=> controller.abort(), timeout);
      try {
        const r = await fetch(url, Object.assign({}, opts, {signal: controller.signal}));
        clearTimeout(id);
        return r;
      } catch (e) {
        clearTimeout(id);
        throw e;
      }
    }

    // loadProfile
    async function loadProfile(){
      try {
        const res = await fetchWithTimeout(`/api/profile_me?uid=${encodeURIComponent(uid)}`, {}, 6000).catch(()=>null);
        if (!res || !res.ok) { renderBalance(0); return; }
        const j = await res.json().catch(()=>null);
        if (j && j.user) {
          renderBalance(j.user.balance || 0);
          userName.textContent = j.user.name || userName.textContent;
          userHandle.textContent = j.user.username ? ('@'+j.user.username) : (j.user.id ? `ID: ${j.user.id}` : userHandle.textContent);
        } else renderBalance(0);
      } catch(e){
        console.warn('loadProfile error', e);
        renderBalance(0);
      }
    }

    // tasks
    let allTasks = [];
    let currentTab = 'available';
    tabAvailable.addEventListener('click', () => { currentTab = 'available'; tabAvailable.classList.add('active'); tabMy.classList.remove('active'); renderTasks(); });
    tabMy.addEventListener('click', () => { currentTab = 'my'; tabMy.classList.add('active'); tabAvailable.classList.remove('active'); renderTasks(); });

    async function loadTasks(){
      try {
        let res = await fetchWithTimeout('/api/tasks/list', {}, 7000).catch(()=>null);
        if (!res || !res.ok) { tasksList.innerHTML = '<div class="small-note">Не удалось загрузить задания</div>'; allTasks=[]; return; }
        const j = await res.json().catch(()=>null);
        allTasks = j?.tasks || j || [];
        renderTasks();
      } catch(e){
        console.warn('loadTasks err', e);
        tasksList.innerHTML = '<div class="small-note">Не удалось загрузить задания</div>';
        allTasks = [];
      }
    }

    function renderTasks(){
      let arr = Array.isArray(allTasks) ? allTasks.slice() : [];
      if (currentTab === 'my') arr = arr.filter(t => String(t.owner_uid) === String(uid));
      else arr = arr.filter(t => String(t.owner_uid) !== String(uid));
      tasksCount.textContent = arr.length + ' шт';
      if (!arr.length){ tasksList.innerHTML = '<div class="small-note">Нет заданий</div>'; return; }
      tasksList.innerHTML = '';
      arr.forEach(t => {
        const unit = Number(t.unit_price || t.reward || 0);
        const qty = Number(t.qty || 1);
        const completed = Number(t.completed_qty || 0);
        const progress = Math.round((completed/Math.max(1, qty))*100);
        const el = document.createElement('div');
        el.className = 'task-item';
        el.innerHTML = `
          <div style="flex:1">
            <div style="font-weight:800">${escapeHtml(t.title || t.name || 'Задание')}</div>
            <div class="small-note" style="margin-top:6px">${escapeHtml(t.description || t.desc || '')}</div>
            ${ currentTab === 'my' ? `<div class="small-note" style="margin-top:8px">Выполнено: ${completed}/${qty}</div>` : '' }
          </div>
          <div style="text-align:right;margin-left:12px">
            <div style="font-weight:900">${fmtRub(unit)}</div>
            <div class="small-note">${qty} шт</div>
          </div>
        `;
        tasksList.appendChild(el);
      });
    }

    function escapeHtml(s=''){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    // types & create task
    let types = [], selectedType = null;
    async function loadTypes(){
      try {
        let res = await fetchWithTimeout('/api/task_types', {}, 5000).catch(()=>null);
        if (!res || !res.ok) res = await fetchWithTimeout('/task_types.json', {}, 5000).catch(()=>null);
        const json = res ? await res.json().catch(()=>null) : null;
        types = Array.isArray(json) ? json : [
          {id:'ya_review', name:'Отзыв — Яндекс', unit_price:120, max_qty:500},
          {id:'gmaps_review', name:'Отзыв — Google', unit_price:65, max_qty:500},
          {id:'tg_sub', name:'Подписка — Telegram', unit_price:10, max_qty:100000}
        ];
      } catch(e) {
        console.warn('loadTypes err', e);
        types = [
          {id:'ya_review', name:'Отзыв — Яндекс', unit_price:120, max_qty:500},
          {id:'gmaps_review', name:'Отзыв — Google', unit_price:65, max_qty:500},
          {id:'tg_sub', name:'Подписка — Telegram', unit_price:10, max_qty:100000}
        ];
      }
      renderTypes();
    }

    function renderTypes(){
      typesBox.innerHTML = '';
      types.forEach((t, i) => {
        const btn = document.createElement('button');
        btn.className = 'type-btn';
        btn.type = 'button';
        btn.innerHTML = `<div style="display:flex;justify-content:space-between;min-width:200px"><div style="font-weight:700">${escapeHtml(t.name)}</div><div style="font-weight:900">${Number(t.unit_price)} ₽</div></div>`;
        btn.addEventListener('click', ()=> {
          selectedType = t;
          $$('.type-btn').forEach(x=>x.classList.remove('active'));
          btn.classList.add('active');
          updatePrices();
        });
        typesBox.appendChild(btn);
        if (i===0 && !selectedType) { selectedType = t; btn.classList.add('active'); }
      });
      updatePrices();
    }

    function updatePrices(){
      if (!selectedType) { unitPrice.textContent = 'Цена за шт: —'; totalPrice.textContent = 'Общая: —'; return; }
      const qty = Number(taskQty.value || 1);
      unitPrice.textContent = `Цена за шт: ${selectedType.unit_price} ₽`;
      totalPrice.textContent = `Общая: ${(selectedType.unit_price * qty).toLocaleString('ru-RU')} ₽`;
    }

    taskQty.addEventListener('input', ()=> setTimeout(updatePrices, 120));

    // URL checker with loading animation and result (debounced)
    let urlCheckTimer = null;
    taskUrl.addEventListener('input', ()=> {
      clearTimeout(urlCheckTimer);
      urlStatus.textContent = '';
      const v = taskUrl.value.trim();
      if (!v) { urlChecker.style.display = 'none'; return; }
      urlChecker.style.display = 'inline-block'; urlStatus.textContent = 'Проверка…';
      urlCheckTimer = setTimeout(async ()=> {
        try {
          const r = await checkUrl(v);
          urlChecker.style.display = 'none';
          if (r.ok === true) { urlStatus.textContent = '✅'; urlStatus.style.color = '#28a745'; }
          else if (r.ok === false) { urlStatus.textContent = '❌ '+(r.message||'Недоступно'); urlStatus.style.color = '#ff4d6d'; }
          else { urlStatus.textContent = '⚠ '+(r.message||'CORS'); urlStatus.style.color = '#d7a700'; }
        } catch(e) {
          urlChecker.style.display = 'none';
          urlStatus.textContent = '❌ Ошибка';
          urlStatus.style.color = '#ff4d6d';
        }
      }, 600);
    });

    async function checkUrl(url){
      if (!/^https?:\/\//i.test(url)) return {ok:false, message:'Должна начинаться с http:// или https://'};
      // try HEAD with timeout
      try {
        const r = await fetchWithTimeout(url, {method:'HEAD', mode:'no-cors'}, 4000).catch(()=>null);
        if (r) return {ok:true};
      } catch(e){}
      // fallback GET short
      try {
        const r2 = await fetchWithTimeout(url, {method:'GET'}, 4000).catch(()=>null);
        if (r2) return {ok: r2.ok};
      } catch(e){}
      // can't validate (CORS) vs unreachable
      return {ok:null, message:'Проверка ограничена (CORS) или недоступна'};
    }

    // creating task
    submitTask.addEventListener('click', async ()=> {
      const url = taskUrl.value.trim();
      const qty = Number(taskQty.value || 0);
      if (!selectedType) return alert('Выберите тип задания');
      if (!url) return alert('Введите ссылку');
      if (!qty || qty < 1) return alert('Введите корректное количество');
      if (selectedType.max_qty && qty > selectedType.max_qty) return alert('Превышено макс. кол-во для этого типа');
      const chk = await checkUrl(url);
      if (chk.ok === false) return alert('Ссылка нерабочая: ' + (chk.message || ''));
      if (chk.ok === null && !confirm('Невозможно автоматически проверить ссылку (CORS). Создать задание всё равно?')) return;
      try {
        const body = { title: selectedType.name, description: selectedType.name, unit_price: selectedType.unit_price, qty, url, type_id: selectedType.id, owner_uid: uid };
        const r = await fetch('/api/tasks/create', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
        const j = await r.json().catch(()=>null);
        if (j && j.ok) {
          closeCreateModal();
          await loadTasks();
          alert('Задание создано');
        } else {
          alert((j && j.errmsg) || 'Ошибка создания');
        }
      } catch(e){ console.error(e); alert('Ошибка сети'); }
    });

    // modals: open/close helpers
    function openModal(el){ el.classList.add('open'); el.style.display = 'flex'; el.setAttribute('aria-hidden','false'); }
    function closeModal(el){ el.classList.remove('open'); el.style.display = 'none'; el.setAttribute('aria-hidden','true'); }

    // create modal wiring
    fab.addEventListener('click', ()=> { openCreateModal(); });
    closeCreate.addEventListener('click', ()=> closeCreateModal());
    cancelCreate.addEventListener('click', ()=> closeCreateModal());

    function openCreateModal(){
      createMsg.textContent = '';
      taskUrl.value = '';
      taskQty.value = 1;
      urlChecker.style.display = 'none';
      urlStatus.textContent = '';
      openModal(createModal);
      loadTypes();
    }
    function closeCreateModal(){
      selectedType = null;
      closeModal(createModal);
    }

    // topup wiring
    const minTopup = 150; $('#minTopup')?.textContent && ($('#minTopup').textContent = minTopup);
    topupBtn.addEventListener('click', ()=> {
      topupAmount.value = minTopup;
      topupStep.style.display = 'none';
      topupMsg.textContent = '';
      openModal(topupModal);
    });
    closeTopup.addEventListener('click', ()=> closeModal(topupModal));
    createTopupBtn.addEventListener('click', async ()=> {
      const amount = Number(topupAmount.value || 0);
      if (!amount || amount < minTopup) return alert('Мин. ' + minTopup + ' ₽');
      try {
        const r = await fetch('/api/user/topup-link', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ uid, amount }) });
        const j = await r.json().catch(()=>null);
        if (j && j.ok) {
          topupStep.style.display = 'block';
          manualCode.value = j.manual_code || (j.topup && j.topup.manual_code) || '';
          if (j.qr_base64) qrImg.src = j.qr_base64.startsWith('data:') ? j.qr_base64 : 'data:image/png;base64,' + j.qr_base64;
          else if (j.qr_url) qrImg.src = j.qr_url;
          else qrImg.src = '';
          payLink.href = j.pay_link || (j.topup && j.topup.pay_link) || '#';
          topupMsg.textContent = 'Скопируйте комментарий и оплатите. Затем нажмите "Я оплатил".';
          // save state if needed
          window.__LAST_TOPUP = { id: (j.topup && j.topup.id) || j.id || null, amount, manual: manualCode.value };
        } else alert((j && j.errmsg) || 'Ошибка создания топапа');
      } catch(e){ console.error(e); alert('Ошибка сети'); }
    });

    confirmPaidBtn.addEventListener('click', async ()=> {
      const st = window.__LAST_TOPUP;
      if (!st || !st.id) return alert('Создайте заявку сначала');
      try {
        const r = await fetch('/api/user/topup-confirm', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ topup_id: st.id, uid }) });
        const j = await r.json().catch(()=>null);
        if (j && j.ok) {
          alert('Запрос отправлен на проверку');
          closeModal(topupModal);
          loadProfile();
        } else alert((j && j.errmsg) || 'Ошибка проверки');
      } catch(e){ console.error(e); alert('Ошибка сети'); }
    });

    // withdraw wiring
    withdrawBtn.addEventListener('click', ()=> { openModal(withdrawModal); withdrawMsg.textContent = ''; });
    closeWithdraw.addEventListener('click', ()=> closeModal(withdrawModal));
    cancelWithdraw.addEventListener('click', ()=> closeModal(withdrawModal));
    sendWithdraw.addEventListener('click', async ()=> {
      const amount = Number($('#wAmount').value || 0);
      const name = ($('#wName').value || '').trim();
      const details = ($('#wDetails').value || '').trim();
      if (!amount || amount < 300) return alert('Мин. 300 ₽');
      if (amount > (window.__USER_BALANCE || 0)) return alert('Недостаточно средств');
      if (!name || !details) return alert('Заполните поля');
      try {
        const r = await fetch('/api/user/withdraw', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ uid, amount, name, details }) });
        const j = await r.json().catch(()=>null);
        if (j && j.ok) {
          alert('Заявка отправлена');
          closeModal(withdrawModal);
          loadProfile();
        } else withdrawMsg.textContent = (j && j.errmsg) || 'Ошибка';
      } catch(e){ console.error(e); withdrawMsg.textContent = 'Ошибка сети'; }
    });

    // support
    supportBtn.addEventListener('click', ()=> {
      const tgLink = 'tg://resolve?domain=ReviewCashNews';
      const webLink = 'https://t.me/ReviewCashNews';
      try { if (tg && tg.openTelegramLink) { tg.openTelegramLink(tgLink); return; } } catch(e){}
      window.open(webLink, '_blank');
    });

    // bottom nav behaviour
    navItems.forEach(n => n.addEventListener('click', ()=> {
      navItems.forEach(x=>x.classList.remove('active'));
      n.classList.add('active');
      if (n.dataset.nav === 'profile') window.scrollTo({top:0,behavior:'smooth'});
      else window.scrollTo({top:document.querySelector('#tasksCard').offsetTop - 8,behavior:'smooth'});
    }));

    // Safety: final hide loader (race with timeout)
    function showLoader(){ loader.classList.remove('hidden'); app.style.display = 'none'; loader.setAttribute('aria-hidden','false'); }
    function hideLoader(){ loader.classList.add('hidden'); app.style.display = 'block'; loader.setAttribute('aria-hidden','true'); }

    // Init orchestrator with robust timeout fallback
    async function init(){
      showLoader();
      // allow DOM paint
      await new Promise(r => setTimeout(r, 70));
      const tasks = [
        loadProfile(),
        loadTasks(),
        loadTypes()
      ].map(p => (async ()=> { try { await p; } catch(e){ console.warn('init subtask failed', e); } })());

      // Wait either all tasks done or fallback timeout (10s)
      await Promise.race([
        Promise.allSettled(tasks),
        new Promise(r => setTimeout(r, 10000))
      ]);

      // ensure app visible even if something hung
      try { renderTasks(); } catch(e){}
      // small delay for smoothness
      setTimeout(()=> hideLoader(), 160);
    }

    // start
    document.addEventListener('DOMContentLoaded', ()=> { init().catch(e=>{ console.error('init error', e); hideLoader(); }); });

    // expose for debug
    window.loadProfile = loadProfile;
    window.loadTasks = loadTasks;
    window.loadTypes = loadTypes;
    window.openCreate = openCreateModal;

  })();
  </script>
</body>
</html>
