<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ReviewCash — Админка</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto;background:#f6fbff;color:#052126;margin:0;padding:18px}
    .wrap{max-width:1100px;margin:0 auto}
    h1{font-weight:900}
    .row{display:flex;gap:12px;align-items:center}
    .card{background:white;padding:12px;border-radius:12px;box-shadow:0 12px 40px rgba(0,0,0,0.06);margin-bottom:14px;border:1px solid rgba(0,0,0,0.04)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid rgba(0,0,0,0.06);text-align:left}
    .btn{padding:8px 10px;border-radius:8px;background:linear-gradient(90deg,#00eaff,#0088ff);border:none;font-weight:700;cursor:pointer;color:#001}
    .btn.ghost{background:transparent;border:1px solid rgba(0,0,0,0.06)}
    .small{font-size:13px;color:#6f8b95}
    .status-pending{color:#d79b00}
    .status-done{color:#28a745}
    .modal-bg{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.55);z-index:999}
    .modal{background:white;padding:16px;border-radius:12px;max-width:720px;width:94%}
    .filter-row{display:flex;gap:8px;align-items:center;margin-bottom:12px}
    .search{padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);width:320px}
  </style>
</head>
<body>
  <div class="wrap">
    <header style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px">
      <h1>Админка — ReviewCash</h1>
      <div class="row">
        <button id="refreshBtn" class="btn ghost">Обновить</button>
        <button id="logoutBtn" class="btn">Выйти</button>
      </div>
    </header>

    <section class="card">
      <div class="filter-row">
        <input id="search" class="search" placeholder="Поиск по UID / Комментарию" />
        <select id="filterStatus">
          <option value="">Все статусы</option>
          <option value="pending">Ожидают</option>
          <option value="done">Завершено</option>
        </select>
        <button id="loadTopups" class="btn">Загрузить пополнения</button>
      </div>

      <div id="topupsList" style="margin-top:6px">
        <div class="small">Нажмите "Загрузить пополнения"</div>
      </div>
    </section>

    <section class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:900">Заявки на вывод</div>
        <button id="loadWithdraws" class="btn">Загрузить</button>
      </div>
      <div id="withdrawsList" style="margin-top:8px">
        <div class="small">Нажмите "Загрузить"</div>
      </div>
    </section>

    <section class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:900">Типы заданий (task_types)</div>
        <button id="loadTypes" class="btn">Загрузить</button>
      </div>
      <pre id="typesData" class="small" style="margin-top:8px">—</pre>
    </section>
  </div>

  <!-- Approve modal -->
  <div id="approveModal" class="modal-bg" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <h3 style="margin:0 0 8px">Подтвердить пополнение</h3>
      <div id="approveBody"></div>
      <div style="display:flex;gap:8px;margin-top:10px">
        <button id="approveBtn" class="btn">Подтвердить</button>
        <button id="rejectBtn" class="btn ghost">Отклонить</button>
        <button id="closeApprove" class="btn ghost" style="margin-left:auto">Закрыть</button>
      </div>
    </div>
  </div>

  <script>
    // Admin JS
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const topupsList = $('#topupsList'), loadTopups = $('#loadTopups'), search = $('#search'), filterStatus = $('#filterStatus');
    const withdrawsList = $('#withdrawsList'), loadWithdraws = $('#loadWithdraws');
    const typesData = $('#typesData'), loadTypes = $('#loadTypes');
    const approveModal = $('#approveModal'), approveBody = $('#approveBody'), approveBtn = $('#approveBtn'), rejectBtn = $('#rejectBtn'), closeApprove = $('#closeApprove');

    let loadedTopups = [], selectedTopup = null;

    async function apiGet(url){ const r = await fetch(url); if(!r.ok) throw new Error('status '+r.status); return await r.json(); }
    async function apiPost(url, body){ const r = await fetch(url, {method:'POST',headers:{'Content-Type':'application/json'},body: JSON.stringify(body)}); return await r.json(); }

    loadTopups.addEventListener('click', async ()=> {
      topupsList.innerHTML = '<div class="small">Загрузка…</div>';
      try {
        const j = await apiGet('/api/admin/topups');
        loadedTopups = Array.isArray(j) ? j : (j.topups || j.data || []);
        renderTopups(loadedTopups);
      } catch (e) { topupsList.innerHTML = '<div class="small">Ошибка загрузки</div>'; console.error(e); }
    });

    function renderTopups(arr) {
      if (!arr.length) { topupsList.innerHTML = '<div class="small">Нет пополнений</div>'; return; }
      const rows = arr.map(t => {
        return `<div style="padding:10px;border-radius:8px;border:1px solid rgba(0,0,0,0.04);margin-bottom:8px;display:flex;justify-content:space-between;align-items:center">
          <div>
            <div style="font-weight:800">UID: ${escapeHtml(String(t.uid||t.user_id||''))} — ${escapeHtml(String(t.amount||t.sum||''))} ₽</div>
            <div class="small">${escapeHtml(t.comment||t.manual_code||'')}</div>
            <div class="small ${t.status==='done'?'status-done':(t.status==='pending'?'status-pending':'')}">Статус: ${t.status || '—'}</div>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <button class="btn" data-id="${escapeHtml(String(t.id||t._id||t.topup_id||''))}" data-uid="${escapeHtml(String(t.uid||t.user_id||''))}" data-amount="${escapeHtml(String(t.amount||t.sum||''))}">Открыть</button>
          </div>
        </div>`;
      }).join('');
      topupsList.innerHTML = rows;
      // wire open buttons
      topupsList.querySelectorAll('button[data-id]').forEach(b => b.addEventListener('click', (e) => {
        const id = b.dataset.id, uid = b.dataset.uid, amount = b.dataset.amount;
        selectedTopup = { id, uid, amount };
        approveBody.innerHTML = `<div>Топ-ап: <b>${escapeHtml(amount)} ₽</b></div><div>UID: <b>${escapeHtml(uid)}</b></div><div style="margin-top:8px">ID заявки: ${escapeHtml(id)}</div>`;
        approveModal.style.display = 'flex';
      }));
    }

    closeApprove.addEventListener('click', ()=> approveModal.style.display = 'none');
    approveBtn.addEventListener('click', async ()=> {
      if (!selectedTopup) return;
      try {
        const j = await apiPost(`/api/admin/topups/approve`, { topup_id: selectedTopup.id });
        alert((j && j.ok) ? 'Подтверждено' : (j.errmsg || 'Ошибка'));
        approveModal.style.display = 'none';
        loadTopups.click();
      } catch (e) { console.error(e); alert('Ошибка подтверждения'); }
    });
    rejectBtn.addEventListener('click', async ()=> {
      if (!selectedTopup) return;
      try {
        const j = await apiPost(`/api/admin/topups/reject`, { topup_id: selectedTopup.id });
        alert((j && j.ok) ? 'Отклонено' : (j.errmsg || 'Ошибка'));
        approveModal.style.display = 'none';
        loadTopups.click();
      } catch (e) { console.error(e); alert('Ошибка'); }
    });

    // Withdraws
    loadWithdraws.addEventListener('click', async ()=> {
      withdrawsList.innerHTML = '<div class="small">Загрузка…</div>';
      try {
        const j = await apiGet('/api/admin/withdraws');
        const arr = Array.isArray(j) ? j : (j.withdraws || j.data || []);
        if (!arr.length) { withdrawsList.innerHTML = '<div class="small">Нет заявок</div>'; return; }
        withdrawsList.innerHTML = arr.map(w => {
          return `<div style="padding:10px;border-radius:8px;border:1px solid rgba(0,0,0,0.04);margin-bottom:8px;display:flex;justify-content:space-between;align-items:center">
            <div><div style="font-weight:800">${escapeHtml(String(w.name||''))} — ${escapeHtml(String(w.amount||''))} ₽</div><div class="small">${escapeHtml(w.details||'')}</div><div class="small">UID: ${escapeHtml(String(w.uid||''))}</div></div>
            <div style="display:flex;gap:8px">
              <button class="btn" data-id="${escapeHtml(String(w.id||w._id||''))}" data-uid="${escapeHtml(String(w.uid||''))}" data-amount="${escapeHtml(String(w.amount||''))}">Отметить как выполнено</button>
            </div>
          </div>`;
        }).join('');
        withdrawsList.querySelectorAll('button[data-id]').forEach(b => b.addEventListener('click', async ()=> {
          const id = b.dataset.id;
          try {
            const j = await apiPost('/api/admin/withdraws/complete', { withdraw_id: id });
            alert((j && j.ok) ? 'Отмечено' : (j && j.errmsg) || 'Ошибка');
            loadWithdraws.click();
          } catch (e) { console.error(e); alert('Ошибка'); }
        }));
      } catch (e) { withdrawsList.innerHTML = '<div class="small">Ошибка загрузки</div>'; console.error(e); }
    });

    // Types
    loadTypes.addEventListener('click', async ()=> {
      typesData.textContent = 'Загрузка…';
      try {
        const j = await apiGet('/task_types.json');
        typesData.textContent = JSON.stringify(j, null, 2);
      } catch (e) { console.error(e); typesData.textContent = 'Ошибка загрузки'; }
    });

    // misc
    $('#refreshBtn').addEventListener('click', ()=> { loadTopups.click(); loadWithdraws.click(); loadTypes.click(); });
    $('#logoutBtn').addEventListener('click', ()=> { alert('Выход (реализовать на бэкенде)'); });

    function escapeHtml(s=''){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m])); }
  </script>
</body>
</html>
