<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Admin — Входящие переводы</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
<style>
  body{font-family:Inter,Arial;background:#061426;color:#eaf7fb;margin:0;padding:18px}
  .container{max-width:1200px;margin:0 auto}
  .panel{background:linear-gradient(180deg,#071a2b,#041324);padding:14px;border-radius:10px;margin-bottom:12px}
  input[type="text"]{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,0.04);font-size:13px}
  .muted{color:#9fb6c6}
  .btn{padding:8px 10px;border-radius:8px;border:none;background:linear-gradient(90deg,#00c7d7,#00e08a);color:#012226;font-weight:700;cursor:pointer}
  .btn-ghost{padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
  .warn{color:#ffb4b4;font-weight:700}
  .status-pending{color:#ffd36a}
  .status-paid{color:#8ef2c9}
  .manual-unverified{background:rgba(255,80,80,0.06);padding:4px;border-radius:6px}
  .manual-verified{background:rgba(0,240,200,0.06);padding:4px;border-radius:6px}
  .actions > button{margin-right:6px}
</style>
</head>
<body>
  <div class="container">
    <div class="panel">
      <h2>Входящие переводы</h2>
      <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
        <input id="filterComment" type="text" placeholder="Фильтр по комментарию или коду" style="flex:1"/>
        <select id="filterStatus">
          <option value="">Все статусы</option>
          <option value="pending">pending</option>
          <option value="paid">paid</option>
          <option value="refunded">refunded</option>
        </select>
        <label style="display:flex;align-items:center"><input id="manualOnly" type="checkbox" style="margin-right:6px"/> Только ручные (неподтверждённые)</label>
        <button id="btnFilter" class="btn-ghost">Применить</button>
        <button id="btnRefresh" class="btn">Обновить</button>
      </div>
    </div>

    <div class="panel" id="incomingPanel">
      <table id="incomingTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Пользователь</th>
            <th>Сумма</th>
            <th>Код</th>
            <th>Комментарий / webhook</th>
            <th>Статус</th>
            <th>Действия</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div id="noResults" class="muted" style="display:none;margin-top:8px">Нет записей</div>
    </div>
  </div>

<script>
const token = new URLSearchParams(location.search).get('token') || '';
if(!token){ alert('Admin token не передан в URL. Откройте /mainadmin через бота (/mainadmin)'); }

function apiGet(path){
  return fetch(path + (path.includes('?') ? '&' : '?') + 'token=' + encodeURIComponent(token)).then(r=>r.json());
}
function apiPost(path, body){
  return fetch(path + '?token=' + encodeURIComponent(token), { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body||{}) }).then(r=>r.json());
}

async function loadIncoming(){
  const status = document.getElementById('filterStatus').value;
  const comment = document.getElementById('filterComment').value.trim();
  const manualOnly = document.getElementById('manualOnly').checked;
  const qp = [];
  if(status) qp.push('status='+encodeURIComponent(status));
  if(comment) qp.push('comment='+encodeURIComponent(comment));
  if(manualOnly) qp.push('manual_only=1');
  const url = '/api/admin/incoming_topups' + (qp.length ? '?'+qp.join('&') : '');
  try{
    const j = await apiGet(url);
    if(!j.ok){ console.error(j); return; }
    const items = j.items || [];
    const tbody = document.querySelector('#incomingTable tbody');
    tbody.innerHTML = '';
    if(items.length === 0){
      document.getElementById('noResults').style.display = 'block';
      return;
    } else document.getElementById('noResults').style.display = 'none';
    items.forEach(t=>{
      const tr = document.createElement('tr');
      const user = (t.user && t.user.id) ? t.user.id : '—';
      const manual_code = t.manual_code || '';
      const comment = (t.payment && t.payment.comment) ? t.payment.comment : (t.payment && t.payment.last_webhook ? JSON.stringify(t.payment.last_webhook) : '');
      const manualVerified = (t.payment && t.payment.manual_code_verified) === true;
      const status = t.status || 'pending';
      tr.innerHTML = `
        <td>${t.id}</td>
        <td>${user}</td>
        <td>${t.amount} ₽</td>
        <td>${manual_code ? '<span class="'+(manualVerified?'manual-verified':'manual-unverified')+'">'+manual_code+'</span>' : ''}</td>
        <td style="max-width:360px;white-space:pre-wrap;">${comment || ''}</td>
        <td class="status-${status}">${status}</td>
        <td class="actions"></td>
      `;
      const actionsCell = tr.querySelector('.actions');
      if(t.status !== 'paid'){
        const verifyBtn = document.createElement('button'); verifyBtn.className='btn-ghost'; verifyBtn.textContent='Отметить оплачен';
        verifyBtn.onclick = async ()=> {
          if(!confirm('Отметить как оплачено и зачислить баланс пользователю?')) return;
          const res = await apiPost(`/api/admin/incoming_topups/${encodeURIComponent(t.id)}/mark_paid`, {});
          if(res.ok){ alert('Отмечено как оплачено'); loadIncoming(); } else alert('Ошибка: '+(res.reason||''));
        };
        actionsCell.appendChild(verifyBtn);
        const forceBtn = document.createElement('button'); forceBtn.className='btn-ghost'; forceBtn.textContent='Принудительно сопоставить';
        forceBtn.onclick = async ()=> {
          if(!confirm('Принудительно сопоставить и пометить как оплачено?')) return;
          const res = await apiPost(`/api/admin/incoming_topups/${encodeURIComponent(t.id)}/force_match`, { verify_code: true });
          if(res.ok){ alert('Принудительно сопоставлено'); loadIncoming(); } else alert('Ошибка: '+(res.reason||''));
        };
        actionsCell.appendChild(forceBtn);
      }
      const refundBtn = document.createElement('button'); refundBtn.className='btn'; refundBtn.textContent='Отметить возврат';
      refundBtn.onclick = async ()=> {
        const reason = prompt('Причина возврата (будет записана):') || '';
        if(!confirm('Отметить как возврат? (реальный денежный возврат выполняется вручную)')) return;
        const res = await apiPost(`/api/admin/incoming_topups/${encodeURIComponent(t.id)}/refund`, { reason });
        if(res.ok){ alert('Отмечено как refund'); loadIncoming(); } else alert('Ошибка: '+(res.reason||''));
      };
      actionsCell.appendChild(refundBtn);
      tbody.appendChild(tr);
    });
  }catch(e){
    console.error('loadIncoming error', e);
  }
}

document.getElementById('btnRefresh').addEventListener('click', loadIncoming);
document.getElementById('btnFilter').addEventListener('click', loadIncoming);

loadIncoming();
</script>
</body>
</html>
