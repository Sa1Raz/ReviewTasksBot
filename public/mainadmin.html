<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>ReviewCash — Admin</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
  <style>
    body{background:#060617;color:#e6fbff;font-family:Inter,system-ui,-apple-system;min-height:100vh;padding:20px;}
    .card{background:linear-gradient(180deg,#071023,#0c1330);padding:16px;border-radius:12px;border:1px solid rgba(0,255,255,0.06);margin-bottom:16px;}
    h1{font-size:20px;margin-bottom:12px;color:#00ffcc;}
    table{width:100%;border-collapse:collapse;font-size:14px;}
    th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.03);vertical-align:middle;}
    .btn{padding:8px 10px;border-radius:8px;border:none;cursor:pointer;font-weight:700;}
    .btn-approve{background:#00cc66;color:#001;}
    .btn-reject{background:#ff3366;color:#fff;}
    .btn-detail{background:transparent;color:#88c0d0;border:1px solid rgba(255,255,255,0.04);}
    .small{font-size:12px;color:#a8dfe0;}
    .muted{color:#88c0d0;font-size:13px;}
    .danger{color:#ff8aa0;}
    .top {display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:12px;}
    .search{width:60%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:#061020;color:#fff;}
  </style>
</head>
<body>
  <div class="card top">
    <div>
      <h1>Панель администратора — ReviewCash</h1>
      <div class="muted" id="admin-user">Загрузка профиля...</div>
    </div>
    <div>
      <input class="search" id="searchInput" placeholder="Поиск по пользователю / коду / id">
    </div>
  </div>

  <div class="card" id="topupsCard">
    <h2 style="margin:0 0 10px 0;color:#ffd700;">Заявки на пополнение</h2>
    <div id="topupsList" class="muted">Загрузка...</div>
  </div>

  <div class="card" id="withdrawsCard">
    <h2 style="margin:0 0 10px 0;color:#00ff88;">Заявки на вывод</h2>
    <div id="withdrawsList" class="muted">Загрузка...</div>
  </div>

  <div class="card" id="tasksCard">
    <h2 style="margin:0 0 10px 0;color:#00ffff;">Задания пользователей</h2>
    <div id="tasksList" class="muted">Загрузка...</div>
  </div>

  <script>
    // admin auth by Telegram username — page intended to be opened from WebApp (same origin).
    const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
    try { tg?.ready?.(); } catch(e) {}
    const user = (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) ? tg.initDataUnsafe.user : { username: null, id: null, first_name: null };

    // adjust this list to allowed admin usernames
    const ADMIN_USERNAMES = ['Sa1Raz'];

    // If run as a static file without WebApp, allow if query ?admin=1 maybe — but we strictly check username if available.
    const isAdmin = (user.username && ADMIN_USERNAMES.includes(user.username)) || location.search.includes('admin=1');

    const adminUserEl = document.getElementById('admin-user');
    if (!isAdmin) {
      adminUserEl.innerHTML = '<span class="danger">Доступ запрещён. Только админ может просматривать эту страницу.</span>';
      // show limited info but prevent actions
    } else {
      adminUserEl.innerText = `Вход как: ${user.username || user.first_name} (${user.id || 'no-id'})`;
    }

    // reuse helpers defined in index page if opened from same origin; otherwise recreate small localStorage helpers
    function storageGetJSON(key, fallback) {
      try { return JSON.parse(localStorage.getItem(key) || JSON.stringify(fallback)); } catch(e) { return fallback; }
    }
    function storageSetJSON(key, val) { localStorage.setItem(key, JSON.stringify(val)); }

    function getBalanceFor(userId) {
      const map = storageGetJSON('rc_balances', {});
      return parseInt(map[userId] || 0, 10);
    }
    function setBalanceFor(userId, amount) {
      const map = storageGetJSON('rc_balances', {});
      map[userId] = Math.max(0, parseInt(amount || 0, 10));
      storageSetJSON('rc_balances', map);
    }

    function reloadAll() {
      renderTopups();
      renderWithdraws();
      renderTasks();
    }

    // ========== TOPUPS ===========
    function renderTopups(filter) {
      const arr = storageGetJSON('rc_topups', []).slice().reverse();
      const container = document.getElementById('topupsList');
      const q = (filter || '').toLowerCase().trim();
      if (arr.length === 0) {
        container.innerHTML = '<div class="muted">Нет заявок</div>'; return;
      }
      let html = '<table><thead><tr><th>Пользователь</th><th>Сумма</th><th>Код</th><th>Статус</th><th>Действия</th></tr></thead><tbody>';
      arr.forEach(t => {
        if (q && !(String(t.code||'')+String(t.id||'')+String(t.user?.username||'')+String(t.user?.id||'')).toLowerCase().includes(q)) return;
        html += `<tr>
          <td>${escapeHTML(t.user?.username || t.user?.first_name || '—')}<br><span class="small">${escapeHTML(t.user?.id||'')}</span></td>
          <td>${(t.amount||0).toLocaleString('ru-RU')} ₽</td>
          <td><b>${escapeHTML(t.code||'')}</b></td>
          <td>${escapeHTML(t.status||'')}</td>
          <td>
            ${isAdmin ? `<button class="btn btn-approve" onclick="approveTopup('${t.id}')">Подтвердить</button>
            <button class="btn btn-reject" onclick="rejectTopup('${t.id}')">Отклонить</button>` : ''}
            <button class="btn btn-detail" onclick="showTopupDetail('${t.id}')">Подробнее</button>
          </td>
        </tr>`;
      });
      html += '</tbody></table>';
      container.innerHTML = html;
    }

    function approveTopup(id) {
      if (!isAdmin) return alert('Доступ запрещён');
      const arr = storageGetJSON('rc_topups', []);
      const idx = arr.findIndex(x => x.id === id);
      if (idx === -1) return alert('Заявка не найдена');
      const t = arr[idx];
      if (t.status === 'approved') return alert('Уже подтверждена');
      // approve and credit user's balance
      const userId = t.user?.id || 'guest';
      const prev = getBalanceFor(userId);
      setBalanceFor(userId, prev + (t.amount || 0));
      arr[idx].status = 'approved';
      arr[idx].handled_by = user.username || 'admin';
      arr[idx].handled_at = new Date().toISOString();
      storageSetJSON('rc_topups', arr);
      alert(`Пополнение ${t.amount} ₽ подтверждено и зачислено пользователю ${t.user?.username || t.user?.first_name}`);
      reloadAll();
    }

    function rejectTopup(id) {
      if (!isAdmin) return alert('Доступ запрещён');
      const reason = prompt('Причина отказа (будет записана в заявку):', 'Не могу подтвердить платёж');
      if (reason === null) return;
      const arr = storageGetJSON('rc_topups', []);
      const idx = arr.findIndex(x => x.id === id);
      if (idx === -1) return alert('Заявка не найдена');
      arr[idx].status = 'rejected';
      arr[idx].handled_by = user.username || 'admin';
      arr[idx].handled_at = new Date().toISOString();
      arr[idx].reject_reason = reason;
      storageSetJSON('rc_topups', arr);
      alert('Заявка отклонена');
      reloadAll();
    }

    function showTopupDetail(id) {
      const arr = storageGetJSON('rc_topups', []);
      const t = arr.find(x => x.id === id);
      if (!t) return alert('Не найдено');
      alert(JSON.stringify(t, null, 2));
    }

    // ========== WITHDRAWS ===========
    function renderWithdraws(filter) {
      const arr = storageGetJSON('rc_withdraws', []).slice().reverse();
      const container = document.getElementById('withdrawsList');
      const q = (filter || '').toLowerCase().trim();
      if (arr.length === 0) {
        container.innerHTML = '<div class="muted">Нет заявок</div>'; return;
      }
      let html = '<table><thead><tr><th>Пользователь</th><th>Сумма</th><th>Реквизиты</th><th>Статус</th><th>Действия</th></tr></thead><tbody>';
      arr.forEach(w => {
        if (q && !(String(w.id||'')+String(w.user?.username||'')+String(w.user?.id||'')+String(w.card||'')).toLowerCase().includes(q)) return;
        html += `<tr>
          <td>${escapeHTML(w.user?.username || w.user?.first_name || '—')}<br><span class="small">${escapeHTML(w.user?.id||'')}</span></td>
          <td>${(w.amount||0).toLocaleString('ru-RU')} ₽</td>
          <td>${escapeHTML(w.card||'')}<br><span class="muted">${escapeHTML(w.bank||'')}</span></td>
          <td>${escapeHTML(w.status||'')}</td>
          <td>
            ${isAdmin ? `<button class="btn btn-approve" onclick="approveWithdraw('${w.id}')">Выплатить</button>
            <button class="btn btn-reject" onclick="rejectWithdraw('${w.id}')">Отклонить</button>` : ''}
            <button class="btn btn-detail" onclick="showWithdrawDetail('${w.id}')">Подробнее</button>
          </td>
        </tr>`;
      });
      html += '</tbody></table>';
      container.innerHTML = html;
    }

    function approveWithdraw(id) {
      if (!isAdmin) return alert('Доступ запрещён');
      const arr = storageGetJSON('rc_withdraws', []);
      const idx = arr.findIndex(x => x.id === id);
      if (idx === -1) return alert('Заявка не найдена');
      const w = arr[idx];
      if (w.status === 'paid') return alert('Уже оплачено');
      // Admin confirms transfer done manually
      const ok = confirm(`Подтвердить выплату ${w.amount} ₽ пользователю ${w.user?.username || w.user?.first_name}?`);
      if (!ok) return;
      arr[idx].status = 'paid';
      arr[idx].handled_by = user.username || 'admin';
      arr[idx].handled_at = new Date().toISOString();
      storageSetJSON('rc_withdraws', arr);
      alert('Отмечено как выплачено');
      reloadAll();
    }

    function rejectWithdraw(id) {
      if (!isAdmin) return alert('Доступ запрещён');
      const reason = prompt('Причина отказа (будет записана в заявку):', 'Неверные реквизиты');
      if (reason === null) return;
      const arr = storageGetJSON('rc_withdraws', []);
      const idx = arr.findIndex(x => x.id === id);
      if (idx === -1) return alert('Заявка не найдена');
      const w = arr[idx];
      // refund user by adding back amount
      const userId = w.user?.id || 'guest';
      const prev = getBalanceFor(userId);
      setBalanceFor(userId, prev + (w.amount || 0));
      arr[idx].status = 'rejected';
      arr[idx].handled_by = user.username || 'admin';
      arr[idx].handled_at = new Date().toISOString();
      arr[idx].reject_reason = reason;
      storageSetJSON('rc_withdraws', arr);
      alert('Заявка отклонена и средства возвращены пользователю');
      reloadAll();
    }

    function showWithdrawDetail(id) {
      const arr = storageGetJSON('rc_withdraws', []);
      const w = arr.find(x => x.id === id);
      if (!w) return alert('Не найдено');
      alert(JSON.stringify(w, null, 2));
    }

    // ========== TASKS ===========
    function renderTasks(filter) {
      const arr = storageGetJSON('rc_tasks', []).slice().reverse();
      const container = document.getElementById('tasksList');
      const q = (filter || '').toLowerCase().trim();
      if (arr.length === 0) {
        container.innerHTML = '<div class="muted">Нет заданий</div>'; return;
      }
      let html = '<table><thead><tr><th>Название</th><th>Тип/Бюджет</th><th>Пользователь</th><th>Статус</th><th>Действия</th></tr></thead><tbody>';
      arr.forEach(t => {
        if (q && !(String(t.id||'')+String(t.title||'')+String(t.owner?.username||'')).toLowerCase().includes(q)) return;
        html += `<tr>
          <td>${escapeHTML(t.title||'—')}<br><span class="small link-muted">${escapeHTML(t.link||'')}</span></td>
          <td>${escapeHTML(t.type||'')} / ${(t.budget||0).toLocaleString('ru-RU')} ₽</td>
          <td>${escapeHTML(t.owner?.username || t.owner?.first_name || '—')}<br><span class="small">${escapeHTML(t.owner?.id||'')}</span></td>
          <td>${escapeHTML(t.status||'')}</td>
          <td>
            ${isAdmin ? `<button class="btn btn-reject" onclick="deleteTask('${t.id}')">Удалить</button>` : ''}
            <button class="btn btn-detail" onclick="showTaskDetail('${t.id}')">Подробнее</button>
          </td>
        </tr>`;
      });
      html += '</tbody></table>';
      container.innerHTML = html;
    }

    function deleteTask(id) {
      if (!isAdmin) return alert('Доступ запрещён');
      const reason = prompt('Причина удаления задания (будет видна владельцу):', 'Неактуально / Нарушение правил');
      if (reason === null) return;
      const arr = storageGetJSON('rc_tasks', []);
      const idx = arr.findIndex(x => x.id === id);
      if (idx === -1) return alert('Задание не найдено');
      // mark deleted and store reason
      arr[idx].status = 'deleted';
      arr[idx].deleted = {
        by: user.username || 'admin',
        reason: reason,
        at: new Date().toISOString()
      };
      storageSetJSON('rc_tasks', arr);
      alert('Задание удалено (помечено как deleted)');
      reloadAll();
    }

    function showTaskDetail(id) {
      const arr = storageGetJSON('rc_tasks', []);
      const t = arr.find(x => x.id === id);
      if (!t) return alert('Не найдено');
      alert(JSON.stringify(t, null, 2));
    }

    // helpers
    function escapeHTML(s) { if (!s && s !== 0) return ''; return String(s).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]; }); }

    // search
    const searchInput = document.getElementById('searchInput');
    let searchTimeout;
    searchInput.addEventListener('input', () => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        const q = searchInput.value.trim();
        renderTopups(q);
        renderWithdraws(q);
        renderTasks(q);
      }, 300);
    });

    // initial load
    reloadAll();
  </script>
</body>
</html>
