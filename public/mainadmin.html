<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ReviewCash — Admin</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<style>
  body{margin:0;font-family:Inter,system-ui,Arial;background:#061026;color:#eaf7fb;padding:18px}
  .wrap{max-width:1200px;margin:0 auto;display:grid;grid-template-columns:1fr 420px;gap:18px}
  header{display:flex;align-items:center;gap:12px;margin-bottom:10px}
  .mark{width:48px;height:48px;border-radius:10px;background:linear-gradient(90deg,#00f0ff,#00ff9d);display:flex;align-items:center;justify-content:center;color:#012226;font-weight:800}
  h1{margin:0;font-size:18px}
  .panel{background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);border-radius:12px;padding:14px;border:1px solid rgba(255,255,255,0.04)}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:left;font-size:14px}
  th{color:#9fb6c6}
  .actions button{margin-right:6px;padding:6px 8px;border-radius:8px;border:none;cursor:pointer}
  .approve{background:#00ff9d;color:#012226}
  .reject{background:#ff6b80;color:#fff}
  .muted{color:#9fb6c6;font-size:13px}
  .search{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#eaf7fb}
  .flex-row{display:flex;gap:8px;align-items:center}
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:10000;visibility:hidden;opacity:0;transition:all .16s}
  .modal-backdrop.show{visibility:visible;opacity:1}
  .modal{background:#071426;border-radius:10px;padding:14px;width:520px;border:1px solid rgba(255,255,255,0.04)}
  textarea{width:100%;min-height:100px;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#eaf7fb}
  .btn{padding:8px;border-radius:8px;border:none;cursor:pointer;background:transparent;color:var(--muted)}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="mark">RC</div>
      <div><h1>Админ-панель — ReviewCash</h1><div class="muted">События в реальном времени</div></div>
      <div style="margin-left:auto" id="whoamiInfo" class="muted"></div>
    </header>

    <main>
      <div class="panel" style="margin-bottom:12px">
        <div class="flex-row" style="justify-content:space-between">
          <div><strong>Заявки на пополнение</strong></div>
          <div class="flex-row"><input id="topupSearch" class="search" placeholder="Поиск..." /></div>
        </div>
        <div style="margin-top:10px;overflow:auto;max-height:260px">
          <table id="topupsTable"><thead><tr><th>ID</th><th>Пользователь</th><th>Сумма</th><th>Статус</th><th>Действия</th></tr></thead><tbody></tbody></table>
        </div>
      </div>

      <div class="panel" style="margin-bottom:12px">
        <div class="flex-row" style="justify-content:space-between">
          <div><strong>Заявки на вывод</strong></div>
        </div>
        <div style="margin-top:10px;overflow:auto;max-height:260px">
          <table id="withdrawsTable"><thead><tr><th>ID</th><th>Пользователь</th><th>Сумма</th><th>Реквизиты</th><th>Действия</th></tr></thead><tbody></tbody></table>
        </div>
      </div>

      <div class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>Работы (pending)</strong></div>
          <div class="muted">Обновляется по socket</div>
        </div>
        <div style="margin-top:10px;overflow:auto;max-height:260px">
          <table id="worksTable"><thead><tr><th>ID</th><th>Задание</th><th>Пользователь</th><th>Сумма</th><th>Действия</th></tr></thead><tbody></tbody></table>
        </div>
      </div>
    </main>

    <aside>
      <div class="panel" style="margin-bottom:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>Статистика</strong></div>
          <div class="muted">Live</div>
        </div>
        <div style="margin-top:10px">
          <div class="muted">Всего топапов: <span id="statTopups">0</span></div>
          <div class="muted" style="margin-top:6px">Всего выводов: <span id="statWithdraws">0</span></div>
          <div class="muted" style="margin-top:6px">Работ в ожидании: <span id="statWorks">0</span></div>
        </div>
      </div>

      <div class="panel">
        <div style="display:flex;align-items:center;justify-content:space-between">
          <div><strong>Действия</strong></div>
        </div>
        <div style="margin-top:10px">
          <div class="muted">Токен: <span id="tokenShort" style="word-break:break-all"></span></div>
          <button id="reloadBtn" class="btn" style="margin-top:10px;padding:8px;border-radius:8px">Перезагрузить</button>
        </div>
      </div>
    </aside>
  </div>

  <!-- Confirm modal -->
  <div id="confirmModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <h3 id="confirmTitle">Подтвердите действие</h3>
      <div class="muted" id="confirmDesc">Вы уверены?</div>
      <div style="margin-top:12px">
        <textarea id="confirmReason" placeholder="Причина (опционально)"></textarea>
      </div>
      <div style="margin-top:12px;display:flex;justify-content:flex-end;gap:8px">
        <button id="confirmCancel" class="btn">Отмена</button>
        <button id="confirmApprove" class="approve">Подтвердить</button>
      </div>
    </div>
  </div>

<script>
(function(){
  function qs(name){ return new URLSearchParams(location.search).get(name); }
  const token = qs('token') || '';
  document.getElementById('tokenShort').textContent = token ? token.slice(0,24) + '...' : 'нет';

  let socket = null;
  try {
    socket = io({ auth: { token }, transports: ['websocket'] });
    socket.on('connect', ()=> console.log('admin socket', socket.id));
    socket.on('new_topup', d => { loadTopups(); });
    socket.on('update_topup', d => { loadTopups(); });
    socket.on('new_withdraw', d => { loadWithdraws(); });
    socket.on('new_work', d => { loadWorks(); });
    socket.on('user_balance_changed', d => { /* optionally refresh UI or show toast */ });
  } catch(e){ console.warn('socket fail', e); }

  const topupsTable = document.querySelector('#topupsTable tbody');
  const withdrawsTable = document.querySelector('#withdrawsTable tbody');
  const worksTable = document.querySelector('#worksTable tbody');

  const confirmModal = document.getElementById('confirmModal');
  const confirmTitle = document.getElementById('confirmTitle');
  const confirmDesc = document.getElementById('confirmDesc');
  const confirmReason = document.getElementById('confirmReason');
  const confirmApprove = document.getElementById('confirmApprove');
  const confirmCancel = document.getElementById('confirmCancel');

  let pendingConfirmAction = null;

  function showConfirm(title, desc, action){
    confirmTitle.textContent = title;
    confirmDesc.textContent = desc || '';
    confirmReason.value = '';
    pendingConfirmAction = action;
    confirmModal.classList.add('show'); confirmModal.setAttribute('aria-hidden','false');
  }
  function hideConfirm(){ confirmModal.classList.remove('show'); confirmModal.setAttribute('aria-hidden','true'); pendingConfirmAction = null; }

  confirmCancel.addEventListener('click', hideConfirm);
  confirmApprove.addEventListener('click', async ()=>{
    if (!pendingConfirmAction) { hideConfirm(); return; }
    const reason = confirmReason.value.trim();
    try {
      await pendingConfirmAction({ reason });
      hideConfirm();
      await Promise.all([loadTopups(), loadWithdraws(), loadWorks()]);
    } catch(e) {
      alert('Ошибка: ' + e);
    }
  });

  async function apiGet(path){ const res = await fetch(path + (path.includes('?')? '&':'?') + 'token=' + encodeURIComponent(token)); if (!res.ok) throw await res.text(); return res.json(); }
  async function apiPost(path, body){ const res = await fetch(path + '?token=' + encodeURIComponent(token), { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body||{})}); if (!res.ok) throw await res.text(); return res.json(); }

  async function loadTopups(){
    try {
      const data = await apiGet('/api/topups');
      topupsTable.innerHTML = '';
      data.forEach(t=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${t.id}</td><td>${t.user.username||t.user.id}</td><td>${t.amount||0} ₽</td><td>${t.status||''}</td><td class="actions"></td>`;
        const actions = tr.querySelector('.actions');
        if (t.status === 'pending') {
          const aBtn = document.createElement('button'); aBtn.className='approve'; aBtn.textContent='Одобрить';
          aBtn.onclick = ()=> showConfirm('Подтвердить пополнение','Одобрить заявку ' + t.id + '?', async ({reason})=> {
            await apiPost(`/api/topups/${encodeURIComponent(t.id)}/approve`, {});
          });
          const rBtn = document.createElement('button'); rBtn.className='reject'; rBtn.textContent='Отклонить';
          rBtn.onclick = ()=> showConfirm('Отклонить пополнение','Укажите причину отклонения', async ({reason})=> {
            await apiPost(`/api/topups/${encodeURIComponent(t.id)}/reject`, { reason: reason || 'Отклонено админом' });
          });
          actions.appendChild(aBtn); actions.appendChild(rBtn);
        } else {
          actions.textContent = '-';
        }
        topupsTable.appendChild(tr);
      });
      document.getElementById('statTopups').textContent = data.length;
    } catch(e){ console.error(e); topupsTable.innerHTML = '<tr><td colspan="5">Ошибка загрузки</td></tr>'; }
  }

  async function loadWithdraws(){
    try {
      const data = await apiGet('/api/withdraws');
      withdrawsTable.innerHTML = '';
      data.forEach(t=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${t.id}</td><td>${t.user.username||t.user.id}</td><td>${t.amount||0} ₽</td><td>${(t.card||'') + ' / ' + (t.bank||'')}</td><td class="actions"></td>`;
        const actions = tr.querySelector('.actions');
        if (t.status === 'pending') {
          const aBtn = document.createElement('button'); aBtn.className='approve'; aBtn.textContent='Выплатить';
          aBtn.onclick = ()=> showConfirm('Подтвердить выплату','Отметить как выплаченную: ' + t.id, async ({reason})=> {
            await apiPost(`/api/withdraws/${encodeURIComponent(t.id)}/approve`, {});
          });
          const rBtn = document.createElement('button'); rBtn.className='reject'; rBtn.textContent='Отклонить';
          rBtn.onclick = ()=> showConfirm('Отклонить вывод','Укажите причину отклонения', async ({reason})=> {
            await apiPost(`/api/withdraws/${encodeURIComponent(t.id)}/reject`, { reason: reason || 'Отклонено админом' });
          });
          actions.appendChild(aBtn); actions.appendChild(rBtn);
        } else {
          actions.textContent = '-';
        }
        withdrawsTable.appendChild(tr);
      });
      document.getElementById('statWithdraws').textContent = data.length;
    } catch(e){ console.error(e); withdrawsTable.innerHTML = '<tr><td colspan="5">Ошибка загрузки</td></tr>'; }
  }

  async function loadWorks(){
    try {
      const data = await apiGet('/api/works');
      worksTable.innerHTML = '';
      data.forEach(w=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${w.id}</td><td>${w.task_title||w.task_id}</td><td>${w.user.username||w.user.id}</td><td>${w.amount||0} ₽</td><td class="actions"></td>`;
        const actions = tr.querySelector('.actions');
        if (w.status === 'pending') {
          const aBtn = document.createElement('button'); aBtn.className='approve'; aBtn.textContent='Принять';
          aBtn.onclick = ()=> showConfirm('Принять работу','Подтвердить выплату исполнителю?', async ({reason})=> {
            await apiPost(`/api/works/${encodeURIComponent(w.id)}/approve`, {});
          });
          const rBtn = document.createElement('button'); rBtn.className='reject'; rBtn.textContent='Отклонить';
          rBtn.onclick = ()=> showConfirm('Отклонить работу','Укажите причину отклонения', async ({reason})=> {
            await apiPost(`/api/works/${encodeURIComponent(w.id)}/reject`, { reason: reason || 'Отклонено админом' });
          });
          actions.appendChild(aBtn); actions.appendChild(rBtn);
        } else {
          actions.textContent = w.status || '-';
        }
        worksTable.appendChild(tr);
      });
      document.getElementById('statWorks').textContent = data.length;
    } catch(e){ console.error(e); worksTable.innerHTML = '<tr><td colspan="5">Ошибка загрузки</td></tr>'; }
  }

  document.getElementById('reloadBtn').addEventListener('click', ()=> Promise.all([loadTopups(), loadWithdraws(), loadWorks()]));
  (async function(){ 
    if (!token) { document.getElementById('whoamiInfo').textContent = 'Токен не передан'; }
    else {
      try {
        const who = await (await fetch('/whoami?token=' + encodeURIComponent(token))).json();
        if (who && who.ok && who.admin) {
          document.getElementById('whoamiInfo').textContent = who.admin.username ? (who.admin.username + (who.admin.is_main? ' (главный)': '')) : who.admin.uid;
        }
      } catch(e){}
    }
    await Promise.all([loadTopups(), loadWithdraws(), loadWorks()]);
  })();

})();
</script>
</body>
</html>
