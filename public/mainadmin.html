<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>ReviewCash ‚Ä¢ Admin Panel</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
  <style>
    :root{
      --bg:#020617; --bg-alt:#020817; --card:#0f1e36; --glass:#94a3b8; --accent:#00e7c0; --accent-soft:#22c55e;
      --accent2:#00d4ff; --text:#e2f3ff; --muted:#94a3b8; --radius:20px; --success:#22c55e; --error:#ef4444; --warning:#f59e0b;
      --transition:all 0.45s cubic-bezier(0.34,1.56,0.64,1);
    }
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:'Inter',system-ui,-apple-system,sans-serif;
      background:linear-gradient(135deg,var(--bg) 0%, var(--bg-alt) 100%), 
                 radial-gradient(circle at 0% 0%, rgba(59,130,246,0.3) 0%, transparent 50%),
                 radial-gradient(circle at 100% 100%, rgba(34,197,94,0.3) 0%, transparent 50%);
      color:var(--text);
      min-height:100dvh;
      padding:16px;
      position:relative;
    }
    body::before{
      content:"";
      position:fixed;inset:0;
      background:linear-gradient(120deg, rgba(148,163,184,0.08) 1px, transparent 1px),
                 linear-gradient(210deg, rgba(148,163,184,0.06) 1px, transparent 1px);
      background-size:80px 80px;
      opacity:.6;mix-blend-mode:soft-light;pointer-events:none;z-index:-1;
    }
    .container{max-width:1400px;margin:0 auto;}
    
    .header{
      background:rgba(15,30,54,0.95);backdrop-filter:blur(20px);border:1px solid rgba(148,163,184,0.4);
      border-radius:var(--radius);padding:20px;margin-bottom:20px;display:flex;align-items:center;gap:16px;
      box-shadow:0 20px 60px rgba(15,30,54,0.9);
    }
    .logo{width:60px;height:60px;border-radius:16px;background:linear-gradient(135deg,var(--accent),var(--accent2));
          display:flex;align-items:center;justify-content:center;color:#002;font-weight:900;font-size:24px;
          box-shadow:0 10px 40px rgba(0,231,192,0.4)}
    .title h1{margin:0;font-size:24px;font-weight:800;background:linear-gradient(90deg,var(--text),var(--muted));
              -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .title p{margin:4px 0 0;color:var(--muted);font-size:14px}
    .header-actions{margin-left:auto;display:flex;gap:12px;flex-wrap:wrap}
    .btn{
      padding:10px 20px;border-radius:12px;border:none;background:linear-gradient(135deg,var(--accent),var(--accent2));
      color:#002;font-weight:700;cursor:pointer;font-size:14px;transition:var(--transition);
      box-shadow:0 6px 24px rgba(0,231,192,0.3);position:relative;overflow:hidden;
    }
    .btn:hover{transform:translateY(-2px);box-shadow:0 8px 32px rgba(0,231,192,0.5)}
    .btn-ghost{
      padding:10px 18px;border-radius:12px;border:1px solid rgba(148,163,184,0.4);
      background:rgba(15,30,54,0.8);color:var(--text);cursor:pointer;font-size:14px;font-weight:600;
      transition:var(--transition);backdrop-filter:blur(10px)
    }
    .btn-ghost:hover{background:rgba(15,30,54,0.9);border-color:var(--accent);transform:translateY(-1px)}
    .btn-success{background:linear-gradient(135deg,var(--success),#16a34a);color:#fff}
    .btn-danger{background:linear-gradient(135deg,var(--error),#dc2626);color:#fff}
    .btn-warning{background:linear-gradient(135deg,var(--warning),#d97706);color:#001a0b}
    
    .layout{display:grid;grid-template-columns:300px 1fr;gap:20px;margin-top:20px}
    .left{display:flex;flex-direction:column;gap:16px}
    
    .card{
      background:rgba(15,30,54,0.95);backdrop-filter:blur(20px);border:1px solid rgba(148,163,184,0.4);
      border-radius:var(--radius);padding:24px;box-shadow:0 20px 60px rgba(15,30,54,0.9);
      transition:var(--transition);position:relative;overflow:hidden;
    }
    .card:hover{border-color:rgba(0,231,192,0.6);box-shadow:0 24px 72px rgba(15,30,54,0.95)}
    .card::before{
      content:"";position:absolute;inset:0;background:radial-gradient(circle at 50% -20%, rgba(148,163,184,0.2), transparent 60%);
      opacity:.6;pointer-events:none;
    }
    
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    .tab{padding:12px 18px;border-radius:12px;background:transparent;border:1px solid transparent;color:var(--muted);
          cursor:pointer;font-size:14px;font-weight:600;transition:var(--transition);position:relative}
    .tab:hover{color:var(--text);background:rgba(255,255,255,0.05)}
    .tab.active{background:linear-gradient(135deg,rgba(0,231,192,0.15),rgba(0,212,255,0.1));
                border:1px solid rgba(0,231,192,0.3);color:var(--accent);
                box-shadow:0 4px 16px rgba(0,231,192,0.15)}
    
    .table{width:100%;border-collapse:collapse;margin-top:16px}
    th,td{padding:14px 16px;border-bottom:1px solid rgba(148,163,184,0.2);font-size:13px;text-align:left;color:var(--text)}
    th{color:var(--accent);font-weight:700;background:rgba(0,231,192,0.05);text-transform:uppercase;font-size:12px;letter-spacing:0.5px}
    tr:hover{background:rgba(255,255,255,0.03)}
    
    .input,select{
      width:100%;padding:12px 16px;border-radius:12px;background:rgba(15,30,54,0.9);border:1px solid rgba(148,163,184,0.4);
      color:var(--text);font-size:14px;font-family:inherit;transition:var(--transition)
    }
    .input:focus,select:focus{outline:none;border-color:var(--accent);background:rgba(15,30,54,0.95);
                              box-shadow:0 0 0 3px rgba(0,231,192,0.1)}
    
    .status{display:inline-flex;align-items:center;gap:6px;padding:4px 12px;border-radius:999px;font-size:12px;font-weight:700;
            text-transform:uppercase;letter-spacing:0.5px}
    .status-pending{background:rgba(245,158,11,0.1);color:#f59e0b;border:1px solid rgba(245,158,11,0.3)}
    .status-paid{background:rgba(34,197,94,0.1);color:#22c55e;border:1px solid rgba(34,197,94,0.3)}
    .status-refunded{background:rgba(239,68,68,0.1);color:#ef4444;border:1px solid rgba(239,68,68,0.3)}
    .status-active{background:rgba(34,197,94,0.12);color:#22c55e;border:1px solid rgba(34,197,94,0.3)}
    .status-inactive{background:rgba(107,114,128,0.12);color:#6b7280;border:1px solid rgba(107,114,128,0.3)}
    .status-approved{background:rgba(34,197,94,0.1);color:#22c55e;border:1px solid rgba(34,197,94,0.3)}
    .status-rejected{background:rgba(239,68,68,0.1);color:#ef4444;border:1px solid rgba(239,68,68,0.3)}
    
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px;margin-top:20px}
    .stat-card{padding:20px;border-radius:16px;background:linear-gradient(135deg,rgba(255,255,255,0.06),rgba(255,255,255,0.02));
               border:1px solid rgba(148,163,184,0.4);transition:var(--transition)}
    .stat-card:hover{transform:translateY(-4px);border-color:var(--accent);box-shadow:0 8px 32px rgba(0,231,192,0.2)}
    .stat-label{color:var(--muted);font-size:13px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px}
    .stat-value{font-weight:900;font-size:32px;margin-top:8px;background:linear-gradient(135deg,var(--accent),var(--accent2));
                -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    
    .filter-bar{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-top:16px;padding:16px;
                background:rgba(255,255,255,0.03);border-radius:12px;border:1px solid rgba(148,163,184,0.3)}
    .filter-bar > *{flex:1;min-width:180px}
    
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .actions button{font-size:12px;padding:6px 12px}
    
    .auto-dot{width:10px;height:10px;border-radius:50%;display:inline-block;box-shadow:0 0 8px rgba(0,0,0,0.4)}
    .auto-dot.off{background:rgba(255,255,255,0.4)}
    .auto-dot.on{background:var(--accent);box-shadow:0 0 8px rgba(0,231,192,0.8)}
    
    .toast{position:fixed;bottom:24px;right:24px;background:var(--card);padding:16px 24px;border-radius:12px;
           border:1px solid rgba(148,163,184,0.4);box-shadow:0 16px 48px rgba(15,30,54,0.9);z-index:2000;
           display:none;animation:slideIn 0.3s ease}
    .toast.active{display:block}
    .toast.success{border-color:var(--success);background:rgba(34,197,94,0.1)}
    .toast.error{border-color:var(--error);background:rgba(239,68,68,0.1)}
    .toast.info{border-color:var(--accent);background:rgba(0,231,192,0.1)}
    
    @keyframes slideIn{from{transform:translateX(400px);opacity:0}to{transform:translateX(0);opacity:1}}
    
    @media(max-width:1100px){.layout{grid-template-columns:1fr}.stats-grid{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:600px){body{padding:12px}.header{flex-wrap:wrap;padding:16px}.filter-bar{flex-direction:column}.filter-bar > *{width:100%}.stats-grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">RC</div>
      <div class="title">
        <h1>Admin Panel ‚Ä¢ ReviewCash</h1>
        <p>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏, –∑–∞–¥–∞–Ω–∏—è–º–∏, –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è–º–∏ –∏ –≤—ã–≤–æ–¥–∞–º–∏</p>
      </div>
      <div class="header-actions">
        <button id="btnRefresh" class="btn-ghost">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
        <button id="btnAutoRefresh" class="btn-ghost" title="–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è—Ç—å –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥">
          üîÑ –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ <span id="autoRefreshIndicator" class="auto-dot off"></span>
        </button>
        <button class="btn" id="adminRole">üë§ Super Admin</button>
      </div>
    </div>

    <div class="layout">
      <div class="left">
        <div class="card">
          <div class="section-title" style="font-size:18px;margin-bottom:8px">–ù–∞–≤–∏–≥–∞—Ü–∏—è</div>
          <div class="section-subtitle" style="color:var(--muted);font-size:13px;margin-bottom:12px">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</div>
          <div class="tabs">
            <div class="tab active" data-tab="dashboard">üìä –ü–∞–Ω–µ–ª—å</div>
            <div class="tab" data-tab="users">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</div>
            <div class="tab" data-tab="tasks">üìù –ó–∞–¥–∞–Ω–∏—è</div>
            <div class="tab" data-tab="topups">üí∞ –ü–æ–ø–æ–ª–Ω–µ–Ω–∏—è</div>
            <div class="tab" data-tab="withdraws">üí∏ –í—ã–≤–æ–¥—ã</div>
            <div class="tab" data-tab="analytics">üìà –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</div>
          </div>
        </div>

        <div class="card">
          <div class="section-title" style="font-size:16px;margin-bottom:8px">‚ö° –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</div>
          <div class="actions" style="margin-top:12px">
            <button class="btn-success" onclick="exportData()">üìä –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</button>
            <button class="btn-warning" onclick="clearCache()">üóë –û—á–∏—Å—Ç–∏—Ç—å –∫–µ—à</button>
            <button class="btn-danger" onclick="backupData()">üíæ –ë—ç–∫–∞–ø</button>
          </div>
        </div>

        <div class="card">
          <div class="section-title" style="font-size:16px;margin-bottom:8px">üîê –°–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</div>
          <div style="margin-top:12px;padding:12px;background:rgba(0,231,192,0.05);border-radius:8px;border:1px solid rgba(0,231,192,0.2)">
            <div style="font-size:12px;color:var(--muted)">–°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</div>
            <div style="font-size:14px;font-weight:700;color:var(--success);margin-top:4px">‚úì –ê–∫—Ç–∏–≤–µ–Ω</div>
          </div>
          <div style="margin-top:8px;font-size:12px;color:var(--muted)">–í—Å–µ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–µ —Å–µ—Ä–≤–µ—Ä–∞</div>
        </div>
      </div>

      <div class="right">
        <!-- –ü–∞–Ω–µ–ª—å -->
        <div id="dashboard" class="card section">
          <div class="section-header">
            <div>
              <div class="section-title" style="font-size:20px">–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
              <div class="section-subtitle">–ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã</div>
            </div>
          </div>
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-label">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
              <div class="stat-value" id="numUsers">‚Äî</div>
              <div style="font-size:12px;color:var(--muted);margin-top:4px">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">üí∞ –û–±–æ—Ä–æ—Ç (‚ÇΩ)</div>
              <div class="stat-value" id="totalRevenue">‚Äî</div>
              <div style="font-size:12px;color:var(--muted);margin-top:4px">–í—Å–µ–≥–æ –≤ —Å–∏—Å—Ç–µ–º–µ</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">üìù –ê–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π</div>
              <div class="stat-value" id="numTasks">‚Äî</div>
              <div style="font-size:12px;color:var(--muted);margin-top:4px">–°–æ–∑–¥–∞–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">‚è≥ –í –æ–±—Ä–∞–±–æ—Ç–∫–µ</div>
              <div class="stat-value" id="pendingCount">‚Äî</div>
              <div style="font-size:12px;color:var(--muted);margin-top:4px">–ü–æ–ø–æ–ª–Ω–µ–Ω–∏—è + –≤—ã–≤–æ–¥—ã</div>
            </div>
          </div>
          <div style="margin-top:32px">
            <div class="section-title" style="font-size:18px;margin-bottom:12px">üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</div>
            <div id="recentActivity"></div>
          </div>
        </div>

        <!-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ -->
        <div id="users" class="card section" style="display:none">
          <div class="section-header">
            <div>
              <div class="section-title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</div>
              <div class="section-subtitle">–ü—Ä–æ—Å–º–æ—Ç—Ä –±–∞–ª–∞–Ω—Å–æ–≤, –∏—Å—Ç–æ—Ä–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</div>
            </div>
            <button class="btn" onclick="exportUsers()">üì§ –≠–∫—Å–ø–æ—Ä—Ç</button>
          </div>
          <div class="filter-bar">
            <input id="searchUser" class="input" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ ID, –∏–º–µ–Ω–∏ –∏–ª–∏ @username">
            <input id="minBalance" type="number" class="input" placeholder="–ú–∏–Ω. –±–∞–ª–∞–Ω—Å">
            <input id="maxBalance" type="number" class="input" placeholder="–ú–∞–∫—Å. –±–∞–ª–∞–Ω—Å">
            <button id="applyUserFilter" class="btn">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
          </div>
          <div class="table-container" style="margin-top:20px;overflow-x:auto;border-radius:12px;border:1px solid rgba(148,163,184,0.3)">
            <table class="table" id="usersTable">
              <thead><tr><th>ID</th><th>–ò–º—è</th><th>Username</th><th>–ë–∞–ª–∞–Ω—Å</th><th>–ó–∞–¥–∞–Ω–∏–π –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <!-- –ó–∞–¥–∞–Ω–∏—è -->
        <div id="tasks" class="card section" style="display:none">
          <div class="section-header">
            <div>
              <div class="section-title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è–º–∏</div>
              <div class="section-subtitle">–ü—Ä–æ—Å–º–æ—Ç—Ä —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –∑–∞–¥–∞–Ω–∏–π</div>
            </div>
            <button class="btn" onclick="exportTasks()">üì§ –≠–∫—Å–ø–æ—Ä—Ç</button>
          </div>
          <div class="filter-bar">
            <select id="taskStatus">
              <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
              <option value="active">‚úÖ –ê–∫—Ç–∏–≤–Ω—ã–µ</option>
              <option value="inactive">‚è∏ –ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ</option>
            </select>
            <select id="taskType">
              <option value="">–í—Å–µ —Ç–∏–ø—ã</option>
              <option value="ya_review">–Ø–Ω–¥–µ–∫—Å –û—Ç–∑—ã–≤</option>
              <option value="gmaps_review">Google –û—Ç–∑—ã–≤</option>
              <option value="tg_sub">TG –ü–æ–¥–ø–∏—Å–∫–∞</option>
            </select>
            <button id="applyTaskFilter" class="btn">–§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å</button>
          </div>
          <div class="table-container" style="margin-top:20px;overflow-x:auto;border-radius:12px;border:1px solid rgba(148,163,184,0.3)">
            <table class="table" id="tasksTable">
              <thead><tr><th>ID</th><th>–¢–∏–ø</th><th>–ó–∞–≥–æ–ª–æ–≤–æ–∫</th><th>–í—ã–ø–æ–ª–Ω–µ–Ω–æ</th><th>–¶–µ–Ω–∞/—à—Ç</th><th>–ë—é–¥–∂–µ—Ç</th><th>–°—Ç–∞—Ç—É—Å</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <!-- –ü–æ–ø–æ–ª–Ω–µ–Ω–∏—è -->
        <div id="topups" class="card section" style="display:none">
          <div class="section-header">
            <div>
              <div class="section-title">–ü–æ–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞</div>
              <div class="section-subtitle">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∏–ª–∏ –≤–æ–∑–≤—Ä–∞—Ç –ø–ª–∞—Ç–µ–∂–µ–π</div>
            </div>
            <button class="btn-ghost" onclick="exportTopups()">üì§ –≠–∫—Å–ø–æ—Ä—Ç</button>
          </div>
          <div class="filter-bar">
            <input id="filterComment" class="input" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –∫–æ–¥—É –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è">
            <select id="filterStatus">
              <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
              <option value="pending">‚è≥ –û–∂–∏–¥–∞–µ—Ç</option>
              <option value="paid">‚úÖ –û–ø–ª–∞—á–µ–Ω–æ</option>
              <option value="refunded">‚Ü©Ô∏è –í–æ–∑–≤—Ä–∞—Ç</option>
            </select>
            <button id="applyFilter" class="btn">–§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å</button>
          </div>
          <div class="table-container" style="margin-top:20px;overflow-x:auto;border-radius:12px;border:1px solid rgba(148,163,184,0.3)">
            <table class="table" id="topupsTable">
              <thead><tr><th>ID</th><th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th><th>–°—É–º–º–∞</th><th>–ö–æ–¥</th><th>–°—Ç–∞—Ç—É—Å</th><th>–î–∞—Ç–∞</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <!-- –í—ã–≤–æ–¥—ã -->
        <div id="withdraws" class="card section" style="display:none">
          <div class="section-header">
            <div>
              <div class="section-title">–ó–∞—è–≤–∫–∏ –Ω–∞ –≤—ã–≤–æ–¥</div>
              <div class="section-subtitle">–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞—è–≤–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–∞ –≤—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤</div>
            </div>
            <button class="btn-ghost" onclick="exportWithdraws()">üì§ –≠–∫—Å–ø–æ—Ä—Ç</button>
          </div>
          <div class="filter-bar">
            <select id="withdrawStatus">
              <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
              <option value="pending">‚è≥ –û–∂–∏–¥–∞—é—Ç</option>
              <option value="approved">‚úÖ –í—ã–ø–ª–∞—á–µ–Ω–æ</option>
              <option value="rejected">‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω–æ</option>
            </select>
            <input id="withdrawUser" class="input" placeholder="üë§ –ü–æ–∏—Å–∫ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é">
            <button id="applyWithdrawFilter" class="btn">–§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å</button>
          </div>
          <div class="table-container" style="margin-top:20px;overflow-x:auto;border-radius:12px;border:1px solid rgba(148,163,184,0.3)">
            <table class="table" id="withdrawsTable">
              <thead><tr><th>ID</th><th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th><th>–°—É–º–º–∞</th><th>–ü–æ–ª—É—á–∞—Ç–µ–ª—å</th><th>–†–µ–∫–≤–∏–∑–∏—Ç—ã</th><th>–°—Ç–∞—Ç—É—Å</th><th>–î–∞—Ç–∞</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <!-- –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ -->
        <div id="analytics" class="card section" style="display:none">
          <div class="section-header">
            <div>
              <div class="section-title">–î–µ—Ç–∞–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞</div>
              <div class="section-subtitle">–ü–æ–¥—Ä–æ–±–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –æ—Ç—á–µ—Ç—ã</div>
            </div>
            <button class="btn" onclick="generateReport()">üìä –û—Ç—á–µ—Ç</button>
          </div>
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin-top:20px">
            <div class="stat-card">
              <div class="stat-label">üìà –†–æ—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
              <div class="stat-value" id="userGrowth">+0</div>
              <div style="font-size:12px;color:var(--muted);margin-top:4px">–ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">üí∞ –°—Ä–µ–¥–Ω–∏–π —á–µ–∫</div>
              <div class="stat-value" id="avgCheck">0 ‚ÇΩ</div>
              <div style="font-size:12px;color:var(--muted);margin-top:4px">–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">üéØ –ö–æ–Ω–≤–µ—Ä—Å–∏—è</div>
              <div class="stat-value" id="conversionRate">0%</div>
              <div style="font-size:12px;color:var(--muted);margin-top:4px">–ó–∞–¥–∞–Ω–∏—è ‚Üí –í—ã–ø–æ–ª–Ω–µ–Ω–æ</div>
            </div>
          </div>
          <div style="margin-top:32px">
            <div class="section-title" style="font-size:18px;margin-bottom:12px">üõ° –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤</div>
            <div class="section-subtitle">–°–∫–æ–ª—å–∫–æ –∑–∞–¥–∞—á –ø—Ä–æ–≤–µ—Ä–∏–ª –∫–∞–∂–¥—ã–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</div>
            <div id="adminStats" class="admin-list"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    let autoRefreshTimer = null;
    const API_BASE = window.location.origin;
    const token = new URLSearchParams(location.search).get('token') || '';

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–æ–ª—å –∏–∑ —Ç–æ–∫–µ–Ω–∞
    function getRoleFromToken() {
      try {
        const payload = JSON.parse(atob(token.split('.')[1]));
        return payload.role || 'mod';
      } catch (e) {
        return 'mod';
      }
    }

    const userRole = getRoleFromToken();
    document.getElementById('adminRole').textContent = userRole === 'super' ? 'üëë Super Admin' : 'üõ°Ô∏è Moderator';

    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type} active`;
      setTimeout(() => toast.classList.remove('active'), 3200);
    }

    function apiGet(path) {
      const url = API_BASE + path + (path.includes('?') ? '&' : '?') + 'token=' + encodeURIComponent(token);
      return fetch(url).then(r => r.json()).catch(() => null);
    }

    function apiPost(path, body) {
      const url = API_BASE + path + '?token=' + encodeURIComponent(token);
      return fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body || {})
      }).then(r => r.json()).catch(() => null);
    }

    // –ù–∞–≤–∏–≥–∞—Ü–∏—è
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        const name = tab.getAttribute('data-tab');
        document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
        document.getElementById(name).style.display = 'block';
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–∞–∑–¥–µ–ª–∞
        switch(name) {
          case 'dashboard': loadDashboard(); break;
          case 'users': loadUsers(); break;
          case 'tasks': loadTasks(); break;
          case 'topups': loadTopups(); break;
          case 'withdraws': loadWithdraws(); break;
          case 'analytics': loadAnalytics(); break;
        }
      });
    });

    // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
    document.getElementById('btnAutoRefresh').addEventListener('click', () => {
      const indicator = document.getElementById('autoRefreshIndicator');
      if (autoRefreshTimer) {
        clearInterval(autoRefreshTimer);
        autoRefreshTimer = null;
        indicator.classList.remove('on');
        indicator.classList.add('off');
        showToast('–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—ã–∫–ª—é—á–µ–Ω–æ', 'info');
      } else {
        refreshAll();
        autoRefreshTimer = setInterval(refreshAll, 10000);
        indicator.classList.remove('off');
        indicator.classList.add('on');
        showToast('–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ', 'success');
      }
    });

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
    async function loadDashboard() {
      const res = await apiGet('/api/admin/dashboard');
      if (res && res.ok) {
        document.getElementById('numUsers').textContent = res.data.usersCount.toLocaleString();
        document.getElementById('totalRevenue').textContent = res.data.totalRevenue.toLocaleString() + ' ‚ÇΩ';
        document.getElementById('numTasks').textContent = res.data.tasksCount.toLocaleString();
        document.getElementById('pendingCount').textContent = res.data.pendingCount.toLocaleString();
        
        // –ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
        const activity = document.getElementById('recentActivity');
        activity.innerHTML = '';
        res.data.recentActivity.forEach(item => {
          const div = document.createElement('div');
          div.style.padding = '14px';
          div.style.borderBottom = '1px solid rgba(148,163,184,0.2)';
          div.innerHTML = `
            <div style="font-weight:700">${item.type} #${item.id} ‚Äî ${item.amount || ''} ‚ÇΩ ‚Äî ${item.status}</div>
            <div style="color:var(--muted);font-size:12px">${item.user || ''} ‚Ä¢ ${item.created_at || ''}</div>
          `;
          activity.appendChild(div);
        });
      }
    }

    async function loadUsers() {
      const res = await apiGet('/api/admin/users');
      const tbody = document.querySelector('#usersTable tbody');
      tbody.innerHTML = '';
      if (res && res.ok && res.users) {
        res.users.forEach(u => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td><strong>${u.id}</strong></td>
            <td>${u.first_name || '‚Äî'}</td>
            <td>${u.username || '‚Äî'}</td>
            <td><strong style="color:var(--accent)">${(u.balance || 0).toLocaleString()} ‚ÇΩ</strong></td>
            <td>${u.tasks_done || 0}</td>
            <td class="actions">
              <button class="btn-ghost" onclick="viewUserHistory('${u.id}')">üëÅ –ò—Å—Ç–æ—Ä–∏—è</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      }
    }

    async function loadTasks() {
      const res = await apiGet('/api/admin/tasks');
      const tbody = document.querySelector('#tasksTable tbody');
      tbody.innerHTML = '';
      if (res && res.ok && res.tasks) {
        res.tasks.forEach(t => {
          const tr = document.createElement('tr');
          const statusClass = t.status === 'active' ? 'status-active' : 'status-inactive';
          const statusText = t.status === 'active' ? '–ê–∫—Ç–∏–≤–Ω–∞' : '–ó–∞–≤–µ—Ä—à–µ–Ω–∞';
          tr.innerHTML = `
            <td><strong>${t.id}</strong></td>
            <td>${t.type_id}</td>
            <td>${t.title}</td>
            <td>${t.done || 0}/${t.count}</td>
            <td>${t.unit_price} ‚ÇΩ</td>
            <td><strong style="color:var(--accent)">${t.budget} ‚ÇΩ</strong></td>
            <td><span class="status ${statusClass}">${statusText}</span></td>
            <td class="actions">
              <button class="btn-ghost" onclick="viewTaskDetails('${t.id}')">üëÅ</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      }
    }

    async function loadTopups() {
      const status = document.getElementById('filterStatus').value;
      const comment = document.getElementById('filterComment').value.trim();
      const params = new URLSearchParams();
      if (status) params.set('status', status);
      if (comment) params.set('comment', comment);
      
      const res = await apiGet('/api/admin/topups?' + params.toString());
      const tbody = document.querySelector('#topupsTable tbody');
      tbody.innerHTML = '';
      if (res && res.ok && res.items) {
        res.items.forEach(t => {
          const tr = document.createElement('tr');
          const statusClass = t.status === 'paid' ? 'status-paid' : t.status === 'pending' ? 'status-pending' : 'status-refunded';
          const statusText = t.status === 'paid' ? '–û–ø–ª–∞—á–µ–Ω–æ' : t.status === 'pending' ? '–û–∂–∏–¥–∞–µ—Ç' : '–í–æ–∑–≤—Ä–∞—Ç';
          const date = t.created_at ? new Date(t.created_at).toLocaleString('ru') : '‚Äî';
          tr.innerHTML = `
            <td><strong>${t.id}</strong></td>
            <td>${(t.user && t.user.id) || '‚Äî'}</td>
            <td><strong style="color:var(--accent)">${t.amount} ‚ÇΩ</strong></td>
            <td><code style="color:var(--accent)">${t.manual_code || '‚Äî'}</code></td>
            <td><span class="status ${statusClass}">${statusText}</span></td>
            <td>${date}</td>
            <td class="actions"></td>
          `;
          
          const actions = tr.querySelector('.actions');
          if (t.status === 'pending') {
            const approveBtn = document.createElement('button');
            approveBtn.className = 'btn-success';
            approveBtn.textContent = '‚úì –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å';
            approveBtn.onclick = () => processTopup(t.id, 'approve');
            actions.appendChild(approveBtn);

            const refundBtn = document.createElement('button');
            refundBtn.className = 'btn-danger';
            refundBtn.textContent = '‚Ü©Ô∏è –í–æ–∑–≤—Ä–∞—Ç';
            refundBtn.onclick = () => processTopup(t.id, 'reject');
            actions.appendChild(refundBtn);
          }
          
          tbody.appendChild(tr);
        });
      }
    }

    async function loadWithdraws() {
      const status = document.getElementById('withdrawStatus').value;
      const user = document.getElementById('withdrawUser').value.trim();
      const params = new URLSearchParams();
      if (status) params.set('status', status);
      if (user) params.set('user', user);
      
      const res = await apiGet('/api/admin/withdraws?' + params.toString());
      const tbody = document.querySelector('#withdrawsTable tbody');
      tbody.innerHTML = '';
      if (res && res.ok && res.items) {
        res.items.forEach(w => {
          const tr = document.createElement('tr');
          const statusClass = w.status === 'approved' ? 'status-approved' : w.status === 'pending' ? 'status-pending' : 'status-rejected';
          const statusText = w.status === 'approved' ? '–í—ã–ø–ª–∞—á–µ–Ω–æ' : w.status === 'pending' ? '–û–∂–∏–¥–∞–µ—Ç' : '–û—Ç–∫–ª–æ–Ω–µ–Ω–æ';
          const date = w.created_at ? new Date(w.created_at).toLocaleString('ru') : '‚Äî';
          tr.innerHTML = `
            <td><strong>${w.id}</strong></td>
            <td>${(w.user && w.user.id) || '‚Äî'}</td>
            <td><strong style="color:var(--error)">${w.amount} ‚ÇΩ</strong></td>
            <td>${w.name || '‚Äî'}</td>
            <td>${w.details || '‚Äî'}</td>
            <td><span class="status ${statusClass}">${statusText}</span></td>
            <td>${date}</td>
            <td class="actions"></td>
          `;
          
          const actions = tr.querySelector('.actions');
          if (w.status === 'pending') {
            const approveBtn = document.createElement('button');
            approveBtn.className = 'btn-success';
            approveBtn.textContent = 'üí∞ –í—ã–ø–ª–∞—Ç–∏—Ç—å';
            approveBtn.onclick = () => processWithdraw(w.id, 'approve');
            actions.appendChild(approveBtn);

            const rejectBtn = document.createElement('button');
            rejectBtn.className = 'btn-danger';
            rejectBtn.textContent = '‚úñ –û—Ç–∫–ª–æ–Ω–∏—Ç—å';
            rejectBtn.onclick = () => processWithdraw(w.id, 'reject');
            actions.appendChild(rejectBtn);
          }
          
          tbody.appendChild(tr);
        });
      }
    }

    async function loadAnalytics() {
      // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∞–¥–º–∏–Ω–æ–≤
      const adminRes = await apiGet('/api/admin/stats');
      const container = document.getElementById('adminStats');
      container.innerHTML = '';
      container.style.display = 'grid';
      container.style.gridTemplateColumns = 'repeat(auto-fit, minmax(220px, 1fr))';
      container.style.gap = '12px';

      if (adminRes && adminRes.ok && adminRes.admins) {
        const sorted = adminRes.admins.sort((a,b)=> (b.tasks_reviewed||0) - (a.tasks_reviewed||0));
        const max = sorted.length > 0 ? (sorted[0].tasks_reviewed || 1) : 1;
        
        sorted.forEach(admin => {
          const card = document.createElement('div');
          card.className = 'admin-card';
          card.style.padding = '16px';
          card.style.border = '1px solid rgba(148,163,184,0.3)';
          card.style.borderRadius = '12px';
          card.style.background = 'rgba(15,30,54,0.8)';
          
          const progress = Math.round(((admin.tasks_reviewed||0)/max)*100);
          card.innerHTML = `
            <strong>${admin.name || admin.id}</strong>
            <div style="color:var(--muted);font-size:13px;margin-top:6px;">–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ –∑–∞–¥–∞—á: <span style="color:var(--accent); font-weight:700;">${admin.tasks_reviewed||0}</span></div>
            <div style="width:100%;height:8px;border-radius:999px;background:rgba(255,255,255,0.06);overflow:hidden;margin-top:10px;">
              <div style="display:block;height:100%;border-radius:999px;background:linear-gradient(90deg,var(--accent),var(--accent2));width:${progress}%;"></div>
            </div>
            <div style="margin-top:8px;font-size:12px;color:var(--muted);">–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: ${admin.last_check || '‚Äî'}</div>
          `;
          container.appendChild(card);
        });
      }
    }

    // –î–µ–π—Å—Ç–≤–∏—è
    async function processTopup(id, action) {
      if (action === 'approve' && userRole !== 'super') {
        showToast('–¢–æ–ª—å–∫–æ —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω –º–æ–∂–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—Ç—å –ø–ª–∞—Ç–µ–∂–∏', 'error');
        return;
      }
      
      const message = action === 'approve' ? '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ? –ë–∞–ª–∞–Ω—Å –±—É–¥–µ—Ç –Ω–∞—á–∏—Å–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.' : '–û—Ñ–æ—Ä–º–∏—Ç—å –≤–æ–∑–≤—Ä–∞—Ç? –°—Ä–µ–¥—Å—Ç–≤–∞ –æ—Å—Ç–∞–Ω—É—Ç—Å—è –Ω–∞ –±–∞–ª–∞–Ω—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.';
      if (!confirm(message)) return;
      
      const res = await apiPost(`/api/admin/topups/${id}/${action}`, {});
      if (res && res.ok) {
        showToast(action === 'approve' ? '–ü–ª–∞—Ç–µ–∂ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω' : '–í–æ–∑–≤—Ä–∞—Ç –æ—Ñ–æ—Ä–º–ª–µ–Ω', 'success');
        loadTopups();
        loadDashboard();
      } else {
        showToast('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞—Ç–µ–∂–∞', 'error');
      }
    }

    async function processWithdraw(id, action) {
      if (action === 'approve' && userRole !== 'super') {
        showToast('–¢–æ–ª—å–∫–æ —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω –º–æ–∂–µ—Ç –æ–¥–æ–±—Ä—è—Ç—å –≤—ã–≤–æ–¥—ã', 'error');
        return;
      }
      
      const message = action === 'approve' ? '–í—ã–ø–ª–∞—Ç–∏—Ç—å —Å—Ä–µ–¥—Å—Ç–≤–∞? –°–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç —Å –±–∞–ª–∞–Ω—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.' : '–û—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É? –°—Ä–µ–¥—Å—Ç–≤–∞ –±—É–¥—É—Ç –≤–æ–∑–≤—Ä–∞—â–µ–Ω—ã –Ω–∞ –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.';
      if (!confirm(message)) return;
      
      const res = await apiPost(`/api/admin/withdraws/${id}/${action}`, {});
      if (res && res.ok) {
        showToast(action === 'approve' ? '–í—ã–≤–æ–¥ –æ–¥–æ–±—Ä–µ–Ω' : '–ó–∞—è–≤–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞', 'success');
        loadWithdraws();
        loadDashboard();
      } else {
        showToast('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞—è–≤–∫–∏', 'error');
      }
    }

    // –≠–∫—Å–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–π
    function exportData() { window.location.href = API_BASE + '/api/admin/export/all'; }
    function exportUsers() { window.location.href = API_BASE + '/api/admin/export/users'; }
    function exportTasks() { window.location.href = API_BASE + '/api/admin/export/tasks'; }
    function exportTopups() { window.location.href = API_BASE + '/api/admin/export/topups'; }
    function exportWithdraws() { window.location.href = API_BASE + '/api/admin/export/withdraws'; }
    function clearCache() { showToast('–ö–µ—à –æ—á–∏—â–µ–Ω', 'success'); }
    function backupData() { window.location.href = API_BASE + '/api/admin/backup'; }
    function generateReport() { window.location.href = API_BASE + '/api/admin/report'; }

    function viewUserHistory(userId) {
      window.open(API_BASE + `/admin/user.html?id=${userId}`, '_blank');
    }

    function viewTaskDetails(taskId) {
      window.open(API_BASE + `/admin/task.html?id=${taskId}`, '_blank');
    }

    // –§–∏–ª—å—Ç—Ä—ã
    document.getElementById('applyFilter').addEventListener('click', loadTopups);
    document.getElementById('applyWithdrawFilter').addEventListener('click', loadWithdraws);
    document.getElementById('applyUserFilter').addEventListener('click', loadUsers);
    document.getElementById('applyTaskFilter').addEventListener('click', loadTasks);
    document.getElementById('btnRefresh').addEventListener('click', () => {
      showToast('üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö...', 'info');
      refreshAll();
    });

    function refreshAll() {
      const activeSection = document.querySelector('.tab.active').getAttribute('data-tab');
      switch(activeSection) {
        case 'dashboard': loadDashboard(); break;
        case 'users': loadUsers(); break;
        case 'tasks': loadTasks(); break;
        case 'topups': loadTopups(); break;
        case 'withdraws': loadWithdraws(); break;
        case 'analytics': loadAnalytics(); break;
      }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    loadDashboard();
  </script>
</body>
</html>
