<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ReviewCash — Admin</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<style>
  body{margin:0;font-family:Inter,Arial;background:linear-gradient(180deg,#050017,#02101b);color:#eaf7fb;padding:18px}
  .wrap{max-width:1200px;margin:0 auto;display:grid;grid-template-columns:1fr 360px;gap:18px}
  .panel{background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:left}
  th{color:#9fb6c6}
  .btn{padding:8px 10px;border-radius:8px;border:none;cursor:pointer}
  .approve{background:#00ff9d;color:#012226}
  .reject{background:#ff6b80;color:white}
  .small{font-size:13px;color:#9fb6c6}
  .admins-list{display:flex;flex-direction:column;gap:8px}
  .admin-row{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;background:rgba(255,255,255,0.02)}
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:9999}
  .modal .box{background:#041726;padding:16px;border-radius:10px;width:640px;max-width:95%}
  textarea,input{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:#eaf7fb}
</style>
</head>
<body>
  <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
    <div style="width:56px;height:56px;border-radius:10px;background:linear-gradient(90deg,#00f0ff,#00ff9d);display:flex;align-items:center;justify-content:center;color:#012226;font-weight:900">RC</div>
    <div>
      <h2 style="margin:0">Админ-панель</h2>
      <div class="small">Живые события и управление</div>
    </div>
    <div style="margin-left:auto" id="whoami" class="small">Token: <span id="tokshort">—</span></div>
  </div>

  <div class="wrap">
    <main>
      <div class="panel" style="margin-bottom:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>Пополнения</strong>
          <div><input id="searchTopup" placeholder="Поиск..." style="padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.03);color:#eaf7fb" /></div>
        </div>
        <div style="margin-top:10px;max-height:260px;overflow:auto">
          <table id="topupsTable"><thead><tr><th>ID</th><th>Пользователь</th><th>Сумма</th><th>Статус</th><th>Действия</th></tr></thead><tbody></tbody></table>
        </div>
      </div>

      <div class="panel" style="margin-bottom:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>Выводы</strong>
          <div class="small">Проверяйте аккуратно</div>
        </div>
        <div style="margin-top:10px;max-height:260px;overflow:auto">
          <table id="withdrawsTable"><thead><tr><th>ID</th><th>Пользователь</th><th>Сумма</th><th>Реквизиты</th><th>Действия</th></tr></thead><tbody></tbody></table>
        </div>
      </div>

      <div class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>Поддержка</strong>
        </div>
        <div style="margin-top:10px;max-height:360px;overflow:auto">
          <table id="supportsTable"><thead><tr><th>ID</th><th>Пользователь</th><th>Сообщение</th><th>Статус</th><th>Действия</th></tr></thead><tbody></tbody></table>
        </div>
      </div>
    </main>

    <aside>
      <div class="panel" style="margin-bottom:12px">
        <strong>Статистика</strong>
        <div class="small" style="margin-top:8px">Топапов: <span id="statTopups">0</span></div>
        <div class="small" style="margin-top:6px">Выводов: <span id="statWithdraws">0</span></div>
        <div class="small" style="margin-top:6px">Support: <span id="statSupports">0</span></div>
      </div>

      <div class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>Админы</strong>
          <div class="small">Кто и сколько support обработал</div>
        </div>
        <div id="adminsPanel" style="margin-top:10px" class="admins-list">Загрузка...</div>
      </div>
    </aside>
  </div>

  <!-- Reply modal -->
  <div id="replyModal" class="modal">
    <div class="box">
      <h3 id="replyTitle">Ответ пользователю</h3>
      <div class="small" id="replyOrig"></div>
      <textarea id="replyText" placeholder="Текст ответа"></textarea>
      <div style="margin-top:10px;text-align:right">
        <button id="replySend" class="btn approve">Отправить</button>
        <button id="replyClose" class="btn reject">Отмена</button>
      </div>
    </div>
  </div>

<script>
function qs(name){ return new URLSearchParams(location.search).get(name); }
const token = qs('token') || '';
document.getElementById('tokshort').textContent = token ? token.slice(0,28)+'...' : 'нет';

async function safeFetch(path, opts={}) {
  const url = path + (path.includes('?')? '&':'?') + 'token=' + encodeURIComponent(token);
  const res = await fetch(url, opts);
  if(!res.ok) throw await res.text();
  return await res.json();
}

/* Load topups, withdraws, supports, admins */
async function loadTopups(){
  try {
    const data = await safeFetch('/api/topups');
    const tbody = document.querySelector('#topupsTable tbody'); tbody.innerHTML='';
    data.forEach(t=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${t.id}</td><td>${t.user.username||t.user.id||'—'}</td><td>${t.amount||0} ₽</td><td>${t.status||''}</td><td></td>`;
      const actions = tr.querySelector('td:last-child');
      if(t.status === 'pending'){
        const ok = document.createElement('button'); ok.className='btn approve'; ok.textContent='Одобрить';
        ok.onclick = async ()=> { await safeFetch(`/api/topups/${encodeURIComponent(t.id)}/approve`, { method:'POST' }); loadTopups(); loadAdmins(); };
        const rej = document.createElement('button'); rej.className='btn reject'; rej.textContent='Отклонить';
        rej.onclick = async ()=> { await safeFetch(`/api/topups/${encodeURIComponent(t.id)}/reject`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({reason:'Отклонено'})}); loadTopups(); };
        actions.appendChild(ok); actions.appendChild(rej);
      } else { actions.textContent='—' }
      tbody.appendChild(tr);
    });
    document.getElementById('statTopups').textContent = data.length;
  } catch(e){ console.error(e); }
}

async function loadWithdraws(){
  try {
    const data = await safeFetch('/api/withdraws');
    const tbody = document.querySelector('#withdrawsTable tbody'); tbody.innerHTML='';
    data.forEach(w=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${w.id}</td><td>${w.user.username||w.user.id||'—'}</td><td>${w.amount||0} ₽</td><td>${w.name||''} / ${w.bank||''}</td><td></td>`;
      const actions = tr.querySelector('td:last-child');
      if(w.status === 'pending'){
        const ok = document.createElement('button'); ok.className='btn approve'; ok.textContent='Выплатить';
        ok.onclick = async ()=> { await safeFetch(`/api/withdraws/${encodeURIComponent(w.id)}/approve`, { method:'POST' }); loadWithdraws(); loadAdmins(); };
        const rej = document.createElement('button'); rej.className='btn reject'; rej.textContent='Отклонить';
        rej.onclick = async ()=> { await safeFetch(`/api/withdraws/${encodeURIComponent(w.id)}/reject`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({reason:'Отклонено'})}); loadWithdraws(); loadAdmins(); };
        actions.appendChild(ok); actions.appendChild(rej);
      } else actions.textContent='—';
      tbody.appendChild(tr);
    });
    document.getElementById('statWithdraws').textContent = data.length;
  } catch(e){ console.error(e); }
}

async function loadSupports(){
  try {
    const data = await safeFetch('/api/supports');
    const tbody = document.querySelector('#supportsTable tbody'); tbody.innerHTML='';
    data.forEach(s=>{
      const tr = document.createElement('tr');
      const short = (s.message||'').slice(0,120) + ((s.message||'').length>120?'…':'');
      tr.innerHTML = `<td>${s.id}</td><td>${s.user.username||s.user.id||'—'}</td><td title="${s.message||''}">${short}</td><td>${s.status||''}</td><td></td>`;
      const actions = tr.querySelector('td:last-child');
      const rep = document.createElement('button'); rep.className='btn approve'; rep.textContent='Ответить';
      rep.onclick = ()=> openReply(s.id, s.message || '');
      const closeBtn = document.createElement('button'); closeBtn.className='btn reject'; closeBtn.textContent='Закрыть';
      closeBtn.onclick = async ()=> { await safeFetch(`/api/supports/${encodeURIComponent(s.id)}/resolve`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({reason:'Закрыто админом'})}); loadSupports(); loadAdmins(); };
      actions.appendChild(rep); actions.appendChild(closeBtn);
      tbody.appendChild(tr);
    });
    document.getElementById('statSupports').textContent = data.length;
  } catch(e){ console.error(e); }
}

async function loadAdmins(){
  try {
    const res = await safeFetch('/api/admins');
    if(!res.ok) throw 'no';
    const arr = res.admins || [];
    const panel = document.getElementById('adminsPanel'); panel.innerHTML='';
    arr.forEach(a=>{
      const div = document.createElement('div'); div.className='admin-row';
      div.innerHTML = `<div><strong>${a.id_or_username}</strong><div class="small">${a.is_main? 'Главный':'Обычный'}</div></div><div style="text-align:right"><div style="font-weight:800">${a.supports_handled||0}</div><div class="small">support обработано</div></div>`;
      panel.appendChild(div);
    });
  } catch(e){ console.error(e); document.getElementById('adminsPanel').innerHTML = '<div class="small">Ошибка</div>'; }
}

/* Reply modal */
function openReply(id, orig){
  document.getElementById('replyModal').style.display='flex';
  document.getElementById('replyOrig').textContent = orig;
  document.getElementById('replyText').value = '';
  window._replyTarget = id;
}
document.getElementById('replyClose').onclick = ()=> document.getElementById('replyModal').style.display='none';
document.getElementById('replySend').onclick = async ()=>{
  const txt = document.getElementById('replyText').value.trim();
  if(!txt) { alert('Введите ответ'); return; }
  try {
    await safeFetch(`/api/supports/${encodeURIComponent(window._replyTarget)}/reply`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({message: txt})});
    alert('Ответ отправлен');
    document.getElementById('replyModal').style.display='none';
    loadSupports(); loadAdmins();
  } catch(e){ alert('Ошибка'); }
};

/* Initial load */
(async function(){ await Promise.all([loadTopups(), loadWithdraws(), loadSupports(), loadAdmins()]); })();

</script>
</body>
</html>
