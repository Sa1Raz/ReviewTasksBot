<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>ReviewCash • Admin Panel</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700;800&display=swap" rel="stylesheet">
  <style>
    body{font-family:Inter,system-ui, -apple-system, sans-serif;background:#0b1220;color:#e6f2ff;padding:18px}
    .container{max-width:1200px;margin:0 auto}
    .card{background:linear-gradient(180deg,#071025,#0f1930);padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);margin-bottom:12px}
    .header{display:flex;align-items:center;gap:12px}
    .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(90deg,#22c55e,#0ea5e9);display:flex;align-items:center;justify-content:center;font-weight:900;color:#022}
    .title h1{margin:0;font-size:20px}
    .muted{color:#9fb0c9}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,0.04);text-align:left}
    .btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
    .btn-approve{background:#16a34a;color:white}
    .btn-reject{background:#ef4444;color:white}
    .qr-img{max-width:140px;border-radius:8px}
  </style>
</head>
<body>
  <div class="container">
    <div class="header card">
      <div class="logo">RC</div>
      <div class="title"><h1>Admin Panel — ReviewCash</h1><div class="muted">Управление пополнениями и выводами</div></div>
      <div style="margin-left:auto"><button onclick="loadTopups()" class="btn">Обновить</button></div>
    </div>

    <div class="card">
      <h3>Пополнения (ожидают проверки)</h3>
      <table id="topupsTable">
        <thead><tr><th>ID</th><th>UID</th><th>Сумма</th><th>Код</th><th>QR</th><th>Статус</th><th>Действия</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="card">
      <h3>Выводы</h3>
      <table id="withdrawsTable"><thead><tr><th>ID</th><th>UID</th><th>Сумма</th><th>ФИО</th><th>Реквизиты</th><th>Статус</th><th>Действия</th></tr></thead><tbody></tbody></table>
    </div>

    <div class="card">
      <h3>Создать задачу</h3>
      <input id="adminTitle" placeholder="Заголовок" style="width:40%;padding:8px;border-radius:8px;margin-right:8px">
      <input id="adminReward" placeholder="Цена" type="number" style="width:120px;padding:8px;border-radius:8px;margin-right:8px">
      <button onclick="createTask()" class="btn">Создать</button>
    </div>
  </div>

<script>
const API = '/api';
async function loadTopups(){
  const res = await fetch(API + '/admin/topups');
  const j = await res.json();
  const tbody = document.querySelector('#topupsTable tbody');
  tbody.innerHTML = '';
  if(!j.ok) return;
  j.items.forEach(t => {
    const tr = document.createElement('tr');
    const qrImg = t.pay_link ? `<img class="qr-img" src="${t.qr_base64 || ''}" alt="QR">` : (t.qr_base64 ? `<img class="qr-img" src="${t.qr_base64}">` : '');
    tr.innerHTML = `<td>${t.id}</td><td>${t.uid || (t.user && t.user.id)}</td><td>${t.amount}</td><td><code>${t.manual_code||'—'}</code></td>
      <td>${qrImg}</td><td>${t.status}</td><td></td>`;
    const actions = tr.querySelector('td:last-child');
    if(t.status === 'waiting_for_payment' || t.status === 'pending'){
      const ok = document.createElement('button'); ok.className='btn btn-approve'; ok.textContent='✓ Подтвердить';
      ok.onclick = async ()=> { await fetch(API + `/admin/topups/${t.id}/approve`, {method:'POST'}); loadTopups(); };
      const rej = document.createElement('button'); rej.className='btn btn-reject'; rej.textContent='✖ Отклонить';
      rej.style.marginLeft='8px'; rej.onclick = async ()=> { await fetch(API + `/admin/topups/${t.id}/reject`, {method:'POST'}); loadTopups(); };
      actions.appendChild(ok); actions.appendChild(rej);
    }
    tbody.appendChild(tr);
  });
}

async function loadWithdraws(){
  const res = await fetch(API + '/admin/withdraws');
  const j = await res.json();
  const tbody = document.querySelector('#withdrawsTable tbody');
  tbody.innerHTML = '';
  if(!j.ok) return;
  j.items.forEach(w=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${w.id}</td><td>${(w.user||{}).id}</td><td>${w.amount}</td><td>${w.name}</td><td>${w.details}</td><td>${w.status}</td><td></td>`;
    const actions = tr.querySelector('td:last-child');
    if(w.status === 'pending'){
      const ok = document.createElement('button'); ok.className='btn btn-approve'; ok.textContent='Выплатить';
      ok.onclick = async ()=> { await fetch(API + `/admin/withdraws/${w.id}/approve`, {method:'POST'}); loadWithdraws(); };
      const rej = document.createElement('button'); rej.className='btn btn-reject'; rej.textContent='Отклонить';
      rej.style.marginLeft='8px'; rej.onclick = async ()=> { await fetch(API + `/admin/withdraws/${w.id}/reject`, {method:'POST'}); loadWithdraws(); };
      actions.appendChild(ok); actions.appendChild(rej);
    }
    tbody.appendChild(tr);
  });
}

async function createTask(){
  const title = document.getElementById('adminTitle').value||'';
  const reward = Number(document.getElementById('adminReward').value||0);
  if(!title||!reward){ alert('Заполните поля'); return; }
  const res = await fetch(API + '/admin/task-create', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({title, reward})});
  const j = await res.json();
  if(j.ok){ alert('Задание создано'); }
  loadTopups(); loadWithdraws();
}

loadTopups(); loadWithdraws();
</script>
</body>
</html>
