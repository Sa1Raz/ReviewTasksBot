<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
  <title>–ú–æ–¥–µ—Ä–∞—Ü–∏—è ‚Äî ReviewCash</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="/socket.io/socket.io.js"></script>
  <style>
    body{font-family:'Inter',sans-serif;background:#0d1624;color:#e6f2ff;margin:0;padding:18px}
    .container{max-width:720px;margin:0 auto}
    .card{background:#091227;padding:18px;border-radius:12px;margin-bottom:12px;border:1px solid rgba(255,255,255,0.03)}
    .title{font-weight:800;font-size:20px;margin-bottom:8px}
    .muted{color:#9fb0c9}
    .proof-img{max-width:100%;border-radius:8px;margin-top:8px}
    .actions{display:flex;gap:8px;margin-top:12px}
    .btn{padding:10px 12px;border-radius:8px;border:none;cursor:pointer}
    .btn-approve{background:#16a34a;color:#011}
    .btn-reject{background:#ef4444;color:white}
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="title">üõ° –ú–æ–¥–µ—Ä–∞—Ü–∏—è –æ—Ç–∑—ã–≤–æ–≤</div>
      <div class="muted" id="adminName">–í—ã: ‚Äî</div>
    </div>

    <div id="reviewCard" class="card" style="display:none;">
      <div>ID: <b id="reviewId">‚Äî</b></div>
      <div>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <span id="userId">‚Äî</span></div>
      <div style="font-weight:700;margin-top:8px" id="reviewTitle">‚Äî</div>
      <div class="muted" id="siteName"></div>
      <div class="proof" id="proofBox"></div>
      <div class="actions">
        <button class="btn btn-reject" id="btnReject">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
        <button class="btn btn-approve" id="btnApprove">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
      </div>
    </div>

    <div id="empty" class="card" style="display:none">–û—á–µ—Ä–µ–¥—å –ø—É—Å—Ç–∞. <button onclick="loadNextTask()">–û–±–Ω–æ–≤–∏—Ç—å</button></div>

    <div class="card">
      <div>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
      <div style="display:flex;gap:12px;margin-top:8px">
        <div style="flex:1;background:#071028;padding:10px;border-radius:8px">–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ: <b id="statDone">0</b></div>
        <div style="flex:1;background:#071028;padding:10px;border-radius:8px">–í –æ—á–µ—Ä–µ–¥–∏: <b id="statQueue">0</b></div>
      </div>
    </div>
  </div>

<script>
const token = new URLSearchParams(location.search).get('token') || '';
async function api(path, method='GET', body=null){
  const opts = {headers: {}};
  if(method !== 'GET'){ opts.method = method; opts.headers['Content-Type'] = 'application/json'; opts.body = JSON.stringify(body); }
  const res = await fetch(path + (path.includes('?') ? '&' : '?') + 'token=' + encodeURIComponent(token), opts);
  return await res.json();
}

async function loadStats(){
  const res = await api('/api/moderator/me');
  if(res && res.ok){ document.getElementById('adminName').textContent = '–í—ã: ' + (res.name || '–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä'); document.getElementById('statDone').textContent = res.tasks_reviewed || 0; }
}

let currentAssignmentId = null;
async function loadNextTask(){
  const res = await api('/api/moderator/queue');
  if(!res || !res.ok || !res.assignment){ document.getElementById('reviewCard').style.display='none'; document.getElementById('empty').style.display='block'; document.getElementById('statQueue').textContent='0'; return; }
  document.getElementById('empty').style.display='none';
  document.getElementById('reviewCard').style.display='block';
  const a = res.assignment;
  currentAssignmentId = a.id;
  document.getElementById('statQueue').textContent = res.queue_length || 0;
  document.getElementById('reviewId').textContent = a.id;
  document.getElementById('userId').textContent = a.user_id;
  document.getElementById('reviewTitle').textContent = a.task_title || '';
  document.getElementById('siteName').textContent = a.site_name || '';
  const proofBox = document.getElementById('proofBox');
  if(a.proof_type === 'image' && a.proof_data){
    proofBox.innerHTML = `<img src="${a.proof_data}" class="proof-img">`;
  } else if(a.proof_type === 'link' && a.proof_data){
    proofBox.innerHTML = `<a href="${a.proof_data}" target="_blank">${a.proof_data}</a>`;
  } else { proofBox.innerHTML = `<div class="muted">–ù–µ—Ç –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤</div><div>${a.proof_data||''}</div>`; }
}

document.getElementById('btnApprove').addEventListener('click', async ()=>{
  if(!currentAssignmentId) return;
  if(!confirm('–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –æ—Ç–∑—ã–≤?')) return;
  const res = await api('/api/moderator/approve','POST',{id: currentAssignmentId});
  if(res && res.ok){ alert('–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ'); loadNextTask(); loadStats(); } else alert('–û—à–∏–±–∫–∞');
});

document.getElementById('btnReject').addEventListener('click', async ()=>{
  if(!currentAssignmentId) return;
  const reason = prompt('–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–∞–∑–∞','–ù–µ–≤–µ—Ä–Ω—ã–π –æ—Ç–∑—ã–≤');
  if(!reason) return;
  const res = await api('/api/moderator/reject','POST',{id: currentAssignmentId, reason});
  if(res && res.ok){ alert('–û—Ç–∫–ª–æ–Ω–µ–Ω–æ'); loadNextTask(); loadStats(); } else alert('–û—à–∏–±–∫–∞');
});

const sock = io({ transports: ['websocket'] });
sock.on('connect', ()=> console.log('sock connected'));
sock.on('new_review', ()=> loadNextTask());
sock.on('disconnect', ()=> console.log('sock disconnected'));

loadStats();
loadNextTask();
</script>
</body>
</html>
