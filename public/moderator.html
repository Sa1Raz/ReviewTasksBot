<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
  <title>–ú–æ–¥–µ—Ä–∞—Ü–∏—è –æ—Ç–∑—ã–≤–æ–≤ ‚Äî ReviewCash</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="/socket.io/socket.io.js"></script>
  <style>
    :root{
      --bg: #141e2f; --panel: #1e293b; --panel-light: #223353; --accent: #3b82f6; --success: #10b981;
      --error: #ef4444; --text: #e8effa; --muted: #a1accf; --radius: 18px; --transition:.19s cubic-bezier(.67,1.3,.22,0.85);
    }
    body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);margin:0;padding:0;}
    .container{max-width:520px;margin:33px auto;padding:18px;}
    .main-title{font-weight:900;font-size:24px;letter-spacing:.01em;margin-bottom:7px;}
    .subtitle{font-size:15px;color:var(--muted);margin-bottom:16px;}
    .card{background:var(--panel);border-radius:var(--radius);box-shadow:0 10px 45px rgba(16,24,32,0.22);padding:25px 23px 20px;margin-bottom:22px;}
    .review-id-title{font-weight:600;font-size:14px;color:var(--muted);}
    .review-user{font-size:13px;color:var(--accent);margin-bottom:5px;}
    .review-title{font-weight:700;font-size:18px;margin:5px 0 8px 0;}
    .review-meta{font-size:13px;color:var(--muted);}
    .review-link{display:block;background:var(--panel-light);padding:8px 10px 4px 10px;border-radius:12px;margin-bottom:6px;font-size:14px;word-break:break-all;}
    .proof-box{background:var(--panel-light);border-radius:11px;padding:13px 9px;margin-bottom:10px;}
    .proof-link{color:var(--accent);}
    .proof-img{border-radius:12px;max-width: 100%;}
    .actions{display:flex;gap:9px;margin:20px 0 12px;}
    .btn{border:none;outline:none;font-family:inherit;font-weight:800;font-size:17px;padding:15px 0;border-radius:12px;flex:1;cursor:pointer;transition:var(--transition);}
    .btn-approve{background:linear-gradient(90deg,var(--success) 60%,#28ffc1 110%);color:#111;}
    .btn-reject{background:linear-gradient(90deg,var(--error) 60%,#ff4c4c 120%);color:#fff;}
    .btn:active{transform:scale(0.98);}
    .stats{display:flex;gap:11px;margin-top:24px;}
    .stat-box{background:var(--panel-light);padding:11px 0;border-radius:11px;flex:1;text-align:center;}
    .stat-num{font-weight:900;font-size:22px;color:var(--accent);}
    .stat-label{font-size:13px;color:var(--muted);}
    .empty-state{text-align:center;padding:66px 0 34px;color:var(--muted);}
    .modal{position:fixed;inset:0;backdrop-filter:blur(1.5px);background:rgba(30,38,60,0.82);display:none;align-items:center;justify-content:center;}
    .modal.active{display:flex;}
    .modal-card{background:var(--panel);border-radius:16px;box-shadow:0 10px 45px rgba(30,40,60,0.15);padding:30px 28px 21px;width:90vw;max-width:400px;text-align:center;}
    .modal-btn{margin-top:25px;font-size:16px;padding:10px 26px;}
    @media (max-width: 600px){
      .container{padding:0;}
      .card{padding:17px 7px;}
    }
  </style>
</head>
<body>
  <div class="container">
    <div>
      <div class="main-title">üõ° –ú–æ–¥–µ—Ä–∞—Ü–∏—è –æ—Ç–∑—ã–≤–æ–≤</div>
      <div class="subtitle" id="adminName">–í—ã –ø—Ä–æ–≤–µ—Ä—è–µ—Ç–µ: ‚Äî</div>
    </div>
    <div id="reviewCard" class="card" style="display:none;">
      <div class="review-id-title" id="reviewId">ID: ‚Äî</div>
      <div class="review-user">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <span id="userId">‚Äî</span></div>
      <div class="review-title" id="reviewTitle"></div>
      <div class="review-link">
        –°—Å—ã–ª–∫–∞<br>
        <a href="#" id="reviewTarget" target="_blank" style="color:var(--accent);font-weight:600;text-decoration:underline;">–ü–µ—Ä–µ–π—Ç–∏ –∫ –æ—Ç–∑—ã–≤—É</a>
      </div>
      <div class="review-meta" id="siteName"></div>
      <div class="proof-box" id="proofBox"></div>
      <div class="actions">
        <button class="btn btn-reject" id="btnReject">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
        <button class="btn btn-approve" id="btnApprove">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
      </div>
    </div>
    <div id="emptyState" class="empty-state" style="display:none;">
      <div style="font-size:34px;margin-bottom:5px;">üéâ</div>
      –í—Å–µ –∑–∞—è–≤–∫–∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã!
      <div style="margin:13px 0 0;"><button onclick="loadNextTask()" style="border-radius:10px;border:1px solid #334155;font-weight:600;padding:7px 21px;color:white;background:transparent;cursor:pointer;font-size:15px;">–û–±–Ω–æ–≤–∏—Ç—å –æ—á–µ—Ä–µ–¥—å</button></div>
    </div>
    <div class="stats">
      <div class="stat-box">
        <div class="stat-num" id="statDone">0</div>
        <div class="stat-label">–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ –≤–∞–º–∏</div>
      </div>
      <div class="stat-box">
        <div class="stat-num" id="statQueue">0</div>
        <div class="stat-label">–í –æ—á–µ—Ä–µ–¥–∏</div>
      </div>
    </div>
  </div>
  <!-- –ú–æ–¥–∞–ª–∫–∞ -->
  <div id="modal" class="modal">
    <div class="modal-card">
      <div id="modalMsg"></div>
      <button class="btn btn-approve modal-btn" onclick="closeModal()">OK</button>
    </div>
  </div>
<script>
const token = new URLSearchParams(location.search).get('token');
let currentAssignmentId = null;
async function api(path, method='GET', body=null){
  try {
    const opts = {headers: {'Authorization':'Bearer '+token}};
    if(method!=='GET'){opts.method=method;opts.headers['Content-Type']='application/json';if(body)opts.body=JSON.stringify(body);}
    const res = await fetch(path + '?token=' + token, opts); return await res.json();
  } catch(e){return null;}
}
async function loadStats() {
  const res = await api('/api/moderator/me');
  if(res && res.ok) {
    document.getElementById('adminName').textContent = `–í—ã: ${res.name || '–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä'}`;
    document.getElementById('statDone').textContent = res.tasks_reviewed || 0;
  }
}
function showModal(msg){
  document.getElementById('modalMsg').textContent = msg;
  document.getElementById('modal').classList.add('active');
}
function closeModal(){
  document.getElementById('modal').classList.remove('active');
}
async function loadNextTask() {
  const res = await api('/api/moderator/queue');
  if(!res || !res.ok || !res.assignment){
    document.getElementById('reviewCard').style.display = 'none';
    document.getElementById('emptyState').style.display = 'block';
    document.getElementById('statQueue').textContent = '0';
    return;
  }
  document.getElementById('emptyState').style.display = 'none';
  document.getElementById('reviewCard').style.display = 'block';
  const a = res.assignment;
  currentAssignmentId = a.id;
  document.getElementById('statQueue').textContent = res.queue_length || 1;
  document.getElementById('reviewId').textContent = `ID: ${a.id}`;
  document.getElementById('userId').textContent = a.user_id || '‚Äî';
  document.getElementById('reviewTitle').textContent = a.task_title || '';
  document.getElementById('reviewTarget').href = a.review_target || "#";
  document.getElementById('reviewTarget').textContent = (a.review_target || '').substring(0, 80) || '-';
  document.getElementById('siteName').textContent = a.site_name || '';
  // –î–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ:
  const proofBox = document.getElementById('proofBox');
  if(a.proof_type === 'image' && a.proof_data) {
    proofBox.innerHTML = `<img src="${a.proof_data}" alt="–§–æ—Ç–æ" class="proof-img">`;
  } else if (a.proof_type === 'link' && a.proof_data) {
    proofBox.innerHTML = `<a href="${a.proof_data}" target="_blank" class="proof-link">${a.proof_data}</a>
      <div style="color:var(--muted);font-size:12px;">–ö–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞</div>`;
  } else {
    proofBox.innerHTML = `<div style="color:var(--muted);font-style:italic;">–ù–µ—Ç –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞ (—Ç–µ–∫—Å—Ç –∏–ª–∏ –ø—É—Å—Ç–æ)</div>
      <div style="margin-top:8px;font-size:14px;color:#fff;">${a.proof_data || ''}</div>`;
  }
}
document.getElementById('btnApprove').onclick = async ()=>{
  if(!currentAssignmentId)return;
  if(!confirm('–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –æ—Ç–∑—ã–≤–∞? –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞—á–∏—Å–ª–∏—Ç—å –Ω–∞–≥—Ä–∞–¥—É.'))return;
  const resp = await api('/api/moderator/approve','POST',{id: currentAssignmentId});
  if(resp && resp.ok){ showModal("–ó–∞—è–≤–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞! –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∏–ª –Ω–∞–≥—Ä–∞–¥—É."); loadNextTask(); loadStats(); } else { showModal("–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏!"); }
};
document.getElementById('btnReject').onclick = async ()=>{
  if(!currentAssignmentId)return;
  const reason = prompt('–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–∞–∑–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:','–ù–µ–≤–µ—Ä–Ω—ã–π/–£–¥–∞–ª—ë–Ω–Ω—ã–π –æ—Ç–∑—ã–≤');
  if(!reason)return;
  const resp = await api('/api/moderator/reject','POST',{id:currentAssignmentId,reason});
  if(resp && resp.ok){ showModal("–ó–∞—è–≤–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞."); loadNextTask(); loadStats(); } else { showModal("–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏!"); }
};
const socket = io({ auth: { token }, transports: ['websocket'] });
socket.on('new_work', ()=>loadNextTask());
socket.on('disconnect', ()=>console.log('Socket disconnect'));
loadStats();
loadNextTask();
</script>
</body>
</html>
