<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>ReviewCash — Зарабатывай на отзывах</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
  <script src="/socket.io/socket.io.js"></script>
  <style>
    :root{ --bg:#020617; --card:rgba(15,23,42,0.96); --accent1:#22c55e; --accent2:#0ea5e9; --muted:#94a3b8; --text:#e2f3ff; --radius:18px; --glass-border:1px solid rgba(148,163,184,0.14); }
    *{box-sizing:border-box} body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto;color:var(--text);background:linear-gradient(145deg,#020617,#020817);padding:16px;min-height:100vh}
    .container{max-width:760px;margin:0 auto}
    .status-bar{display:flex;align-items:center;justify-content:space-between;padding:8px;border-radius:999px;border:var(--glass-border);background:rgba(255,255,255,0.02);margin-bottom:18px}
    .app-pill{display:flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;font-weight:700}
    .balance-chip{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.02);display:flex;align-items:center;gap:8px}
    .card{background:var(--card);border-radius:20px;padding:20px;border:var(--glass-border);margin-bottom:18px}
    .tabs{display:flex;gap:8px;margin-bottom:12px}
    .tab{flex:1;padding:10px;border-radius:999px;text-align:center;background:rgba(255,255,255,0.02);cursor:pointer;font-weight:800}
    .tab.active{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#021018}
    .avatar{width:92px;height:92px;border-radius:50%;margin:0 auto 10px;background:linear-gradient(180deg,#0f1724,#020617);display:flex;align-items:center;justify-content:center;border:4px solid rgba(34,197,94,0.14)}
    .avatar img{width:100%;height:100%;object-fit:cover;border-radius:50%}
    .balance{font-weight:900;font-size:44px;text-align:center;background:linear-gradient(90deg,var(--accent1),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .action-row{display:flex;gap:10px;margin-top:12px}
    .action-btn{flex:1;padding:12px;border-radius:999px;text-align:center;font-weight:800;cursor:pointer;background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#021018;border:none}
    .action-btn.ghost{background:rgba(255,255,255,0.02);border:var(--glass-border);color:var(--text)}
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,0.75);backdrop-filter:blur(6px);z-index:9999;padding:16px}
    .modal.open{display:flex}
    .modal-card{width:100%;max-width:640px;background:var(--card);border-radius:16px;padding:20px;border:var(--glass-border)}
    .close-btn{position:absolute;right:12px;top:10px;background:transparent;border:none;color:var(--muted);font-size:24px;cursor:pointer}
    input[type="number"], input[type="text"]{width:100%;padding:12px;border-radius:12px;border:var(--glass-border);background:rgba(255,255,255,0.02);color:var(--text);margin-top:8px}
    .topup-amount-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:10px}
    .amount-btn{padding:12px;border-radius:12px;background:rgba(255,255,255,0.02);border:var(--glass-border);font-weight:800;cursor:pointer}
    .sbp-details{background:linear-gradient(90deg, rgba(14,165,233,0.03), rgba(34,197,94,0.03));padding:12px;border-radius:10px;margin-top:12px}
    .tasks-list{display:flex;flex-direction:column;gap:10px;margin-top:12px}
    .task-item{background:rgba(255,255,255,0.02);padding:12px;border-radius:12px;display:flex;justify-content:space-between;align-items:center}
    .fab{position:fixed;right:20px;bottom:90px;width:56px;height:56px;border-radius:999px;background:linear-gradient(90deg,var(--accent1),var(--accent2));display:flex;align-items:center;justify-content:center;font-weight:900;color:#021018;cursor:pointer}
    .bottom-nav{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:rgba(255,255,255,0.02);padding:8px;border-radius:999px;border:var(--glass-border);display:flex;gap:8px}
    .nav-item{padding:8px 12px;border-radius:999px;color:var(--muted);cursor:pointer}
    .nav-item.active{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#021018}
    .muted{color:var(--muted)}
    .small{font-size:13px}
    .qr-img{max-width:180px;border-radius:12px;display:block;margin:12px auto}
    .spinner{display:inline-block;width:18px;height:18px;border-radius:50%;border:3px solid rgba(255,255,255,0.08);border-top-color:var(--text);animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    @media(max-width:520px){ .balance{font-size:36px} .avatar{width:80px;height:80px} }
  </style>
</head>
<body>
  <div class="container" id="app">
    <div class="status-bar">
      <div class="app-pill"><span style="width:8px;height:8px;border-radius:999px;background:linear-gradient(90deg,#bbf7d0,#22c55e);display:inline-block"></span> ReviewCash</div>
      <div class="balance-chip" aria-live="polite"><span id="headerBalanceText">0 ₽</span></div>
    </div>

    <!-- Tabs -->
    <div class="card">
      <div class="tabs" role="tablist">
        <div class="tab active" data-tab="tasks">Мои задания</div>
        <div class="tab" data-tab="profile">Профиль</div>
      </div>

      <!-- Tasks content -->
      <div id="tasksPanel">
        <div id="tasksEmpty" class="empty-state" style="text-align:center;padding:24px;border-radius:12px;background:rgba(255,255,255,0.01);">
          <div style="font-weight:800;font-size:18px;margin-bottom:8px">Задания появятся здесь</div>
          <div class="small muted">Пока что можно создать задание (кнопка справа)</div>
        </div>
        <div class="tasks-list" id="tasksList" style="display:none"></div>
      </div>

      <!-- Profile content -->
      <div id="profilePanel" style="display:none">
        <div style="text-align:center">
          <div class="avatar"><img id="userPhoto" src="" alt="Аватар"></div>
          <h2 id="userName" style="margin:6px 0 0">Пользователь</h2>
          <div id="userHandle" class="muted small">@user</div>
          <div style="margin-top:14px;border-top:1px solid rgba(255,255,255,0.02);padding-top:12px">
            <div class="small muted">Текущий баланс</div>
            <div class="balance" id="balance">0 ₽</div>
            <div class="action-row">
              <button class="action-btn" id="topupBtn"><i class="fas fa-plus-circle"></i> Пополнить</button>
              <button class="action-btn ghost" id="withdrawBtn"><i class="fas fa-arrow-up-right-from-square"></i> Вывести</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="fab" id="createFab" title="Создать задание">+</div>

  <div class="bottom-nav">
    <div class="nav-item active" data-nav="tasks">Задания</div>
    <div class="nav-item" data-nav="profile">Профиль</div>
  </div>

  <!-- TOPUP Modal -->
  <div id="topupModal" class="modal" aria-hidden="true">
    <div class="modal-card">
      <button class="close-btn" data-close>×</button>
      <h3>Пополнить через СБП</h3>
      <p class="small muted">Выберите сумму или введите свою. Система создаст заявку и сгенерирует ссылку для оплаты.</p>

      <div id="sbpStep1">
        <div class="label-row">
          <div class="small">Быстрый выбор</div>
          <div class="small muted">Мин. 150 ₽</div>
        </div>
        <div class="topup-amount-grid">
          <button class="amount-btn" data-amount="300">300 ₽</button>
          <button class="amount-btn" data-amount="500">500 ₽</button>
          <button class="amount-btn" data-amount="1000">1 000 ₽</button>
          <button class="amount-btn" data-amount="2000">2 000 ₽</button>
        </div>
        <label class="small muted" style="margin-top:12px">Своя сумма</label>
        <input type="number" id="customAmount" placeholder="Введите сумму (от 150 ₽)" min="150">
        <div style="display:flex;gap:10px;margin-top:12px">
          <button class="action-btn" id="toSBP">Перевести через СБП</button>
          <button class="action-btn ghost" data-close>Отмена</button>
        </div>
      </div>

      <div id="sbpStep2" style="display:none">
        <div class="sbp-details">
          <div style="font-weight:700">Реквизиты для перевода</div>
          <div style="margin-top:8px">Получатель: <strong>Нигматдинов Раяз Ильдарович</strong></div>
          <div>Договор: <strong>5587811905</strong></div>
          <div style="margin-top:8px">Сумма: <strong id="sbpAmount">— ₽</strong></div>
        </div>

        <!-- Use your provided local QR image -->
        <img id="qrImg" class="qr-img" src="/mnt/data/44e2a7f0-6c8c-4641-9717-9eb401613a95.png" alt="QR код">

        <label class="small muted" style="margin-top:8px">Комментарий к переводу (обязательно)</label>
        <input type="text" id="transferComment" readonly value="" style="cursor:pointer">
        <div style="display:flex;gap:10px;margin-top:12px">
          <a id="openBankLink" class="action-btn" href="#" target="_blank" rel="noopener"><i class="fas fa-external-link-alt"></i> Открыть банк</a>
          <button class="action-btn ghost" id="iPaidBtn">Перевел, создать заявку</button>
        </div>
      </div>
    </div>
  </div>

  <!-- WITHDRAW Modal -->
  <div id="withdrawModal" class="modal" aria-hidden="true">
    <div class="modal-card">
      <button class="close-btn" data-close>×</button>
      <h3>Вывод средств</h3>
      <p class="small muted">Заявка будет отправлена на проверку администраторам.</p>
      <label class="small muted">Сумма (мин. 300 ₽)</label>
      <input type="number" id="wAmount" min="300" placeholder="Сумма (мин. 300 ₽)">
      <label class="small muted">ФИО или ник в Банке</label>
      <input type="text" id="wName" placeholder="ФИО или ник в Банке">
      <label class="small muted">Реквизиты (номер карты / телефона)</label>
      <input type="text" id="wDetails" placeholder="Номер карты / телефона">
      <div style="display:flex;gap:10px;margin-top:12px">
        <button class="action-btn" id="sendWithdrawBtn">Отправить заявку</button>
        <button class="action-btn ghost" data-close>Отмена</button>
      </div>
    </div>
  </div>

  <!-- Create Task modal -->
  <div id="createTaskModal" class="modal" aria-hidden="true">
    <div class="modal-card">
      <button class="close-btn" data-close>×</button>
      <h3>Создать задание</h3>
      <label class="small muted">Заголовок</label>
      <input type="text" id="taskTitle" placeholder="Например: Написать отзыв в Яндекс.Карты">
      <label class="small muted">Описание</label>
      <input type="text" id="taskDesc" placeholder="Краткие требования">
      <div style="display:flex;gap:8px;margin-top:10px">
        <input type="number" id="taskPrice" placeholder="Цена за 1" min="1" style="flex:1">
        <input type="number" id="taskQty" placeholder="Количество" min="1" style="width:110px">
      </div>
      <div style="display:flex;gap:10px;margin-top:12px">
        <button class="action-btn" id="createTaskBtn">Создать</button>
        <button class="action-btn ghost" data-close>Отмена</button>
      </div>
    </div>
  </div>

<script>
(function(){
  'use strict';
  // Telegram WebApp (safe)
  const tg = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;
  try { tg?.ready?.(); tg?.expand?.(); } catch(e){}

  const tgUser = (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) ? tg.initDataUnsafe.user : {};
  const my_uid = tgUser.id || null;

  // DOM refs
  const tabs = document.querySelectorAll('.tab');
  const navItems = document.querySelectorAll('.nav-item');
  const tasksList = document.getElementById('tasksList');
  const tasksEmpty = document.getElementById('tasksEmpty');
  const createFab = document.getElementById('createFab');
  const headerBalanceText = document.getElementById('headerBalanceText');
  const balanceEl = document.getElementById('balance');

  // Profile
  const userPhoto = document.getElementById('userPhoto');
  const userNameEl = document.getElementById('userName');
  const userHandleEl = document.getElementById('userHandle');

  // Topup
  const topupModal = document.getElementById('topupModal');
  const sbpStep1 = document.getElementById('sbpStep1');
  const sbpStep2 = document.getElementById('sbpStep2');
  const amountBtns = document.querySelectorAll('.amount-btn');
  const customAmountInput = document.getElementById('customAmount');
  const toSBPBtn = document.getElementById('toSBP');
  const sbpAmountEl = document.getElementById('sbpAmount');
  const transferCommentEl = document.getElementById('transferComment');
  const openBankLink = document.getElementById('openBankLink');
  const iPaidBtn = document.getElementById('iPaidBtn');

  let currentTopup = null;

  // Withdraw
  const withdrawModal = document.getElementById('withdrawModal');
  const wAmount = document.getElementById('wAmount');
  const wName = document.getElementById('wName');
  const wDetails = document.getElementById('wDetails');
  const sendWithdrawBtn = document.getElementById('sendWithdrawBtn');

  // Create Task
  const createTaskModal = document.getElementById('createTaskModal');
  const createTaskBtn = document.getElementById('createTaskBtn');
  const taskTitle = document.getElementById('taskTitle');
  const taskDesc = document.getElementById('taskDesc');
  const taskPrice = document.getElementById('taskPrice');
  const taskQty = document.getElementById('taskQty');

  // Utils
  function fmtRub(n){ return Number(n||0).toLocaleString('ru-RU') + ' ₽'; }
  function showModal(el){ el.classList.add('open'); el.setAttribute('aria-hidden','false'); }
  function closeModal(el){ el.classList.remove('open'); el.setAttribute('aria-hidden','true'); }
  document.querySelectorAll('[data-close]').forEach(b => b.addEventListener('click', e => {
    const modal = e.target.closest('.modal');
    if (modal) closeModal(modal);
  }));

  // Set profile
  userPhoto.src = tgUser.photo_url || `https://api.dicebear.com/7.x/avataaars/svg?seed=${tgUser.id || 'user'}`;
  userNameEl.textContent = tgUser.first_name || 'Пользователь';
  userHandleEl.textContent = tgUser.username ? '@' + tgUser.username : '@user';

  // Tabs
  tabs.forEach(t => t.addEventListener('click', ()=> {
    tabs.forEach(x => x.classList.toggle('active', x===t));
    const tabName = t.dataset.tab;
    document.getElementById('tasksPanel').style.display = tabName==='tasks' ? 'block' : 'none';
    document.getElementById('profilePanel').style.display = tabName==='profile' ? 'block' : 'none';
    navItems.forEach(n => n.classList.toggle('active', (tabName==='profile'? n.dataset.nav==='profile' : n.dataset.nav==='tasks')));
  }));
  navItems.forEach(n => n.addEventListener('click', ()=> {
    const nav = n.dataset.nav;
    document.querySelector(`.tab[data-tab="${nav==='profile'?'profile':'tasks'}"]`).click();
  }));

  // Fab opens create task
  createFab.addEventListener('click', ()=> showModal(createTaskModal));

  // Load tasks list
  async function loadTasks(){
    try{
      const res = await fetch('/api/tasks/list');
      const j = await res.json();
      if (j.ok){
        const tasks = j.tasks || [];
        if (!tasks.length){ tasksList.style.display='none'; tasksEmpty.style.display='block'; return; }
        tasksList.innerHTML = '';
        tasks.forEach(t => {
          const item = document.createElement('div'); item.className = 'task-item';
          item.innerHTML = `<div><div style="font-weight:800">${t.title}</div><div class="small muted">${t.description}</div></div>
            <div style="text-align:right"><div style="font-weight:900">${(t.unit_price||0)} ₽</div><div class="small muted">${t.qty||1} шт</div></div>`;
          tasksList.appendChild(item);
        });
        tasksList.style.display='flex'; tasksEmpty.style.display='none';
      }
    }catch(e){ console.warn('loadTasks',e) }
  }

  // Initial profile & balance load
  async function loadProfile(){
    if (!my_uid) { updateBalanceUI(0); return; }
    try{
      const res = await fetch(`/api/profile_me?uid=${encodeURIComponent(my_uid)}`);
      const j = await res.json();
      if (j.ok && j.user){
        updateBalanceUI(j.user.balance);
      }
    }catch(e){ console.warn(e) }
  }

  function updateBalanceUI(bal){
    const txt = fmtRub(b);
    balanceEl.textContent = txt;
    headerBalanceText.textContent = txt;
  }

  // Socket.io realtime
  let socket = null;
  try {
    socket = io({ transports: ['websocket'] });
    socket.on('connect', ()=> console.log('socket connected', socket.id));
    socket.on('user_update', data => {
      if (!data) return;
      if (String(data.user_id) === String(my_uid)){
        updateBalanceUI(data.balance);
      }
    });
    socket.on('topup_approved', data => {
      if (String(data.user.id) === String(my_uid)) {
        // balance updated via user_update event
        tg?.showPopup?.({ title:'Пополнение принято', message:`+${Number(data.amount).toLocaleString()} ₽ зачислено`, buttons:[{type:'ok'}] });
      }
    });
    socket.on('topup_rejected', data => {
      if (String(data.user.id) === String(my_uid)) {
        tg?.showPopup?.({ title:'Пополнение отклонено', message:data.reject_reason || 'Отклонено администратором', buttons:[{type:'ok'}] });
      }
    });
    socket.on('withdraw_approved', data => {
      if (String(data.user.id) === String(my_uid)) {
        tg?.showPopup?.({ title:'Вывод подтверждён', message:`Вывод ${Number(data.amount).toLocaleString()} ₽ подтверждён`, buttons:[{type:'ok'}] });
      }
    });
    socket.on('withdraw_rejected', data => {
      if (String(data.user.id) === String(my_uid)) {
        tg?.showPopup?.({ title:'Вывод отклонён', message:data.reject_reason || 'Отклонено администратором', buttons:[{type:'ok'}] });
      }
    });
    socket.on('task_created', t => {
      // push into listing
      loadTasks();
    });
  } catch (e) {
    console.warn('socket init', e);
  }

  // Topup flow: request pay_link -> show step2 -> when user clicks "I paid" call confirm endpoint
  amountBtns.forEach(b => b.addEventListener('click', ()=> prepareSBPTransfer(Number(b.dataset.amount))));
  toSBPBtn.addEventListener('click', ()=> {
    const v = Number(customAmountInput.value || 0);
    prepareSBPTransfer(v);
  });

  async function prepareSBPTransfer(amount){
    if (!amount || amount < 150) { tg?.showPopup?.({message:'Минимум 150 ₽'}); return; }
    // call server to create topup and get pay_link + manual_code
    try{
      const res = await fetch('/api/user/topup-link', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ uid: my_uid, amount })
      });
      const j = await res.json();
      if (!res.ok || !j.ok) {
        tg?.showPopup?.({ title:'Ошибка', message: j.errmsg || 'Ошибка создания заявки', buttons:[{type:'ok'}] });
        return;
      }
      // save current topup
      currentTopup = j.topup;
      sbpAmountEl.textContent = amount.toLocaleString() + ' ₽';
      transferCommentEl.value = j.manual_code;
      openBankLink.href = j.pay_link;
      // show step 2
      sbpStep1.style.display='none'; sbpStep2.style.display='block';
      showModal(topupModal);
      // optionally open bank automatically:
      // window.open(j.pay_link, '_blank');
    }catch(e){
      console.error('prepareSBPTransfer', e);
      tg?.showPopup?.({message:'Ошибка сети'});
    }
  }

  // copy comment on click
  transferCommentEl.addEventListener('click', async ()=> {
    if (!transferCommentEl.value) return;
    try { await navigator.clipboard.writeText(transferCommentEl.value); tg?.showPopup?.({message:'Комментарий скопирован!'}); } catch(e){ tg?.showPopup?.({message:'Не удалось скопировать'}); }
  });

  // user clicked "I paid"
  iPaidBtn.addEventListener('click', async ()=> {
    if (!currentTopup) return tg?.showPopup?.({message:'Нет активной заявки'});
    try{
      const res = await fetch('/api/user/topup-confirm', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ uid: my_uid, topup_id: currentTopup.id })
      });
      const j = await res.json();
      if (!res.ok || !j.ok) {
        tg?.showPopup?.({ title:'Ошибка', message: j.errmsg || 'Ошибка подтверждения', buttons:[{type:'ok'}] });
        return;
      }
      tg?.showPopup?.({ title:'Заявка создана', message:'Спасибо! Заявка на проверку отправлена администратору.', buttons:[{type:'ok'}] });
      closeModal(topupModal);
      // keep UI step2 cleared
      sbpStep1.style.display='block'; sbpStep2.style.display='none';
      currentTopup = null;
    }catch(e){
      console.error('iPaid', e);
      tg?.showPopup?.({message:'Ошибка сети'});
    }
  });

  // Withdraw submit
  sendWithdrawBtn.addEventListener('click', async ()=> {
    const amount = Number(wAmount.value || 0);
    const name = (wName.value || '').trim();
    const details = (wDetails.value || '').trim();
    if (!amount || amount < 300) return tg?.showPopup?.({message:'Мин. 300 ₽'});
    try {
      const res = await fetch('/api/user/withdraw', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ uid: my_uid, amount, name, details })
      });
      const j = await res.json();
      if (!res.ok || !j.ok) return tg?.showPopup?.({ title:'Ошибка', message: j.errmsg || 'Ошибка запроса', buttons:[{type:'ok'}] });
      tg?.showPopup?.({ title:'Готово', message:'Заявка на вывод отправлена на проверку администратору.', buttons:[{type:'ok'}] });
      closeModal(withdrawModal);
      wAmount.value = wName.value = wDetails.value = '';
    } catch (e) { console.error(e); tg?.showPopup?.({message:'Ошибка сети'}); }
  });

  // Create task
  createTaskBtn.addEventListener('click', async ()=> {
    const title = (taskTitle.value || '').trim();
    const desc = (taskDesc.value || '').trim();
    const price = Number(taskPrice.value || 0);
    const qty = Number(taskQty.value || 1);
    if (!title || !price || price <= 0) return tg?.showPopup?.({message:'Заполните заголовок и цену'});
    try {
      const res = await fetch('/api/tasks/create', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ title, description: desc, type_id: 'custom', unit_price: price, qty })
      });
      const j = await res.json();
      if (!res.ok || !j.ok) return tg?.showPopup?.({message: j.errmsg || 'Ошибка создания задания'});
      tg?.showPopup?.({message:'Задание создано!'}); closeModal(createTaskModal);
      taskTitle.value = taskDesc.value = taskPrice.value = taskQty.value = '';
      loadTasks();
    } catch(e){ console.error(e); tg?.showPopup?.({message:'Ошибка сети'}); }
  });

  // Openers
  document.getElementById('topupBtn').addEventListener('click', ()=> { sbpStep1.style.display='block'; sbpStep2.style.display='none'; showModal(topupModal); });
  document.getElementById('withdrawBtn').addEventListener('click', ()=> showModal(withdrawModal));
  document.getElementById('createFab').addEventListener('click', ()=> showModal(createTaskModal));

  // initial load
  loadTasks(); loadProfile();
  // try to update balance periodically (in case socket disconnect)
  setInterval(loadProfile, 60_000);

})();
</script>
</body>
</html>
