<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Пополнение — ReviewCash</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
<style>
  body{font-family:Inter,Arial,Helvetica,sans-serif;background:#061426;color:#eaf7fb;margin:0;padding:20px}
  .panel{max-width:920px;margin:16px auto;background:linear-gradient(180deg,#071a2b,#041324);padding:18px;border-radius:12px}
  h2{margin:0 0 8px}
  .muted{color:#9fb6c6;font-size:14px}
  .amounts{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}
  .preset{padding:10px 14px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;cursor:pointer}
  .preset.active{box-shadow:0 12px 40px rgba(0,240,255,0.06);transform:translateY(-4px)}
  .btn{padding:10px 14px;border-radius:10px;border:none;background:linear-gradient(90deg,#00c7d7,#00e08a);color:#012226;font-weight:700;cursor:pointer}
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:9999}
  .card{background:#0a1b23;padding:18px;border-radius:12px;max-width:520px;width:100%;text-align:center}
  img.qr{width:260px;height:260px;border-radius:8px;border:1px solid rgba(255,255,255,0.03)}
  .manual-code{font-size:20px;font-weight:800;color:#00ffd0;margin-top:8px}
  .warn{color:#ffb4b4;margin-top:12px;font-weight:700}
  .note{color:#cfece6;margin-top:8px}
  .close{margin-top:14px;padding:8px 12px;border-radius:8px;border:none;background:#22333b;color:#eaf7fb;cursor:pointer}
</style>
</head>
<body>
  <div class="panel">
    <h2>Пополнение баланса</h2>
    <div class="muted">Выберите сумму или введите свою. Минимум 100 ₽.</div>

    <div class="amounts" aria-hidden="false">
      <button class="preset" data-amount="100">100 ₽</button>
      <button class="preset" data-amount="500">500 ₽</button>
      <button class="preset" data-amount="1000">1000 ₽</button>
      <button class="preset" data-amount="3000">3000 ₽</button>
      <button id="otherBtn" class="preset">Другая сумма</button>
    </div>

    <div style="margin-top:12px">
      <button id="doTopup" class="btn">Пополнить</button>
    </div>

    <div id="status" style="margin-top:12px"></div>
  </div>

  <!-- payment modal -->
  <div id="payModal" class="modal" role="dialog" aria-hidden="true">
    <div class="card">
      <h3>Оплатите переводом через приложение банка</h3>
      <div class="muted" id="payInfo">Откройте приложение банка и осуществите перевод</div>
      <div id="payAmount" style="font-size:18px;font-weight:800;margin-top:8px"></div>

      <div style="margin-top:12px">
        <img id="payQR" class="qr" src="" alt="QR для оплаты (SBP)"/>
      </div>

      <div style="margin-top:12px">
        <a id="payLink" href="#" target="_blank" rel="noopener noreferrer" style="color:#00ffd0">Открыть платёжную ссылку</a>
      </div>

      <div style="margin-top:14px;text-align:left">
        <div class="muted">ВАЖНО:</div>
        <div class="note">После открытия платежа в приложении банка сумма и получатель заполняются автоматически. Поле «Комментарий к переводу» часто остаётся пустым — это нормально.</div>
        <div class="note">Пожалуйста, вручную введите в поле «Комментарий к переводу» следующий код (обязательно):</div>
        <div class="manual-code" id="manualCode">RCXXXXXX</div>
        <div class="note">Только после ввода кода нажмите оплатить в вашем банке — это единственный способ привязать платёж к вашему аккаунту.</div>
        <div class="warn">Деньги не возвращаются, если вы перевели на неправильный код или неверного получателя — проверяйте код вручную!</div>
      </div>

      <div style="margin-top:12px">
        <button id="payClose" class="close">Закрыть</button>
      </div>
      <div id="payPollStatus" style="margin-top:8px" class="muted"></div>
    </div>
  </div>

<script>
function qs(name){ return new URLSearchParams(location.search).get(name); }
let selectedAmount = null;
document.querySelectorAll('.preset').forEach(btn=>{
  btn.addEventListener('click', ()=> {
    document.querySelectorAll('.preset').forEach(x=>x.classList.remove('active'));
    btn.classList.add('active');
    const a = btn.dataset.amount;
    if(a) selectedAmount = Number(a);
    else selectedAmount = null;
  });
});

document.getElementById('otherBtn').addEventListener('click', async ()=>{
  const s = prompt('Введите сумму в рублях (целое число >= 100):');
  if(!s) return;
  const v = Math.round(Number(String(s).replace(',','.')));
  if(isNaN(v) || v < 100){ alert('Сумма должна быть целым числом >= 100'); return; }
  selectedAmount = v;
  // mark selection visually
  document.querySelectorAll('.preset').forEach(x=>x.classList.remove('active'));
  document.getElementById('otherBtn').classList.add('active');
  document.getElementById('otherBtn').textContent = v + ' ₽';
});

document.getElementById('doTopup').addEventListener('click', async ()=>{
  if(!selectedAmount || selectedAmount < 100){
    alert('Выберите сумму не менее 100 ₽');
    return;
  }
  document.getElementById('status').textContent = 'Создаём платёжную сессию...';
  try{
    const res = await fetch('/api/topups_public', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ amount: selectedAmount })});
    const j = await res.json();
    if(!j.ok){ alert('Ошибка: '+(j.reason||'')); document.getElementById('status').textContent=''; return; }
    const topup = j.topup;
    // show modal
    document.getElementById('payAmount').textContent = (topup.amount || selectedAmount) + ' ₽';
    const manualCode = j.manual_code || topup.manual_code || 'RCXXXXXX';
    document.getElementById('manualCode').textContent = manualCode;
    // set QR/link if present
    const pay = topup.payment || {};
    if(pay.qr) document.getElementById('payQR').src = pay.qr; else document.getElementById('payQR').src = '';
    if(pay.url) { document.getElementById('payLink').href = pay.url; document.getElementById('payLink').style.display = 'inline'; }
    else document.getElementById('payLink').style.display = 'none';
    // show instruction more prominently
    document.getElementById('status').textContent = '';
    const modal = document.getElementById('payModal');
    modal.style.display = 'flex';
    modal.setAttribute('aria-hidden','false');
    // Optionally start polling for topup status (if webhook will update it)
    pollTopupStatus(topup.id, 2*60*1000);
  } catch(e){
    console.error(e);
    alert('Ошибка сети при создании платежа');
    document.getElementById('status').textContent = '';
  }
});

document.getElementById('payClose').addEventListener('click', ()=>{
  const modal = document.getElementById('payModal');
  modal.style.display = 'none';
  modal.setAttribute('aria-hidden','true');
});

let pollTimer = null;
async function pollTopupStatus(topupId, timeoutMs){
  const statusEl = document.getElementById('payPollStatus');
  const start = Date.now();
  statusEl.textContent = 'Ожидание подтверждения платежа...';
  if(pollTimer) clearInterval(pollTimer);
  pollTimer = setInterval(async ()=>{
    try{
      const res = await fetch('/api/topups/' + encodeURIComponent(topupId));
      const j = await res.json();
      if(!j.ok){ statusEl.textContent = 'Ошибка проверки статуса'; clearInterval(pollTimer); return; }
      const t = j.topup;
      if(t.status === 'paid'){
        statusEl.textContent = 'Платёж принят — баланс обновлён';
        clearInterval(pollTimer);
        setTimeout(()=>{ document.getElementById('payClose').click(); }, 1200);
        return;
      } else {
        const elapsed = Date.now() - start;
        if(elapsed > timeoutMs){
          statusEl.textContent = 'Время ожидания истекло. Если вы уже оплатили — дождитесь обновления (может занять несколько минут).';
          clearInterval(pollTimer);
          return;
        }
      }
    } catch(e){
      console.error('poll error', e);
      statusEl.textContent = 'Ошибка проверки статуса';
      clearInterval(pollTimer);
    }
  }, 3000);
}
</script>
</body>
</html>
