<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>ReviewCash • Кабинет</title>
  <!-- Telegram WebApp -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <!-- Socket.IO -->
  <script src="/socket.io/socket.io.js"></script>
  <style>
    :root {
      --bg: #040204; --panel: rgba(9,7,6,0.6); --accent1: #b8860b; --accent2: #ffd27f;
      --muted: #9fb7c7; --text: #eaf9ff; --glass: 1px solid rgba(255,255,255,0.04);
      --radius: 16px; --shadow: 0 10px 30px rgba(0,0,0,0.6); --transition: all 0.3s ease; --animation-timing: cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }
    * { box-sizing: border-box; transition: var(--transition); }
    body { margin: 0; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; background: var(--bg); color: var(--text); -webkit-font-smoothing: antialiased; min-height: 100vh; padding: 16px; touch-action: manipulation; -webkit-tap-highlight-color: transparent; overflow: hidden; }
    .wrap { max-width: 820px; margin: 0 auto; padding: 12px; display: none; }
    .card { background: var(--panel); border-radius: var(--radius); padding: 18px; border: var(--glass); box-shadow: var(--shadow); margin-bottom: 14px; animation: fadeIn 0.35s var(--animation-timing); opacity: 1; transform: translateY(0); position: relative; perspective: 1000px; }
    @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }
    .row { display: flex; gap: 12px; align-items: center; }
    .avatar { width: 74px; height: 74px; border-radius: 50%; overflow: hidden; border: 2px solid rgba(184,134,11,0.14); box-shadow: var(--shadow); }
    .avatar img { width: 100%; height: 100%; object-fit: cover; }
    .title { font-weight: 800; font-size: 18px; text-shadow: 0 2px 4px rgba(184,134,11,0.2); }
    .muted { color: var(--muted); font-size: 13px; }
    .balance { font-weight: 900; font-size: 32px; background: linear-gradient(90deg, var(--accent1), var(--accent2)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-shadow: 0 2px 4px rgba(184,134,11,0.3); }
    .btn { display: inline-block; padding: 12px; border-radius: 12px; border: none; background: linear-gradient(90deg, var(--accent1), var(--accent2)); color: #111; font-weight: 800; cursor: pointer; margin-top: 10px; min-width: 120px; text-align: center; box-shadow: var(--shadow); position: relative; overflow: hidden; }
    .btn.ghost { background: transparent; border: 1px solid rgba(255,255,255,0.04); color: var(--text); }
    .tabs { display: flex; gap: 8px; margin-bottom: 12px; }
    .tab { flex: 1; padding: 10px; border-radius: 999px; text-align: center; background: rgba(255,255,255,0.02); cursor: pointer; font-weight: 800; }
    .tab.active { background: linear-gradient(90deg, var(--accent1), var(--accent2)); color: #111; }
    .task-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-radius: 10px; background: rgba(255,255,255,0.02); margin-bottom: 8px; box-shadow: var(--shadow); position: relative; overflow: hidden; }
    .small { font-size: 13px; color: var(--muted); }
    .fab { position: fixed; right: 18px; bottom: 100px; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: linear-gradient(90deg, var(--accent1), var(--accent2)); color: #111; font-weight: 900; cursor: pointer; box-shadow: 0 10px 30px rgba(184,134,11,0.12); }
    .tabbar { position: fixed; left: 50%; transform: translateX(-50%); bottom: 18px; background: rgba(255,255,255,0.02); padding: 8px; border-radius: 999px; border: var(--glass); display: flex; gap: 8px; box-shadow: var(--shadow); }
    .nav-item { padding: 8px 12px; border-radius: 999px; color: var(--muted); cursor: pointer; }
    .nav-item.active { background: linear-gradient(90deg, var(--accent1), var(--accent2)); color: #111; }
    .modal-bg { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.7); z-index: 9999; opacity: 0; transition: opacity 0.3s ease; }
    .modal-bg.open { display: flex; opacity: 1; }
    .modal { width: 100%; max-width: 640px; background: rgba(6,6,6,0.9); padding: 18px; border-radius: 14px; border: var(--glass); box-shadow: var(--shadow); transform: scale(1); }
    .type-btn { padding: 10px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.04); background: rgba(255,255,255,0.02); cursor: pointer; margin-top: 8px; display: flex; justify-content: space-between; align-items: center; }
    input, textarea { width: 100%; padding: 10px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.04); background: transparent; color: var(--text); margin-top: 8px; font-size: 16px; }
    .qr { display: block; margin: 12px auto; max-width: 220px; border-radius: 10px; box-shadow: var(--shadow); }
    .note { font-size: 13px; color: var(--muted); margin-top: 8px; }
    /* loader */
    .loader { position: fixed; inset: 0; background: var(--bg); display: flex; align-items: center; justify-content: center; z-index: 10000; opacity: 1; transition: opacity 0.5s ease; }
    .loader.hidden { opacity: 0; pointer-events: none; display: none; }
    canvas#particleCanvas { width: 220px; height: 220px; border-radius: 220px; background: radial-gradient(circle at 30% 0, rgba(184,134,11,0.08), transparent 40%); box-shadow: 0 10px 30px rgba(0,0,0,0.6); }
    .error { color: #ff8b8b; }
    .ok { color: #8bffcf; }
    @media (max-width: 520px) {
      .card { padding: 14px; }
      .btn { min-width: 100px; font-size: 14px; }
      .fab { width: 50px; height: 50px; }
    }
  </style>
</head>
<body>
  <!-- Loader -->
  <div class="loader" id="appLoader">
    <canvas id="particleCanvas" width="220" height="220"></canvas>
  </div>
  <!-- Main app content -->
  <div class="wrap" id="appContent" aria-hidden="true">
    <!-- PROFILE CARD -->
    <div class="card" id="profileCard">
      <div class="row">
        <div class="avatar"><img id="avatar" src="" alt="avatar"></div>
        <div style="flex:1">
          <div class="title" id="userName">Загрузка...</div>
          <div class="muted" id="userHandle">@user</div>
          <div style="margin-top:12px">
            <div class="small">Баланс</div>
            <div class="balance" id="balance">0 ₽</div>
          </div>
        </div>
        <div style="text-align:right">
          <button class="btn" id="topupBtn">Пополнить</button><br>
          <button class="btn ghost" id="withdrawBtn">Вывести</button>
        </div>
      </div>
    </div>
    <!-- TABS -->
    <div class="card">
      <div class="tabs" role="tablist">
        <div class="tab active" data-tab="tasks" id="tabTasks">Задания</div>
        <div class="tab" data-tab="profile" id="tabProfile">Профиль</div>
      </div>
      <!-- TASKS PANEL -->
      <div id="tasksPanel">
        <div style="display:flex;gap:8px;margin-bottom:10px">
          <input id="filterInput" placeholder="Поиск по заданиям" style="flex:1;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text)">
          <button class="btn" id="searchBtn">Поиск</button>
          <button class="btn ghost" id="newTaskBtn">Создать задание</button>
        </div>
        <div id="tasksList">
          <div class="small">Загрузка…</div>
        </div>
      </div>
      <!-- PROFILE PANEL (вкладка) -->
      <div id="profilePanel" style="display:none">
        <div class="small">Имя</div>
        <div style="font-weight:800;font-size:18px" id="pName">—</div>
        <div class="small" style="margin-top:8px">История операций</div>
        <div id="history" style="margin-top:8px"></div>
      </div>
    </div>
  </div>
  <div class="fab" id="fab">+</div>
  <div class="tabbar" role="navigation">
    <div class="nav-item active" data-nav="tasks">Задания</div>
    <div class="nav-item" data-nav="profile">Профиль</div>
  </div>
  <!-- TOPUP Modal -->
  <div id="topupModal" class="modal-bg" aria-hidden="true">
    <div class="modal">
      <button id="closeTopup" style="float:right;background:transparent;border:none;color:var(--muted);font-size:20px;cursor:pointer">×</button>
      <h3>Пополнение через SBP / QR</h3>
      <div class="note">Минимум <b id="minTopup">150</b> ₽</div>
      <div style="display:flex;gap:8px;margin-top:10px">
        <input id="topupAmount" type="number" placeholder="Сумма" min="150" style="flex:1" />
        <button class="btn" id="createTopupBtn">Создать заявку</button>
      </div>
      <div id="topupStep" style="display:none;margin-top:12px">
        <div class="note">Ссылка для оплаты / QR (скопируйте комментарий)</div>
        <img id="qrImg" class="qr" src="" alt="QR" />
        <input id="manualCode" readonly />
        <div style="display:flex;gap:8px;margin-top:8px">
          <a id="payLink" class="btn" target="_blank" rel="noopener noreferrer">Открыть банк</a>
          <button class="btn ghost" id="confirmPaidBtn">Я оплатил</button>
        </div>
        <div class="note" id="topupMsg"></div>
      </div>
    </div>
  </div>
  <!-- WITHDRAW Modal -->
  <div id="withdrawModal" class="modal-bg" aria-hidden="true">
    <div class="modal">
      <button id="closeWithdraw" style="float:right;background:transparent;border:none;color:var(--muted);font-size:20px;cursor:pointer">×</button>
      <h3>Вывести средства</h3>
      <div class="note">Мин. 300 ₽</div>
      <input id="wAmount" type="number" placeholder="Сумма" />
      <input id="wName" type="text" placeholder="ФИО или ник (получатель)" />
      <input id="wDetails" type="text" placeholder="Реквизиты (карта / СБП)" />
      <button class="btn" id="sendWithdraw">Отправить заявку</button>
      <div id="withdrawMsg" class="note"></div>
    </div>
  </div>
  <!-- CREATE TASK Modal -->
  <div id="createModal" class="modal-bg" aria-hidden="true">
    <div class="modal">
      <button id="closeCreate" style="float:right;background:transparent;border:none;color:var(--muted);font-size:20px;cursor:pointer">×</button>
      <h3>Создать задание</h3>
      <div class="note">Выберите тип — цена проставится автоматически</div>
      <div id="typesBox" style="margin-top:8px"></div>
      <input id="taskUrl" placeholder="Ссылка (проверьте)" />
      <input id="taskQty" type="number" placeholder="Количество" min="1" value="1" />
      <div style="display:flex;gap:8px;margin-top:10px">
        <button class="btn" id="submitTask">Создать</button>
        <button class="btn ghost" id="cancelCreate">Отмена</button>
      </div>
      <div id="createMsg" class="note"></div>
    </div>
  </div>
<script>
(() => {
  // Basic safe helpers
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  // Telegram init
  const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
  try { tg?.ready?.(); tg?.expand?.(); } catch(e){ /* ignore */ }
  // IDs and DOM
  const appLoader = document.getElementById('appLoader');
  const appContent = document.getElementById('appContent');
  const avatar = document.getElementById('avatar');
  const userName = document.getElementById('userName');
  const userHandle = document.getElementById('userHandle');
  const balanceEl = document.getElementById('balance');
  const pName = document.getElementById('pName');
  const tasksList = document.getElementById('tasksList');
  const filterInput = document.getElementById('filterInput');
  const historyBox = document.getElementById('history');
  // modals
  const topupModal = document.getElementById('topupModal');
  const withdrawModal = document.getElementById('withdrawModal');
  const createModal = document.getElementById('createModal');
  // topup elements
  const topupAmountInput = document.getElementById('topupAmount');
  const createTopupBtn = document.getElementById('createTopupBtn');
  const topupStep = document.getElementById('topupStep');
  const qrImg = document.getElementById('qrImg');
  const manualCodeInput = document.getElementById('manualCode');
  const payLink = document.getElementById('payLink');
  const confirmPaidBtn = document.getElementById('confirmPaidBtn');
  const topupMsg = document.getElementById('topupMsg');
  // create task elements
  const typesBox = document.getElementById('typesBox');
  const submitTaskBtn = document.getElementById('submitTask');
  const cancelCreateBtn = document.getElementById('cancelCreate');
  // withdraw elements
  const wAmount = document.getElementById('wAmount');
  const wName = document.getElementById('wName');
  const wDetails = document.getElementById('wDetails');
  const sendWithdrawBtn = document.getElementById('sendWithdraw');
  const withdrawMsg = document.getElementById('withdrawMsg');
  // profile from Telegram or fallback
  const tgUser = (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) ? tg.initDataUnsafe.user : {};
  const uid = tgUser.id ? String(tgUser.id) : (new URLSearchParams(location.search)).get('uid') || 'guest_' + String(Math.floor(Math.random()*99999));
  avatar.src = tgUser.photo_url || `https://api.dicebear.com/8.x/thumbs/svg?seed=${encodeURIComponent(uid)}`;
  userName.textContent = tgUser.first_name || 'Пользователь';
  userHandle.textContent = tgUser.username ? '@' + tgUser.username : '';
  pName.textContent = userName.textContent;
  // Particles loader
  const canvas = document.getElementById('particleCanvas');
  const ctx = canvas.getContext('2d');
  function resizeCanvas() { canvas.width = 220; canvas.height = 220; }
  resizeCanvas();
  let particles = [];
  class Particle {
    constructor() {
      this.x = Math.random() * canvas.width;
      this.y = Math.random() * canvas.height;
      this.size = Math.random() * 4 + 1;
      this.vx = Math.random() * 2 - 1;
      this.vy = Math.random() * 2 - 1;
      this.c = `rgba(184,134,11,${Math.random()*0.6+0.2})`;
    }
    update() {
      this.x += this.vx; this.y += this.vy;
      if (this.x < 0 || this.x > canvas.width) this.vx *= -1;
      if (this.y < 0 || this.y > canvas.height) this.vy *= -1;
      this.size = Math.max(0.5, this.size - 0.01);
    }
    draw() {
      ctx.fillStyle = this.c;
      ctx.beginPath();
      ctx.arc(this.x, this.y, this.size, 0, Math.PI*2);
      ctx.fill();
    }
  }
  function animateParticles() {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    if (particles.length < 80) particles.push(new Particle());
    particles.forEach(p => { p.update(); p.draw(); });
    particles = particles.filter(p => p.size > 0.6);
    requestAnimationFrame(animateParticles);
  }
  animateParticles();
  // Socket.IO
  let socket = null;
  try {
    socket = io();
    socket.on('connect', ()=> console.log('WS connected', socket.id));
    socket.on('user_update', data => {
      if (!data) return;
      if (String(data.user_id) === String(uid)) {
        // prefer server-provided balance if present
        if (typeof data.balance !== 'undefined') {
          renderBalance(Number(data.balance));
        } else {
          loadProfile();
        }
      }
    });
    socket.on('task_update', () => loadTasks());
  } catch(e){ console.warn('Socket init failed', e); }
  // Utilities
  function showLoader(bool) {
    if (bool) { appLoader.classList.remove('hidden'); appContent.style.display = 'none'; appContent.setAttribute('aria-hidden', 'true'); }
    else { appLoader.classList.add('hidden'); appContent.style.display = 'block'; appContent.removeAttribute('aria-hidden'); }
  }
  function renderBalance(bal) {
    balanceEl.textContent = Number(bal||0).toLocaleString('ru-RU') + ' ₽';
    const headerBalanceText = document.getElementById('headerBalanceText');
    if (headerBalanceText) {
      headerBalanceText.textContent = Number(bal||0).toLocaleString('ru-RU') + ' ₽';
    }
    window.__USER_BALANCE = Number(bal||0);
  }
  // Load profile from server
  async function loadProfile() {
    try {
      const res = await fetch(`/api/profile_me?uid=${encodeURIComponent(uid)}`);
      if (!res.ok) throw new Error('Bad response');
      const j = await res.json();
      if (j && j.ok && j.user) {
        const user = j.user;
        renderBalance(user.balance || 0);
        pName.textContent = user.name || user.first_name || userHandle.textContent || 'Пользователь';
        // render history
        const hist = (user.history || []).slice(0, 10);
        historyBox.innerHTML = hist.length ? hist.map(h => `<div style="padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);margin-bottom:6px"><div style="font-weight:700">${h.type||h.note||''}</div><div class="small">${h.amount ? (h.amount+' ₽') : ''} ${h.note||''}</div></div>`).join('') : '<div class="small">История пуста</div>';
      } else {
        renderBalance(0);
        historyBox.innerHTML = '<div class="small error">Не удалось загрузить профиль</div>';
      }
    } catch (e) {
      console.warn(e);
      try {
        renderBalance(0);
        historyBox.innerHTML = '<div class="small error">Ошибка сети при загрузке профиля</div>';
      } catch (innerE) {
        console.warn('Render balance failed', innerE);
      }
    }
  }
  // Tasks loading (tries two endpoints for compatibility)
  let allTasks = [];
  async function loadTasks() {
    try {
      let res = await fetch('/api/tasks/list').catch(()=>null);
      if (!res || !res.ok) {
        res = await fetch('/api/tasks_public').catch(()=>null);
      }
      if (!res) throw new Error('No tasks endpoint');
      const j = await res.json();
      allTasks = j.tasks || j || [];
      renderTasks();
    } catch (e) {
      console.warn('loadTasks error', e);
      tasksList.innerHTML = '<div class="small error">Не удалось загрузить задания</div>';
    }
  }
  function renderTasks() {
    const q = (filterInput.value || '').toLowerCase();
    const filtered = allTasks.filter(t => {
      const title = (t.title || t.name || '').toLowerCase();
      const descr = (t.description || t.desc || '').toLowerCase();
      return !q || title.includes(q) || descr.includes(q);
    });
    if (filtered.length === 0) { tasksList.innerHTML = '<div class="small">Нет заданий</div>'; return; }
    tasksList.innerHTML = '';
    filtered.forEach(t => {
      const el = document.createElement('div');
      el.className = 'task-item';
      el.innerHTML = `<div style="flex:1"><div style="font-weight:800">${escapeHtml(t.title || t.name || 'Задание')}</div><div class="small">${escapeHtml(t.description || t.desc || '')}</div></div>
                      <div style="text-align:right"><div style="font-weight:900">${Number(t.unit_price || t.reward || 0).toLocaleString('ru-RU')} ₽</div><div class="small">${t.qty || 1} шт</div></div>`;
      tasksList.appendChild(el);
    });
  }
  // escape helper
  function escapeHtml(s='') { return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
  // Tabs & nav
  $$('.tab').forEach(el => el.addEventListener('click', () => {
    $$('.tab').forEach(x=>x.classList.remove('active'));
    el.classList.add('active');
    const tab = el.dataset.tab;
    document.getElementById('tasksPanel').style.display = tab === 'tasks' ? 'block' : 'none';
    document.getElementById('profilePanel').style.display = tab === 'profile' ? 'block' : 'none';
  }));
  $$('.nav-item').forEach(n => n.addEventListener('click', () => {
    $$('.nav-item').forEach(x=>x.classList.remove('active'));
    n.classList.add('active');
    const nav = n.dataset.nav;
    const targetTab = nav === 'profile' ? 'profile' : 'tasks';
    $(`.tab[data-tab="${targetTab}"]`).click();
    window.scrollTo({top:0,behavior:'smooth'});
  }));
  // FAB and create
  document.getElementById('fab').addEventListener('click', openCreate);
  document.getElementById('newTaskBtn').addEventListener('click', openCreate);
  document.getElementById('cancelCreate').addEventListener('click', closeCreate);
  document.getElementById('closeCreate').addEventListener('click', closeCreate);
  // Types loading
  let types = [];
  let selectedType = null;
  async function loadTypes(){
    try {
      const res = await fetch('/api/task_types').catch(()=>null);
      if (res && res.ok) {
        const j = await res.json();
        types = j || [];
      } else {
        // fallback read from /task_types.json
        const res2 = await fetch('/task_types.json').catch(()=>null);
        if (res2 && res2.ok) types = await res2.json();
      }
    } catch(e) { console.warn('loadTypes', e); types = []; }
    if (!types || types.length === 0) {
      types = [
        {id:"ya_review", name:"Отзыв — Яндекс Карты", unit_price:85},
        {id:"gmaps_review", name:"Отзыв — Google Maps", unit_price:50},
        {id:"tg_sub", name:"Подписка — Telegram канал", unit_price:5}
      ];
    }
    renderTypes();
  }
  function renderTypes(){
    typesBox.innerHTML = '';
    types.forEach((t, idx) => {
      const div = document.createElement('div');
      div.className = 'type-btn';
      div.innerHTML = `<div style="font-weight:700">${escapeHtml(t.name)}</div><div style="font-weight:800">${Number(t.unit_price||0)} ₽</div>`;
      div.addEventListener('click', () => {
        selectedType = t;
        $$('.type-btn').forEach(x=>x.classList.remove('active'));
        div.classList.add('active');
      });
      typesBox.appendChild(div);
      if (idx === 0 && !selectedType) { selectedType = t; div.classList.add('active'); }
    });
  }
  function openCreate() {
    createModal.classList.add('open'); createModal.style.display = 'flex';
    loadTypes();
    document.getElementById('createMsg').textContent = '';
  }
  function closeCreate() {
    createModal.classList.remove('open'); createModal.style.display = 'none';
    selectedType = null;
    $('#taskUrl').value = '';
    $('#taskQty').value = 1;
  }
  async function checkUrl(url) {
    // best-effort: try fetch, but many URLs will be blocked by CORS; if fetch fails, warn but allow
    if (!url) return { ok:false, message:'Пустая ссылка' };
    try {
      const res = await fetch(url, { method: 'HEAD', mode: 'no-cors' }).catch(()=>null);
      // If fetch didn't error, assume OK; otherwise return ok:true but with warning
      return { ok: true };
    } catch (e) {
      return { ok: true, message: 'Не удалось проверить (CORS) — убедитесь, что ссылка рабочая' };
    }
  }
  submitTaskBtn.addEventListener('click', async () => {
    const url = $('#taskUrl').value.trim();
    const qty = Number($('#taskQty').value || 0);
    if (!selectedType) return alert('Выберите тип задания');
    if (!url) return alert('Введите ссылку');
    if (!qty || qty < 1) return alert('Укажите корректное количество');
    const chk = await checkUrl(url);
    if (!chk.ok && !confirm('Ссылка не прошла проверку. Создать задание всё равно?')) return;
    try {
      const body = {
        title: selectedType.name,
        description: selectedType.name,
        unit_price: selectedType.unit_price || 0,
        qty,
        url,
        type_id: selectedType.id,
        owner_uid: uid
      };
      const res = await fetch('/api/tasks/create', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
      const j = await res.json();
      if (j && j.ok) {
        closeCreate();
        await loadTasks();
        alert('Задание создано');
      } else {
        alert((j && j.errmsg) || 'Ошибка создания задания');
      }
    } catch (e) {
      console.error(e); alert('Ошибка сети при создании задания');
    }
  });
  // TOPUP flow
  const minTopup = 150;
  document.getElementById('minTopup').textContent = minTopup;
  $('#topupBtn').addEventListener('click', openTopupModal);
  $('#closeTopup').addEventListener('click', ()=> { topupModal.classList.remove('open'); topupModal.style.display = 'none'; });
  function openTopupModal(){
    topupAmountInput.value = minTopup;
    topupStep.style.display = 'none';
    topupModal.classList.add('open'); topupModal.style.display = 'flex';
    topupMsg.textContent = '';
  }
  const topupState = { current: null, manual_code: null, amount: 0 };
  createTopupBtn.addEventListener('click', async () => {
    const amount = Number(topupAmountInput.value || 0);
    if (!amount || amount < minTopup) return alert('Мин. пополнение ' + minTopup + ' ₽');
    try {
      const res = await fetch('/api/user/topup-link', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ uid, amount }) });
      const j = await res.json();
      if (j && j.ok) {
        topupStep.style.display = 'block';
        manualCodeInput.value = j.manual_code || (j.topup && j.topup.manual_code) || '';
        qrImg.src = j.qr_base64 ? `data:image/png;base64,${j.qr_base64}` : (j.qr_url || '');
        payLink.href = j.pay_link || (j.topup && j.topup.pay_link) || '#';
        topupState.current = (j.topup && j.topup.id) || j.id || null;
        topupState.manual_code = manualCodeInput.value;
        topupState.amount = amount;
        topupMsg.textContent = 'Скопируйте комментарий и оплатите через банк. После платежа нажмите "Я оплатил" и создастся заявка на проверку админом.';
      } else {
        alert((j && j.errmsg) || 'Ошибка создания ссылки оплаты');
      }
    } catch (e) {
      console.error(e); alert('Ошибка сети при запросе ссылки оплаты');
    }
  });
  confirmPaidBtn.addEventListener('click', async () => {
    if (!topupState.current) return alert('Не найдена информация о созданной оплате. Пересоздайте заявку.');
    try {
      const res = await fetch('/api/user/topup-confirm', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ topup_id: topupState.current, uid }) });
      const j = await res.json();
      if (j && j.ok) {
        alert('Заявка отправлена на проверку администратору. Баланс будет зачислен после подтверждения.');
        topupModal.classList.remove('open'); topupModal.style.display = 'none';
      } else {
        alert((j && j.errmsg) || 'Не удалось подтвердить оплату');
      }
    } catch (e) {
      console.error(e); alert('Ошибка сети при подтверждении оплаты');
    }
  });
  // WITHDRAW flow
  $('#withdrawBtn').addEventListener('click', ()=> { withdrawModal.classList.add('open'); withdrawModal.style.display = 'flex'; withdrawMsg.textContent = ''; });
  $('#closeWithdraw').addEventListener('click', ()=> { withdrawModal.classList.remove('open'); withdrawModal.style.display = 'none'; });
  sendWithdrawBtn.addEventListener('click', async () => {
    const amount = Number(wAmount.value || 0);
    const name = wName.value.trim();
    const details = wDetails.value.trim();
    if (!amount || amount < 300) return alert('Мин. 300 ₽');
    if (amount > (window.__USER_BALANCE || 0)) return alert('Недостаточно средств');
    if (!name || !details) return alert('Заполните все поля');
    try {
      const res = await fetch('/api/user/withdraw', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ uid, amount, name, details }) });
      const j = await res.json();
      if (j && j.ok) {
        withdrawMsg.textContent = 'Заявка отправлена на проверку';
        withdrawModal.classList.remove('open'); withdrawModal.style.display = 'none';
        // optional: notify bot endpoint
        fetch('/api/notify_bot', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ uid, msg:`Заявка на вывод ${amount} ₽` }) }).catch(()=>{});
      } else {
        withdrawMsg.textContent = (j && j.errmsg) || 'Ошибка создания заявки';
      }
    } catch (e) {
      console.error(e);
      withdrawMsg.textContent = 'Ошибка сети';
    }
  });
  // Search
  $('#searchBtn').addEventListener('click', renderTasks);
  filterInput.addEventListener('keyup', e => { if (e.key === 'Enter') renderTasks(); });
  // Initial load sequence
  (async function init() {
    showLoader(true);
    await Promise.allSettled([ loadProfile(), loadTasks(), loadTypes() ]);
    setTimeout(()=> {
      showLoader(false);
    }, 600);
  })();
  // resize canvas when viewport changes to keep loader nice
  window.addEventListener('resize', ()=> {
    // keep canvas fixed size for design; no need to resize heavily
  });
  // Expose some functions if needed
  window.loadProfile = loadProfile;
  window.loadTasks = loadTasks;
  window.loadTypes = loadTypes;
})();
</script>
</body>
</html>
