<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ReviewCash ‚Äî –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
<script src="https://unpkg.com/lottie-web@5.8.1/build/player/lottie.min.js"></script>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<style>
:root{
  --bg-1:#061426; --bg-2:#031827; --card-bg:rgba(255,255,255,0.03); --glass:rgba(255,255,255,0.04);
  --muted:#9fb6c6; --accentA:#00c7d7; --accentB:#00e08a; --text:#eaf7fb; --radius:14px;
}
:root[data-theme="light"]{
  --bg-1:#f4f7fb; --bg-2:#eef4fa; --card-bg:#fff; --glass:rgba(12,20,28,0.06);
  --muted:#5b6b76; --accentA:#0079c8; --accentB:#00a86b; --text:#071426;
}
*{box-sizing:border-box} html{scroll-behavior:smooth}
body{margin:0;font-family:Inter,system-ui,Arial;background:linear-gradient(180deg,var(--bg-1),var(--bg-2));color:var(--text)}
.app{max-width:1100px;margin:20px auto;padding:16px;display:grid;grid-template-columns:1fr 360px;gap:18px}
.header{grid-column:1/-1;display:flex;align-items:center;gap:12px}
.logo{width:64px;height:64px;border-radius:12px;background:linear-gradient(135deg,var(--accentA),var(--accentB));display:flex;align-items:center;justify-content:center;color:#012226;font-weight:900}
.title h1{margin:0} .title p{margin:0;color:var(--muted);font-size:13px}
.panel{background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);border-radius:12px;padding:14px;border:1px solid var(--glass);box-shadow:0 8px 24px rgba(0,0,0,0.35)}
.tasks-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px;margin-top:12px}
.task{padding:12px;border-radius:12px;background:var(--card-bg);border:1px solid rgba(0,0,0,0.04);cursor:pointer;transition:transform .22s,box-shadow .22s}
.task:hover{transform:translateY(-8px);box-shadow:0 24px 60px rgba(0,0,0,0.45)}
.btn{padding:10px 12px;border-radius:12px;border:none;background:linear-gradient(90deg,var(--accentA),var(--accentB));color:#012226;font-weight:700;cursor:pointer}
.btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px;border-radius:10px;color:var(--text)}
.bottom-nav{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;width:360px;height:68px;border-radius:14px;display:flex;align-items:center;justify-content:space-around;gap:8px;padding:8px;background:linear-gradient(180deg, rgba(0,0,0,0.18), rgba(0,0,0,0.12));border:1px solid rgba(255,255,255,0.03);z-index:2000}
.nav-button{display:flex;flex-direction:column;align-items:center;gap:6px;color:var(--muted);cursor:pointer;padding:6px;border-radius:10px;transition:all .25s}
.nav-button.active{color:var(--accentA);transform:translateY(-6px);background:linear-gradient(90deg,rgba(0,200,255,0.05),rgba(0,200,140,0.02))}
.modal-backdrop{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);align-items:center;justify-content:center;z-index:3000}
.modal{background:linear-gradient(180deg,#061426,#041726);padding:16px;border-radius:12px;width:720px;max-width:94%;border:1px solid rgba(255,255,255,0.04)}
.input{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text)}
.skeleton{height:12px;border-radius:8px;background:linear-gradient(90deg,#ffffff06,#ffffff02,#ffffff06);animation: pulse 1.6s infinite}
@keyframes pulse{0%{opacity:.6}50%{opacity:1}100%{opacity:.6}}
@media(max-width:1000px){ .app{grid-template-columns:1fr;padding-bottom:96px} .bottom-nav{display:flex} }
@media(min-width:1001px){ .bottom-nav{display:none} }
small{color:var(--muted)}
</style>
</head>
<body>
  <div class="app" id="app">
    <div class="header">
      <div class="logo">RC</div>
      <div class="title"><h1>ReviewCash</h1><p>–ó–∞–¥–∞–Ω–∏—è –∏ –ø—Ä–æ—Ñ–∏–ª—å ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–∏–ø–æ–≤ –∑–∞–¥–∞–Ω–∏–π –ø—Ä—è–º–æ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏</p></div>
      <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
        <button id="createTaskBtn" class="btn" style="display:none">–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É</button>
        <button id="createTypeBtn" class="btn-ghost" style="display:none">–î–æ–±–∞–≤–∏—Ç—å —Ç–∏–ø</button>
        <button id="themeToggle" class="btn-ghost">–¢–µ–º–∞</button>
      </div>
    </div>

    <main id="tasksView" class="panel" aria-live="polite">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><h2 style="margin:0">–ó–∞–¥–∞–Ω–∏—è</h2><div class="muted">–°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∑–∞–¥–∞—á</div></div>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="search" class="input" placeholder="–ü–æ–∏—Å–∫..." style="max-width:220px"/>
          <button id="refreshBtn" class="btn">–û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>
      </div>
      <div id="tasksGrid" class="tasks-grid">
        <div><div class="task skeleton" style="height:84px"></div></div>
        <div><div class="task skeleton" style="height:84px"></div></div>
        <div><div class="task skeleton" style="height:84px"></div></div>
      </div>
    </main>

    <aside id="profileView" class="panel">
      <div style="display:flex;gap:12px;align-items:center;justify-content:space-between">
        <div style="display:flex;gap:12px;align-items:center">
          <div id="avatar" style="width:72px;height:72px;border-radius:12px;background:linear-gradient(135deg,#04202a,#05202a);display:flex;align-items:center;justify-content:center;font-weight:800">RC</div>
          <div>
            <div id="fullname" style="font-weight:800">–ü—Ä–æ—Ñ–∏–ª—å —Å–∫—Ä—ã—Ç</div>
            <div id="handle" class="muted">–ù–∞–∂–º–∏—Ç–µ ¬´–ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å¬ª</div>
            <div style="margin-top:8px"><button id="revealProfile" class="btn-ghost">–ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button></div>
          </div>
        </div>
        <div><button id="supportBtn" class="btn-ghost">üéß</button></div>
      </div>

      <div style="margin-top:12px">
        <h3 style="margin:6px 0">–ò—Å—Ç–æ—Ä–∏—è</h3>
        <div id="history" style="max-height:260px;overflow:auto"><div class="muted">–°–∫—Ä—ã—Ç–æ</div></div>
      </div>

      <div style="margin-top:12px;display:flex;gap:8px">
        <button id="topupBtn" class="btn">–ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>
        <button id="withdrawBtn" class="btn-ghost">–í—ã–≤–µ—Å—Ç–∏</button>
      </div>
    </aside>
  </div>

  <nav class="bottom-nav" id="bottomNav">
    <div class="nav-button active" id="navTasks" data-view="tasks"><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><rect x="9" y="2" width="6" height="4" rx="1" stroke="currentColor" stroke-width="1.4"/><path d="M7 8h10v12a1 1 0 0 1-1 1H8a1 1 0 0 1-1-1V8z" stroke="currentColor" stroke-width="1.4"/></svg><div style="font-size:13px">–ó–∞–¥–∞–Ω–∏—è</div></div>
    <div class="nav-button" id="navProfile" data-view="profile"><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" stroke="currentColor" stroke-width="1.4"/><circle cx="12" cy="7" r="4" stroke="currentColor" stroke-width="1.4"/></svg><div style="font-size:13px">–ü—Ä–æ—Ñ–∏–ª—å</div></div>
  </nav>

  <!-- Create Task Modal -->
  <div id="createModal" class="modal-backdrop" style="display:none;align-items:center;justify-content:center">
    <div class="modal">
      <div style="display:flex;justify-content:space-between;align-items:center"><strong>–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É</strong><button id="closeCreate" class="btn-ghost">–ó–∞–∫—Ä—ã—Ç—å</button></div>
      <div style="margin-top:10px">
        <label>–¢–∏–ø –∑–∞–¥–∞—á–∏</label>
        <select id="taskTypeSelect" class="input"></select>
      </div>
      <div style="margin-top:8px"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input id="taskTitle" class="input"/></div>
      <div style="margin-top:8px"><label>–û–ø–∏—Å–∞–Ω–∏–µ</label><textarea id="taskDesc" class="input" style="min-height:100px"></textarea></div>
      <div style="margin-top:8px;display:flex;gap:8px">
        <input id="taskLink" class="input" placeholder="–°—Å—ã–ª–∫–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)"/>
        <input id="taskBudget" class="input" placeholder="–ë—é–¥–∂–µ—Ç ‚ÇΩ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)" style="max-width:160px"/>
      </div>
      <div style="margin-top:8px">
        <small id="budgetInfo">‚Äî</small>
      </div>
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
        <button id="submitTask" class="btn">–°–æ–∑–¥–∞—Ç—å</button>
        <button id="cancelCreate" class="btn-ghost">–û—Ç–º–µ–Ω–∞</button>
      </div>
      <div id="createFeedback" style="margin-top:8px;color:var(--muted)"></div>
    </div>
  </div>

  <!-- Add Type Modal -->
  <div id="createTypeModal" class="modal-backdrop" style="display:none;align-items:center;justify-content:center">
    <div class="modal">
      <div style="display:flex;justify-content:space-between;align-items:center"><strong>–î–æ–±–∞–≤–∏—Ç—å —Ç–∏–ø –∑–∞–¥–∞—á–∏</strong><button id="closeType" class="btn-ghost">–ó–∞–∫—Ä—ã—Ç—å</button></div>
      <div style="margin-top:10px"><label>ID (–ª–∞—Ç–∏–Ω–∏—Ü–∞, –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤)</label><input id="typeId" class="input"/></div>
      <div style="margin-top:8px"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input id="typeName" class="input"/></div>
      <div style="margin-top:8px"><label>–¶–µ–Ω–∞ –∑–∞ 1 –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ (‚ÇΩ)</label><input id="typePrice" class="input" /></div>
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
        <button id="submitType" class="btn">–î–æ–±–∞–≤–∏—Ç—å</button>
        <button id="cancelType" class="btn-ghost">–û—Ç–º–µ–Ω–∞</button>
      </div>
      <div id="typeFeedback" style="margin-top:8px;color:var(--muted)"></div>
    </div>
  </div>

<script>
/* Helper utilities */
function qs(name){ return new URLSearchParams(location.search).get(name); }
function escapeHtml(s){ return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }
const adminToken = qs('token') || '';

/* Theme toggle */
(function(){
  const root = document.documentElement;
  const stored = localStorage.getItem('rc_theme');
  if(stored) root.setAttribute('data-theme', stored);
  else if(window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches) root.setAttribute('data-theme','light');
  document.getElementById('themeToggle').addEventListener('click', ()=>{
    const cur = root.getAttribute('data-theme');
    const next = (cur === 'light') ? null : 'light';
    if(next){ root.setAttribute('data-theme', next); localStorage.setItem('rc_theme', next); } else { root.removeAttribute('data-theme'); localStorage.removeItem('rc_theme'); }
  });
})();

/* Bottom nav behaviour */
(function(){
  const navTasks=document.getElementById('navTasks'), navProfile=document.getElementById('navProfile'), tasksView=document.getElementById('tasksView'), profileView=document.getElementById('profileView');
  function setActive(view){
    if(window.innerWidth>1000){ tasksView.style.display=''; profileView.style.display=''; return; }
    if(view==='tasks'){ tasksView.style.display=''; profileView.style.display='none'; navTasks.classList.add('active'); navProfile.classList.remove('active'); }
    else { profileView.style.display=''; tasksView.style.display='none'; navProfile.classList.add('active'); navTasks.classList.remove('active'); }
  }
  navTasks.addEventListener('click', ()=> setActive('tasks'));
  navProfile.addEventListener('click', ()=> setActive('profile'));
  window.addEventListener('resize', ()=> { if(window.innerWidth>1000){ tasksView.style.display=''; profileView.style.display=''; } else setActive('tasks'); });
  if(window.innerWidth<=1000) setActive('tasks');
})();

/* Load existing task types into select */
async function loadTaskTypesIntoSelect(){
  try {
    const res = await fetch('/api/task_types');
    const types = await res.json();
    const sel = document.getElementById('taskTypeSelect');
    sel.innerHTML = '';
    types.forEach(t=>{
      const opt = document.createElement('option');
      opt.value = t.id;
      opt.textContent = `${t.name} ‚Äî ${t.unit_price} ‚ÇΩ`;
      sel.appendChild(opt);
    });
    return types;
  } catch(e){
    console.error('loadTaskTypes', e);
    return [];
  }
}

/* Load tasks */
async function loadTasks(){
  const grid = document.getElementById('tasksGrid');
  grid.innerHTML = '';
  for(let i=0;i<6;i++){ const sk=document.createElement('div'); sk.innerHTML='<div class="task skeleton" style="height:84px"></div>'; grid.appendChild(sk); }
  try {
    const res = await fetch('/api/tasks_public');
    const tasks = await res.json();
    grid.innerHTML = '';
    if(!Array.isArray(tasks) || tasks.length === 0){ grid.innerHTML = '<div class="muted">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π</div>'; return; }
    for(let t of tasks){
      const el = document.createElement('div'); el.className = 'fadeIn';
      el.innerHTML = `<div class="task"><div style="font-weight:700">${escapeHtml(t.title)}</div><div class="muted">${escapeHtml(t.description||'')}</div><div style="margin-top:8px;color:var(--muted)">${t.count? t.count + '√ó' + (t.unit_price||'') + ' ‚ÇΩ ‚Ä¢ ' + (t.budget||0)+' ‚ÇΩ': (t.budget? t.budget+' ‚ÇΩ':'')}</div>${t.link? '<div style="margin-top:6px"><a href="'+escapeHtml(t.link)+'" target="_blank" rel="noopener noreferrer">–ü–µ—Ä–µ–π—Ç–∏ –ø–æ —Å—Å—ã–ª–∫–µ</a></div>':''}</div>`;
      grid.appendChild(el);
      el.querySelector('.task').addEventListener('click', ()=> alert('–û—Ç–∫—Ä—ã—Ç–æ: '+(t.title||t.id)));
      await sleep(40);
    }
  } catch(e){
    console.error('loadTasks error', e);
    grid.innerHTML = '<div class="muted">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
  }
}

/* Profile toggle (fixed, multi-toggle, persisted in sessionStorage) */
(function(){
  const btn = document.getElementById('revealProfile');
  let shown = sessionStorage.getItem('rc_profile_shown') === '1';
  async function renderProfile(show){
    const fullname = document.getElementById('fullname'), handle = document.getElementById('handle'), avatar = document.getElementById('avatar');
    if(!show){
      fullname.textContent = '–ü—Ä–æ—Ñ–∏–ª—å —Å–∫—Ä—ã—Ç';
      handle.textContent = '–ù–∞–∂–º–∏—Ç–µ ¬´–ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å¬ª';
      btn.textContent = '–ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å';
      sessionStorage.setItem('rc_profile_shown', '0');
      return;
    }
    const tgInit = (window.Telegram && Telegram.WebApp && Telegram.WebApp.initData) ? Telegram.WebApp.initData : null;
    if(!tgInit){
      fullname.textContent = '–ì–æ—Å—Ç—å';
      handle.textContent = '–ü—Ä–æ—Ñ–∏–ª—å –æ—Ç–∫—Ä—ã—Ç –ª–æ–∫–∞–ª—å–Ω–æ';
      btn.textContent = '–°–∫—Ä—ã—Ç—å –ø—Ä–æ—Ñ–∏–ª—å';
      sessionStorage.setItem('rc_profile_shown', '1');
      return;
    }
    try {
      const res = await fetch('/api/profile_me', { headers: { 'X-Tg-InitData': tgInit }});
      const j = await res.json();
      if(j.ok){
        fullname.textContent = j.user.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
        handle.textContent = j.user.username ? '@'+j.user.username : 'UID: '+j.user.id;
        if(j.photo_url){
          avatar.innerHTML = ''; const img=document.createElement('img'); img.src=j.photo_url; img.style.width='72px'; img.style.height='72px'; img.style.borderRadius='12px'; avatar.appendChild(img);
        }
        btn.textContent = '–°–∫—Ä—ã—Ç—å –ø—Ä–æ—Ñ–∏–ª—å';
        sessionStorage.setItem('rc_profile_shown', '1');
        // load history
        const list = document.getElementById('history'); list.innerHTML='';
        const res2 = await fetch(`/api/user_history?uid=${encodeURIComponent(j.user.id)}&page=1&page_size=6`);
        const j2 = await res2.json();
        if(j2.ok && j2.items && j2.items.length>0){
          for(let it of j2.items){
            const row=document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.padding='8px 0'; row.style.borderBottom='1px dashed rgba(0,0,0,0.06)';
            row.innerHTML = `<div><div style="font-weight:700">${escapeHtml((it.type||'').toUpperCase())} ‚Äî ${escapeHtml(it.id||'')}</div><div class="muted" style="font-size:13px">${escapeHtml(it.summary||'')}</div></div><div style="text-align:right"><div style="font-weight:800">${it.amount? it.amount+' ‚ÇΩ': ''}</div><div class="muted" style="font-size:12px">${escapeHtml(it.created_at||'')}</div></div>`;
            list.appendChild(row);
          }
        } else { list.innerHTML = '<div class="muted">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</div>'; }
      } else {
        fullname.textContent = '–ü—Ä–æ—Ñ–∏–ª—å —Å–∫—Ä—ã—Ç';
        handle.textContent = '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è';
      }
    } catch(e){
      console.error('profile fetch', e);
      fullname.textContent = '–ü—Ä–æ—Ñ–∏–ª—å —Å–∫—Ä—ã—Ç';
      handle.textContent = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏';
    }
  }
  (async ()=>{ shown = sessionStorage.getItem('rc_profile_shown') === '1'; await renderProfile(shown); })();
  btn.addEventListener('click', async ()=> { shown = !shown; await renderProfile(shown); });
})();

/* Support (works from browser and WebApp) */
document.getElementById('supportBtn').addEventListener('click', async ()=>{
  const text = prompt('–û–ø–∏—à–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—É:'); if(!text) return;
  try {
    const headers = {'Content-Type':'application/json'}; if(window.Telegram && Telegram.WebApp && Telegram.WebApp.initData) headers['X-Tg-InitData'] = Telegram.WebApp.initData;
    const res = await fetch('/api/support', { method:'POST', headers, body: JSON.stringify({ message: text })});
    const j = await res.json();
    if(!j.ok) alert('–û—à–∏–±–∫–∞: '+(j.reason||'')); else alert('–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É');
  } catch(e){ alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'); }
});

/* Create task modal + autoadjust budget logic (0.8s debounce) */
(function(){
  const createBtn = document.getElementById('createTaskBtn');
  const createModal = document.getElementById('createModal');
  const closeCreate = document.getElementById('closeCreate');
  const cancelCreate = document.getElementById('cancelCreate');
  const submitTask = document.getElementById('submitTask');
  const typeSelect = document.getElementById('taskTypeSelect');
  const budgetInput = document.getElementById('taskBudget');
  const budgetInfo = document.getElementById('budgetInfo');
  const feedback = document.getElementById('createFeedback');

  let typesCache = [];
  async function refreshTypes(){
    typesCache = await loadTaskTypes();
    typeSelect.innerHTML = '';
    typesCache.forEach(t => {
      const opt = document.createElement('option');
      opt.value = t.id;
      opt.textContent = `${t.name} ‚Äî ${t.unit_price} ‚ÇΩ`;
      typeSelect.appendChild(opt);
    });
    updateBudgetInfo(); // recompute
  }

  async function loadTaskTypes(){
    try {
      const res = await fetch('/api/task_types');
      const json = await res.json();
      return Array.isArray(json)? json : [];
    } catch(e){
      console.error('loadTaskTypes', e);
      return [];
    }
  }

  // Debounce 0.8s
  let debounceTimer = null;
  function scheduleAdjust(){
    if(debounceTimer) clearTimeout(debounceTimer);
    debounceTimer = setTimeout(adjustBudget, 800);
  }

  function updateBudgetInfo(){
    // compute unit price and show info
    const sel = typeSelect.value;
    const unit = (typesCache.find(t=>t.id===sel)?.unit_price) || 1;
    budgetInfo.textContent = `–¶–µ–Ω–∞ –∑–∞ 1 –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ: ${unit} ‚ÇΩ`;
  }

  function adjustBudget(){
    const val = Number(String(budgetInput.value || '').replace(',', '.')) || 0;
    const sel = typeSelect.value;
    const unit = (typesCache.find(t=>t.id===sel)?.unit_price) || 1;
    if(unit <= 0){
      budgetInfo.textContent = '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Ü–µ–Ω–∞ –≤ —Ç–∏–ø–µ';
      return;
    }
    // desiredCount = round(val / unit)
    let desiredCount = Math.round(val / unit);
    if(desiredCount * unit > val){
      desiredCount = Math.floor(val / unit);
    }
    const finalBudget = desiredCount * unit;
    budgetInfo.textContent = `–ü–æ—Å–ª–µ –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è: ${desiredCount} —à—Ç. √ó ${unit} ‚ÇΩ = ${finalBudget} ‚ÇΩ (–≤–Ω–∏–∑, –µ—Å–ª–∏ –ø—Ä–µ–≤—ã—Å–∏—Ç –≤–≤–æ–¥)`;
    // reflect in input (optional) ‚Äî show final budget but keep original if admin wants to edit
    // We'll not overwrite user's input automatically; show adjusted value beside it.
  }

  // wire events
  typeSelect.addEventListener('change', ()=>{ updateBudgetInfo(); scheduleAdjust(); });
  budgetInput.addEventListener('input', ()=> scheduleAdjust());

  // show modal only if adminToken present
  if(adminToken){
    createBtn.style.display = '';
    document.getElementById('createTypeBtn').style.display = '';
    createBtn.addEventListener('click', async ()=> {
      createModal.style.display = 'flex';
      createModal.setAttribute('aria-hidden', 'false');
      typesCache = await loadTaskTypesIntoSelect();
      await refreshTypes();
      budgetInfo.textContent = '–í–≤–æ–¥–∏—Ç–µ —Å—É–º–º—É ‚Äî —á–µ—Ä–µ–∑ 0.8—Å –æ–Ω–∞ –±—É–¥–µ—Ç –æ–∫—Ä—É–≥–ª–µ–Ω–∞ –∫ –±–ª–∏–∂–∞–π—à–µ–º—É –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –∏ –æ–∫—Ä—É–≥–ª–µ–Ω–∞ –≤–Ω–∏–∑ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.';
    });
    closeCreate.addEventListener('click', ()=> { createModal.style.display = 'none'; createModal.setAttribute('aria-hidden', 'true'); });
    cancelCreate.addEventListener('click', ()=> { createModal.style.display = 'none'; createModal.setAttribute('aria-hidden', 'true'); });
    submitTask.addEventListener('click', async ()=>{
      const title = document.getElementById('taskTitle').value.trim();
      const desc = document.getElementById('taskDesc').value.trim();
      const link = document.getElementById('taskLink').value.trim();
      let budget = Number(String(document.getElementById('taskBudget').value || '').replace(',', '.')) || 0;
      const type_id = document.getElementById('taskTypeSelect').value;
      if(!title){ feedback.textContent = '–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏'; return; }
      // link validation
      if(link){
        try { const u = new URL(link); if(u.protocol !== 'http:' && u.protocol !== 'https:'){ feedback.textContent = '–°—Å—ã–ª–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å http/https'; return; } } catch(e){ feedback.textContent = '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—Å—ã–ª–∫–∞'; return; }
      }
      // compute adjusted final budget based on selected type unit price
      const unit = (typesCache.find(t=>t.id===type_id)?.unit_price) || 1;
      let desiredCount = Math.round(budget / unit);
      if(desiredCount * unit > budget) desiredCount = Math.floor(budget / unit);
      const finalBudget = desiredCount * unit;
      if(desiredCount <= 0 && unit > 0){
        feedback.textContent = `–ë—é–¥–∂–µ—Ç —Å–ª–∏—à–∫–æ–º –º–∞–ª ‚Äî –º–∏–Ω–∏–º—É–º ${unit} ‚ÇΩ –∑–∞ 1 –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ`;
        return;
      }
      feedback.textContent = '–°–æ–∑–¥–∞–Ω–∏–µ...';
      try {
        const res = await fetch('/api/tasks_create?token=' + encodeURIComponent(adminToken), {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ title, description: desc, link, budget: finalBudget, type_id })
        });
        const j = await res.json();
        if(!j.ok){
          feedback.textContent = '–û—à–∏–±–∫–∞: ' + (j.reason || '');
        } else {
          feedback.textContent = '–ó–∞–¥–∞—á–∞ —Å–æ–∑–¥–∞–Ω–∞';
          createModal.style.display = 'none';
          loadTasks();
        }
      } catch(e){
        feedback.textContent = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏';
        console.error(e);
      }
    });
  } else {
    createBtn.style.display = 'none';
    document.getElementById('createTypeBtn').style.display = 'none';
  }
})();

/* Add type modal (admin only) */
(function(){
  const createTypeBtn = document.getElementById('createTypeBtn');
  const modal = document.getElementById('createTypeModal');
  const closeType = document.getElementById('closeType');
  const submitType = document.getElementById('submitType');
  const cancelType = document.getElementById('cancelType');
  const feedback = document.getElementById('typeFeedback');

  if(adminToken){
    createTypeBtn.addEventListener('click', ()=> { modal.style.display = 'flex'; modal.setAttribute('aria-hidden','false'); feedback.textContent=''; });
    closeType.addEventListener('click', ()=> { modal.style.display = 'none'; modal.setAttribute('aria-hidden','true'); });
    cancelType.addEventListener('click', ()=> { modal.style.display = 'none'; modal.setAttribute('aria-hidden','true'); });
    submitType.addEventListener('click', async ()=>{
      const id = document.getElementById('typeId').value.trim();
      const name = document.getElementById('typeName').value.trim();
      const price = Number(String(document.getElementById('typePrice').value || '').replace(',', '.')) || 0;
      if(!id || !name || price <= 0){ feedback.textContent = '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ'; return; }
      feedback.textContent = '–î–æ–±–∞–≤–ª–µ–Ω–∏–µ...';
      try {
        const res = await fetch('/api/task_types_add?token=' + encodeURIComponent(adminToken), {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ id, name, unit_price: Math.round(price) })
        });
        const j = await res.json();
        if(!j.ok){ feedback.textContent = '–û—à–∏–±–∫–∞: ' + (j.reason || ''); }
        else { feedback.textContent = '–¢–∏–ø –¥–æ–±–∞–≤–ª–µ–Ω'; modal.style.display='none'; document.getElementById('createTaskBtn').click(); } // reopen create task to refresh types
      } catch(e){ feedback.textContent = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'; console.error(e); }
    });
  }
})();

/* socket.io listen new_task */
try {
  const sock = io();
  sock.on('connect', ()=> console.log('socket connected'));
  sock.on('new_task', ()=> loadTasks());
} catch(e){ console.warn('socket fail', e); }

/* Support, topup, withdraw quick handlers */
document.getElementById('topupBtn').addEventListener('click', async ()=>{
  const s = prompt('–°—É–º–º–∞ (–º–∏–Ω.100 ‚ÇΩ):'); if(!s) return;
  const amount = parseFloat(s.replace(',', '.')); if(isNaN(amount) || amount < 100){ alert('–ú–∏–Ω.100 ‚ÇΩ'); return; }
  try {
    const headers = {'Content-Type':'application/json'}; if(window.Telegram && Telegram.WebApp && Telegram.WebApp.initData) headers['X-Tg-InitData'] = Telegram.WebApp.initData;
    const res = await fetch('/api/topups_public', { method:'POST', headers, body: JSON.stringify({ amount })});
    const j = await res.json();
    if(!j.ok) alert('–û—à–∏–±–∫–∞: '+(j.reason||'')); else alert(`–°–æ–∑–¥–∞–Ω–æ. –ö–æ–¥: ${j.topup.code}. –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –∞–¥–º–∏–Ω–∞–º.`);
  } catch(e){ alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'); }
});
document.getElementById('withdrawBtn').addEventListener('click', async ()=>{
  const s = prompt('–°—É–º–º–∞ (–º–∏–Ω.250 ‚ÇΩ):'); if(!s) return;
  const amount = parseFloat(s.replace(',', '.')); if(isNaN(amount) || amount < 250){ alert('–ú–∏–Ω.250 ‚ÇΩ'); return; }
  const name = prompt('–§–ò–û/–Ω–∏–∫:'); if(!name) return;
  const bank = prompt('–ë–∞–Ω–∫/—Ä–µ–∫–≤–∏–∑–∏—Ç—ã:'); if(!bank) return;
  try {
    const headers = {'Content-Type':'application/json'}; if(window.Telegram && Telegram.WebApp && Telegram.WebApp.initData) headers['X-Tg-InitData'] = Telegram.WebApp.initData;
    const res = await fetch('/api/withdraw_public', { method:'POST', headers, body: JSON.stringify({ amount, name, bank })});
    const j = await res.json();
    if(!j.ok){ if(j.reason==='insufficient_balance') alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤: '+(j.balance||0)); else alert('–û—à–∏–±–∫–∞: '+(j.reason||'')); return; }
    alert('–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞. –í —Ç–µ—á–µ–Ω–∏–µ 24 —á–∞—Å–æ–≤.');
  } catch(e){ alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'); }
});

/* Init */
document.getElementById('refreshBtn').addEventListener('click', ()=> loadTasks());
loadTasks();
</script>
</body>
</html>
