<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ReviewCash — WebApp</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<style>
  :root{
    --bg:#071426; --panel:#071a2a; --accent1:#00f0ff; --accent2:#00ff9d;
    --muted:#9fb6c6; --gold:#ffd166; --glass:rgba(255,255,255,0.04);
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Arial;background:linear-gradient(135deg,var(--bg),#081a33);color:#eaf7fb;min-height:100vh;overflow-x:hidden}
  .wrap{max-width:980px;margin:0 auto;padding:20px;display:grid;grid-template-columns:1fr 360px;gap:20px;opacity:0;transform:translateY(20px);animation:enter 800ms cubic-bezier(.2,.9,.2,1) forwards;}
  @keyframes enter{to{opacity:1;transform:none}}
  header{display:flex;align-items:center;gap:12px}
  .mark{width:56px;height:56px;border-radius:12px;background:linear-gradient(90deg,var(--accent1),var(--accent2));display:flex;align-items:center;justify-content:center;color:#012226;font-weight:900;box-shadow:0 8px 30px rgba(0,240,255,0.08)}
  h1{margin:0;font-size:20px}
  .tabs{display:flex;gap:8px;margin-top:12px}
  .tab{padding:10px 14px;border-radius:12px;background:transparent;border:1px solid rgba(255,255,255,0.04);cursor:pointer}
  .tab.active{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#012226}
  .panel{background:var(--panel);padding:16px;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,0.4)}
  .tasks-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
  .task{padding:16px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);cursor:pointer;transition:transform .18s ease, box-shadow .18s ease}
  .task:hover{transform:translateY(-6px);box-shadow:0 18px 40px rgba(2,16,32,0.6)}
  .avatar{width:120px;height:120px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;background:linear-gradient(90deg,#05202a,#04202a);font-weight:900;color:var(--accent1);border:6px solid rgba(0,255,200,0.06)}
  .support-btn{
    position:fixed;right:22px;bottom:22px;width:64px;height:64px;border-radius:50%;background:linear-gradient(90deg,var(--accent2),var(--accent1));display:flex;align-items:center;justify-content:center;color:#012226;font-weight:800;box-shadow:0 12px 40px rgba(0,255,160,0.12),0 6px 18px rgba(0,255,160,0.06);cursor:pointer;z-index:999;
    animation:btnPulse 2000ms infinite;
  }
  @keyframes btnPulse{0%{transform:scale(1)}50%{transform:scale(1.06)}100%{transform:scale(1)}}
  .pulse-ring{position:absolute;right:-6px;bottom:-6px;width:76px;height:76px;border-radius:50%;border:2px solid rgba(0,255,160,0.06);pointer-events:none}
  .modal-backdrop{position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(2,8,16,0.6);display:none;align-items:center;justify-content:center;z-index:1000}
  .modal{width:520px;max-width:94%;background:linear-gradient(180deg,#082033, #041827);padding:18px;border-radius:12px;color:#eaf7fb;box-shadow:0 20px 60px rgba(0,0,0,0.6)}
  .modal h3{margin:0 0 10px 0}
  .modal textarea, .modal input {width:100%;padding:10px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.06);color:#eaf7fb;margin-bottom:10px}
  .modal .row{display:flex;gap:8px}
  .btn {padding:10px 14px;border-radius:10px;background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#012226;border:none;cursor:pointer}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
  footer{margin-top:18px;color:var(--muted);font-size:13px}
</style>
</head>
<body>
<div class="wrap" id="app">
  <div>
    <header>
      <div class="mark">RC</div>
      <div>
        <h1>ReviewCash</h1>
        <div style="color:var(--muted)">Отзывы и выплаты — интерактивно</div>
      </div>
      <div style="margin-left:auto;display:flex;gap:8px">
        <button id="adminBtn" class="tab">Админ-панель</button>
        <button id="refreshBtn" class="tab">Обновить</button>
      </div>
    </header>

    <div class="tabs">
      <button id="tabTasks" class="tab active">Задания</button>
      <button id="tabProfile" class="tab">Профиль</button>
    </div>

    <main id="tasksView" class="panel" style="margin-top:12px">
      <div style="display:flex;gap:8px;margin-bottom:12px">
        <input id="search" placeholder="Поиск..." style="flex:1;padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:#eaf7fb"/>
        <button id="createBtn" class="btn ghost">+ Создать</button>
      </div>
      <div id="tasksGrid" class="tasks-grid"></div>
    </main>

    <section id="profileView" class="panel" style="display:none;margin-top:12px">
      <div style="text-align:center">
        <div id="avatar" class="avatar">RC</div>
        <div id="fullname" style="font-weight:800;margin-top:8px">Гость</div>
        <div id="handle" style="color:var(--muted)">@guest</div>
        <div id="balance" style="font-weight:900;font-size:28px;color:var(--gold);margin-top:8px">0 ₽</div>
        <div style="display:flex;flex-direction:column;gap:8px;margin-top:12px">
          <button id="topupBtn" class="btn">Пополнить</button>
          <button id="withdrawBtn" class="btn ghost">Вывести</button>
        </div>
      </div>
      <div style="margin-top:12px">
        <h3>Мои заявки</h3>
        <div id="myList" style="color:var(--muted)">Загрузка...</div>
      </div>
    </section>
  </div>

  <aside>
    <div class="panel">
      <h3 style="margin:0 0 8px 0">Статистика</h3>
      <div style="color:var(--muted)">Заявок: <span id="statRequests">0</span></div>
      <div style="color:var(--muted);margin-top:6px">Пользователей: <span id="statUsers">—</span></div>
    </div>
  </aside>
</div>

<!-- Support floating button -->
<div class="support-btn" id="supportBtn" title="Поддержка">
  <div style="position:relative;z-index:2">?</div>
  <div class="pulse-ring"></div>
</div>

<!-- Modal backdrop -->
<div class="modal-backdrop" id="modalBackdrop">
  <div class="modal" id="modal">
    <h3 id="modalTitle">Поддержка</h3>
    <div id="modalBody"></div>
    <div style="text-align:right;margin-top:8px">
      <button id="modalCancel" class="btn ghost">Отмена</button>
      <button id="modalSubmit" class="btn">Отправить</button>
    </div>
  </div>
</div>

<footer style="text-align:center;margin-top:20px">© ReviewCash — интерактивная платформа</footer>

<script>
(function(){
  const qsVal = k => new URLSearchParams(location.search).get(k) || '';
  const token = qsVal('token') || '';
  const modalBackdrop = document.getElementById('modalBackdrop');
  const modal = document.getElementById('modal');
  const modalTitle = document.getElementById('modalTitle');
  const modalBody = document.getElementById('modalBody');
  const modalCancel = document.getElementById('modalCancel');
  const modalSubmit = document.getElementById('modalSubmit');

  function openModal(title, innerHTML, onSubmit){
    modalTitle.textContent = title;
    modalBody.innerHTML = innerHTML;
    modalBackdrop.style.display = 'flex';
    modalSubmit.onclick = async ()=> {
      try {
        const data = {};
        // collect inputs
        modalBody.querySelectorAll('input,textarea,select').forEach(el=>{
          if(el.name) data[el.name] = el.value;
        });
        await onSubmit(data);
        closeModal();
      } catch(e){
        alert("Ошибка: " + (e.message||e));
      }
    };
  }
  function closeModal(){ modalBackdrop.style.display = 'none'; modalBody.innerHTML=''; }

  modalCancel.addEventListener('click', closeModal);
  modalBackdrop.addEventListener('click', (e)=> { if(e.target===modalBackdrop) closeModal(); });

  // Support button
  document.getElementById('supportBtn').addEventListener('click', ()=> {
    openModal("Поддержка", `
      <p>Опишите вашу проблему — мы свяжемся с вами.</p>
      <textarea name="message" placeholder="Ваше сообщение" rows="5"></textarea>
      <input name="contact" placeholder="Email или Telegram (необязательно)"/>
    `, async (formData)=>{
      if(!formData.message || formData.message.trim().length<5) throw new Error("Опишите проблему минимум 5 символов.");
      const res = await fetch('/api/support', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(formData)});
      const j = await res.json();
      if(!j.ok) throw new Error(j.reason || 'Ошибка отправки');
      alert('Сообщение отправлено — спасибо!');
    });
  });

  // Topup modal
  document.getElementById('topupBtn').addEventListener('click', ()=> {
    openModal("Пополнение", `
      <p>Укажите сумму и реквизиты.</p>
      <input name="amount" placeholder="Сумма (₽)" />
      <textarea name="details" placeholder="Комментарий / реквизиты" rows="3"></textarea>
    `, async (formData)=>{
      const amount = parseFloat(formData.amount);
      if(!amount || amount<=0) throw new Error("Введите корректную сумму.");
      const res = await fetch('/api/topups_public', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({amount: amount, details: formData.details||''})});
      const j = await res.json();
      if(!j.ok) throw new Error(j.reason || 'Ошибка');
      alert('Заявка на пополнение создана!');
    });
  });

  // Withdraw modal
  document.getElementById('withdrawBtn').addEventListener('click', ()=> {
    openModal("Вывод средств", `
      <p>Укажите сумму и метод выплаты.</p>
      <input name="amount" placeholder="Сумма (₽)" />
      <input name="method" placeholder="Метод (например, bank/card/qiwi)" />
      <textarea name="details" placeholder="Реквизиты" rows="3"></textarea>
    `, async (formData)=>{
      const amount = parseFloat(formData.amount);
      if(!amount || amount<=0) throw new Error("Введите корректную сумму.");
      if(!formData.method || formData.method.trim().length<2) throw new Error("Укажите метод выплаты.");
      const res = await fetch('/api/withdraw_public', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({amount: amount, method: formData.method, details: formData.details||''})});
      const j = await res.json();
      if(!j.ok) throw new Error(j.reason || 'Ошибка');
      alert('Заявка на вывод создана!');
    });
  });

  // Admin button
  document.getElementById('adminBtn').addEventListener('click', ()=> {
    if(token) window.open('/mainadmin?token=' + encodeURIComponent(token), '_blank');
    else alert('Требуется админ-токен (откройте панель через Telegram).');
  });

  // Refresh button
  document.getElementById('refreshBtn').addEventListener('click', ()=> loadTasks());

  // Load tasks
  async function loadTasks(){
    try {
      const res = await fetch('/api/tasks_public');
      const data = await res.json();
      const el = document.getElementById('tasksGrid');
      el.innerHTML = '';
      if(!data || data.length===0){ el.innerHTML = '<div style="color:var(--muted)">Нет заданий</div>'; return; }
      data.forEach(t=>{
        const node = document.createElement('div');
        node.className = 'task';
        node.innerHTML = `<div style="font-weight:800">${t.title||t.id}</div><div style="color:var(--muted);margin-top:6px">${t.type||''} · ${t.budget? t.budget + ' ₽' : ''}</div>`;
        node.addEventListener('click', ()=> {
          openModal("Задание: " + (t.title||t.id), `<p>Ссылка: <a href="${t.link||'#'}" target="_blank">${t.link||'—'}</a></p><p>Бюджет: ${t.budget||0} ₽</p><div style="text-align:right"><button class="btn" onclick="alert('Для выполнения задания используйте WebApp.');">Выполнить</button></div>`);
        });
        el.appendChild(node);
      });
    } catch(e){ console.warn(e); }
  }

  // Init
  document.addEventListener('DOMContentLoaded', ()=> {
    loadTasks();
    // show wrap after animation declared in CSS (already animated)
    // Optionally, connect to socket for real-time notifications (if admin token provided)
    if(token){
      try {
        const sock = io({ auth: { token }, transports: ['websocket'] });
        sock.on('connect', ()=> console.log('socket connected'));
        sock.on('new_topup', data => { alert('Новый топап (админ): ' + (data.amount || '')); });
        sock.on('new_support', data => { alert('Новый запрос в поддержку (админ)'); });
      } catch(e){
        console.warn('Socket init failed', e);
      }
    }
  });

})();
</script>
</body>
</html>
