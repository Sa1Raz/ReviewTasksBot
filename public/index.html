<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ReviewCash ‚Äî –∫—Ä–∞—Å–∏–≤–∞—è –≤–µ—Ä—Å–∏—è</title>

<!-- Fonts & Icons -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Poppins:wght@600;800&display=swap" rel="stylesheet">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

<!-- Lottie for entrance animation -->
<script src="https://unpkg.com/lottie-web@5.8.1/build/player/lottie.min.js"></script>
<!-- Socket.IO (if enabled on backend) -->
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<style>
  :root{
    --bg-1: #031025;
    --bg-2: #0b2030;
    --glass: rgba(255,255,255,0.06);
    --accentA: #00f0ff;
    --accentB: #00ff9d;
    --muted: #9fb6c6;
    --gold: #ffd166;
    --card-shadow: 0 10px 30px rgba(4,19,30,0.6);
    --glass-border: rgba(255,255,255,0.06);
    --radius: 14px;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background: radial-gradient(1200px 600px at 10% 10%, rgba(0,240,255,0.04), transparent),
                linear-gradient(180deg, var(--bg-1), var(--bg-2));
    color:#eaf7fb;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    overflow-x:hidden;
  }

  /* Layout */
  .container{max-width:1200px;margin:28px auto;padding:24px;display:grid;grid-template-columns:1fr 380px;gap:24px;align-items:start}
  .shell{background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent); border-radius:var(--radius); padding:18px; box-shadow: var(--card-shadow); border:1px solid var(--glass-border);}

  header.app-header{display:flex;gap:16px;align-items:center;margin-bottom:12px}
  .logo{
    width:68px;height:68px;border-radius:14px;background:linear-gradient(135deg,var(--accentA),var(--accentB));
    display:flex;align-items:center;justify-content:center;color:#012226;font-weight:800;font-family:Poppins,Inter;font-size:20px;box-shadow:0 18px 50px rgba(0,240,255,0.06);
  }
  .title{display:flex;flex-direction:column}
  .title h1{margin:0;font-size:20px;font-weight:800}
  .title p{margin:0;color:var(--muted);font-size:13px}

  /* Animated hero */
  .hero{
    display:flex;gap:16px;align-items:center;padding:16px;border-radius:12px;background:linear-gradient(90deg, rgba(0,255,160,0.03), transparent);
    border:1px solid rgba(255,255,255,0.02);
  }
  #lottie {width:140px;height:140px;flex:0 0 140px}

  /* Tabs */
  .tabs{display:flex;gap:10px;margin-top:14px}
  .tab{padding:8px 12px;border-radius:10px;background:transparent;border:1px solid rgba(255,255,255,0.03);cursor:pointer;color:var(--muted)}
  .tab.active{background:linear-gradient(90deg,var(--accentA),var(--accentB));color:#012226;font-weight:700;border:none;box-shadow:0 12px 35px rgba(0,240,255,0.06)}

  /* Tasks grid */
  .tasks-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px;margin-top:12px}
  .task{
    background: linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));
    border-radius:12px;padding:14px;border:1px solid var(--glass-border);transition:transform .22s cubic-bezier(.2,.9,.2,1), box-shadow .22s;
    cursor:pointer;overflow:hidden;position:relative;
  }
  .task:hover{transform:translateY(-10px);box-shadow:0 30px 60px rgba(0,0,0,0.6)}
  .task .meta{display:flex;align-items:center;gap:12px}
  .task .badge{background:rgba(255,255,255,0.02);padding:6px 8px;border-radius:8px;font-size:13px;color:var(--muted)}
  .task .title{font-weight:700;margin-top:8px}

  /* Right column */
  .right-col{display:flex;flex-direction:column;gap:14px}
  .panel{padding:16px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);border:1px solid var(--glass-border)}

  .profile{
    display:flex;gap:12px;align-items:center;
  }
  .avatar{width:84px;height:84px;border-radius:14px;background:linear-gradient(135deg,#04202a,#05202a);display:flex;align-items:center;justify-content:center;color:var(--accentA);font-weight:800;font-size:22px;border:5px solid rgba(0,255,200,0.04)}
  .profile .info{flex:1}
  .profile .info .name{font-weight:800}
  .profile .info .handle{color:var(--muted);font-size:13px}

  .stat{display:flex;gap:12px;align-items:center;justify-content:space-between;background:rgba(255,255,255,0.01);padding:12px;border-radius:10px;margin-top:10px}

  /* Floating support chat */
  .support-fab{
    position:fixed;right:28px;bottom:28px;width:72px;height:72px;border-radius:20px;background:linear-gradient(135deg,var(--accentB),var(--accentA));
    display:flex;align-items:center;justify-content:center;color:#012226;font-weight:800;z-index:2000;box-shadow:0 20px 60px rgba(0,255,160,0.12);cursor:pointer;
    transition:transform .2s;
  }
  .support-fab:hover{transform:translateY(-6px)}
  .support-fab .dot{position:absolute;right:8px;top:8px;width:12px;height:12px;background:#ff6b6b;border-radius:10px;box-shadow:0 6px 14px rgba(255,107,107,0.12)}

  /* Chat modal */
  .chat-backdrop{position:fixed;left:0;top:0;width:100%;height:100%;display:none;align-items:flex-end;justify-content:center;background:linear-gradient(180deg, rgba(0,0,0,0.4), rgba(0,0,0,0.6));z-index:2010}
  .chat-window{width:420px;max-width:96%;height:68vh;border-radius:14px;background:linear-gradient(180deg,#042231,#021b28);margin-bottom:28px;padding:12px;display:flex;flex-direction:column;gap:10px;border:1px solid rgba(255,255,255,0.04)}
  .chat-head{display:flex;align-items:center;gap:12px}
  .chat-messages{flex:1;overflow:auto;padding:8px;display:flex;flex-direction:column;gap:8px}
  .msg{max-width:78%;padding:10px;border-radius:12px;background:rgba(255,255,255,0.02);align-self:flex-start}
  .msg.me{background:linear-gradient(90deg,var(--accentA),var(--accentB));color:#012226;align-self:flex-end}
  .chat-input{display:flex;gap:8px}
  .chat-input input{flex:1;padding:10px;border-radius:10px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:#eaf7fb}
  .chat-input button{padding:10px 12px;border-radius:10px;background:linear-gradient(90deg,var(--accentA),var(--accentB));color:#012226;border:none;cursor:pointer}

  /* Toast */
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:96px;background:#05202a;padding:12px 16px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);box-shadow:0 12px 30px rgba(2,16,32,0.6);color:#eaf7fb;z-index:3000;display:none}

  /* History panel styles */
  .history-panel{margin-top:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);max-height:220px;overflow:auto}
  .controls{display:flex;gap:8px;align-items:center;margin-bottom:8px}
  .btn-mini{padding:6px 8px;border-radius:8px;background:linear-gradient(90deg,#00f0ff,#00ff9d);color:#012226;border:none;cursor:pointer}
  .pager{display:flex;justify-content:center;margin-top:8px;color:#9fb6c6}

  /* Responsive */
  @media (max-width:980px){
    .container{grid-template-columns:1fr; padding:14px}
    .right-col{order:2}
    .hero{flex-direction:column;align-items:flex-start}
  }
</style>
</head>
<body>
  <div class="container">
    <div>
      <div class="shell">
        <header class="app-header">
          <div class="logo">RC</div>
          <div class="title">
            <h1>ReviewCash</h1>
            <p>–ö—Ä–∞—Å–∏–≤—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å ‚Äî –æ—Ç–∑—ã–≤—ã, –∑–∞–¥–∞–Ω–∏—è –∏ –≤—ã–ø–ª–∞—Ç—ã</p>
          </div>
          <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
            <button id="refreshBtn" class="tab">–û–±–Ω–æ–≤–∏—Ç—å</button>
            <button id="adminBtn" class="tab">–ê–¥–º–∏–Ω</button>
          </div>
        </header>

        <div class="hero" aria-hidden="false">
          <div id="lottie"></div>
          <div style="flex:1">
            <h2 style="margin:0 0 6px 0">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ ReviewCash</h2>
            <p style="margin:0;color:var(--muted)">–í—ã–ø–æ–ª–Ω—è–π—Ç–µ –∑–∞–¥–∞–Ω–∏—è, –ø–æ–ª—É—á–∞–π—Ç–µ –≤—ã–ø–ª–∞—Ç—ã –∏ –æ–±—â–∞–π—Ç–µ—Å—å —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –ø—Ä—è–º–æ –∏–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –∏–ª–∏ —á–µ—Ä–µ–∑ Telegram WebApp.</p>
            <div style="margin-top:12px;display:flex;gap:8px">
              <button id="openTasks" class="tab active">–ó–∞–¥–∞–Ω–∏—è</button>
              <button id="openProfile" class="tab">–ü—Ä–æ—Ñ–∏–ª—å</button>
              <button id="quickTopup" class="btn" style="margin-left:auto">–ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>
            </div>
          </div>
        </div>

        <div class="tabs" style="margin-top:12px">
          <div id="tabTasks" class="tab active">–ó–∞–¥–∞–Ω–∏—è</div>
          <div id="tabProfile" class="tab">–ü—Ä–æ—Ñ–∏–ª—å</div>
          <div id="tabSupport" class="tab">–ü–æ–¥–¥–µ—Ä–∂–∫–∞</div>
        </div>

        <div id="tasksSection" style="margin-top:12px">
          <div style="display:flex;gap:10px;align-items:center">
            <input id="search" placeholder="–ü–æ–∏—Å–∫ –∑–∞–¥–∞—á..." style="flex:1;padding:10px;border-radius:10px;background:transparent;border:1px solid rgba(255,255,255,0.03);color:#eaf7fb" />
            <button id="createBtn" class="tab">+ –°–æ–∑–¥–∞—Ç—å</button>
          </div>
          <div id="tasksGrid" class="tasks-grid" aria-live="polite" style="margin-top:12px">
            <!-- tasks will be injected -->
          </div>
        </div>

      </div>
    </div>

    <aside class="right-col">
      <div class="panel profile">
        <div class="avatar" id="avatar">RC</div>
        <div class="info">
          <div class="name" id="fullname">–ì–æ—Å—Ç—å</div>
          <div class="handle" id="handle">@guest</div>
          <div style="margin-top:8px;font-weight:800;font-size:20px;color:var(--gold)" id="balance">0 ‚ÇΩ</div>
        </div>
      </div>

      <div class="panel">
        <div style="display:flex;align-items:center;justify-content:space-between">
          <strong>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</strong>
          <small style="color:var(--muted)">–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</small>
        </div>
        <div class="stat" style="margin-top:10px">
          <div>
            <div style="font-size:13px;color:var(--muted)">–ó–∞—è–≤–æ–∫</div>
            <div style="font-weight:800" id="statRequests">0</div>
          </div>
          <div>
            <div style="font-size:13px;color:var(--muted)">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
            <div style="font-weight:800" id="statUsers">‚Äî</div>
          </div>
        </div>
      </div>

      <div class="panel">
        <strong>–ò—Å—Ç–æ—Ä–∏—è –¥–µ–π—Å—Ç–≤–∏–π</strong>
        <div style="margin-top:8px;color:var(--muted);font-size:13px">–ü—Ä–æ—Å–º–æ—Ç—Ä –æ–ø–µ—Ä–∞—Ü–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è, –≤—ã–≤–æ–¥—ã, —Ä–∞–±–æ—Ç—ã)</div>

        <div style="margin-top:10px" id="historyControls" class="controls">
          <select id="historyFilter">
            <option value="">–í—Å–µ</option>
            <option value="topup">–ü–æ–ø–æ–ª–Ω–µ–Ω–∏—è</option>
            <option value="withdraw">–í—ã–≤–æ–¥—ã</option>
            <option value="work">–†–∞–±–æ—Ç—ã</option>
          </select>
          <div style="flex:1"></div>
          <input id="uidManual" placeholder="UID (–µ—Å–ª–∏ –Ω–µ—Ç WebApp)" style="padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.03);color:#eaf7fb"/>
          <button id="uidLoadBtn" class="btn-mini">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
        </div>

        <div id="historyList" class="history-panel">
          <div style="color:var(--muted)">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</div>
        </div>

        <div class="pager" id="historyPager">–°—Ç—Ä–∞–Ω–∏—Ü–∞ 1</div>
      </div>
    </aside>
  </div>

  <!-- Floating Support button -->
  <div class="support-fab" id="supportFab" title="–ü–æ–¥–¥–µ—Ä–∂–∫–∞">
    <div style="font-size:22px">üí¨</div>
    <div class="dot"></div>
  </div>

  <!-- Chat modal -->
  <div class="chat-backdrop" id="chatBackdrop" role="dialog" aria-modal="true">
    <div class="chat-window" id="chatWindow">
      <div class="chat-head">
        <div style="font-weight:800">–ü–æ–¥–¥–µ—Ä–∂–∫–∞</div>
        <div style="margin-left:auto"><button id="closeChat" class="tab">–ó–∞–∫—Ä—ã—Ç—å</button></div>
      </div>
      <div class="chat-messages" id="chatMessages" aria-live="polite">
        <!-- messages -->
      </div>
      <div class="chat-input">
        <input id="chatInput" placeholder="–û–ø–∏—à–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—É..." />
        <button id="chatSend">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast">–ì–æ—Ç–æ–≤–æ</div>

<script>
/* =========================
   Helper UI / network logic
   ========================= */
const toastEl = document.getElementById('toast');
function showToast(text, delay=2200){
  toastEl.textContent = text;
  toastEl.style.display = 'block';
  setTimeout(()=> toastEl.style.display='none', delay);
}

/* Lottie animation */
try {
  const anim = lottie.loadAnimation({
    container: document.getElementById('lottie'),
    renderer: 'svg',
    loop: true,
    autoplay: true,
    path: 'https://assets10.lottiefiles.com/packages/lf20_jbrw3hcz.json' // soft abstract animation
  });
} catch(e){ console.warn('lottie fail', e) }

/* Basic state */
let tasks = [];
let activities = [];
const tasksGrid = document.getElementById('tasksGrid');
const activityEl = document.getElementById('activity');
const statRequests = document.getElementById('statRequests');
const statUsers = document.getElementById('statUsers');

function addActivity(text){
  const time = new Date().toLocaleTimeString();
  activities.unshift({t:time,text});
  if(activities.length>50) activities.pop();
  renderActivities();
}
function renderActivities(){
  const el = document.getElementById('activity');
  if (!el) return;
  el.innerHTML = activities.slice(0,40).map(a=>`<div style="padding:8px;border-bottom:1px dashed rgba(255,255,255,0.02)"><small style="color:var(--muted)">${a.t}</small><div style="margin-top:6px">${a.text}</div></div>`).join('');
}

/* Load tasks from server */
async function loadTasks(){
  tasksGrid.innerHTML = ''; // skeleton
  for(let i=0;i<6;i++){
    const s = document.createElement('div'); s.className='task';
    s.innerHTML = `<div class="meta"><div class="badge">‚Äî</div></div><div class="title" style="height:18px;background:linear-gradient(90deg,#ffffff09,#ffffff00);border-radius:6px;margin-top:10px"></div>`;
    tasksGrid.appendChild(s);
  }
  try {
    const res = await fetch('/api/tasks_public');
    const data = await res.json();
    tasks = data || [];
    if(tasks.length===0){
      tasksGrid.innerHTML = `<div style="color:var(--muted)">–ü–æ–∫–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π</div>`;
    } else {
      tasksGrid.innerHTML = '';
      tasks.forEach(t=>{
        const node = document.createElement('div'); node.className='task';
        node.innerHTML = `<div class="meta"><div class="badge">${t.type||'–∑–∞–¥–∞—á–∞'}</div><div style="margin-left:auto;color:var(--muted);font-size:13px">${t.budget? t.budget + ' ‚ÇΩ':''}</div></div>
                          <div class="title">${t.title||t.id}</div>
                          <div style="margin-top:10px;color:var(--muted);font-size:13px">${t.link? t.link:''}</div>`;
        node.addEventListener('click', ()=> openTaskModal(t));
        tasksGrid.appendChild(node);
      });
    }
    statRequests.textContent = tasks.length;
    addActivity('–ó–∞–¥–∞–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
  } catch(e){
    console.error(e);
    tasksGrid.innerHTML = `<div style="color:var(--muted)">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞–Ω–∏–π</div>`;
    addActivity('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∑–∞–¥–∞—á');
  }
}

/* Open Task modal (quick view) */
function openTaskModal(t){
  const html = `<p style="margin:0 0 8px 0">${t.title||t.id}</p>
                <p style="color:var(--muted);margin:0 0 12px 0">–ë—é–¥–∂–µ—Ç: <strong>${t.budget? t.budget+' ‚ÇΩ':'‚Äî'}</strong></p>
                <p><a href="${t.link||'#'}" target="_blank" style="color:var(--accentA)">–ü–µ—Ä–µ–π—Ç–∏</a></p>
                <div style="text-align:right"><button class="btn" id="doTask">–í—ã–ø–æ–ª–Ω–∏—Ç—å</button></div>`;
  openModal('–ó–∞–¥–∞–Ω–∏–µ', html, async ()=>{
    showToast('–§—É–Ω–∫—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞–Ω–∏—è –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –≤ WebApp (–∏–ª–∏ –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø–æ–∑–∂–µ)');
  });
}

/* Very small modal helper */
const modalBackdrop = document.createElement('div');
modalBackdrop.style.position='fixed';
modalBackdrop.style.left=0;modalBackdrop.style.top=0;modalBackdrop.style.width='100%';modalBackdrop.style.height='100%';
modalBackdrop.style.display='none';modalBackdrop.style.alignItems='center';modalBackdrop.style.justifyContent='center';
modalBackdrop.style.zIndex=2500;
document.body.appendChild(modalBackdrop);
function openModal(title, innerHTML, onSubmit){
  modalBackdrop.innerHTML = '';
  modalBackdrop.style.display = 'flex';
  modalBackdrop.style.background = 'rgba(0,0,0,0.45)';
  const box = document.createElement('div');
  box.style.width='560px';box.style.maxWidth='94%';box.style.borderRadius='12px';box.style.background='linear-gradient(180deg,#06212a,#041622)';box.style.padding='18px';
  box.style.border='1px solid rgba(255,255,255,0.04)';
  box.innerHTML = `<h3 style="margin:0 0 8px 0">${title}</h3><div style="margin-bottom:12px">${innerHTML}</div>
                   <div style="text-align:right"><button id="modalCancel" style="margin-right:8px" class="btn ghost">–û—Ç–º–µ–Ω–∞</button><button id="modalOk" class="btn">OK</button></div>`;
  modalBackdrop.appendChild(box);
  box.querySelector('#modalCancel').onclick = ()=> closeModal();
  box.querySelector('#modalOk').onclick = async ()=>{
    try{
      await onSubmit();
      closeModal();
    }catch(e){ alert(e.message||e) }
  };
}
function closeModal(){ modalBackdrop.style.display='none'; modalBackdrop.innerHTML=''; }

/* Chat support logic */
const supportFab = document.getElementById('supportFab');
const chatBackdrop = document.getElementById('chatBackdrop');
const chatMessages = document.getElementById('chatMessages');
const chatInput = document.getElementById('chatInput');
const chatSend = document.getElementById('chatSend');
document.getElementById('closeChat').onclick = ()=> chatBackdrop.style.display='none';
supportFab.onclick = ()=> chatBackdrop.style.display='flex';

chatSend.onclick = async ()=>{
  const text = chatInput.value && chatInput.value.trim();
  if(!text) return;
  appendChatMsg('me', text);
  chatInput.value='';
  showToast('–û—Ç–ø—Ä–∞–≤–∫–∞ –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É...');
  try{
    const res = await fetch('/api/support', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({message:text})});
    const j = await res.json();
    if(j.ok){
      appendChatMsg('bot', '–í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ. –ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏.');
      addActivity('–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É');
      showToast('–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ');
    } else {
      appendChatMsg('bot', '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + (j.reason||''));
      showToast('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏');
    }
  }catch(e){ appendChatMsg('bot','–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'); showToast('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏') }
};

function appendChatMsg(cls, text){
  const d = document.createElement('div');
  d.className = 'msg ' + (cls==='me'?'me':'');
  d.textContent = text;
  chatMessages.appendChild(d);
  chatMessages.scrollTop = chatMessages.scrollHeight;
}

/* Admin socket notifications (if token present) */
const token = new URLSearchParams(location.search).get('token') || '';
if(token){
  try {
    const sock = io({ auth: { token }, transports: ['websocket'] });
    sock.on('connect', ()=> {
      addActivity('Socket connected');
      showToast('Socket connected');
    });
    sock.on('new_topup', data => { addActivity('–ù–æ–≤—ã–π —Ç–æ–ø–∞–ø: ' + (data.amount||'')); showToast('–ù–æ–≤—ã–π —Ç–æ–ø–∞–ø'); });
    sock.on('new_support', data => { addActivity('–ù–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É'); showToast('–ù–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å'); });
    sock.on('disconnect', ()=> addActivity('Socket disconnected'));
  } catch(e){ console.warn('socket error', e) }
}

/* ================= history integration ================= */
let rc_history_page = 1;
let rc_history_page_size = 6;
let rc_history_uid = null;

async function rc_loadHistory(){
  if(!rc_history_uid) { document.getElementById('historyList').innerHTML = '<div style="color:var(--muted)">UID –Ω–µ —É–∫–∞–∑–∞–Ω</div>'; return; }
  const type = document.getElementById('historyFilter').value;
  const res = await fetch(`/api/user_history?uid=${encodeURIComponent(rc_history_uid)}&page=${rc_history_page}&page_size=${rc_history_page_size}&type=${type}`);
  let j;
  try { j = await res.json(); } catch(e){ document.getElementById('historyList').innerHTML = '<div style="color:var(--muted)">–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞</div>'; return; }
  if(!j.ok) { document.getElementById('historyList').innerHTML = '<div style="color:var(--muted)">–û—à–∏–±–∫–∞: ' + (j.reason||'') + '</div>'; return; }
  renderHistoryList(j.items);
  document.getElementById('historyPager').textContent = `–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${j.page} / ${Math.max(1, Math.ceil((j.total||0)/ (j.page_size||rc_history_page_size)))}`;
}

function renderHistoryList(arr){
  const el = document.getElementById('historyList'); el.innerHTML='';
  if(!arr || arr.length===0) { el.innerHTML = '<div style="color:var(--muted)">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</div>'; return; }
  arr.forEach(it=>{
    const div = document.createElement('div');
    div.style.display='flex';
    div.style.justifyContent='space-between';
    div.style.padding='8px 0';
    div.style.borderBottom='1px dashed rgba(255,255,255,0.02)';
    const left = document.createElement('div');
    left.innerHTML = `<div style="font-weight:700">${(it.type||'').toUpperCase()} ‚Äî ${it.id||''}</div><div style="color:var(--muted);font-size:13px">${it.summary||''}</div>`;
    const right = document.createElement('div');
    right.style.textAlign='right';
    right.innerHTML = `<div style="font-weight:800">${it.amount? (it.amount + ' ‚ÇΩ') : ''}</div><div style="color:var(--muted);font-size:13px">${it.created_at||''}</div>`;
    div.appendChild(left); div.appendChild(right);
    el.appendChild(div);
  });
}

// Controls
document.getElementById('uidLoadBtn').onclick = ()=> {
  const v = document.getElementById('uidManual').value.trim();
  if(!v) return alert('–í–≤–µ–¥–∏—Ç–µ UID');
  rc_history_uid = v;
  rc_history_page = 1;
  document.getElementById('uidManual').value = v;
  rc_loadHistory();
};
document.getElementById('historyFilter').onchange = ()=> { rc_history_page = 1; rc_loadHistory(); };

// pager by clicking pager
document.getElementById('historyPager').addEventListener('click', ()=>{
  rc_history_page++;
  rc_loadHistory();
});

// Try to pick UID from Telegram WebApp initData
document.addEventListener('DOMContentLoaded', ()=>{
  try {
    if(window.Telegram && Telegram.WebApp && Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.user){
      const u = Telegram.WebApp.initDataUnsafe.user;
      rc_history_uid = u.id;
      document.getElementById('fullname').textContent = (u.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å');
      document.getElementById('handle').textContent = 'UID: ' + u.id;
      rc_history_page = 1;
      rc_loadHistory();
    }
  } catch(e){}
});
/* ================= end history integration ================= */

/* Buttons */
document.getElementById('refreshBtn').onclick = ()=> { loadTasks(); showToast('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...') }
document.getElementById('openProfile').onclick = ()=> { document.getElementById('tabProfile').click() }
document.getElementById('openTasks').onclick = ()=> { document.getElementById('tabTasks').click() }
document.getElementById('adminBtn').onclick = ()=> {
  if(token) window.open('/mainadmin?token='+encodeURIComponent(token),'_blank');
  else alert('–û—Ç–∫—Ä–æ–π—Ç–µ –∞–¥–º–∏–Ω–∫—É —á–µ—Ä–µ–∑ Telegram (–ø–æ–ª—É—á–∏—Ç–µ token)');
};
document.getElementById('quickTopup').onclick = ()=> document.getElementById('supportFab').click();

/* Tabs */
document.getElementById('tabTasks').onclick = () => {
  document.getElementById('tasksSection').style.display='block';
  document.getElementById('tabTasks').classList.add('active');
  document.getElementById('tabProfile').classList.remove('active');
};
document.getElementById('tabProfile').onclick = () => {
  document.getElementById('tasksSection').style.display='none';
  document.getElementById('tabProfile').classList.add('active');
  document.getElementById('tabTasks').classList.remove('active');
  showToast('–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–∫–∞ —É–ø—Ä–æ—â–µ–Ω');
};

/* Init */
document.addEventListener('DOMContentLoaded', async ()=>{
  loadTasks();
  addActivity('–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∑–∞–≥—Ä—É–∂–µ–Ω');
  // Try to fetch basic stats
  try{
    const res = await fetch('/api/works_pending');
    const arr = await res.json();
    statUsers.textContent = arr.length || '‚Äî';
  }catch(e){}
});

</script>
</body>
</html>
