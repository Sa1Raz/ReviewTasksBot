<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ReviewCash — Задания & Профиль</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Poppins:wght@600;800&display=swap" rel="stylesheet">

<!-- Lottie & Socket.IO -->
<script src="https://unpkg.com/lottie-web@5.8.1/build/player/lottie.min.js"></script>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<style>
  :root{
    --bg-1:#031025;
    --bg-2:#072233;
    --accentA:#00f0ff;
    --accentB:#00ff9d;
    --muted:#9fb6c6;
    --gold:#ffd166;
    --card-radius:14px;
    --glass-border: rgba(255,255,255,0.04);
    --nav-height:74px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    background: radial-gradient(900px 400px at 10% 8%, rgba(0,240,255,0.03), transparent), linear-gradient(180deg,var(--bg-1),var(--bg-2));
    color:#eaf7fb;
    -webkit-font-smoothing:antialiased;
    overflow-x:hidden;
  }

  /* App layout */
  .app {
    max-width:1100px;
    margin:20px auto;
    padding:16px;
    min-height: calc(100vh - 40px);
    position:relative;
  }

  /* top header */
  header.app-header{
    display:flex;
    align-items:center;
    gap:12px;
    margin-bottom:12px;
  }
  .logo{
    width:64px;height:64px;border-radius:12px;background:linear-gradient(135deg,var(--accentA),var(--accentB));
    display:flex;align-items:center;justify-content:center;color:#012226;font-weight:900;font-family:Poppins;font-size:20px;
    box-shadow:0 18px 50px rgba(0,240,255,0.06);
  }
  .title h1{margin:0;font-size:18px}
  .title p{margin:0;color:var(--muted);font-size:13px}

  /* view container: two main views (tasks / profile) that smoothly transition */
  .view-wrap{
    position:relative;
    overflow:hidden;
    border-radius:12px;
    min-height: calc(100vh - 160px); /* account for header and bottom nav */
    background: linear-gradient(180deg, rgba(255,255,255,0.012), rgba(255,255,255,0.01));
    border:1px solid var(--glass-border);
  }

  .views {
    display:flex;
    width:200%; /* two panels */
    transition: transform 420ms cubic-bezier(.22,.98,.2,1);
    will-change: transform;
  }

  .view {
    width:50%;
    min-height: 420px;
    padding:18px;
  }

  /* On narrow screens we want each view to occupy full width */
  @media (max-width:900px) {
    .views { width:200%; }
    .view { width:100%; min-height: calc(100vh - 220px); }
  }

  /* When .show-profile is set, translate to show profile */
  .show-profile .views { transform: translateX(-50%); }

  /* content cards inside views */
  .card {
    background: linear-gradient(180deg, rgba(255,255,255,0.015), transparent);
    border-radius:12px; padding:14px; border:1px solid var(--glass-border); box-shadow:0 12px 40px rgba(0,0,0,0.6);
  }

  /* Tasks grid */
  .tasks-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:14px; margin-top:12px }
  .task {
    background: linear-gradient(180deg, rgba(255,255,255,0.01), transparent);
    padding:12px; border-radius:10px; transition: transform 220ms, box-shadow 220ms; cursor:pointer; border:1px solid rgba(255,255,255,0.02);
  }
  .task:hover { transform: translateY(-8px); box-shadow:0 30px 60px rgba(0,0,0,0.55) }

  /* Profile view layout */
  .profile-header { display:flex; align-items:center; gap:12px; position:relative }
  .avatar {
    width:84px;height:84px;border-radius:12px;background:linear-gradient(135deg,#04202a,#05202a);display:flex;align-items:center;justify-content:center;color:var(--accentA);font-weight:900;font-size:22px;border:4px solid rgba(0,255,200,0.03)
  }
  .profile-info .name { font-weight:800; font-size:18px }
  .profile-info .handle { color:var(--muted); font-size:13px }

  /* small support headphone button top-right of profile card */
  .support-btn {
    position:absolute; right:0; top:0;
    width:38px;height:38px;border-radius:10px;background:linear-gradient(90deg,var(--accentA),var(--accentB));
    display:flex;align-items:center;justify-content:center;color:#012226; cursor:pointer; border:1px solid rgba(0,0,0,0.2);
    box-shadow:0 8px 20px rgba(0,0,0,0.5);
    transition: transform 180ms;
  }
  .support-btn:hover { transform: translateY(-3px); }

  /* history list */
  .history { margin-top:12px; max-height:240px; overflow:auto; border-top:1px dashed rgba(255,255,255,0.02); padding-top:8px }
  .history-item { display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px dashed rgba(255,255,255,0.02) }
  .history-item .left .title { font-weight:700; font-size:14px }
  .history-item .right .amount { font-weight:800; }

  /* bottom navigation (fixed) */
  .bottom-nav {
    position:fixed; left:50%; transform:translateX(-50%); bottom:18px;
    width:360px; max-width:92%; height:var(--nav-height); border-radius:14px; background:linear-gradient(180deg,#051122,#02121a);
    display:flex; justify-content:space-around; align-items:center; gap:8px; padding:10px; box-shadow:0 18px 60px rgba(0,0,0,0.7); border:1px solid rgba(255,255,255,0.03);
  }
  .nav-item { flex:1; text-align:center; color:var(--muted); font-size:14px; cursor:pointer; padding:8px; border-radius:10px; transition: all 220ms; display:flex; align-items:center; justify-content:center; gap:8px; flex-direction:column; }
  .nav-item.active { color: var(--accentA); font-weight:700; transform:translateY(-4px); background:linear-gradient(90deg, rgba(0,240,255,0.06), rgba(0,255,157,0.03)); box-shadow:0 10px 30px rgba(0,240,255,0.05); }
  .nav-item svg { width:20px;height:20px; opacity:0.95 }

  /* subtle page transitions (fade-in for content blocks) */
  .fade-in { animation: fadeIn .36s ease both; }
  @keyframes fadeIn { from { opacity:0; transform: translateY(8px) } to { opacity:1; transform: translateY(0) } }

  /* responsive: on wide screens show both panels side-by-side and hide bottom nav */
  @media(min-width:1100px){
    .bottom-nav { display:none; }
    .views { transform: translateX(0) !important; }
    .view { width:50% }
  }

  /* helper buttons */
  .btn { padding:8px 12px;border-radius:10px;border:none;background:linear-gradient(90deg,var(--accentA),var(--accentB));color:#012226;cursor:pointer }
  .btn-ghost { background:transparent;border:1px solid rgba(255,255,255,0.04); color:var(--muted) }
</style>
</head>
<body>
  <div class="app" id="appRoot">
    <header class="app-header">
      <div class="logo">RC</div>
      <div class="title">
        <h1>ReviewCash</h1>
        <p>Красивый и плавный интерфейс — задания и профиль</p>
      </div>
      <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
        <button id="refreshBtn" class="btn-ghost">Обновить</button>
      </div>
    </header>

    <!-- view wrapper: contains two panels (tasks | profile) which slide -->
    <div class="view-wrap" id="viewWrap">
      <div class="views" id="views">
        <!-- TASKS VIEW -->
        <section class="view" id="viewTasks">
          <div class="card fade-in">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <h2 style="margin:0">Задания</h2>
                <div class="small" style="color:var(--muted)">Список доступных заданий</div>
              </div>
              <div>
                <input id="search" placeholder="Поиск..." style="padding:8px;border-radius:8px;border:1px solid var(--glass-border);background:transparent;color:#eaf7fb"/>
              </div>
            </div>

            <div id="tasksGrid" class="tasks-grid" aria-live="polite" style="margin-top:14px">
              <!-- tasks injected here -->
            </div>
          </div>
        </section>

        <!-- PROFILE VIEW -->
        <section class="view" id="viewProfile">
          <div class="card fade-in" style="position:relative; overflow:visible">
            <div class="profile-header">
              <div class="avatar" id="avatar">RC</div>
              <div class="profile-info">
                <div class="name" id="fullname">Гость</div>
                <div class="handle" id="handle">@guest</div>
                <div style="margin-top:8px;font-weight:800;font-size:20px;color:var(--gold)" id="balance">0 ₽</div>
              </div>

              <!-- tiny support headphone button in top-right of profile card -->
              <div class="support-btn" id="profileSupportBtn" title="Поддержка">
                <!-- simple headphone SVG -->
                <svg viewBox="0 0 24 24" fill="none" width="18" height="18" xmlns="http://www.w3.org/2000/svg"><path d="M12 3C7.031 3 3 7.031 3 12v6a2 2 0 0 0 2 2h.5a1.5 1.5 0 0 0 1.5-1.5V15a1.5 1.5 0 0 0-1.5-1.5H5" stroke="#012226" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/><path d="M21 15v3.5A1.5 1.5 0 0 1 19.5 20H19a2 2 0 0 1-2-2v-6c0-4.969-4.031-9-9-9v0" stroke="#012226" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg>
              </div>
            </div>

            <div style="margin-top:12px">
              <h3 style="margin:0 0 8px 0">История операций</h3>
              <div id="historyList" class="history">
                <div style="color:var(--muted)">Нет записей</div>
              </div>
            </div>

            <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
              <button id="btnTopup" class="btn">Пополнить</button>
              <button id="btnWithdraw" class="btn btn-ghost">Вывести</button>
            </div>
          </div>
        </section>
      </div>
    </div>

    <!-- bottom nav (mobile-first) -->
    <div class="bottom-nav" id="bottomNav" role="navigation" aria-label="Нижняя навигация">
      <div class="nav-item active" data-view="tasks" id="navTasks">
        <!-- clipboard icon -->
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="9" y="2" width="6" height="4" rx="1" stroke="currentColor" stroke-width="1.4"></rect><path d="M7 8h10v12a1 1 0 0 1-1 1H8a1 1 0 0 1-1-1V8z" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <div>Задания</div>
      </div>
      <div class="nav-item" data-view="profile" id="navProfile">
        <!-- user icon -->
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/><circle cx="12" cy="7" r="4" stroke="currentColor" stroke-width="1.4"/></svg>
        <div>Профиль</div>
      </div>
    </div>

  </div>

  <!-- simple modals for topup/withdraw/support (kept minimal for clarity) -->
  <div id="modalBackdrop" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:9999;align-items:center;justify-content:center"></div>

  <div id="modalTopup" style="display:none;position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:520px;max-width:92%;background:#041726;padding:16px;border-radius:10px;z-index:10000;border:1px solid rgba(255,255,255,0.04)">
    <h3 style="margin:0 0 8px 0">Пополнение</h3>
    <div class="small" style="color:var(--muted)">Минимум 100 ₽</div>
    <div style="margin-top:10px"><input id="topupAmount" class="input" placeholder="Сумма" /></div>
    <div style="margin-top:10px" class="small">Мои данные: Раяз Н. • <span id="bankPhone">+79600738559</span></div>
    <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
      <button id="confirmTopup" class="btn">Отправить заявку</button>
      <button id="cancelTopup" class="btn btn-ghost">Отмена</button>
    </div>
    <div id="topupFeedback" style="margin-top:10px;color:var(--muted)"></div>
  </div>

  <div id="modalWithdraw" style="display:none;position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:520px;max-width:92%;background:#041726;padding:16px;border-radius:10px;z-index:10000;border:1px solid rgba(255,255,255,0.04)">
    <h3 style="margin:0 0 8px 0">Вывод средств</h3>
    <div class="small" style="color:var(--muted)">Минимальная сумма 250 ₽</div>
    <div style="margin-top:10px"><input id="wdAmount" class="input" placeholder="Сумма" /></div>
    <div style="margin-top:10px"><input id="wdName" class="input" placeholder="ФИО или ник в банке" /></div>
    <div style="margin-top:10px"><input id="wdBank" class="input" placeholder="Банк / реквизиты" /></div>
    <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
      <button id="confirmWithdraw" class="btn">Отправить заявку</button>
      <button id="cancelWithdraw" class="btn btn-ghost">Отмена</button>
    </div>
    <div id="withdrawFeedback" style="margin-top:10px;color:var(--muted)"></div>
  </div>

<script>
/* Basic state and UI wiring for bottom nav and smooth transitions */
const app = document.getElementById('appRoot');
const viewWrap = document.getElementById('viewWrap');
const bottomNav = document.getElementById('bottomNav');

const navTasks = document.getElementById('navTasks');
const navProfile = document.getElementById('navProfile');

function setActiveNav(view) {
  if (view === 'tasks') {
    document.body.classList.remove('show-profile');
    navTasks.classList.add('active'); navProfile.classList.remove('active');
  } else {
    document.body.classList.add('show-profile');
    navTasks.classList.remove('active'); navProfile.classList.add('active');
  }
}

/* Attach nav handlers */
navTasks.addEventListener('click', ()=> setActiveNav('tasks'));
navProfile.addEventListener('click', ()=> setActiveNav('profile'));

/* On wide screens we show both panels; keep nav but hidden via CSS. Ensure default state */
if (window.innerWidth >= 1100) {
  setActiveNav('tasks');
}

/* Smooth transition: when toggling we also add small fade classes to contents */
function animateViewChange() {
  const tasksCard = document.querySelector('#viewTasks .card');
  const profileCard = document.querySelector('#viewProfile .card');
  tasksCard && tasksCard.classList.add('fade-in');
  profileCard && profileCard.classList.add('fade-in');
  setTimeout(()=> {
    tasksCard && tasksCard.classList.remove('fade-in');
    profileCard && profileCard.classList.remove('fade-in');
  }, 420);
}
navTasks.addEventListener('click', animateViewChange);
navProfile.addEventListener('click', animateViewChange);

/* Preload tasks skeleton and sample loading */
const tasksGrid = document.getElementById('tasksGrid');
async function loadTasks(){
  tasksGrid.innerHTML = '';
  // skeletons
  for(let i=0;i<6;i++){
    const sk = document.createElement('div'); sk.className='task';
    sk.innerHTML = `<div style="height:14px;background:linear-gradient(90deg,#ffffff06,#ffffff04,#ffffff06);border-radius:8px;margin-bottom:8px"></div><div style="height:12px;background:linear-gradient(90deg,#ffffff06,#ffffff04,#ffffff06);border-radius:6px;width:70%"></div>`;
    tasksGrid.appendChild(sk);
  }
  try {
    const res = await fetch('/api/tasks_public');
    const data = await res.json();
    tasksGrid.innerHTML = '';
    if(!Array.isArray(data) || data.length === 0){
      tasksGrid.innerHTML = `<div style="color:var(--muted)">Пока нет активных заданий</div>`;
      return;
    }
    data.forEach(t=>{
      const el = document.createElement('div'); el.className='task';
      el.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div style="font-weight:700">${t.title||t.id}</div><div style="color:var(--muted)">${t.budget? t.budget+' ₽':''}</div></div><div style="margin-top:8px;color:var(--muted);font-size:13px">${t.link||''}</div>`;
      tasksGrid.appendChild(el);
    });
  } catch(e){
    console.error('loadTasks error', e);
    tasksGrid.innerHTML = `<div style="color:var(--muted)">Ошибка загрузки</div>`;
  }
}
loadTasks();

/* Simple profile load: if Telegram WebApp present, pick name and uid; try to call /api/profile_me */
async function loadProfile() {
  try {
    if(window.Telegram && Telegram.WebApp && Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.user){
      const u = Telegram.WebApp.initDataUnsafe.user;
      document.getElementById('fullname').textContent = (u.first_name || 'Пользователь');
      document.getElementById('handle').textContent = u.username ? '@'+u.username : 'UID: ' + u.id;
      document.getElementById('avatar').textContent = (u.first_name||'U').slice(0,2).toUpperCase();
      // try fetch server profile (may return avatar url)
      try {
        const res = await fetch('/api/profile_me', { headers: { 'X-Tg-InitData': Telegram.WebApp.initData }});
        const j = await res.json();
        if(j.ok){
          document.getElementById('balance').textContent = (j.balance || 0) + ' ₽';
          if(j.photo_url){
            const av = document.getElementById('avatar'); av.innerHTML = '';
            const img = document.createElement('img');
            img.src = j.photo_url; img.style.width='84px'; img.style.height='84px'; img.style.borderRadius='12px';
            av.appendChild(img);
          }
        }
      } catch(e){}
    }
  } catch(e){}
}
loadProfile();

/* Support button in profile (small headphone) opens support modal (reuse modal) */
const profileSupportBtn = document.getElementById('profileSupportBtn');
profileSupportBtn.addEventListener('click', ()=> {
  // open support modal (reuse topup modal pattern)
  openSupportModal();
});

/* Modal logic for topup/withdraw/support */
const modalBackdrop = document.getElementById('modalBackdrop');
const modalTopup = document.getElementById('modalTopup');
const modalWithdraw = document.getElementById('modalWithdraw');

function showModal(mod) {
  modalBackdrop.style.display = 'flex';
  mod.style.display = 'block';
}
function hideModals() {
  modalBackdrop.style.display = 'none';
  modalTopup.style.display = 'none';
  modalWithdraw.style.display = 'none';
  const topupFeedback = document.getElementById('topupFeedback'); if(topupFeedback) topupFeedback.textContent='';
  const withdrawFeedback = document.getElementById('withdrawFeedback'); if(withdrawFeedback) withdrawFeedback.textContent='';
}

document.getElementById('btnTopup').addEventListener('click', ()=> showModal(modalTopup));
document.getElementById('cancelTopup').addEventListener('click', hideModals);
document.getElementById('btnWithdraw').addEventListener('click', ()=> showModal(modalWithdraw));
document.getElementById('cancelWithdraw').addEventListener('click', hideModals);

modalBackdrop.addEventListener('click', hideModals);

/* Confirm topup: call API and show returned bank + code */
document.getElementById('confirmTopup').addEventListener('click', async function(){
  const amt = parseFloat(document.getElementById('topupAmount').value || 0);
  if(isNaN(amt) || amt < 100){ document.getElementById('topupFeedback').textContent = 'Минимальная сумма 100 ₽'; return; }
  const headers = {'Content-Type':'application/json'};
  try {
    if(window.Telegram && Telegram.WebApp && Telegram.WebApp.initData) headers['X-Tg-InitData'] = Telegram.WebApp.initData;
  } catch(e){}
  try {
    const res = await fetch('/api/topups_public', { method:'POST', headers, body: JSON.stringify({ amount: amt }) });
    const j = await res.json();
    if(!j.ok){ document.getElementById('topupFeedback').textContent = 'Ошибка: ' + (j.reason||''); return; }
    document.getElementById('topupFeedback').innerHTML = `<div class="small">Переведите ${amt} ₽ на номер <strong>${j.bank.phone}</strong> (Раяз Н.). В комментарии укажите код: <strong>${j.topup.code}</strong>. После перевода ожидайте подтверждения в течение 24 часов.</div>`;
  } catch(e){
    document.getElementById('topupFeedback').textContent = 'Ошибка сети';
  }
});

/* Confirm withdraw: send API, server will validate balance and reserve funds */
document.getElementById('confirmWithdraw').addEventListener('click', async function(){
  const amt = parseFloat(document.getElementById('wdAmount').value || 0);
  const name = document.getElementById('wdName').value.trim();
  const bank = document.getElementById('wdBank').value.trim();
  if(isNaN(amt) || amt < 250){ document.getElementById('withdrawFeedback').textContent = 'Минимальная сумма 250 ₽'; return; }
  if(!name || !bank){ document.getElementById('withdrawFeedback').textContent = 'Заполните ФИО и банк'; return; }
  const headers = {'Content-Type':'application/json'};
  try {
    if(window.Telegram && Telegram.WebApp && Telegram.WebApp.initData) headers['X-Tg-InitData'] = Telegram.WebApp.initData;
  } catch(e){}
  try {
    const res = await fetch('/api/withdraw_public', { method:'POST', headers, body: JSON.stringify({ amount: amt, name, bank })});
    const j = await res.json();
    if(!j.ok){
      if(j.reason === 'insufficient_balance') document.getElementById('withdrawFeedback').textContent = `Недостаточно средств: ${j.balance} ₽`;
      else document.getElementById('withdrawFeedback').textContent = 'Ошибка: ' + (j.reason || '');
      return;
    }
    document.getElementById('withdrawFeedback').textContent = 'Заявка отправлена, в течение 24 часов переведём сумму.';
    // update shown balance if server returned new balance
    if(j.balance_after !== undefined) document.getElementById('balance').textContent = j.balance_after + ' ₽';
  } catch(e){
    document.getElementById('withdrawFeedback').textContent = 'Ошибка сети';
  }
});

/* Support modal opener (small) */
function openSupportModal(){
  // reuse the withdraw modal container for simple support prompt or implement a lightweight prompt
  const msg = prompt('Опишите проблему для отправки в поддержку:');
  if(!msg) return;
  // send to server
  (async function(){
    try {
      const headers = {'Content-Type':'application/json'};
      if(window.Telegram && Telegram.WebApp && Telegram.WebApp.initData) headers['X-Tg-InitData'] = Telegram.WebApp.initData;
      const res = await fetch('/api/support', { method:'POST', headers, body: JSON.stringify({ message: msg })});
      const j = await res.json();
      if(j.ok) alert('Сообщение отправлено в поддержку');
      else alert('Ошибка: ' + (j.reason||''));
    } catch(e){ alert('Ошибка сети'); }
  })();
}

/* small: switch layout on resize to ensure nav visibility logic */
window.addEventListener('resize', ()=> {
  if(window.innerWidth >= 1100){
    // on wide screens ensure both visible (remove profile-only shift)
    document.body.classList.remove('show-profile');
    navTasks.classList.remove('active'); navProfile.classList.remove('active');
  } else {
    // on small screens keep current nav active
    if(document.body.classList.contains('show-profile')){
      navProfile.classList.add('active'); navTasks.classList.remove('active');
    } else {
      navTasks.classList.add('active'); navProfile.classList.remove('active');
    }
  }
});

/* nice initial animation: show tasks by default */
setTimeout(()=> { setActiveNav('tasks'); }, 90);

</script>
</body>
</html>
