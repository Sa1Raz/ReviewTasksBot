<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ReviewCash — WebApp</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
<style>
  :root{
    --bg:#0a0014;--glass:rgba(15,10,45,0.98);--neon:#00ffff;--green:#00ff88;--gold:#ffd700;--muted:#88c0d0;--red:#ff3366;
  }
  *{box-sizing:border-box}
  body{background:linear-gradient(135deg,#0a0014,#001133);color:#e6fbff;font-family:Inter,system-ui,-apple-system;padding:14px;min-height:100vh;margin:0;}
  .container{max-width:420px;margin:0 auto;}
  .header{text-align:center;margin:18px 0;}
  h1{font-size:34px;background:linear-gradient(90deg,#00ffff,#00ff88);-webkit-background-clip:text;color:transparent;margin:0;}
  .top-actions{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:12px;}
  .search{flex:1;padding:8px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:#071022;color:#fff;}
  .btn{padding:10px 12px;border-radius:10px;border:none;font-weight:900;cursor:pointer}
  .btn-outline{background:transparent;border:2px solid rgba(255,255,255,0.04);color:var(--muted)}
  .card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:16px;border-radius:14px;border:1px solid rgba(0,255,255,0.06);margin-bottom:12px;}
  .task-title{font-weight:900;font-size:18px;margin-bottom:6px;}
  .task-meta{color:var(--muted);font-size:13px;margin-bottom:8px;}
  .task-actions{display:flex;gap:8px;margin-top:8px;}
  .btn-primary{background:linear-gradient(45deg,var(--neon),var(--green));color:#001;flex:1;padding:12px;border-radius:12px;border:none;font-weight:900;cursor:pointer}
  .btn-small{padding:8px 10px;border-radius:10px;border:none;background:transparent;color:#fff;border:1px solid rgba(255,255,255,0.04);font-weight:800;cursor:pointer}
  .small{font-size:13px;color:var(--muted)}
  .instr{background:rgba(0,0,0,0.35);padding:10px;border-radius:8px;margin-top:8px;font-size:14px;color:#e6fbff}
  .profile-row{display:flex;flex-direction:column;align-items:center;text-align:center;padding:20px}
  .profile-avatar{width:130px;height:130px;border-radius:50%;border:8px solid var(--neon);box-shadow:0 0 80px rgba(0,255,255,0.15);object-fit:cover;background:#001;margin-bottom:12px}
  .balance{font-size:44px;font-weight:900;color:var(--green);margin-top:6px}
  .bottom-nav{position:fixed;left:16px;right:16px;bottom:18px;background:rgba(15,15,45,0.98);backdrop-filter:blur(20px);border-radius:40px;padding:10px;border:3px solid rgba(0,255,255,0.06);display:flex;gap:8px;box-shadow:0 30px 80px rgba(0,0,0,0.7)}
  .nav-btn{flex:1;padding:14px;border-radius:26px;border:none;background:transparent;color:var(--muted);font-weight:900;cursor:pointer}
  .nav-btn.active{background:linear-gradient(45deg,var(--neon),var(--green));color:#001;transform:translateY(-6px);box-shadow:0 0 60px rgba(0,255,255,0.08)}
  .requests-list .req-item{background:rgba(0,0,0,0.35);padding:10px;border-radius:10px;margin-bottom:8px}
  /* fallback modal */
  .rc-modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:4000}
  .rc-modal{width:92%;max-width:480px;background:linear-gradient(180deg,#071426,#081a33);padding:16px;border-radius:12px;border:2px solid rgba(0,255,255,0.06);color:#e6fbff;position:relative}
  .rc-modal .rc-close{position:absolute;right:12px;top:8px;cursor:pointer;font-weight:900;color:#fff}
  .copy-block{background:rgba(0,255,255,0.06);border:2px dashed rgba(0,255,255,0.12);padding:12px;border-radius:10px;text-align:center;cursor:pointer}
  .copy-text{font-size:20px;font-weight:900;color:var(--gold)}
</style>
</head>
<body>
  <div class="container" id="main-page">
    <div class="header"><h1>REVIEWCASH</h1></div>

    <div class="top-actions">
      <input id="searchInput" class="search" placeholder="Поиск заданий">
      <button id="refreshBtn" class="btn btn-outline">Обновить</button>
    </div>

    <div id="tasksList"></div>
  </div>

  <div class="container" id="profile-page" style="display:none;">
    <div class="card" style="position:relative;">
      <div style="position:absolute;right:12px;top:12px;">
        <button id="supportBtn" class="btn-small" title="Поддержка"><i class="fas fa-headset"></i></button>
      </div>
      <div class="profile-row">
        <img id="user-avatar" class="profile-avatar" src="" alt="avatar">
        <div id="user-name" style="font-weight:900;font-size:22px;color:#fff">Пользователь</div>
        <div id="user-username" class="small" style="margin-top:6px">@username</div>
        <div class="balance" id="user-balance">0 ₽</div>
        <div style="width:100%;margin-top:12px;">
          <button id="topup-btn" class="btn-primary" style="width:100%;margin-bottom:10px;padding:14px;font-size:18px;">ПОПОЛНИТЬ БАЛАНС</button>
          <button id="withdraw-btn" class="btn-small" style="width:100%;padding:12px;background:linear-gradient(45deg,var(--red),#ff1a50);color:#fff;border:none;font-weight:900;">ВЫВЕСТИ СРЕДСТВА</button>
        </div>
      </div>

      <div style="margin-top:12px;">
        <div class="small">Мои заявки</div>
        <div id="my-requests" class="requests-list" style="margin-top:8px"></div>
      </div>
    </div>
  </div>

  <div class="bottom-nav" role="navigation" aria-label="Навигация">
    <button class="nav-btn active" data-page="main">Задания</button>
    <button class="nav-btn" data-page="profile">Профиль</button>
  </div>

<script>
  // Telegram WebApp
  const tg = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;
  try { tg?.ready?.(); tg?.expand?.(); } catch(e){}

  // Safe wrappers for showPopup / showAlert (use tg if available)
  function showAlert(text) {
    try { if (tg && typeof tg.showAlert === 'function') return tg.showAlert(text); } catch(e){}
    alert(text);
  }

  // Fallback modal implementation for environments without tg.showPopup
  function showPopup(opts = {}) {
    try {
      if (tg && typeof tg.showPopup === 'function') {
        return tg.showPopup(opts);
      }
    } catch (e) { /* fallback */ }

    const overlay = document.createElement('div');
    overlay.className = 'rc-modal-overlay';
    const html = `
      <div class="rc-modal" role="dialog" aria-modal="true">
        <div style="font-weight:900;font-size:18px;margin-bottom:8px;color:#00ffcc;">${escapeHtml(opts.title || '')}</div>
        <div>${opts.message || ''}</div>
        <div style="text-align:right;margin-top:10px;">
          ${(opts.buttons || []).map((b,i)=>`<button data-idx="${i}" class="rc-btn" style="margin-left:8px;padding:8px 10px;border-radius:8px;border:none;background:${b.type==='close'?'#444':'#00aaee'};color:#fff;font-weight:900">${escapeHtml(b.text || 'OK')}</button>`).join('')}
        </div>
        <div class="rc-close">✕</div>
      </div>`;
    overlay.innerHTML = html;
    document.body.appendChild(overlay);
    overlay.querySelector('.rc-close').addEventListener('click', ()=>overlay.remove());
    overlay.addEventListener('click', e => { if (e.target === overlay) overlay.remove(); });
    overlay.querySelectorAll('.rc-btn').forEach(btn => {
      btn.addEventListener('click', (ev) => {
        const idx = +btn.dataset.idx;
        const b = (opts.buttons || [])[idx];
        if (b && typeof b.onClick === 'function') {
          try { b.onClick(); } catch(e){ console.error(e); }
        }
        if (b && b.type === 'close') overlay.remove();
      });
    });
    return { close: () => overlay.remove() };
  }

  // global copy function used inside popup HTML (onclick attributes)
  function copy(text) {
    if (!text) return;
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(text).then(()=> showAlert("Скопировано!")).catch(()=> showAlert("Скопировано!"));
    } else {
      try {
        const ta = document.createElement('textarea'); ta.value = text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); showAlert("Скопировано!");
      } catch(e) { showAlert("Скопировано!"); }
    }
  }
  window.copy = copy;

  function escapeHtml(s){ if(s===undefined||s===null) return ''; return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]); }

  // User info from tg.initDataUnsafe if available
  const user = (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) ? tg.initDataUnsafe.user : { id: null, username: null, first_name: null, photo_url: null };
  const currentUid = user.id || ('guest_' + Math.floor(Math.random()*100000));
  const rc_prices = { yandex: 100, google: 65, telegram: 10 };
  const TASKS_API = '/api/tasks_public';

  // initialize profile UI
  document.getElementById('user-name').innerText = user.first_name || 'Пользователь';
  document.getElementById('user-username').innerText = user.username ? '@'+user.username : '—';
  document.getElementById('user-avatar').src = user.photo_url || ('https://api.dicebear.com/7.x/avataaars/svg?seed=' + encodeURIComponent(user.username || String(user.id || 'guest')));

  // Balance: try to fetch via web_app_data -> request 'get_tasks' or show stored from localStorage as fallback
  let localBalance = parseInt(localStorage.getItem('rc_balance_' + currentUid) || '0', 10);
  function renderBalance() {
    document.getElementById('user-balance').innerText = (localBalance || 0).toLocaleString('ru-RU') + ' ₽';
  }
  renderBalance();

  // fetch tasks
  async function fetchTasks(q='') {
    try {
      const res = await fetch(TASKS_API, { cache: 'no-store' });
      if (!res.ok) return [];
      const tasks = await res.json();
      if (q) {
        const ql = q.toLowerCase();
        return tasks.filter(t => (t.title||'').toLowerCase().includes(ql) || (t.type||'').toLowerCase().includes(ql));
      }
      return tasks;
    } catch (e) {
      console.error('fetchTasks error', e);
      return [];
    }
  }

  function instructionTextFor(type) {
    if (type === 'yandex') {
      return `<b>Инструкция (Яндекс)</b><ul style="padding-left:18px;margin:6px 0;">
        <li>Откройте ссылку места / отзыва и авторизуйтесь в Яндексе.</li>
        <li>Оставьте честный отзыв. Рекомендуем вставить код вида <b>RC####</b>.</li>
        <li>Дождитесь публикации (публикация может занять время).</li>
        <li>Заявка для Я.К.: не чаще 1 раза в 3 дня.</li>
      </ul>`;
    } else if (type === 'google') {
      return `<b>Инструкция (Google)</b><ul style="padding-left:18px;margin:6px 0;">
        <li>Откройте Google Maps, найдите место и оставьте отзыв.</li>
        <li>Можно вставить уникальный код в текст (RC####).</li>
        <li>Проверьте, что отзыв виден публично, затем отправьте выполнение.</li>
        <li>Ограничение: Google — не чаще 1 раза в 1 день.</li>
      </ul>`;
    } else if (type === 'telegram') {
      return `<b>Инструкция (Telegram)</b><ul style="padding-left:18px;margin:6px 0;">
        <li>Подпишитесь на указанный канал.</li>
        <li>Бот проверит подписку по вашему аккаунту.</li>
        <li>Подписки не ограничены по частоте.</li>
      </ul>`;
    } else {
      return `<b>Инструкция</b><div>Откройте ссылку, выполните задание, убедитесь в публикации и отправьте выполнение.</div>`;
    }
  }

  function createTaskCard(task) {
    const el = document.createElement('div'); el.className = 'card';
    const count = Math.floor((task.budget||0) / (rc_prices[task.type] || 1));
    el.innerHTML = `
      <div class="task-title">${escapeHtml(task.title || 'Без названия')}</div>
      <div class="task-meta">${escapeHtml(task.type || '')} · Бюджет: ${(task.budget||0).toLocaleString('ru-RU')} ₽</div>
      <div class="small">Кол-во: <b>${count}</b> ${task.type==='telegram' ? 'подписок' : 'отзывов'}</div>
      <div class="task-actions">
        <button class="btn-primary" data-id="${escapeHtml(task.id)}" data-type="${escapeHtml(task.type||'')}">Выполнить</button>
        <button class="btn-small" data-instr="1">Инструкция</button>
      </div>
      <div class="instr" style="display:none;"></div>
    `;
    const instrEl = el.querySelector('.instr');
    instrEl.innerHTML = instructionTextFor(task.type);

    // newbie hint
    const seen = localStorage.getItem('rc_seen_before');
    if (!seen) {
      const newbie = document.createElement('div'); newbie.className = 'small'; newbie.style.marginTop='8px';
      newbie.innerText = 'Вы новичок? Нажмите "Инструкция" для подсказок.';
      el.appendChild(newbie);
    }

    el.querySelector('[data-instr="1"]').addEventListener('click', () => {
      instrEl.style.display = instrEl.style.display === 'none' ? 'block' : 'none';
      localStorage.setItem('rc_seen_before','1');
    });

    el.querySelector('.btn-primary').addEventListener('click', (e) => {
      const tid = e.currentTarget.dataset.id;
      const type = e.currentTarget.dataset.type;
      openPerformModal(tid, task.title, type);
    });
    return el;
  }

  // render tasks list
  async function renderTasks(q='') {
    const list = document.getElementById('tasksList');
    list.innerHTML = '<div class="small">Загрузка...</div>';
    const tasks = await fetchTasks(q);
    list.innerHTML = '';
    if (!tasks || tasks.length===0) { list.innerHTML = '<div class="small">Нет доступных заданий</div>'; return; }
    tasks.forEach(t => list.appendChild(createTaskCard(t)));
  }

  // perform modal + sendData to bot
  function openPerformModal(taskId, title, platform) {
    const overlay = document.createElement('div'); overlay.className='rc-modal-overlay';
    overlay.innerHTML = `<div class="rc-modal" role="dialog" aria-modal="true">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div style="font-weight:900;font-size:18px;">Выполнение задания</div>
        <div class="rc-close">✕</div>
      </div>
      <div style="margin-top:10px" class="small">Задание: ${escapeHtml(title)}</div>
      <div style="margin-top:10px"><textarea id="rcReviewText" placeholder="Текст отзыва или комментарий" style="width:100%;height:120px;padding:8px;border-radius:8px;background:#001;color:#fff;border:1px solid rgba(255,255,255,0.04)"></textarea></div>
      <div style="margin-top:8px"><input id="rcReviewLink" placeholder="Ссылка на отзыв (если есть)" style="width:100%;padding:8px;border-radius:8px;background:#001;color:#fff;border:1px solid rgba(255,255,255,0.04)"></div>
      <div style="display:flex;gap:8px;margin-top:12px;">
        <button id="rcSubmitBtn" style="flex:1;padding:12px;border-radius:10px;background:linear-gradient(45deg,var(--neon),var(--green));border:none;font-weight:900;color:#001">Отправить на проверку</button>
        <button id="rcHelpBtn" style="padding:12px;border-radius:10px;background:transparent;border:1px solid rgba(255,255,255,0.06);color:#fff;font-weight:900">Помощь</button>
      </div>
    </div>`;
    document.body.appendChild(overlay);
    overlay.querySelector('.rc-close').addEventListener('click', ()=>overlay.remove());
    overlay.querySelector('#rcHelpBtn').addEventListener('click', ()=>{
      showAlert(platform === 'yandex' ? 'Оставьте код RC#### в тексте отзыва и дождитесь публикации.' :
                platform === 'google' ? 'Оставьте код RC#### в тексте и проверьте публикацию в Google Maps.' :
                'Подпишитесь на канал и убедитесь, что подписка видна в вашем аккаунте.');
    });
    overlay.querySelector('#rcSubmitBtn').addEventListener('click', () => {
      const text = overlay.querySelector('#rcReviewText').value.trim();
      const link = overlay.querySelector('#rcReviewLink').value.trim();
      if (!text && !link) { alert('Введите текст или ссылку.'); return; }
      const payload = { action: "submit_work", task_id: taskId, platform: platform, text: text, link: link };
      try {
        if (tg && typeof tg.sendData === 'function') {
          tg.sendData(JSON.stringify(payload));
          overlay.remove();
          showAlert('Заявка отправлена. Обычные админы проверят работу.');
          renderMyRequests(); // update my requests list
        } else {
          // fallback post
          fetch('/api/submit_work', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) })
            .then(r=>r.json()).then(res=>{ showAlert(res.message || 'Отправлено'); overlay.remove(); renderMyRequests(); }).catch(e=>{ console.error(e); showAlert('Ошибка отправки'); });
        }
      } catch (e) { console.error(e); showAlert('Не удалось отправить заявку.'); }
    });
  }

  // TOPUP flow
  document.getElementById('topup-btn').addEventListener('click', () => {
    showPopup({
      title: "Пополнение баланса",
      message: `<div style="padding:6px 0;">
        <input id="topupAmount" type="number" placeholder="Сумма (минимум 100 ₽)" style="width:100%;padding:10px;border-radius:8px;background:#001;color:#fff;border:1px solid rgba(255,255,255,0.04)">
        <div style="margin-top:10px"><button id="topupNext" style="width:100%;padding:10px;border-radius:8px;background:linear-gradient(45deg,var(--neon),var(--green));border:none;font-weight:900;color:#001">Далее</button></div>
      </div>`,
      buttons:[{type:'close', text:'Закрыть'}]
    });
    requestAnimationFrame(()=> {
      const next = document.getElementById('topupNext');
      if (!next) return;
      next.onclick = () => {
        const amount = parseInt(document.getElementById('topupAmount').value || '0',10);
        if (amount < 100) return showAlert('Минимальная сумма пополнения — 100 ₽');
        const code = 'RC' + Math.floor(1000 + Math.random()*9000);
        showPopup({
          title: 'Информация для перевода',
          message: `<div style="text-align:center;padding:6px 0;font-size:15px;">
            Переведите <b style="color:#00ff88;font-size:20px">${amount.toLocaleString('ru-RU')} ₽</b><br><br>
            <div style="font-weight:900;margin-bottom:6px">Номер</div>
            <div class="copy-block" onclick="copy('+79600738559')"><div class="copy-text">+7 960 073 85 59</div><div class="small" style="margin-top:6px;color:var(--muted)">Нажмите чтобы скопировать</div></div>
            <div style="font-weight:900;margin-top:10px">Код (в комментарии к переводу)</div>
            <div class="copy-block" onclick="copy('${code}')"><div class="copy-text">${code}</div><div class="small" style="margin-top:6px;color:var(--muted)">Нажмите чтобы скопировать</div></div>
            <div style="margin-top:10px"><button id="topupSubmit" style="width:100%;padding:10px;border-radius:8px;background:linear-gradient(45deg,var(--neon),var(--green));border:none;font-weight:900;color:#001">Отправить заявку</button></div>
          </div>`,
          buttons:[{type:'close', text:'Закрыть'}]
        });
        requestAnimationFrame(()=> {
          const submit = document.getElementById('topupSubmit');
          if (!submit) return;
          submit.onclick = () => {
            const ok = confirm(`Точно отправить заявку на пополнение ${amount.toLocaleString('ru-RU')} ₽?`);
            if (!ok) return;
            const payload = { action: 'request_topup', amount: amount, code: code };
            try {
              if (tg && typeof tg.sendData === 'function') { tg.sendData(JSON.stringify(payload)); showAlert('Заявка отправлена'); }
              else { fetch('/api/request_topup', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)}).then(()=>showAlert('Заявка отправлена')); }
              // no auto-credit; admin will approve
            } catch(e) { console.error(e); showAlert('Ошибка отправки заявки'); }
          };
        });
      };
    });
  });

  // WITHDRAW flow
  document.getElementById('withdraw-btn').addEventListener('click', () => {
    showPopup({
      title: 'Вывод средств',
      message: `<div style="padding:6px 0;">
        <div class="small">Доступно: <b style="color:#00ff88">${(localBalance||0).toLocaleString('ru-RU')} ₽</b></div>
        <input id="withdrawAmount" type="number" placeholder="Сумма (минимум 250 ₽)" style="width:100%;padding:10px;border-radius:8px;background:#001;color:#fff;border:1px solid rgba(255,255,255,0.04);margin-top:8px;">
        <div style="margin-top:10px"><button id="withdrawNext" style="width:100%;padding:10px;border-radius:8px;background:linear-gradient(45deg,var(--red),#ff1a50);border:none;font-weight:900;color:#fff">Далее</button></div>
      </div>`,
      buttons:[{type:'close', text:'Закрыть'}]
    });
    requestAnimationFrame(()=> {
      const next = document.getElementById('withdrawNext'); if (!next) return;
      next.onclick = () => {
        const amount = parseInt(document.getElementById('withdrawAmount').value||'0',10);
        if (amount < 250) return showAlert('Минимальная сумма вывода — 250 ₽');
        if (amount > (localBalance||0)) return showAlert('Недостаточно средств');
        showPopup({
          title: 'Реквизиты для вывода',
          message: `<div style="padding:6px 0;">
            <input id="withdrawName" placeholder="ФИО получателя" style="width:100%;padding:8px;border-radius:8px;background:#001;color:#fff;border:1px solid rgba(255,255,255,0.04);margin-bottom:6px;">
            <input id="withdrawCard" placeholder="Номер карты / счёт" style="width:100%;padding:8px;border-radius:8px;background:#001;color:#fff;border:1px solid rgba(255,255,255,0.04);margin-bottom:6px;">
            <input id="withdrawBank" placeholder="Банк / примечание" style="width:100%;padding:8px;border-radius:8px;background:#001;color:#fff;border:1px solid rgba(255,255,255,0.04);margin-bottom:6px;">
            <div style="margin-top:6px"><button id="withdrawSubmit" style="width:100%;padding:10px;border-radius:8px;background:linear-gradient(45deg,var(--red),#ff1a50);border:none;font-weight:900;color:#fff">Отправить заявку</button></div>
          </div>`,
          buttons:[{type:'close', text:'Закрыть'}]
        });
        requestAnimationFrame(()=> {
          const submit = document.getElementById('withdrawSubmit'); if (!submit) return;
          submit.onclick = () => {
            const name = (document.getElementById('withdrawName')||{}).value || '';
            const card = (document.getElementById('withdrawCard')||{}).value || '';
            const bank = (document.getElementById('withdrawBank')||{}).value || '';
            if (!name || !card) return showAlert('Укажите ФИО и реквизиты (карта/счёт).');
            const ok = confirm(`Точно вывести ${amount.toLocaleString('ru-RU')} ₽ на ${card}?`);
            if (!ok) return;
            const payload = { action: 'request_withdraw', amount: amount, name: name, card: card, bank: bank };
            try {
              if (tg && typeof tg.sendData === 'function') { tg.sendData(JSON.stringify(payload)); showAlert('Заявка отправлена'); }
              else { fetch('/api/request_withdraw', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)}).then(()=>showAlert('Заявка отправлена')); }
              // deduct locally for UX (will be confirmed by admin)
              localBalance = Math.max(0, (localBalance || 0) - amount);
              localStorage.setItem('rc_balance_' + currentUid, String(localBalance));
              renderBalance();
            } catch(e) { console.error(e); showAlert('Ошибка отправки заявки'); }
          };
        });
      };
    });
  });

  // My requests rendering (reads from localStorage fallback or tries /api endpoints)
  function renderMyRequests() {
    const container = document.getElementById('my-requests');
    // try server endpoint for user requests (not implemented server-side in all cases) -> fallback to localStorage
    const storedTopups = JSON.parse(localStorage.getItem('rc_topups_' + currentUid) || '[]');
    const storedWithdraws = JSON.parse(localStorage.getItem('rc_withdraws_' + currentUid) || '[]');
    const storedWorks = JSON.parse(localStorage.getItem('rc_works_' + currentUid) || '[]');

    container.innerHTML = '';
    if (storedTopups.length === 0 && storedWithdraws.length === 0 && storedWorks.length === 0) {
      container.innerHTML = '<div class="small">Заявок нет</div>'; return;
    }
    if (storedTopups.length) {
      const h = document.createElement('div'); h.className='small'; h.innerText='Пополнения'; container.appendChild(h);
      storedTopups.slice().reverse().forEach(t => {
        const d = document.createElement('div'); d.className='req-item'; d.innerHTML = `<div><b>${(t.amount||0).toLocaleString('ru-RU')} ₽</b> · <span class="small">${t.status||'pending'}</span></div><div class="small">Код: ${t.code||''}</div>`;
        container.appendChild(d);
      });
    }
    if (storedWithdraws.length) {
      const h = document.createElement('div'); h.className='small'; h.innerText='Выводы'; container.appendChild(h);
      storedWithdraws.slice().reverse().forEach(w => {
        const d = document.createElement('div'); d.className='req-item'; d.innerHTML = `<div><b>${(w.amount||0).toLocaleString('ru-RU')} ₽</b> · <span class="small">${w.status||'pending'}</span></div><div class="small">Реквизиты: ${w.card||'-'}</div>`;
        container.appendChild(d);
      });
    }
    if (storedWorks.length) {
      const h = document.createElement('div'); h.className='small'; h.innerText='Выполнения'; container.appendChild(h);
      storedWorks.slice().reverse().forEach(w => {
        const d = document.createElement('div'); d.className='req-item'; d.innerHTML = `<div><b>${(w.amount||0).toLocaleString('ru-RU')} ₽</b> · <span class="small">${w.status||'pending'}</span></div><div class="small">${escapeHtml(w.task_title||'')}</div>`;
        container.appendChild(d);
      });
    }
  }

  // nav switching
  document.querySelectorAll('.nav-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const page = btn.dataset.page;
      document.getElementById('main-page').style.display = page === 'main' ? 'block' : 'none';
      document.getElementById('profile-page').style.display = page === 'profile' ? 'block' : 'none';
      if (page === 'profile') { renderMyRequests(); }
    });
  });

  // support button
  document.getElementById('supportBtn').addEventListener('click', () => {
    try { if (tg && typeof tg.openTelegramLink === 'function') tg.openTelegramLink('https://t.me/RapiHappy'); else window.open('https://t.me/RapiHappy','_blank'); } catch(e){ window.open('https://t.me/RapiHappy','_blank'); }
  });

  // refresh / search
  document.getElementById('refreshBtn').addEventListener('click', ()=> renderTasks(document.getElementById('searchInput').value));
  document.getElementById('searchInput').addEventListener('input', (e)=> { setTimeout(()=> renderTasks(e.target.value), 200); });

  // initial load
  renderTasks();
  renderMyRequests();

  // small UX: handle fallback storing of submitted requests so user sees them immediately
  // When bot receives web_app_data it will store requests server-side; here we also write local copies for UX
  // These functions can be used by server-side responses if you add callbacks.
  function storeLocalTopup(obj) {
    const arr = JSON.parse(localStorage.getItem('rc_topups_' + currentUid) || '[]'); arr.push(obj); localStorage.setItem('rc_topups_' + currentUid, JSON.stringify(arr));
  }
  function storeLocalWithdraw(obj) {
    const arr = JSON.parse(localStorage.getItem('rc_withdraws_' + currentUid) || '[]'); arr.push(obj); localStorage.setItem('rc_withdraws_' + currentUid, JSON.stringify(arr));
  }
  function storeLocalWork(obj) {
    const arr = JSON.parse(localStorage.getItem('rc_works_' + currentUid) || '[]'); arr.push(obj); localStorage.setItem('rc_works_' + currentUid, JSON.stringify(arr));
  }

  // If you want the UI to reflect server confirmations, add a small handler endpoint or use tg.sendData responses from bot.
  // Example: when submitting topup/withdraw via tg.sendData, the bot can send back a confirmation message and the server can update storage.

</script>
</body>
</html>
