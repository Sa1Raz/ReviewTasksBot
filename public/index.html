<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>ReviewCash ‚Äì –ó–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π –Ω–∞ –æ—Ç–∑—ã–≤–∞—Ö</title>

  <!-- Telegram Web App + Socket.IO -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="/socket.io/socket.io.js"></script>

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">

  <style>
    :root {
      --bg: #020617;
      --bg-alt: #020817;
      --card: rgba(15, 35, 60, 0.96);
      --glass: rgba(148, 163, 184, 0.38);
      --accent: #00e7c0;
      --accent-soft: rgba(34, 197, 167, 0.18);
      --accent2: #00d4ff;
      --green: #22c55e;
      --red: #fb7185;
      --text: #e2f3ff;
      --muted: #94a3b8;
      --radius: 32px;
      --transition: all 0.45s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background:
        radial-gradient(circle at 0% 0%, rgba(59,130,246,0.35), transparent 55%),
        radial-gradient(circle at 100% 0%, rgba(16,185,129,0.38), transparent 55%),
        radial-gradient(circle at 0% 100%, rgba(236,72,153,0.32), transparent 55%),
        linear-gradient(145deg, var(--bg) 0%, var(--bg-alt) 45%, #020617 100%);
      color: var(--text);
      min-height: 100dvh;
      padding: 16px;
      padding-bottom: 140px;
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
      position: relative;
      isolation: isolate;
    }
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background-image:
        linear-gradient(120deg, rgba(148,163,184,0.08) 1px, transparent 1px),
        linear-gradient(210deg, rgba(148,163,184,0.06) 1px, transparent 1px);
      background-size: 80px 80px;
      opacity: 0.6;
      mix-blend-mode: soft-light;
      pointer-events: none;
      z-index: -1;
    }
    body::-webkit-scrollbar { width: 6px; background: transparent; }
    body::-webkit-scrollbar-thumb { background: rgba(148,163,184,0.6); border-radius: 999px; }

    .container { position: relative; max-width: 640px; margin: 0 auto; }

    /* Status bar */
    .status-bar {
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:18px;
      padding:6px 14px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.35);
      background:radial-gradient(circle at 0 0, rgba(56,189,248,0.32), transparent 55%),
                 radial-gradient(circle at 100% 0, rgba(45,212,191,0.3), transparent 60%),
                 rgba(15,23,42,0.88);
      backdrop-filter:blur(18px);
      box-shadow:0 18px 45px rgba(15,23,42,0.85);
      gap:8px;
    }
    .status-left { display:flex; align-items:center; gap:8px; }
    .app-pill {
      padding:4px 10px;
      border-radius:999px;
      font-size:10px;
      font-weight:700;
      letter-spacing:0.08em;
      text-transform:uppercase;
      background:rgba(15,23,42,0.8);
      border:1px solid rgba(148,163,184,0.5);
      display:flex;
      align-items:center;gap:5px;
    }
    .app-pill-dot{
      width:7px;height:7px;border-radius:999px;
      background:radial-gradient(circle at 30% 30%, #bbf7d0, #22c55e);
      box-shadow:0 0 18px rgba(34,197,94,0.9);
    }
    .status-right{ display:flex;align-items:center;gap:10px;font-size:11px;color:var(--muted); }
    .balance-chip{ padding:4px 10px;border-radius:999px;background:rgba(15,23,42,0.9);border:1px solid rgba(56,189,248,0.6);font-weight:600;font-size:11px;display:flex;align-items:center;gap:5px;}
    .balance-dot{ width:7px;height:7px;border-radius:999px;background:conic-gradient(from 0deg, #22c55e, #22c55e);box-shadow:0 0 10px rgba(34,197,94,0.9); }

    /* Tabs etc (kept same as original) */
    .tabs { display:flex;background:rgba(15,23,42,0.86);border-radius:50px;padding:6px;margin-bottom:28px;backdrop-filter:blur(18px);box-shadow:0 18px 55px rgba(15,23,42,0.95);border:1px solid rgba(148,163,184,0.55);position:relative;overflow:hidden; }
    .tab { flex:1;padding:16px 18px;text-align:center;font-weight:800;font-size:16px;border-radius:999px;transition:var(--transition);color:#64748b;display:flex;align-items:center;justify-content:center;gap:8px; }
    .tab.active{ background:linear-gradient(135deg,#22c55e,#22c55e,#0ea5e9);color:#020617;box-shadow:0 18px 40px rgba(34,197,94,0.6);transform:translateY(-2px); }

    .card { background: rgba(15,23,42,0.96); border-radius:var(--radius); padding:28px 22px 26px; box-shadow:0 30px 80px rgba(15,23,42,0.9); margin-bottom:22px; position:relative; overflow:hidden; border:1px solid var(--glass); }
    .card::before{ content:""; position:absolute; inset:0; background:radial-gradient(circle at 50% -20%, rgba(148,163,184,0.3), transparent 65%); opacity:0.6; pointer-events:none; }

    /* Profile & UI blocks (kept from your original) */
    .avatar { width:112px;height:112px;border-radius:50%;overflow:hidden;border:4px solid rgba(52,211,153,0.85);box-shadow:0 22px 55px rgba(34,197,94,0.85); margin:0 auto 18px; background:radial-gradient(circle at 30% 0,#1e293b,#020617); }
    .avatar img{width:100%;height:100%;object-fit:cover;display:block;}
    .balance { font-size:64px;font-weight:900;text-align:center;background:linear-gradient(120deg,#22c55e,#22c55e,#0ea5e9);-webkit-background-clip:text;-webkit-text-fill-color:transparent; }
    .balance-caption{ font-size:13px;color:var(--muted); text-transform:uppercase; margin-bottom:6px; }

    /* Buttons and modal styles preserved... */
    .action-btn{ flex:1;padding:18px 0;border-radius:999px;font-weight:800;font-size:17px;text-align:center;cursor:pointer;background:linear-gradient(135deg,#22c55e,#0ea5e9);color:#020617;box-shadow:0 20px 50px rgba(34,197,94,0.75);border:1px solid rgba(15,23,42,0.85); display:flex;align-items:center;justify-content:center;gap:8px;}
    .action-btn.withdraw{ background: rgba(15,23,42,0.9); color:#e2e8f0; border:1px solid rgba(148,163,184,0.55); box-shadow:0 16px 40px rgba(15,23,42,0.95); }
    .topup-amount-grid{ display:grid; grid-template-columns:1fr 1fr; gap:10px; margin:10px 0 14px; }
    .amount-btn{ padding:16px;border-radius:18px;background:rgba(15,23,42,0.96);border:1px solid rgba(148,163,184,0.7); font-weight:800; cursor:pointer; transition:var(--transition); text-align:center; }

    .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background: rgba(2,6,23,0.93); backdrop-filter: blur(26px); z-index:9999; padding:16px; }
    .modal.active{ display:flex; }
    .modal-card{ width:100%; max-width:560px; background:rgba(15,23,42,0.98); border-radius:30px; padding:30px 22px 26px; max-height:92dvh; overflow-y:auto; border:1px solid rgba(148,163,184,0.6); box-shadow:0 28px 90px rgba(15,23,42,1); position:relative; }

    input[type="text"], input[type="number"]{ width:100%; padding:18px; border-radius:18px; background:rgba(15,23,42,0.96); border:1px solid rgba(148,163,184,0.7); color:white; font-size:16px; margin:10px 0 6px; }
    .label-row{ display:flex;align-items:center;justify-content:space-between;font-size:12px;color:var(--muted); margin-top:8px; }
    .sbp-details{ background:linear-gradient(135deg, rgba(59,130,246,0.1), rgba(16,185,129,0.1)); border-radius:18px; padding:20px; margin:16px 0; border:1px solid rgba(59,130,246,0.3); }
    .sbp-warning{ background:rgba(234,179,8,0.1); border-radius:12px; padding:14px; margin:16px 0; }

    @media (max-width:480px){ .card{padding:24px 18px;} .balance{font-size:52px;} .avatar{width:100px;height:100px;} }
  </style>
</head>
<body>
  <div class="container">
    <!-- Status / header -->
    <div class="status-bar">
      <div class="status-left">
        <div class="app-pill"><span class="app-pill-dot"></span><span>ReviewCash</span></div>
        <span style="font-size:11px;color:#cbd5f5;font-weight:500;">–ó–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π –Ω–∞ –æ—Ç–∑—ã–≤–∞—Ö</span>
      </div>
      <div class="status-right">
        <div class="balance-chip" id="headerBalanceChip">
          <span class="balance-dot"></span>
          <span id="headerBalanceText">0 ‚ÇΩ</span>
        </div>
      </div>
    </div>

    <!-- Tabs -->
    <div id="tasksTab">
      <div class="card">
        <div class="tabs">
          <div class="tab active" onclick="switchTaskTab(0)"><i class="fas fa-list-ul"></i><span>–ú–æ–∏ –∑–∞–¥–∞–Ω–∏—è</span></div>
          <div class="tab" onclick="switchTaskTab(1)"><i class="fas fa-play-circle"></i><span>–í—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–¥–∞–Ω–∏—è</span></div>
        </div>

        <div class="empty-state">
          <div class="empty-orb"><i class="fas fa-stars"></i></div>
          –ó–∞–¥–∞–Ω–∏—è —Å–∫–æ—Ä–æ –ø–æ—è–≤—è—Ç—Å—è...<br>
          <span style="font-size:14px;opacity:0.85;">–ú—ã –∞–∫—Ç–∏–≤–Ω–æ –≤—ã–∫–∞—Ç—ã–≤–∞–µ–º –Ω–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏</span>
          <div class="empty-pill"><i class="fas fa-bolt"></i><span>–°–ª–µ–¥–∏ –∑–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏</span></div>
        </div>
      </div>
    </div>

    <!-- Profile -->
    <div id="profileTab" style="display:none">
      <div class="card">
        <div class="support-btn" onclick="tg.openTelegramLink('https://t.me/LolikMoney')"><i class="fas fa-headset"></i></div>

        <div style="text-align:center; margin-top:10px">
          <div class="avatar"><img id="userPhoto" src="" alt="–ê–≤–∞—Ç–∞—Ä"></div>
          <h2 id="userName" style="font-size:26px; font-weight:900; margin:10px 0 2px">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</h2>
          <p id="userHandle" style="color:var(--muted); font-size:14px">@user</p>
          <div class="profile-meta">
            <div class="profile-tag"><i class="fas fa-crown" style="font-size:11px;color:#facc15;"></i><span>–£—Ä–æ–≤–µ–Ω—å: 1</span></div>
            <div class="profile-tag"><i class="fas fa-shield-halved" style="font-size:11px;color:#60a5fa;"></i><span>–ó–∞—â–∏—Ç–∞ —Å–¥–µ–ª–æ–∫</span></div>
          </div>
        </div>

        <div style="text-align:center; padding:26px 0 26px; border-top:1px solid rgba(148,163,184,0.55); margin:22px 0 6px">
          <div class="balance-caption">–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å</div>
          <div class="balance" id="balance">0 ‚ÇΩ</div>
        </div>

        <div class="action-buttons">
          <div class="action-btn" id="topupBtn"><i class="fas fa-plus-circle"></i><span>–ü–æ–ø–æ–ª–Ω–∏—Ç—å</span></div>
          <div class="action-btn withdraw" id="withdrawBtn"><i class="fas fa-arrow-up-right-from-square"></i><span>–í—ã–≤–µ—Å—Ç–∏</span></div>
        </div>
      </div>
    </div>
  </div>

  <div class="fab visible" id="createFab"><span>+</span></div>

  <div class="bottom-nav">
    <div class="nav-item active" onclick="showTab('tasks')"><i class="fas fa-tasks"></i><span>–ó–∞–¥–∞–Ω–∏—è</span></div>
    <div class="nav-item" onclick="showTab('profile')"><i class="fas fa-user-circle"></i><span>–ü—Ä–æ—Ñ–∏–ª—å</span></div>
  </div>

  <!-- Topup modal (QR + Tinkoff link) -->
  <div id="topupModal" class="modal" aria-hidden="true">
    <div class="modal-card">
      <div class="close-btn" onclick="closeModal('topupModal')">√ó</div>
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;margin-top:6px;">
        <div class="step-pill"><span class="step-dot"></span><span>–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞</span></div>
        <span style="font-size:12px;color:var(--muted);">–ó–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞—ë—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</span>
      </div>

      <h2 style="text-align:left; margin-bottom:10px; font-size:22px; font-weight:800;">–ü–æ–ø–æ–ª–Ω–∏—Ç—å —á–µ—Ä–µ–∑ –°–ë–ü</h2>
      <p style="font-size:13px;color:var(--muted);margin-bottom:14px;">
        –ü–µ—Ä–µ–≤–µ–¥–∏—Ç–µ –¥–µ–Ω—å–≥–∏ –ø–æ QR-–∫–æ–¥—É –∏–ª–∏ –ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –¢–∏–Ω—å–∫–æ—Ñ—Ñ. –ë–∞–ª–∞–Ω—Å –±—É–¥–µ—Ç –∑–∞—á–∏—Å–ª–µ–Ω —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.
      </p>

      <div style="display:flex;flex-direction:column;align-items:center;margin-bottom:10px;">
        <!-- Put your QR image file (qr-code.png) in /public -->
        <img src="qr-code.png" alt="QR –∫–æ–¥ –¥–ª—è –æ–ø–ª–∞—Ç—ã" style="max-width:170px;width:100%;height:auto;border-radius:14px;box-shadow:0 2px 8px #0f1e3622;margin-bottom:10px;">
        <a href="https://www.tinkoff.ru/rm/r_TfPtbPbddX.PiDdKULdka/kkRwB91205" target="_blank"
           class="action-btn bank-btn" style="margin:4px auto;max-width:280px;">
          <i class="fas fa-external-link-alt"></i>–ü–µ—Ä–µ–π—Ç–∏ –≤ –±–∞–Ω–∫
        </a>
      </div>

      <div id="sbpStep1">
        <div class="label-row"><span>–ë—ã—Å—Ç—Ä—ã–π –≤—ã–±–æ—Ä</span><span style="font-size:11px;color:var(--muted);">–ú–∏–Ω–∏–º—É–º 150 ‚ÇΩ</span></div>
        <div class="topup-amount-grid">
          <div class="amount-btn" onclick="prepareSBP(300)">300 ‚ÇΩ</div>
          <div class="amount-btn" onclick="prepareSBP(500)">500 ‚ÇΩ</div>
          <div class="amount-btn" onclick="prepareSBP(1000)">1 000 ‚ÇΩ</div>
          <div class="amount-btn" onclick="prepareSBP(2000)">2 000 ‚ÇΩ</div>
        </div>

        <label class="label-row" style="margin-top:4px;"><span>–°–≤–æ—è —Å—É–º–º–∞</span><span style="font-size:11px;color:var(--muted);">–ú–∏–Ω–∏–º—É–º 150 ‚ÇΩ</span></label>
        <input type="number" id="customAmount" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É (–æ—Ç 150 ‚ÇΩ)">
        <div class="action-btn bank-btn" style="margin-top:10px;" onclick="prepareCustomSBP()"><i class="fas fa-mobile-alt"></i><span>–ü–µ—Ä–µ–≤–µ—Å—Ç–∏ —á–µ—Ä–µ–∑ –°–ë–ü</span></div>
      </div>

      <div id="sbpStep2" style="display:none">
        <div class="sbp-details">
          <h3>üì± –†–µ–∫–≤–∏–∑–∏—Ç—ã –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞ –°–ë–ü:</h3>
          <div class="detail-item"><span class="detail-label">–ü–æ–ª—É—á–∞—Ç–µ–ª—å</span><span class="detail-value">–†–∞—è–∑ –ù.</span></div>
          <div class="detail-item"><span class="detail-label">–ë–∞–Ω–∫</span><span class="detail-value">–¢-–ë–∞–Ω–∫</span></div>
          <div class="detail-item"><span class="detail-label">–°—É–º–º–∞</span><span class="sbp-amount" id="sbpAmount">‚Äî ‚ÇΩ</span></div>
        </div>

        <div class="sbp-warning">
          <div class="warning-title"><i class="fas fa-info-circle" style="color:#f59e0b;font-size:16px;"></i><strong>–í–∞–∂–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</strong></div>
          <ul>
            <li>–ü–µ—Ä–µ–≤–µ–¥–∏—Ç–µ —Ç–æ—á–Ω—É—é —Å—É–º–º—É: <strong id="exactAmount">‚Äî ‚ÇΩ</strong></li>
            <li>–£–∫–∞–∂–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: <strong id="transferCode">RC –∫–æ–¥</strong></li>
            <li>–ü–æ—Å–ª–µ –ø–µ—Ä–µ–≤–æ–¥–∞ –Ω–∞–∂–º–∏—Ç–µ "–ü–µ—Ä–µ–≤–µ–ª"</li>
          </ul>
        </div>

        <a href="https://www.tinkoff.ru/rm/r_TfPtbPbddX.PiDdKULdka/kkRwB91205" target="_blank"
           class="action-btn bank-btn" style="margin: 16px 0; width:100%;"><i class="fas fa-external-link-alt"></i><span>–û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±–∞–Ω–∫–∞</span></a>

        <div style="border-top:1px solid rgba(148,163,184,0.3);padding-top:16px;margin-top:16px;">
          <label class="label-row"><span>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –ø–µ—Ä–µ–≤–æ–¥—É (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</span><span style="font-size:11px;color:var(--muted);">–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ç–æ—á–Ω–æ –∫–∞–∫ —É–∫–∞–∑–∞–Ω–æ</span></label>
          <input type="text" id="transferComment" placeholder="RC_12345" readonly style="background:rgba(15,23,42,0.9);">
          <div style="text-align:center;margin:16px 0;">
            <div style="font-size:13px;color:var(--muted);margin-bottom:8px;">–ü–æ—Å–ª–µ –ø–µ—Ä–µ–≤–æ–¥–∞ –Ω–∞–∂–º–∏—Ç–µ:</div>
            <div class="action-btn bank-btn" onclick="confirmTransfer()"><i class="fas fa-check"></i><span>–ü–µ—Ä–µ–≤–µ–ª, —Å–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É</span></div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Withdraw modal -->
  <div id="withdrawModal" class="modal" aria-hidden="true">
    <div class="modal-card">
      <div class="close-btn" onclick="closeModal('withdrawModal')">√ó</div>
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;margin-top:6px;">
        <div class="step-pill"><span class="step-dot"></span><span>–í—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤</span></div>
        <span style="font-size:12px;color:var(--muted);">–î–æ—Å—Ç—É–ø–Ω–æ: <span id="withdrawBalanceInline">0 ‚ÇΩ</span></span>
      </div>

      <h2 style="text-align:left; margin-bottom:10px; font-size:22px; font-weight:800">–°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É</h2>
      <p style="font-size:13px;color:var(--muted);margin-bottom:10px;">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã –¥–ª—è –≤—ã–≤–æ–¥–∞. –û–±—ã—á–Ω–æ –∑–∞—è–≤–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –≤ —Ç–µ—á–µ–Ω–∏–µ 5‚Äì30 –º–∏–Ω—É—Ç.</p>

      <label class="label-row">–°—É–º–º–∞ –≤—ã–≤–æ–¥–∞</label>
      <input type="number" placeholder="–°—É–º–º–∞ (–º–∏–Ω. 300 ‚ÇΩ)" id="wAmount">
      <label class="label-row">–ü–æ–ª—É—á–∞—Ç–µ–ª—å</label>
      <input type="text" placeholder="–§–ò–û –∏–ª–∏ @–Ω–∏–∫ –≤ Telegram" id="wName">
      <label class="label-row">–†–µ–∫–≤–∏–∑–∏—Ç—ã</label>
      <input type="text" placeholder="–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã / —Ç–µ–ª–µ—Ñ–æ–Ω–∞" id="wDetails">
      <div class="action-btn bank-btn" style="margin-top:12px;" onclick="sendWithdraw()"><i class="fas fa-paper-plane"></i><span>–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É</span></div>
    </div>
  </div>

  <script>
    // Telegram WebApp init
    const tg = window.Telegram.WebApp;
    tg.ready();
    try { tg.expand(); } catch(e){}
    const tgUser = (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) ? tg.initDataUnsafe.user : {};

    const my_uid = tgUser.id || null;

    // Elements
    const balanceEl = document.getElementById('balance');
    const headerBalanceText = document.getElementById('headerBalanceText');
    const withdrawBalanceInline = document.getElementById('withdrawBalanceInline');
    const userPhoto = document.getElementById('userPhoto');
    const userNameEl = document.getElementById('userName');
    const userHandleEl = document.getElementById('userHandle');

    // Render profile from Telegram data
    userPhoto.src = tgUser.photo_url || `https://api.dicebear.com/7.x/avataaars/svg?seed=${tgUser.id || 'user'}`;
    userNameEl.textContent = tgUser.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
    userHandleEl.textContent = tgUser.username ? '@' + tgUser.username : '@user';

    // Load profile/balance from server
    async function loadProfile() {
      if (!my_uid) return;
      try {
        const res = await fetch(`/api/user/info?uid=${encodeURIComponent(my_uid)}`);
        if (!res.ok) return;
        const data = await res.json();
        const bal = Number((data.user && data.user.balance) || 0);
        renderBalance(bal);
        window.__USER_BALANCE = bal;
      } catch(e) {
        console.error('loadProfile error', e);
      }
    }

    function renderBalance(bal) {
      const fmt = Number(bal||0).toLocaleString() + ' ‚ÇΩ';
      balanceEl.textContent = fmt;
      headerBalanceText.textContent = fmt;
      withdrawBalanceInline.textContent = fmt;
    }

    // WebSocket for realtime updates
    let socket = null;
    (function setupSocket(){
      if (typeof io === 'undefined') return;
      try {
        socket = io({ transports: ['websocket'] });
        socket.on('connect', () => console.log('socket connected', socket.id));
        socket.on('user_update', data => {
          if (!data) return;
          if (String(data.user_id) === String(my_uid)) {
            // Server tells us to reload profile
            loadProfile();
          }
        });
      } catch(e){
        console.warn('Socket init error', e);
      }
    })();

    // Tabs
    function showTab(t) {
      document.getElementById('tasksTab').style.display = t==='tasks'?'block':'none';
      document.getElementById('profileTab').style.display = t==='profile'?'block':'none';
      document.querySelectorAll('.nav-item').forEach((e,i)=>e.classList.toggle('active', i === (t==='tasks'?0:1)));
      document.getElementById('createFab').classList.toggle('visible', t==='tasks');
      window.scrollTo({top:0,behavior:'smooth'});
    }
    function switchTaskTab(i) {
      document.querySelectorAll('.tab').forEach((t,idx)=>t.classList.toggle('active', idx===i));
    }

    // Modals
    function openModal(id){ document.getElementById(id).classList.add('active'); }
    function closeModal(id){
      document.getElementById(id).classList.remove('active');
      setTimeout(()=>{
        if (id === 'topupModal') {
          document.getElementById('sbpStep1').style.display = 'block';
          document.getElementById('sbpStep2').style.display = 'none';
        }
      }, 300);
    }

    document.getElementById('topupBtn').onclick = () => openModal('topupModal');
    document.getElementById('withdrawBtn').onclick = () => openModal('withdrawModal');
    document.getElementById('createFab').onclick = () => {
      tg.showPopup({ title:'üìù –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è', message:'–§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞–Ω–∏–π –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–µ–π –≤–µ—Ä—Å–∏–∏!', buttons:[{type:'ok'}]});
    };

    // TOPUP logic: create a topup request on server (no client-side balance change)
    let currentSBPAmount = 0;
    let currentTransferCode = '';
    let transferUnique = '';

    function prepareSBP(amount) {
      if (!amount || amount < 150) { tg.showPopup({message:'–ú–∏–Ω–∏–º—É–º 150 ‚ÇΩ'}); return; }
      prepareSBPTransfer(amount);
    }
    function prepareCustomSBP() {
      const amount = parseInt(document.getElementById('customAmount').value);
      if (!amount || amount < 150) { tg.showPopup({message:'–ú–∏–Ω–∏–º—É–º 150 ‚ÇΩ'}); return; }
      prepareSBPTransfer(amount);
    }
    function prepareSBPTransfer(amount) {
      currentSBPAmount = amount;
      currentTransferCode = 'RC' + Math.floor(1000 + Math.random() * 9000);
      transferUnique = currentTransferCode + '_' + Math.floor(Date.now() / 1000);
      document.getElementById('sbpAmount').textContent = amount.toLocaleString() + ' ‚ÇΩ';
      document.getElementById('exactAmount').textContent = amount.toLocaleString() + ' ‚ÇΩ';
      document.getElementById('transferCode').textContent = transferUnique;
      document.getElementById('transferComment').value = transferUnique;
      document.getElementById('sbpStep1').style.display = 'none';
      document.getElementById('sbpStep2').style.display = 'block';
    }

    // copy transfer comment
    document.getElementById('transferComment').addEventListener('click', function(){
      if (!this.value) return;
      navigator.clipboard.writeText(this.value).then(()=> tg.showPopup({message:'–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!'}));
    });

    async function confirmTransfer() {
      if (!my_uid) { tg.showPopup({message:'–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}); return; }
      try {
        const res = await fetch('/api/user/topup', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ uid: my_uid, amount: currentSBPAmount, manual_code: transferUnique })
        });
        if (res.ok) {
          tg.showPopup({ title:'‚úÖ –ó–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞!', message:`+${currentSBPAmount.toLocaleString()} ‚ÇΩ –ø–æ—è–≤–∏—Ç—Å—è –Ω–∞ –±–∞–ª–∞–Ω—Å–µ –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.`, buttons:[{type:'ok'}]});
          closeModal('topupModal');
        } else {
          const j = await res.json().catch(()=>null);
          tg.showPopup({ title:'–û—à–∏–±–∫–∞', message: j && j.errmsg ? j.errmsg : '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏', buttons:[{type:'ok'}]});
        }
      } catch(e) {
        console.error('confirmTransfer error', e);
        tg.showPopup({ title:'–û—à–∏–±–∫–∞', message:'–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', buttons:[{type:'ok'}]});
      }
    }

    // Withdraw: send withdraw request to server; no client-side balance change
    async function sendWithdraw() {
      const amount = parseInt(document.getElementById('wAmount').value);
      const name = document.getElementById('wName').value.trim();
      const details = document.getElementById('wDetails').value.trim();
      if (!amount || amount < 300) { tg.showPopup({message:'–ú–∏–Ω–∏–º—É–º –¥–ª—è –≤—ã–≤–æ–¥–∞ 300 ‚ÇΩ'}); return; }
      if (amount > (window.__USER_BALANCE || 0)) { tg.showPopup({message:'–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤'}); return; }
      if (!name || !details) { tg.showPopup({message:'–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è'}); return; }

      try {
        const res = await fetch('/api/user/withdraw', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ uid: my_uid, amount, name, details })
        });
        if (res.ok) {
          tg.showPopup({ title:'‚úÖ –ó–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞!', message:`–ó–∞—è–≤–∫–∞ –Ω–∞ –≤—ã–≤–æ–¥ ${amount.toLocaleString()} ‚ÇΩ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞. –°—Ç–∞—Ç—É—Å: –í –æ–±—Ä–∞–±–æ—Ç–∫–µ.`, buttons:[{type:'ok'}]});
          closeModal('withdrawModal');
        } else {
          const j = await res.json().catch(()=>null);
          tg.showPopup({ title:'–û—à–∏–±–∫–∞', message: j && j.errmsg ? j.errmsg : '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞—è–≤–∫–∏', buttons:[{type:'ok'}]});
        }
      } catch(e) {
        console.error('sendWithdraw error', e);
        tg.showPopup({ title:'–û—à–∏–±–∫–∞', message:'–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', buttons:[{type:'ok'}]});
      }
    }

    // Init load
    loadProfile();

    // Small helpers for UI
    function showTabName(name) { showTab(name); }
    // Expose some functions to global (for inline onclicks)
    window.switchTaskTab = switchTaskTab;
    window.showTab = showTab;
    window.openModal = openModal;
    window.closeModal = closeModal;
    window.prepareSBP = prepareSBP;
    window.prepareCustomSBP = prepareCustomSBP;
    window.confirmTransfer = confirmTransfer;
    window.sendWithdraw = sendWithdraw;

  </script>
</body>
</html>
