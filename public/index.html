<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>ReviewCash ‚Ä¢ –ö–∞–±–∏–Ω–µ—Ç</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&display=swap">
  <!-- use CDN socket.io client to avoid engine mismatch -->
  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
  <style>
    :root{
      --bg-light: linear-gradient(180deg,#f0f4f8,#ffffff);
      --panel-light: rgba(255,255,255,0.94);
      --accent1-light: #4CAF50;
      --accent2-light: #8BC34A;
      --text-dark: #121212;
      --muted-dark: #666;
      --radius: 16px;
    }
    body{margin:0;font-family:'Inter',sans-serif;-webkit-font-smoothing:antialiased;background:var(--bg-light);color:var(--text-dark);padding:14px;min-height:100vh;}
    /* dark theme variables via body.dark */
    body.dark{ --bg-light: linear-gradient(180deg,#060608,#000); --panel-light: rgba(12,12,12,0.92); --accent1-light:#00ff66; --accent2-light:#00ffcc; --text-dark:#f4f9f4; --muted-dark:#bdbdbd; }
    .wrap{max-width:900px;margin:0 auto;display:block;}
    .loader{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:transparent;z-index:9999;pointer-events:none}
    .loader .logo{background:linear-gradient(90deg,var(--accent1-light),var(--accent2-light));color:#001;padding:24px;border-radius:20px;font-weight:900;box-shadow:0 8px 40px rgba(0,0,0,0.15);animation:loaderPulse 2.4s infinite}
    @keyframes loaderPulse{0%{transform:translateY(0) scale(1);}50%{transform:translateY(-10px) scale(1.02);}100%{transform:translateY(0) scale(1)}}
    .card{background:var(--panel-light);padding:18px;border-radius:var(--radius);box-shadow:0 6px 30px rgba(0,0,0,0.06);margin-bottom:16px;backdrop-filter:blur(4px);border:1px solid rgba(0,0,0,0.04);}
    body.dark .card{box-shadow:0 8px 40px rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.04)}
    .header{display:flex;align-items:center;gap:12px}
    .avatar{width:84px;height:84px;border-radius:50%;overflow:hidden;border:3px solid var(--accent1-light);flex:0 0 84px;background:#222}
    .avatar img{width:100%;height:100%;object-fit:cover}
    .title-block{flex:1}
    .user-name{font-weight:800;font-size:20px}
    .user-handle{color:var(--muted-dark);font-size:13px}
    .balance{font-weight:900;font-size:32px;background:linear-gradient(90deg,var(--accent1-light),var(--accent2-light));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .actions{display:flex;gap:10px;align-items:center}
    .btn{padding:10px 16px;border-radius:12px;border:none;background:linear-gradient(90deg,var(--accent1-light),var(--accent2-light));color:#001;font-weight:800;cursor:pointer;box-shadow:0 6px 20px rgba(0,0,0,0.12)}
    .btn.ghost{background:transparent;border:1px solid rgba(0,0,0,0.07);color:var(--text-dark)}
    body.dark .btn.ghost{border:1px solid rgba(255,255,255,0.06);color:var(--text-dark)}
    .btn.small{padding:8px 10px;font-size:13px}
    /* Top support and theme fixed */
    #supportBtn{position:fixed;top:12px;right:12px;z-index:1200;border-radius:999px;padding:10px;font-size:20px;background:transparent;border:none;cursor:pointer;color:var(--accent1-light);box-shadow:0 6px 30px rgba(0,0,0,0.08)}
    #themeToggle{position:fixed;top:12px;left:12px;z-index:1200;border-radius:999px;padding:8px 12px;background:transparent;border:1px solid rgba(0,0,0,0.06);cursor:pointer}
    body.dark #themeToggle{border:1px solid rgba(255,255,255,0.08)}
    /* nav bottom */
    .tabbar{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:var(--panel-light);padding:8px;border-radius:999px;border:1px solid rgba(0,0,0,0.06);display:flex;gap:8px;z-index:1100}
    body.dark .tabbar{border:1px solid rgba(255,255,255,0.04)}
    .nav-item{padding:8px 12px;border-radius:999px;cursor:pointer;font-weight:800;color:var(--muted-dark)}
    .nav-item.active{background:linear-gradient(90deg,var(--accent1-light),var(--accent2-light));color:#001}
    /* tasks list */
    .task-item{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:12px;background:rgba(0,0,0,0.02);margin-bottom:10px}
    body.dark .task-item{background:rgba(255,255,255,0.02)}
    .sub-tabs{display:flex;gap:8px;margin:12px 0}
    .sub-tab{padding:10px;border-radius:999px;cursor:pointer;background:transparent;border:1px solid rgba(0,0,0,0.04);font-weight:800}
    .sub-tab.active{background:linear-gradient(90deg,var(--accent1-light),var(--accent2-light));color:#001}
    /* modal */
    .modal-bg{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:9999}
    .modal{width:100%;max-width:720px;background:var(--panel-light);padding:18px;border-radius:18px;border:1px solid rgba(0,0,0,0.06)}
    /* link checker */
    .url-check{display:inline-block;width:18px;height:18px;border:3px solid var(--accent1-light);border-top-color:transparent;border-radius:50%;animation:spin 0.8s linear infinite;vertical-align:middle}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .url-status.ok{color:var(--accent1-light)}
    .url-status.err{color:#ff5b6e}
    /* dark theme button outline for visibility */
    body.dark .btn{box-shadow:none;border:1px solid rgba(255,255,255,0.06)}
    body.dark .btn { outline: 2px solid rgba(0,255,102,0.08); }
    /* small tweaks */
    .note{font-size:13px;color:var(--muted-dark)}
  </style>
</head>
<body>
  <div class="loader" id="loader" aria-hidden="true">
    <div class="logo">ReviewCash</div>
  </div>

  <button id="supportBtn" title="–ü–æ–¥–¥–µ—Ä–∂–∫–∞">üéß</button>
  <button id="themeToggle" title="–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É">–¢–µ–º–∞</button>

  <div class="wrap" id="app">
    <!-- profile card -->
    <div class="card" id="profileCard">
      <div class="header">
        <div class="avatar"><img id="avatar" src="" alt="avatar"></div>
        <div class="title-block">
          <div class="user-name" id="userName">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
          <div class="user-handle" id="userHandle">@user</div>
          <div style="margin-top:10px">
            <div class="note">–ë–∞–ª–∞–Ω—Å</div>
            <div class="balance" id="balance">0 ‚ÇΩ</div>
          </div>
        </div>
        <div class="actions">
          <button class="btn" id="topupBtn">–ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>
          <button class="btn ghost" id="withdrawBtn">–í—ã–≤–µ—Å—Ç–∏</button>
        </div>
      </div>
    </div>

    <!-- content card (tasks) -->
    <div class="card" id="tasksCard">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:900">–ó–∞–¥–∞–Ω–∏—è</div>
        <div>
          <button class="btn small" id="createTaskBtn">–°–æ–∑–¥–∞—Ç—å</button>
        </div>
      </div>

      <div class="sub-tabs" id="subTabs">
        <div class="sub-tab active" data-sub="my">–ú–æ–∏ –∑–∞–¥–∞–Ω–∏—è</div>
        <div class="sub-tab" data-sub="public">–í—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–¥–∞–Ω–∏—è</div>
      </div>

      <div id="tasksList"><div class="note">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div></div>
    </div>

    <!-- profile panel separate -->
    <div class="card" id="profilePanel" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div style="font-weight:900">–ü—Ä–æ—Ñ–∏–ª—å</div>
          <div class="note">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞</div>
        </div>
        <div>
          <div class="note">–ò–º—è</div>
          <div id="pName" style="font-weight:800">‚Äî</div>
        </div>
      </div>
      <div style="margin-top:12px">
        <div class="note">–ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π</div>
        <div id="history" style="margin-top:8px"></div>
      </div>
    </div>

  </div>

  <!-- bottom nav -->
  <div class="tabbar" role="navigation" id="tabbar">
    <div class="nav-item active" data-nav="tasks">–ó–∞–¥–∞–Ω–∏—è</div>
    <div class="nav-item" data-nav="profile">–ü—Ä–æ—Ñ–∏–ª—å</div>
  </div>

  <!-- Topup modal -->
  <div class="modal-bg" id="topupModal">
    <div class="modal">
      <button id="closeTopup" style="float:right;background:transparent;border:none;font-size:24px;cursor:pointer">√ó</button>
      <h3>–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ</h3>
      <div class="note">–ú–∏–Ω. 150 ‚ÇΩ</div>
      <div style="display:flex;gap:8px;margin-top:12px">
        <input id="topupAmount" type="number" value="150" min="150" style="flex:1;padding:10px;border-radius:10px;border:1px solid rgba(0,0,0,0.06)">
        <button class="btn" id="createTopupBtn">–°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É</button>
      </div>

      <div id="topupStep" style="display:none;margin-top:12px">
        <div class="note">–°—Å—ã–ª–∫–∞ –¥–ª—è –æ–ø–ª–∞—Ç—ã / –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</div>
        <img id="qrImg" style="display:block;margin:10px auto;max-width:280px;border-radius:10px"/>
        <input id="manualCode" readonly style="width:100%;padding:10px;border-radius:10px;border:1px solid rgba(0,0,0,0.06)">
        <div style="display:flex;gap:8px;margin-top:10px">
          <a id="payLink" class="btn" target="_blank" rel="noopener noreferrer">–û—Ç–∫—Ä—ã—Ç—å –±–∞–Ω–∫</a>
          <button class="btn ghost" id="confirmPaidBtn">–Ø –æ–ø–ª–∞—Ç–∏–ª</button>
        </div>
        <div id="topupMsg" class="note" style="margin-top:8px"></div>
      </div>
    </div>
  </div>

  <!-- Withdraw modal -->
  <div class="modal-bg" id="withdrawModal">
    <div class="modal">
      <button id="closeWithdraw" style="float:right;background:transparent;border:none;font-size:24px;cursor:pointer">√ó</button>
      <h3>–í—ã–≤–µ—Å—Ç–∏</h3>
      <div class="note">–ú–∏–Ω. 300 ‚ÇΩ</div>
      <input id="wAmount" type="number" placeholder="–°—É–º–º–∞" style="width:100%;padding:10px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);margin-top:10px">
      <input id="wName" type="text" placeholder="–§–ò–û –∏–ª–∏ –Ω–∏–∫" style="width:100%;padding:10px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);margin-top:10px">
      <input id="wDetails" type="text" placeholder="–†–µ–∫–≤–∏–∑–∏—Ç—ã" style="width:100%;padding:10px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);margin-top:10px">
      <button class="btn" id="sendWithdraw" style="margin-top:10px">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      <div id="withdrawMsg" class="note" style="margin-top:8px"></div>
    </div>
  </div>

  <!-- Create Task modal -->
  <div class="modal-bg" id="createModal">
    <div class="modal">
      <button id="closeCreate" style="float:right;background:transparent;border:none;font-size:24px;cursor:pointer">√ó</button>
      <h3>–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ</h3>
      <div class="note">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ</div>
      <div id="typesBox" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:12px"></div>
      <div style="margin-top:10px">
        <input id="taskUrl" placeholder="–°—Å—ã–ª–∫–∞ (http:// –∏–ª–∏ https://)" style="width:100%;padding:10px;border-radius:10px;border:1px solid rgba(0,0,0,0.06)">
        <span id="urlChecker" style="display:none"></span>
        <span id="urlStatus" style="margin-left:8px"></span>
      </div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <input id="taskQty" type="number" value="1" min="1" style="padding:10px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);width:120px">
        <div id="totalPrice" class="note" style="align-self:center"></div>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
        <button class="btn" id="submitTask">–°–æ–∑–¥–∞—Ç—å</button>
        <button class="btn ghost" id="cancelCreate">–û—Ç–º–µ–Ω–∞</button>
      </div>
      <div id="createMsg" class="note" style="margin-top:8px"></div>
    </div>
  </div>

<script>
(() => {
  // CDN socket.io
  const socket = (typeof io !== 'undefined') ? io() : null;

  // DOM
  const loader = document.getElementById('loader');
  const avatar = document.getElementById('avatar');
  const userName = document.getElementById('userName');
  const userHandle = document.getElementById('userHandle');
  const balanceEl = document.getElementById('balance');
  const pName = document.getElementById('pName');
  const historyBox = document.getElementById('history');
  const tasksList = document.getElementById('tasksList');
  const typesBox = document.getElementById('typesBox');

  const topupModal = document.getElementById('topupModal');
  const topupAmount = document.getElementById('topupAmount');
  const createTopupBtn = document.getElementById('createTopupBtn');
  const topupStep = document.getElementById('topupStep');
  const qrImg = document.getElementById('qrImg');
  const manualCode = document.getElementById('manualCode');
  const payLink = document.getElementById('payLink');
  const confirmPaidBtn = document.getElementById('confirmPaidBtn');
  const topupMsg = document.getElementById('topupMsg');

  const withdrawModal = document.getElementById('withdrawModal');
  const wAmount = document.getElementById('wAmount'), wName = document.getElementById('wName'), wDetails = document.getElementById('wDetails'), sendWithdraw = document.getElementById('sendWithdraw'), withdrawMsg = document.getElementById('withdrawMsg');

  const createModal = document.getElementById('createModal');
  const taskUrl = document.getElementById('taskUrl'), taskQty = document.getElementById('taskQty'), totalPrice = document.getElementById('totalPrice'), submitTask = document.getElementById('submitTask');

  const supportBtn = document.getElementById('supportBtn');
  const themeToggle = document.getElementById('themeToggle');
  const tabbar = document.getElementById('tabbar');

  // state
  let uid = (new URLSearchParams(location.search)).get('uid') || 'guest_' + Math.floor(Math.random()*99999);
  let allTasks = [];
  let types = [];
  let selectedType = null;
  let topupState = { current: null };

  // UI helpers
  function showLoader(show){
    loader.style.pointerEvents = show ? 'auto' : 'none';
    loader.style.opacity = show ? 1 : 0;
    setTimeout(()=> loader.style.display = show ? 'flex' : 'none', show ? 0 : 400);
  }

  function renderProfile(u){
    avatar.src = `https://api.dicebear.com/8.x/thumbs/svg?seed=${encodeURIComponent(u.id)}`;
    userName.textContent = u.name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
    userHandle.textContent = u.username ? '@'+u.username : '';
    balanceEl.textContent = Number(u.balance||0).toLocaleString('ru-RU') + ' ‚ÇΩ';
    pName.textContent = u.name || '';
    historyBox.innerHTML = (u.history||[]).length ? (u.history||[]).slice(0,10).map(h=>`<div style="padding:8px;border-radius:10px;background:rgba(0,0,0,0.03);margin-bottom:6px"><div style="font-weight:700">${h.type||h.note||''}</div><div class="note">${h.amount? (h.amount+' ‚ÇΩ') : ''} ${h.note||''}</div></div>`).join('') : '<div class="note">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</div>';
  }

  async function api(path, opts){
    try{
      const res = await fetch(path, opts);
      const j = await res.json();
      return j;
    }catch(e){
      console.error('api error', e);
      return null;
    }
  }

  async function loadProfile(){
    const j = await api(`/api/profile_me?uid=${encodeURIComponent(uid)}`);
    if (j && j.ok) renderProfile(j.user);
  }

  async function loadTasks(){
    const j = await api('/api/tasks/list');
    if (!j || !j.ok) {
      tasksList.innerHTML = '<div class="note error">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–¥–∞–Ω–∏—è</div>';
      return;
    }
    allTasks = j.tasks || [];
    renderTasks();
  }

  function renderTasks(){
    const active = document.querySelector('.sub-tab.active').dataset.sub;
    let filtered = allTasks;
    if (active === 'my') filtered = filtered.filter(t => t.owner_uid === uid);
    else filtered = filtered.filter(t => t.owner_uid !== uid);
    if (!filtered.length) { tasksList.innerHTML = '<div class="note">–ù–µ—Ç –∑–∞–¥–∞–Ω–∏–π</div>'; return; }
    tasksList.innerHTML = '';
    filtered.forEach(t=>{
      const el = document.createElement('div'); el.className='task-item';
      el.innerHTML = `<div style="flex:1">
        <div style="font-weight:800">${escapeHtml(t.title)}</div>
        <div class="note">${escapeHtml(t.description||'')}</div>
        <div class="note">–í—ã–ø–æ–ª–Ω–µ–Ω–æ: ${Number(t.completed_qty||0)}/${Number(t.qty||1)}</div>
      </div>
      <div style="text-align:right">
        <div style="font-weight:900">${Number(t.unit_price||0).toLocaleString('ru-RU')} ‚ÇΩ</div>
        <div class="note">${Number(t.qty||0)} —à—Ç</div>
      </div>`;
      tasksList.appendChild(el);
    });
  }

  function escapeHtml(s=''){ return (s+'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  // types
  async function loadTypes(){
    const j = await api('/api/task_types');
    if (j && j.ok && Array.isArray(j.types)) types = j.types;
    else {
      // fallback try json file
      const r = await fetch('/task_types.json').catch(()=>null);
      if (r && r.ok) types = await r.json();
    }
    renderTypes();
  }
  function renderTypes(){
    typesBox.innerHTML = '';
    types.forEach((t,idx)=>{
      const btn = document.createElement('div'); btn.className='type-btn';
      btn.style.padding='8px 12px'; btn.style.borderRadius='12px'; btn.style.border='1px solid rgba(0,0,0,0.06)'; btn.style.cursor='pointer';
      btn.innerHTML = `<div style="font-weight:700">${escapeHtml(t.name)}</div><div style="font-weight:800">${Number(t.unit_price||0)} ‚ÇΩ</div>`;
      btn.addEventListener('click', ()=> {
        selectedType = t;
        document.querySelectorAll('.type-btn').forEach(x=>x.style.boxShadow='none');
        btn.style.boxShadow = '0 6px 24px rgba(0,0,0,0.08)';
        updateTotal();
      });
      typesBox.appendChild(btn);
      if (idx===0 && !selectedType){ selectedType = t; btn.style.boxShadow = '0 6px 24px rgba(0,0,0,0.08)'; updateTotal(); }
    });
  }

  function updateTotal(){
    if (!selectedType) return totalPrice.textContent = '';
    const qty = Number(taskQty.value||1);
    totalPrice.textContent = `–û–±—â–∞—è —Ü–µ–Ω–∞: ${qty * (selectedType.unit_price||0)} ‚ÇΩ`;
  }

  // link checker with spinner
  const urlCheckerEl = document.getElementById('urlChecker');
  const urlStatusEl = document.getElementById('urlStatus');
  let urlCheckTimer = null;
  taskUrl.addEventListener('input', ()=>{
    clearTimeout(urlCheckTimer);
    urlStatusEl.textContent = '';
    const v = taskUrl.value.trim();
    if (!v) { urlCheckerEl.style.display='none'; return; }
    urlCheckerEl.style.display='inline-block'; urlCheckerEl.className='url-check';
    urlCheckTimer = setTimeout(async ()=>{
      try{
        const res = await fetch(v, {method:'HEAD', mode:'no-cors'}).catch(()=>null);
        // we can't reliably HEAD due to CORS; do a best-effort fetch
        urlCheckerEl.style.display='none';
        urlStatusEl.className='url-status ok';
        urlStatusEl.textContent = '‚úÖ';
      }catch(e){
        urlCheckerEl.style.display='none';
        urlStatusEl.className='url-status err';
        urlStatusEl.textContent = '‚ùå';
      }
    }, 500);
  });

  // create task
  document.getElementById('createTaskBtn').addEventListener('click', ()=> {
    createModal.style.display='flex'; createModal.classList.add('open');
  });
  document.getElementById('cancelCreate').addEventListener('click', closeCreate);
  document.getElementById('closeCreate').addEventListener('click', closeCreate);
  function closeCreate(){ createModal.style.display='none'; createModal.classList.remove('open'); selectedType=null; taskUrl.value=''; taskQty.value=1; totalPrice.textContent=''; }

  submitTask.addEventListener('click', async ()=>{
    if (!selectedType) return alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø');
    const url = taskUrl.value.trim(); const qty = Number(taskQty.value||0);
    if (!url) return alert('–í–≤–µ–¥–∏—Ç–µ —Å—Å—ã–ª–∫—É');
    if (!qty || qty<1) return alert('–ö–æ–ª-–≤–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ');
    const body = { title: selectedType.name, description:selectedType.name, unit_price:selectedType.unit_price, qty, url, type_id:selectedType.id, owner_uid: uid };
    const j = await api('/api/tasks/create', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
    if (j && j.ok){ alert('–ó–∞–¥–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ'); closeCreate(); loadTasks(); } else alert((j && j.errmsg) || '–û—à–∏–±–∫–∞');
  });

  taskQty.addEventListener('input', updateTotal);

  // topup
  document.getElementById('topupBtn').addEventListener('click', ()=> { topupModal.style.display='flex'; topupModal.classList.add('open'); topupStep.style.display='none'; topupMsg.textContent=''; topupAmount.value=150; });
  document.getElementById('closeTopup').addEventListener('click', ()=> { topupModal.style.display='none'; topupModal.classList.remove('open'); });
  createTopupBtn.addEventListener('click', async ()=>{
    const amount = Number(topupAmount.value||0);
    if (!amount || amount<150) return alert('–ú–∏–Ω. 150 ‚ÇΩ');
    const j = await api('/api/user/topup-link', {method:'POST',headers:{'Content-Type':'application/json'}, body: JSON.stringify({ uid, amount })});
    if (!j || !j.ok) return alert((j && j.errmsg) || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏');
    topupState.current = j.topup.id;
    manualCode.value = j.manual_code || '';
    qrImg.src = j.qr_url || '';
    payLink.href = j.pay_link || '#';
    topupStep.style.display='block';
    topupMsg.textContent = '–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∏ –æ–ø–ª–∞—Ç–∏—Ç–µ. –ù–∞–∂–º–∏—Ç–µ "–Ø –æ–ø–ª–∞—Ç–∏–ª" –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏.';
  });

  confirmPaidBtn.addEventListener('click', async ()=>{
    if (!topupState.current) return alert('–ü–µ—Ä–µ—Å–æ–∑–¥–∞–π—Ç–µ –∑–∞—è–≤–∫—É');
    const j = await api('/api/user/topup-confirm', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ topup_id: topupState.current, uid })});
    if (j && j.ok){ alert('–ó–∞—è–≤–∫–∞ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É'); topupModal.style.display='none'; topupModal.classList.remove('open'); setTimeout(loadProfile, 1500); } else alert((j && j.errmsg) || '–û—à–∏–±–∫–∞');
  });

  // withdraw
  document.getElementById('withdrawBtn').addEventListener('click', ()=> { withdrawModal.style.display='flex'; withdrawModal.classList.add('open'); withdrawMsg.textContent=''; });
  document.getElementById('closeWithdraw').addEventListener('click', ()=> { withdrawModal.style.display='none'; withdrawModal.classList.remove('open'); });
  sendWithdraw.addEventListener('click', async ()=>{
    const amount = Number(wAmount.value||0);
    const name = wName.value.trim(); const details = wDetails.value.trim();
    if (!amount || amount<300) return alert('–ú–∏–Ω. 300 ‚ÇΩ');
    if (!name || !details) return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è');
    const j = await api('/api/user/withdraw', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ uid, amount, name, details })});
    if (j && j.ok){ withdrawMsg.textContent='–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞'; withdrawModal.style.display='none'; withdrawModal.classList.remove('open'); loadProfile(); } else withdrawMsg.textContent = (j && j.errmsg) || '–û—à–∏–±–∫–∞';
  });

  // nav
  document.querySelectorAll('.nav-item').forEach(el=>{
    el.addEventListener('click', ()=>{
      document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active'));
      el.classList.add('active');
      const nav = el.dataset.nav;
      document.getElementById('tasksCard').style.display = nav==='tasks' ? 'block' : 'none';
      document.getElementById('profilePanel').style.display = nav==='profile' ? 'block' : 'none';
      document.getElementById('profileCard').style.display = nav==='profile' ? 'none' : 'block';
    });
  });

  document.querySelectorAll('.sub-tab').forEach(el=> el.addEventListener('click', ()=>{
    document.querySelectorAll('.sub-tab').forEach(x=>x.classList.remove('active'));
    el.classList.add('active'); renderTasks();
  }));

  // support and theme
  supportBtn.addEventListener('click', ()=> window.open('https://t.me/LolikMoney','_blank'));
  themeToggle.addEventListener('click', ()=> {
    document.body.classList.toggle('dark');
    localStorage.setItem('theme', document.body.classList.contains('dark') ? 'dark' : 'light');
  });
  if (localStorage.getItem('theme') === 'dark') document.body.classList.add('dark');

  // socket handlers
  if (socket){
    socket.on('connect', ()=> console.log('socket connected'));
    socket.on('task_update', ()=> loadTasks());
    socket.on('new_topup', (data)=> console.log('new topup', data));
    socket.on('topup_updated', ()=> { loadProfile(); });
    socket.on('withdraw_new', ()=> console.log('withdraw_new'));
  }

  // initial
  (async ()=>{
    showLoader(true);
    await Promise.all([loadProfile(), loadTasks(), loadTypes()]);
    setTimeout(()=> showLoader(false), 700);
  })();

  // small helpers
  function $(sel){ return document.querySelector(sel); }
})();
</script>
</body>
</html>
