<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>ReviewCash — Личный кабинет</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Telegram WebApp -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
    body {
        background: #000000;
        margin: 0;
        font-family: 'Inter', sans-serif;
        color: #eaffff;
    }

    /* НЕОН */
    .neon {
        color: #00eaff;
        text-shadow: 0 0 10px #00eaff, 0 0 25px #00aaff;
    }

    .card {
        background: rgba(0,0,0,0.6);
        border: 1px solid rgba(0,255,255,0.25);
        border-radius: 20px;
        padding: 20px;
        margin: 15px;
        box-shadow: 0 0 25px rgba(0,255,255,0.1);
        backdrop-filter: blur(10px);
        animation: fadeIn 0.4s ease;
    }

    @keyframes fadeIn {
        from {opacity:0; transform: translateY(15px);}
        to {opacity:1; transform: translateY(0);}
    }

    .btn {
        width: 100%;
        padding: 15px;
        background: linear-gradient(90deg,#00eaff,#0077ff);
        border: none;
        border-radius: 12px;
        color: black;
        font-weight: 700;
        font-size: 16px;
        margin-top: 10px;
        cursor:pointer;
        box-shadow: 0 0 15px rgba(0,200,255,0.45);
    }

    .tabbar {
        display: flex;
        justify-content: space-around;
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background: rgba(0,0,0,0.8);
        border-top: 1px solid rgba(0,255,255,0.25);
        padding: 10px 0;
    }

    .tab {
        color: #77ddee;
        font-size: 16px;
        font-weight: 600;
    }

    /* FAB кнопка создания задания */
    .fab {
        position: fixed;
        bottom: 75px;
        right: 25px;
        width: 60px;
        height: 60px;
        background: linear-gradient(90deg,#00eaff,#00c4ff);
        border-radius: 50%;
        display: flex;
        align-items:center;
        justify-content:center;
        font-size: 35px;
        color: black;
        box-shadow: 0 0 20px rgba(0,255,255,0.5);
        cursor: pointer;
        user-select:none;
    }

    /* Модалка */
    .modal-bg {
        position: fixed;
        top:0; left:0; width:100%; height:100%;
        background: rgba(0,0,0,0.75);
        display:none;
        align-items:center;
        justify-content:center;
    }

    .modal {
        background: rgba(0,0,0,0.85);
        border: 1px solid #00aaff;
        border-radius: 18px;
        padding: 20px;
        width: 90%;
        box-shadow: 0 0 25px rgba(0,255,255,0.25);
        animation: scaleIn 0.35s ease;
    }

    @keyframes scaleIn {
        from {opacity:0; transform:scale(0.7);}
        to {opacity:1; transform:scale(1);}
    }

    input {
        width: 100%;
        padding: 12px;
        margin-top:10px;
        border-radius: 12px;
        border: 1px solid #006688;
        background: #001c22;
        color: #aafaff;
    }

    .type-btn {
        padding: 12px;
        border-radius: 12px;
        background: rgba(0,255,255,0.1);
        border: 1px solid #00bbff;
        margin-top: 8px;
        cursor:pointer;
        font-size: 15px;
        color: #66eeff;
    }

    .active-type {
        background: linear-gradient(90deg,#00eaff,#0080ff);
        color: black;
        font-weight: 800;
    }

</style>
</head>
<body>

<div id="profile" class="card">
    <div style="display:flex; align-items:center;">
        <img id="avatar" src="" style="width:70px;height:70px;border-radius:50%;border:2px solid #00eaff;box-shadow:0 0 15px #00eaff;">
        <div style="margin-left:15px;">
            <div class="neon" id="name">Загрузка…</div>
            <div style="color:#88ddee;">ID: <span id="uid"></span></div>
        </div>
    </div>
    <div style="margin-top:15px;">
        <div style="font-size:15px;color:#88e0ff;">Баланс:</div>
        <div class="neon" style="font-size:28px;" id="balance">0 ₽</div>
    </div>
    <button class="btn" onclick="openTopup()">Пополнить</button>
    <button class="btn" onclick="openWithdraw()">Вывести</button>
</div>

<div id="tasksBlock" class="card">
    <div class="neon" style="font-size:22px;">Задания</div>

    <div style="display:flex; margin-top:10px;">
        <div onclick="setTab('my')" id="tabMy" class="type-btn active-type" style="flex:1;">Мои</div>
        <div onclick="setTab('available')" id="tabAvailable" class="type-btn" style="flex:1;margin-left:8px;">Доступные</div>
    </div>

    <div id="tasksList" style="margin-top:15px;">
        Загрузка…
    </div>
</div>

<!-- Кнопка создания задания -->
<div class="fab" onclick="openCreateTask()">+</div>

<!-- Модалка создания задания -->
<div id="createModal" class="modal-bg">
    <div class="modal">
        <div class="neon" style="font-size:20px;">Создание задания</div>

        <div id="taskTypes"></div>

        <input id="taskUrl" placeholder="Ссылка…" type="text">
        <input id="taskQty" placeholder="Количество…" type="number">

        <button class="btn" onclick="submitTask()">Создать</button>
        <button class="btn" style="background:#333;color:#0ff" onclick="closeCreateModal()">Отмена</button>
    </div>
</div>

<script>
let tg = window.Telegram.WebApp;
tg.expand();

let UID = tg.initDataUnsafe?.user?.id || 0;
document.getElementById("uid").innerText = UID;

// Аватарка
if (tg.initDataUnsafe.user.photo_url) {
    document.getElementById("avatar").src = tg.initDataUnsafe.user.photo_url;
} else {
    document.getElementById("avatar").src = "https://api.dicebear.com/8.x/thumbs/svg?seed=" + UID;
}

// Имя
document.getElementById("name").innerText =
    tg.initDataUnsafe.user.first_name + (tg.initDataUnsafe.user.last_name ? (" " + tg.initDataUnsafe.user.last_name) : "");

// ————————— ЗАГРУЗКА ПРОФИЛЯ —————————
function loadProfile() {
    fetch(`/api/profile_me?uid=${UID}`)
        .then(r => r.json())
        .then(d=>{
            if(d.ok) {
                document.getElementById("balance").innerText = d.user.balance + " ₽";
            }
        });
}
loadProfile();

// LIVE обновление баланса
const socket = io();
socket.on("user_update", msg=>{
    if(msg.user_id == UID.toString()) {
        document.getElementById("balance").innerText = msg.balance + " ₽";
    }
});

// ————————— ТАБЫ —————————
let currentTab = "my";

function setTab(t) {
    currentTab = t;
    document.getElementById("tabMy").classList.remove("active-type");
    document.getElementById("tabAvailable").classList.remove("active-type");

    if(t=="my") document.getElementById("tabMy").classList.add("active-type");
    else document.getElementById("tabAvailable").classList.add("active-type");

    loadTasks();
}

// ————————— ЗАГРУЗКА ЗАДАНИЙ —————————
function loadTasks() {
    fetch("/api/tasks/list")
        .then(r=>r.json())
        .then(d=>{
            let box = document.getElementById("tasksList");
            box.innerHTML="";

            let arr = d.tasks;

            if(currentTab=="my") {
                arr = arr.filter(t=>t.owner_uid==UID);
            } else {
                arr = arr.filter(t=>t.owner_uid!=UID);
            }

            if(arr.length==0) {
                box.innerHTML="<div style='color:#77ddee;padding:10px;'>Нет заданий</div>";
                return;
            }

            arr.forEach(t=>{
                let div=document.createElement("div");
                div.className="card";
                div.innerHTML = `
                    <div class="neon" style="font-size:18px;">${t.title}</div>
                    <div style="color:#88ddee;margin-top:5px;">${t.description || ""}</div>
                    <div style="margin-top:10px;color:#55eaff;">${t.unit_price} ₽ × ${t.qty}</div>
                `;
                box.appendChild(div);
            });
        })
}
loadTasks();

// ————————— Модалка создания задания —————————
function openCreateTask(){document.getElementById("createModal").style.display="flex"; loadTypes();}
function closeCreateModal(){document.getElementById("createModal").style.display="none";}

let selectedType=null;

function loadTypes() {
    fetch("/api/admin/tasks") // переиспользуем endpoint
        .then(r=>r.json())
        .then(d=>{
            fetch("/api/admin/tasks") // игнорируем, получим только типы
        });

    fetch("/task_types.json") // можно заменить на /api/task-types если добавишь
}

fetch("/api/admin/tasks") // костыль, при необходимости заменим позже
.catch(()=>{});

// Заглушка типов (берутся с backend)
let types = [
    {id:"ya_review", name:"Яндекс карты", price:120},
    {id:"gmaps_review", name:"Google Maps", price:65},
    {id:"tg_sub", name:"Подписка на канал", price:10}
];

function loadTypes(){
    let box=document.getElementById("taskTypes");
    box.innerHTML="";

    types.forEach(t=>{
        let div=document.createElement("div");
        div.className="type-btn";
        div.innerHTML=`${t.name} — <b>${t.price} ₽</b>`;
        div.onclick=()=>{
            selectedType=t.id;
            document.querySelectorAll(".type-btn").forEach(b=>b.classList.remove("active-type"));
            div.classList.add("active-type");
        };
        box.appendChild(div);
    });
}

function submitTask(){
    let url=document.getElementById("taskUrl").value.trim();
    let qty=document.getElementById("taskQty").value;

    if(!selectedType) return alert("Выберите тип");
    if(!url) return alert("Введите ссылку");
    if(!qty || qty<=0) return alert("Количество!");

    fetch("/api/admin/task-create",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({
            title: selectedType,
            desc:"Задание",
            reward: types.find(x=>x.id==selectedType).price,
            url:url
        })
    })
    .then(r=>r.json())
    .then(d=>{
        if(d.ok){
            closeCreateModal();
            loadTasks();
        } else alert("Ошибка");
    });
}

// ————————— Пополнение / вывод —————————
function openTopup(){alert("Пока отключено");}
function openWithdraw(){window.location.href="/withdraw.html";}
</script>

<!-- Socket.io -->
<script src="/socket.io/socket.io.js"></script>

</body>
</html>
