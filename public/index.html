<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ReviewCash — Кабинет</title>

<!-- Telegram WebApp -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<!-- Socket.IO -->
<script src="/socket.io/socket.io.js"></script>

<style>
  :root{
    --bg:#040204; --panel:rgba(9,7,6,0.6); --accent1:#b8860b; --accent2:#ffd27f;
    --muted:#9fb7c7; --text:#eaf9ff; --glass:1px solid rgba(255,255,255,0.04);
    --radius:16px;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#000,#07060a);color:var(--text);-webkit-font-smoothing:antialiased}
  .wrap{max-width:820px;margin:18px auto;padding:12px}
  .card{background:var(--panel);border-radius:var(--radius);padding:18px;border:var(--glass);box-shadow:0 10px 30px rgba(0,0,0,0.6);margin-bottom:14px;animation:fadeIn .35s ease}
  @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}
  .row{display:flex;gap:12px;align-items:center}
  .avatar{width:74px;height:74px;border-radius:50%;overflow:hidden;border:2px solid rgba(184,134,11,0.14)}
  .avatar img{width:100%;height:100%;object-fit:cover}
  .title{font-weight:800;font-size:18px}
  .muted{color:var(--muted);font-size:13px}
  .balance{font-weight:900;font-size:32px;background:linear-gradient(90deg,var(--accent1),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
  .btn{display:inline-block;padding:12px;border-radius:12px;border:none;background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#111;font-weight:800;cursor:pointer;margin-top:10px}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--text)}
  .tabs{display:flex;gap:8px;margin-bottom:12px}
  .tab{flex:1;padding:10px;border-radius:999px;text-align:center;background:rgba(255,255,255,0.02);cursor:pointer;font-weight:800}
  .tab.active{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#111}
  .task-item{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:10px;background:rgba(255,255,255,0.02);margin-bottom:8px}
  .small{font-size:13px;color:var(--muted)}
  .fab{position:fixed;right:18px;bottom:100px;width:60px;height:60px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#111;font-weight:900;cursor:pointer;box-shadow:0 10px 30px rgba(184,134,11,0.12)}
  .tabbar{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:rgba(255,255,255,0.02);padding:8px;border-radius:999px;border:var(--glass);display:flex;gap:8px}
  .nav-item{padding:8px 12px;border-radius:999px;color:var(--muted);cursor:pointer}
  .nav-item.active{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#111}
  .modal-bg{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.7);z-index:9999}
  .modal{width:100%;max-width:640px;background:rgba(6,6,6,0.9);padding:18px;border-radius:14px;border:var(--glass)}
  .type-btn{padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);background:rgba(255,255,255,0.02);cursor:pointer;margin-top:8px;display:flex;justify-content:space-between;align-items:center}
  .type-btn.active{background:linear-gradient(90deg,#222 0%, rgba(184,134,11,0.08) 100%);border-color:rgba(184,134,11,0.25)}
  input, textarea{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text);margin-top:8px}
  .qr{display:block;margin:12px auto;max-width:220px;border-radius:10px}
  .note{font-size:13px;color:var(--muted);margin-top:8px}
  .error{color:#ff8b8b}
  .ok{color:#8bffcf}
</style>
</head>
<body>
  <div class="wrap">
    <!-- PROFILE CARD -->
    <div class="card" id="profileCard">
      <div class="row">
        <div class="avatar"><img id="avatar" src="" alt="avatar"></div>
        <div style="flex:1">
          <div class="title" id="userName">Загрузка...</div>
          <div class="muted" id="userHandle">@user</div>
          <div style="margin-top:12px">
            <div class="small">Баланс</div>
            <div class="balance" id="balance">0 ₽</div>
          </div>
        </div>
        <div style="text-align:right">
          <button class="btn" id="topupBtn">Пополнить</button><br>
          <button class="btn ghost" id="withdrawBtn">Вывести</button>
        </div>
      </div>
    </div>

    <!-- TABS -->
    <div class="card">
      <div class="tabs" role="tablist">
        <div class="tab active" data-tab="tasks" id="tabTasks">Задания</div>
        <div class="tab" data-tab="profile" id="tabProfile">Профиль</div>
      </div>

      <!-- TASKS PANEL -->
      <div id="tasksPanel">
        <div style="display:flex;gap:8px;margin-bottom:10px">
          <input id="filterInput" placeholder="Поиск по заданиям" style="flex:1;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text)">
          <button class="btn ghost" id="newTaskBtn">Создать задание</button>
        </div>
        <div id="tasksList">
          <div class="small">Загрузка…</div>
        </div>
      </div>

      <!-- PROFILE PANEL (вкладка) -->
      <div id="profilePanel" style="display:none">
        <div class="small">Имя</div>
        <div style="font-weight:800;font-size:18px" id="pName">—</div>
        <div class="small" style="margin-top:8px">История операций</div>
        <div id="history" style="margin-top:8px"></div>
      </div>
    </div>
  </div>

  <div class="fab" id="fab">+</div>

  <div class="tabbar" role="navigation">
    <div class="nav-item active" data-nav="tasks">Задания</div>
    <div class="nav-item" data-nav="profile">Профиль</div>
  </div>

  <!-- TOPUP Modal -->
  <div id="topupModal" class="modal-bg">
    <div class="modal">
      <button id="closeTopup" style="float:right;background:transparent;border:none;color:var(--muted);font-size:20px;cursor:pointer">×</button>
      <h3>Пополнение через SBP / QR</h3>
      <div class="note">Минимум <b id="minTopup">150</b> ₽</div>
      <div style="display:flex;gap:8px;margin-top:10px">
        <input id="topupAmount" type="number" placeholder="Сумма" min="150" style="flex:1">
        <button class="btn" id="createTopupBtn">Создать заявку</button>
      </div>

      <div id="topupStep" style="display:none;margin-top:12px">
        <div class="note">Ссылка для оплаты / QR (скопируйте комментарий)</div>
        <img id="qrImg" class="qr" src="" alt="QR">
        <input id="manualCode" readonly>
        <div style="display:flex;gap:8px;margin-top:8px">
          <a id="payLink" class="btn" target="_blank" rel="noopener">Открыть банк</a>
          <button class="btn ghost" id="confirmPaidBtn">Я оплатил</button>
        </div>
        <div class="note" id="topupMsg"></div>
      </div>
    </div>
  </div>

  <!-- WITHDRAW Modal -->
  <div id="withdrawModal" class="modal-bg">
    <div class="modal">
      <button id="closeWithdraw" style="float:right;background:transparent;border:none;color:var(--muted);font-size:20px;cursor:pointer">×</button>
      <h3>Вывести средства</h3>
      <div class="note">Мин. 300 ₽</div>
      <input id="wAmount" type="number" placeholder="Сумма">
      <input id="wName" type="text" placeholder="ФИО или ник (получатель)">
      <input id="wDetails" type="text" placeholder="Реквизиты (карта / СБП)">
      <button class="btn" id="sendWithdraw">Отправить заявку</button>
      <div id="withdrawMsg" class="note"></div>
    </div>
  </div>

  <!-- CREATE TASK Modal -->
  <div id="createModal" class="modal-bg">
    <div class="modal">
      <button id="closeCreate" style="float:right;background:transparent;border:none;color:var(--muted);font-size:20px;cursor:pointer">×</button>
      <h3>Создать задание</h3>
      <div class="note">Выберите тип — цена проставится автоматически</div>
      <div id="typesBox" style="margin-top:8px"></div>

      <input id="taskUrl" placeholder="Ссылка (проверьте)"/>
      <input id="taskQty" type="number" placeholder="Количество" min="1" value="1"/>
      <div style="display:flex;gap:8px;margin-top:10px">
        <button class="btn" id="submitTask">Создать</button>
        <button class="btn ghost" id="cancelCreate">Отмена</button>
      </div>
      <div id="createMsg" class="note"></div>
    </div>
  </div>

<script>
(() => {
  const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
  try { tg?.ready?.(); tg?.expand?.(); } catch(e){}

  const uid = tg?.initDataUnsafe?.user?.id ? String(tg.initDataUnsafe.user.id) : (new URLSearchParams(location.search)).get('uid') || 'guest';
  const username = tg?.initDataUnsafe?.user?.username || tg?.initDataUnsafe?.user?.first_name || 'Пользователь';
  const avatarUrl = tg?.initDataUnsafe?.user?.photo_url || `https://api.dicebear.com/8.x/thumbs/svg?seed=${uid}`;

  // DOM
  const avatar = document.getElementById('avatar');
  const userName = document.getElementById('userName');
  const userHandle = document.getElementById('userHandle');
  const balanceEl = document.getElementById('balance');
  const pName = document.getElementById('pName');
  const tasksList = document.getElementById('tasksList');
  const filterInput = document.getElementById('filterInput');

  // modals
  const topupModal = document.getElementById('topupModal');
  const withdrawModal = document.getElementById('withdrawModal');
  const createModal = document.getElementById('createModal');

  // init profile UI
  avatar.src = avatarUrl;
  userName.textContent = tg?.initDataUnsafe?.user?.first_name || 'Пользователь';
  userHandle.textContent = tg?.initDataUnsafe?.user?.username ? '@'+tg.initDataUnsafe.user.username : '';
  pName.textContent = userName.textContent;

  // socket
  const socket = io();
  socket.on('connect', ()=>console.log('socket connected'));
  socket.on('user_update', data => {
    if (String(data.user_id) === String(uid)) {
      balanceEl.textContent = Number(data.balance).toLocaleString('ru-RU') + ' ₽';
      // also update profile history if needed
      loadProfile();
    }
  });
  socket.on('task_update', ()=> loadTasks());
  socket.on('new_topup', ()=> loadAdminInfo && loadAdminInfo()); // admin-side

  // load profile
  async function loadProfile(){
    try{
      const res = await fetch(`/api/profile_me?uid=${encodeURIComponent(uid)}`);
      const j = await res.json();
      if (j.ok && j.user){
        balanceEl.textContent = Number(j.user.balance||0).toLocaleString('ru-RU') + ' ₽';
        // history
        const hist = (j.user.history || []).slice(0,8);
        const histBox = document.getElementById('history');
        histBox.innerHTML = hist.length ? hist.map(h=>`<div style="padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);margin-bottom:6px"><div style="font-weight:700">${h.type||h.note||''}</div><div class="small">${h.amount ? (h.amount+' ₽') : ''} ${h.note || ''}</div></div>`).join('') : '<div class="small">История пуста</div>';
      }
    }catch(e){ console.warn(e) }
  }
  loadProfile();

  // tasks
  let allTasks = [];
  let currentTab = 'tasks';
  async function loadTasks(){
    try{
      const res = await fetch('/api/tasks/list');
      const j = await res.json();
      if (!j.ok) { tasksList.innerHTML = '<div class="small error">Ошибка загрузки</div>'; return; }
      allTasks = j.tasks || [];
      renderTasks();
    }catch(e){ tasksList.innerHTML = '<div class="small error">Ошибка сети</div>'; }
  }

  function renderTasks(){
    const q = (filterInput.value||'').toLowerCase();
    const filtered = allTasks.filter(t => (!q) || (t.title && t.title.toLowerCase().includes(q)) || (t.description && t.description.toLowerCase().includes(q)));
    if (filtered.length === 0) { tasksList.innerHTML = '<div class="small">Нет заданий</div>'; return; }
    tasksList.innerHTML = '';
    filtered.forEach(t=>{
      const div = document.createElement('div');
      div.className = 'task-item';
      div.innerHTML = `<div style="flex:1"><div style="font-weight:800">${t.title}</div><div class="small">${t.description||t.desc||''}</div></div>
                       <div style="text-align:right"><div style="font-weight:900">${(t.unit_price||t.reward||0)} ₽</div><div class="small">${t.qty||1} шт</div></div>`;
      tasksList.appendChild(div);
    });
  }

  filterInput.addEventListener('input', renderTasks);

  // tabs navigation
  document.querySelectorAll('.tab').forEach(el=>{
    el.addEventListener('click', ()=> {
      document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
      el.classList.add('active');
      const tab = el.dataset.tab;
      document.getElementById('tasksPanel').style.display = tab === 'tasks' ? 'block' : 'none';
      document.getElementById('profilePanel').style.display = tab === 'profile' ? 'block' : 'none';
    });
  });
  document.querySelectorAll('.nav-item').forEach(n => n.addEventListener('click', ()=>{
    document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active'));
    n.classList.add('active');
    const nav = n.dataset.nav;
    document.querySelector(`.tab[data-tab="${nav==='profile'?'profile':'tasks'}"]`).click();
    window.scrollTo({top:0,behavior:'smooth'});
  }));

  // FAB + create button
  document.getElementById('fab').addEventListener('click', openCreate);
  document.getElementById('newTaskBtn').addEventListener('click', openCreate);

  // Create task modal logic
  const typesBox = document.getElementById('typesBox');
  let types = [];
  let selectedType = null;

  async function loadTypes(){
    try{
      const res = await fetch('/task_types.json');
      types = await res.json();
    }catch(e){
      types = [
        {id:"ya_review", name:"Отзыв — Яндекс Карты", unit_price:120},
        {id:"gmaps_review", name:"Отзыв — Google Maps", unit_price:65},
        {id:"tg_sub", name:"Подписка — Telegram канал", unit_price:10}
      ];
    }
    renderTypes();
  }

  function renderTypes(){
    typesBox.innerHTML = '';
    types.forEach(t=>{
      const el = document.createElement('div');
      el.className = 'type-btn';
      el.innerHTML = `<div style="font-weight:700">${t.name}</div><div style="font-weight:800">${t.unit_price} ₽</div>`;
      el.onclick = ()=> {
        selectedType = t;
        document.querySelectorAll('.type-btn').forEach(x=>x.classList.remove('active'));
        el.classList.add('active');
      };
      typesBox.appendChild(el);
    });
    // select first by default
    if(types.length && !selectedType){ selectedType = types[0]; typesBox.firstChild.classList.add('active') }
  }

  function openCreate(){ document.getElementById('createModal').style.display = 'flex'; loadTypes(); document.getElementById('createMsg').textContent=''; }
  function closeCreate(){ document.getElementById('createModal').style.display = 'none'; selectedType = null; document.getElementById('taskUrl').value=''; document.getElementById('taskQty').value=1; }

  document.getElementById('closeCreate').addEventListener('click', closeCreate);
  document.getElementById('cancelCreate').addEventListener('click', closeCreate);

  // URL check helper (best-effort)
  async function checkUrl(url){
    if (!url) return { ok:false, message:'Пустая ссылка' };
    try{
      // Try HEAD first
      const res = await fetch(url, {method:'HEAD', mode:'no-cors'}); // note: often no-cors will hide status
      // if fetch doesn't throw, assume ok
      return { ok:true };
    }catch(e){
      // CORS or blocked; we can't be sure — warn user but allow
      return { ok:true, message: 'Не удалось проверить (CORS) — убедитесь, что ссылка рабочая' };
    }
  }

  document.getElementById('submitTask').addEventListener('click', async ()=>{
    const url = document.getElementById('taskUrl').value.trim();
    const qty = Number(document.getElementById('taskQty').value || 0);
    if (!selectedType) return alert('Выберите тип задания');
    if (!url) return alert('Введите ссылку');
    if (!qty || qty < 1) return alert('Укажите корректное количество');

    const chk = await checkUrl(url);
    if (!chk.ok) {
      if (!confirm('Ссылка не прошла проверку. Создать задание всё равно?')) return;
    }

    // create task (user-facing endpoint)
    try{
      const body = {
        title: selectedType.name,
        description: selectedType.name,
        unit_price: selectedType.unit_price || selectedType.reward || 0,
        qty,
        url,
        type_id: selectedType.id,
        owner_uid: uid
      };
      const res = await fetch('/api/tasks/create', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
      const j = await res.json();
      if (j.ok) {
        closeCreate();
        loadTasks();
        alert('Задание создано');
      } else {
        alert(j.errmsg || 'Ошибка создания задания');
      }
    }catch(e){
      alert('Ошибка сети при создании');
    }
  });

  // TOPUP flow
  const minTopup = 150;
  document.getElementById('minTopup').textContent = minTopup;
  document.getElementById('topupBtn').addEventListener('click', ()=> openTopupModal());
  document.getElementById('closeTopup').addEventListener('click', ()=> topupModal.style.display='none');
  async function openTopupModal(){
    document.getElementById('topupAmount').value = minTopup;
    document.getElementById('topupStep').style.display = 'none';
    topupModal.style.display = 'flex';
  }

  document.getElementById('createTopupBtn').addEventListener('click', async ()=>{
    const amount = Number(document.getElementById('topupAmount').value || 0);
    if (!amount || amount < minTopup) return alert('Мин. пополнение ' + minTopup + ' ₽');
    try{
      const res = await fetch('/api/user/topup-link', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({uid, amount})});
      const j = await res.json();
      if(j.ok){
        document.getElementById('topupStep').style.display = 'block';
        document.getElementById('manualCode').value = j.manual_code || (j.topup && j.topup.manual_code) || '';
        document.getElementById('qrImg').src = j.qr_base64 || '';
        document.getElementById('payLink').href = j.pay_link || (j.topup && j.topup.pay_link) || '#';
        // store topup id
        topupState.current = j.topup?.id || j.topup?.id || j.topup?.id || j.topup?.id || j.topup?.id || (j.topup && j.topup.id) || j.topup?.id || j.topup;
        topupState.externalId = (j.topup && j.topup.id) || j.id || j.topup?.id;
        topupState.manual_code = j.manual_code || '';
        topupState.amount = amount;
        document.getElementById('topupMsg').textContent = 'Скопируйте комментарий и оплатите через банк.';
      } else {
        alert(j.errmsg || 'Ошибка создания заявки');
      }
    }catch(e){ alert('Ошибка сети'); }
  });

  const topupState = { current: null };
  document.getElementById('confirmPaidBtn').addEventListener('click', async ()=>{
    if (!topupState.current) {
      // Try to find latest topup by manual_code
      alert('Подтверждение: используем id из ответа сервера. Если не работает — обновите страницу и создайте заявку снова.');
    }
    try{
      const res = await fetch('/api/user/topup-confirm', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ topup_id: topupState.current || topupState.externalId, uid })});
      const j = await res.json();
      if (j.ok){
        alert('Заявка создана — ожидайте проверки администратором.');
        topupModal.style.display = 'none';
      } else {
        alert(j.errmsg || 'Не удалось подтвердить');
      }
    }catch(e){ alert('Ошибка сети'); }
  });

  // WITHDRAW
  document.getElementById('withdrawBtn').addEventListener('click', ()=> withdrawModal.style.display='flex');
  document.getElementById('closeWithdraw').addEventListener('click', ()=> withdrawModal.style.display='none');
  document.getElementById('sendWithdraw').addEventListener('click', async ()=>{
    const amount = Number(document.getElementById('wAmount').value || 0);
    const name = document.getElementById('wName').value.trim();
    const details = document.getElementById('wDetails').value.trim();
    if (!amount || amount < 300) return alert('Мин. 300 ₽');
    try{
      const res = await fetch('/api/user/withdraw', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({uid, amount, name, details})});
      const j = await res.json();
      if (j.ok){
        document.getElementById('withdrawMsg').textContent = 'Заявка отправлена на проверку';
        withdrawModal.style.display = 'none';
      } else {
        document.getElementById('withdrawMsg').textContent = j.errmsg || 'Ошибка';
      }
    }catch(e){ document.getElementById('withdrawMsg').textContent = 'Ошибка сети'; }
  });

  // initial loads
  loadTypes();
  loadTasks();
  setInterval(loadProfile, 60_000);
})();
</script>
</body>
</html>
