<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>ReviewCash — Личный кабинет</title>

<!-- Telegram WebApp -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="/socket.io/socket.io.js"></script>

<style>
  :root{
    --bg:#05060a; --card:#071020; --muted:#8aa6b3; --neon1:#00e676; --neon2:#00b4ff;
    --glass: rgba(255,255,255,0.03);
    --radius:18px;
  }
  html,body{height:100%;margin:0;background:
    radial-gradient(1200px 400px at 10% 10%, rgba(0,180,255,0.04), transparent),
    linear-gradient(180deg,#02030a 0%, #05060a 100%); font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto; color:#e6fbff;}
  .container{max-width:820px;margin:18px auto;padding:12px}
  .topbar{display:flex;align-items:center;gap:12px;padding:12px;border-radius:14px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.03)}
  .brand{display:flex;align-items:center;gap:10px}
  .logo{width:46px;height:46px;border-radius:10px;background:linear-gradient(90deg,var(--neon1),var(--neon2));display:flex;align-items:center;justify-content:center;color:#041018;font-weight:800}
  .top-actions{margin-left:auto;display:flex;gap:10px}
  .btn{background:linear-gradient(90deg,var(--neon1),var(--neon2));color:#021018;border:none;padding:10px 14px;border-radius:12px;font-weight:800;cursor:pointer;box-shadow:0 8px 30px rgba(0,180,255,0.06)}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);box-shadow:none}
  .profile-card{margin-top:12px;padding:18px;border-radius:18px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid var(--glass);display:flex;gap:18px;align-items:center}
  .avatar{width:86px;height:86px;border-radius:50%;overflow:hidden;border:3px solid rgba(0,230,160,0.12);flex:0 0 86px;background:#08121a;display:flex;align-items:center;justify-content:center}
  .avatar img{width:100%;height:100%;object-fit:cover;display:block}
  .profile-info{flex:1}
  .name{font-weight:800;font-size:20px}
  .handle{color:var(--muted);margin-top:4px}
  .balance-wrap{display:flex;flex-direction:column;align-items:flex-end;gap:8px}
  .balance-amount{font-size:28px;font-weight:900;background:linear-gradient(90deg,var(--neon1),var(--neon2));-webkit-background-clip:text;color:transparent}
  .profile-actions{display:flex;gap:10px;margin-top:12px}
  .pill{padding:8px 12px;border-radius:999px;background:rgba(255,255,255,0.01);border:1px solid rgba(255,255,255,0.02);color:var(--muted);cursor:pointer}

  /* main card */
  .card{margin-top:14px;padding:16px;border-radius:16px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));border:1px solid rgba(255,255,255,0.02)}
  .tabs{display:flex;gap:8px}
  .tab{flex:1;padding:10px;border-radius:12px;text-align:center;background:rgba(255,255,255,0.01);cursor:pointer;font-weight:800;color:var(--muted)}
  .tab.active{background:linear-gradient(90deg,var(--neon1),var(--neon2));color:#021018}

  .tasks-list{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-top:14px}
  .task-item{padding:12px;border-radius:12px;background:rgba(255,255,255,0.01);border:1px solid rgba(255,255,255,0.02);display:flex;flex-direction:column;gap:8px}
  .task-title{font-weight:800}
  .task-desc{color:var(--muted);font-size:13px}
  .task-meta{display:flex;justify-content:space-between;align-items:center;margin-top:6px}
  .task-price{font-weight:900;color:var(--neon1)}

  /* FAB */
  .fab{position:fixed;right:22px;bottom:90px;width:66px;height:66px;border-radius:50%;background:linear-gradient(90deg,var(--neon1),var(--neon2));display:flex;align-items:center;justify-content:center;font-size:34px;color:#021018;box-shadow:0 16px 40px rgba(0,180,255,0.12);cursor:pointer}

  /* modals */
  .modal-back{position:fixed;inset:0;background:rgba(2,6,12,0.6);display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
  .modal{width:100%;max-width:720px;background:linear-gradient(180deg,#071021,#04101a);border-radius:14px;padding:16px;border:1px solid rgba(255,255,255,0.02)}
  .modal h3{margin:0 0 8px 0}
  .row{display:flex;gap:8px}
  .col{flex:1}
  input,textarea,select{width:100%;padding:10px;border-radius:10px;background:#04101a;border:1px solid rgba(255,255,255,0.02);color:#e6fbff}
  .small{font-size:13px;color:var(--muted)}

  .type-grid{display:flex;gap:8px;margin-top:10px}
  .type-card{flex:1;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.02);cursor:pointer;text-align:center}
  .type-card.active{background:linear-gradient(90deg,var(--neon1),var(--neon2));color:#021018;font-weight:900}

  .notify{position:fixed;right:20px;bottom:20px;padding:10px 14px;border-radius:10px;background:#021018;color:#bff;border:1px solid rgba(255,255,255,0.03);display:none;z-index:60}

  @media(max-width:520px){ .profile-card{flex-direction:column;align-items:flex-start} .balance-wrap{align-self:stretch;display:flex;flex-direction:row;justify-content:space-between;width:100%}}
</style>
</head>
<body>
<div class="container">
  <div class="topbar">
    <div class="brand">
      <div class="logo">RC</div>
      <div>
        <div style="font-weight:900">ReviewCash</div>
        <div style="font-size:13px;color:var(--muted)">Зарабатывайте на отзывах</div>
      </div>
    </div>

    <div class="top-actions">
      <button id="supportBtn" class="btn ghost">Поддержка</button>
      <button id="openAppBtn" class="btn">Перейти в приложение</button>
    </div>
  </div>

  <!-- PROFILE -->
  <div class="profile-card">
    <div class="avatar"><img id="avatar" src="" alt="avatar"></div>
    <div class="profile-info">
      <div class="name" id="userName">Гость</div>
      <div class="handle" id="userHandle">@user</div>

      <div class="profile-actions">
        <div>
          <div class="small">Текущий баланс</div>
          <div class="balance-amount" id="balanceAmount">0 ₽</div>
        </div>
        <div style="margin-left:auto;display:flex;flex-direction:column;gap:8px">
          <button id="topupOpen" class="pill">Пополнить</button>
          <button id="withdrawOpen" class="pill">Вывести</button>
        </div>
      </div>
    </div>
  </div>

  <!-- TASKS -->
  <div class="card">
    <div style="display:flex;align-items:center;gap:12px">
      <div style="font-weight:900">Задания</div>
      <div style="margin-left:auto" class="small">Управляйте своими и доступными заданиями</div>
    </div>

    <div class="tabs" style="margin-top:12px">
      <div class="tab active" data-tab="my">Мои задания</div>
      <div class="tab" data-tab="available">Доступные</div>
    </div>

    <div class="tasks-list" id="tasksList"></div>
  </div>
</div>

<div class="fab" id="createFab" title="Создать задание">+</div>

<!-- CREATE TASK MODAL -->
<div class="modal-back" id="modalBack">
  <div class="modal" role="dialog" aria-modal="true">
    <h3 id="modalTitle">Создать задание</h3>

    <div class="small">Выберите тип задания</div>
    <div class="type-grid" id="typeGrid">
      <div class="type-card" data-id="ya_review">
        Отзыв — Яндекс<br><small class="small">120 ₽</small>
      </div>
      <div class="type-card" data-id="gmaps_review">
        Отзыв — Google Maps<br><small class="small">65 ₽</small>
      </div>
      <div class="type-card" data-id="tg_sub">
        Подписка — Telegram<br><small class="small">10 ₽</small>
      </div>
    </div>

    <div style="margin-top:10px">
      <label class="small">Ссылка (для отзывов) / канал (для подписки)</label>
      <input id="taskLink" placeholder="https://..." />
      <div class="small" id="linkCheck" style="margin-top:6px;color:var(--muted)">Проверка ссылки: —</div>
    </div>

    <div style="margin-top:10px" class="row">
      <div class="col">
        <label class="small">Количество</label>
        <input id="taskQty" type="number" min="1" value="1" />
      </div>
      <div style="width:140px">
        <label class="small">Цена (за шт)</label>
        <input id="taskPrice" readonly />
      </div>
    </div>

    <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end">
      <button id="createTaskBtn" class="btn">Создать</button>
      <button id="cancelModal" class="btn ghost">Отмена</button>
    </div>
  </div>
</div>

<!-- TOPUP MODAL -->
<div class="modal-back" id="topupBack">
  <div class="modal">
    <h3>Пополнение (СБП / карта)</h3>
    <div class="small">Минимум 150 ₽</div>
    <div style="margin-top:10px" class="row">
      <div class="col">
        <input id="topupAmount" type="number" min="150" placeholder="Сумма ₽" />
      </div>
      <div style="width:180px">
        <button id="getTopup" class="btn">Создать ссылку</button>
      </div>
    </div>

    <div id="topupResult" style="margin-top:12px;display:none">
      <div class="small">Комментарий (обязательно указывать при переводе)</div>
      <input id="manualCode" readonly />
      <div style="margin-top:8px"><img id="qrImage" src="" alt="QR" style="max-width:220px;border-radius:10px"/></div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <a id="openPayLink" class="btn" href="#" target="_blank">Открыть банк</a>
        <button id="confirmPaid" class="btn ghost">Я оплатил</button>
      </div>
    </div>

    <div style="display:flex;justify-content:flex-end;margin-top:12px">
      <button id="closeTopup" class="btn ghost">Закрыть</button>
    </div>
  </div>
</div>

<!-- WITHDRAW MODAL -->
<div class="modal-back" id="withdrawBack">
  <div class="modal">
    <h3>Вывод средств</h3>
    <div class="small">Мин. 300 ₽ — заявка отправляется на проверку</div>
    <div style="margin-top:10px">
      <input id="wAmount" type="number" min="300" placeholder="Сумма ₽" />
      <input id="wName" placeholder="ФИО или ник" style="margin-top:8px"/>
      <input id="wDetails" placeholder="Реквизиты (карта / СБП)" style="margin-top:8px"/>
    </div>

    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
      <button id="sendWithdraw" class="btn">Отправить</button>
      <button id="closeWithdraw" class="btn ghost">Отмена</button>
    </div>
  </div>
</div>

<div class="notify" id="notify">Готово</div>

<script>
(() => {
  // Basic helpers
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const notify = (t, ms=2800) => {
    const n = $('#notify'); n.textContent = t; n.style.display = 'block';
    setTimeout(()=> n.style.display='none', ms);
  };

  // Telegram WebApp initialization (if available)
  let tg = window.Telegram ? window.Telegram.WebApp : null;
  if (tg) { try { tg.ready(); tg.expand(); } catch(e){ } }
  const tgUser = tg && tg.initDataUnsafe && tg.initDataUnsafe.user ? tg.initDataUnsafe.user : null;
  const UID = tgUser ? (tgUser.id || ('tg_'+Math.floor(Math.random()*1e6))) : ('guest_'+Math.floor(Math.random()*1e6));

  // Support link (user requested)
  $('#supportBtn').addEventListener('click', ()=> window.open('https://t.me/LolikMoney','_blank'));

  // Open app / fallback
  $('#openAppBtn').addEventListener('click', ()=> {
    // If Telegram: open WebApp main; else open root
    window.location.href = '/';
  });

  // avatar & profile
  const avatar = $('#avatar'); const nameEl = $('#userName'); const handleEl = $('#userHandle');
  if (tgUser) {
    avatar.src = tgUser.photo_url || `https://api.dicebear.com/7.x/avataaars/svg?seed=${UID}`;
    nameEl.textContent = (tgUser.first_name || 'Пользователь') + (tgUser.last_name ? (' '+tgUser.last_name) : '');
    handleEl.textContent = tgUser.username ? ('@'+tgUser.username) : '';
  } else {
    avatar.src = `https://api.dicebear.com/7.x/avataaars/svg?seed=${UID}`;
    nameEl.textContent = 'Гость';
    handleEl.textContent = '';
  }

  // socket
  const socket = io({ transports:['websocket'] });
  socket.on('connect', ()=> console.log('socket connected', socket.id));
  socket.on('user_update', data => {
    if (String(data.user_id) === String(UID) || String(data.user_id) === String(UID)) {
      setBalance(data.balance);
    }
  });
  socket.on('task_update', ()=> loadTasks()); // reload tasks on update

  // balance
  function setBalance(v) { $('#balanceAmount').textContent = (Number(v||0).toLocaleString('ru-RU') + ' ₽'); }
  async function loadProfile(){
    try {
      const res = await fetch(`/api/profile_me?uid=${encodeURIComponent(UID)}`);
      const j = await res.json();
      if (j.ok && j.user) setBalance(j.user.balance);
    } catch(e){ console.warn('profile load', e) }
  }
  loadProfile();

  // Tabs
  $$('.tab').forEach(t => t.addEventListener('click', (e) => {
    $$('.tab').forEach(x => x.classList.remove('active'));
    e.currentTarget.classList.add('active');
    const tab = e.currentTarget.dataset.tab;
    // filter tasks accordingly
    renderTasks(lastTasks, tab === 'my' ? 'my' : 'available');
  }));

  // FAB create
  $('#createFab').addEventListener('click', ()=> openCreateModal());

  // Create modal logic
  let chosenType = null;
  $$('#typeGrid .type-card').forEach(card=>{
    card.addEventListener('click', ()=>{
      chosenType = card.dataset.id;
      $$('#typeGrid .type-card').forEach(c=>c.classList.remove('active'));
      card.classList.add('active');
      // prices auto fill
      const priceMap = { 'ya_review':120, 'gmaps_review':65, 'tg_sub':10 };
      $('#taskPrice').value = (priceMap[chosenType]||0);
    });
  });

  // check link best-effort
  async function checkLink(url){
    const el = $('#linkCheck'); el.textContent = 'Проверка...';
    try{
      // basic URL validation:
      new URL(url);
    } catch(e){ el.textContent = 'Неверный URL'; return false; }
    // try HEAD
    try {
      const resp = await fetch(url, {method:'HEAD', mode:'no-cors'}); // mode no-cors — may opaque
      el.textContent = 'Проверка выполнена (best-effort)';
      return true;
    } catch(e){
      // fallback: mark as unchecked because of CORS
      el.textContent = 'Не удалось проверить (CORS), пользователь просмотреть вручную';
      return true;
    }
  }

  $('#taskLink').addEventListener('blur', (e)=> { const v=e.target.value.trim(); if(v) checkLink(v); });

  $('#cancelModal').addEventListener('click', closeCreateModal);
  $('#createTaskBtn').addEventListener('click', async ()=>{
    const qty = Number($('#taskQty').value || 0);
    const link = ($('#taskLink').value || '').trim();
    if (!chosenType) return notify('Выберите тип задания');
    if (chosenType !== 'tg_sub' && !link) return notify('Укажите ссылку для отзыва');
    if (qty < 1) return notify('Укажите количество');
    // determine price
    const priceMap = { 'ya_review':120, 'gmaps_review':65, 'tg_sub':10 };
    const price = priceMap[chosenType] || 10;
    const payload = {
      title: chosenType === 'ya_review' ? 'Отзыв — Яндекс' : chosenType === 'gmaps_review' ? 'Отзыв — Google' : 'Подписка — Telegram',
      description: link || '',
      unit_price: price,
      qty: qty,
      type_id: chosenType
    };
    try {
      const res = await fetch('/api/tasks/create', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      const j = await res.json();
      if (j.ok) {
        notify('Задание создано');
        closeCreateModal();
        loadTasks();
      } else {
        notify('Ошибка создания');
      }
    } catch(e){ console.error(e); notify('Ошибка сети'); }
  });

  function openCreateModal(){ $('#modalBack').style.display='flex'; $('#taskPrice').value=''; $('#taskQty').value=1; $('#taskLink').value=''; $('#linkCheck').textContent='Проверка ссылки: —'; chosenType=null; $$('#typeGrid .type-card').forEach(x=>x.classList.remove('active')) }
  function closeCreateModal(){ $('#modalBack').style.display='none'; }

  // TOPUP flow
  $('#topupOpen').addEventListener('click', ()=> $('#topupBack').style.display = 'flex');
  $('#closeTopup').addEventListener('click', ()=> $('#topupBack').style.display = 'none');

  $('#getTopup').addEventListener('click', async ()=>{
    const amount = Number($('#topupAmount').value || 0);
    if (!amount || amount < 150) return notify('Мин. 150 ₽');
    try {
      const res = await fetch('/api/user/topup-link', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ uid: UID, amount })});
      const j = await res.json();
      if (!j.ok) return notify(j.errmsg || 'Ошибка создания ссылки');
      $('#manualCode').value = j.manual_code || j.manualCode || '';
      $('#qrImage').src = j.qr_base64 || j.qr_base64 || '';
      $('#openPayLink').href = j.pay_link || j.pay_link || '#';
      $('#topupResult').style.display = 'block';
      currentTopup = j.topup || j.topup || null;
    } catch(e){ console.error(e); notify('Ошибка сети'); }
  });

  let currentTopup = null;
  $('#confirmPaid').addEventListener('click', async ()=>{
    if (!currentTopup) return notify('Нет активной заявки');
    try {
      const res = await fetch('/api/user/topup-confirm', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ uid: UID, topup_id: currentTopup.id })});
      const j = await res.json();
      if (j.ok) {
        notify('Заявка отправлена на проверку');
        $('#topupBack').style.display='none';
      } else notify(j.errmsg || 'Ошибка');
    } catch(e){ console.error(e); notify('Ошибка сети'); }
  });

  // WITHDRAW
  $('#withdrawOpen').addEventListener('click', ()=> $('#withdrawBack').style.display = 'flex');
  $('#closeWithdraw').addEventListener('click', ()=> $('#withdrawBack').style.display = 'none');
  $('#sendWithdraw').addEventListener('click', async ()=>{
    const amount = Number($('#wAmount').value || 0);
    const name = $('#wName').value || '';
    const details = $('#wDetails').value || '';
    if (!amount || amount < 300) return notify('Мин. 300 ₽');
    try {
      const res = await fetch('/api/user/withdraw', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ uid: UID, amount, name, details })});
      const j = await res.json();
      if (j.ok) { notify('Заявка отправлена'); $('#withdrawBack').style.display='none'; loadProfile(); }
      else notify(j.errmsg || 'Ошибка');
    } catch(e){ console.error(e); notify('Ошибка сети'); }
  });

  // Create/Load tasks
  let lastTasks = [];
  async function loadTasks(){
    try {
      const res = await fetch('/api/tasks/list'); const j = await res.json();
      if (!j.ok) return console.warn('tasks list error');
      lastTasks = j.tasks || [];
      const activeTab = document.querySelector('.tab.active').dataset.tab;
      renderTasks(lastTasks, activeTab==='my' ? 'my' : 'available');
    } catch(e){ console.error(e); }
  }

  function renderTasks(tasks, mode='available'){
    const container = $('#tasksList'); container.innerHTML = '';
    const me = String(UID);
    let arr = tasks.slice();
    if (mode === 'my') arr = arr.filter(t=> String(t.owner_uid || '') === me);
    else arr = arr.filter(t => String(t.owner_uid || '') !== me);
    if (!arr.length) { container.innerHTML = '<div style="color:var(--muted);padding:12px">Список пуст</div>'; return; }
    arr.forEach(t => {
      const el = document.createElement('div'); el.className = 'task-item';
      el.innerHTML = `<div class="task-title">${t.title || t.type_id || 'Задание'}</div>
                      <div class="task-desc">${t.desc || t.description || t.description || ''}</div>
                      <div class="task-meta"><div class="small">#${t.id}</div><div class="task-price">${(t.unit_price||t.reward||0)} ₽</div></div>`;
      container.appendChild(el);
    });
  }

  // initial load
  loadTasks();
  setInterval(loadProfile, 60_000);

})();
</script>
</body>
</html>
