<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ReviewCash ‚Äî –∫—Ä–∞—Å–∏–≤—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Poppins:wght@600;800&display=swap" rel="stylesheet">
<script src="https://unpkg.com/lottie-web@5.8.1/build/player/lottie.min.js"></script>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<style>
  :root{
    --bg1:#061426; --bg2:#031827;
    --accentA:#00f0ff; --accentB:#00ff9d;
    --muted:#9fb6c6; --gold:#ffd166;
    --card-radius:16px;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,Arial;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:#eaf7fb}
  .container{max-width:1100px;margin:28px auto;padding:18px;display:flex;flex-direction:column;gap:18px}
  header{display:flex;align-items:center;gap:12px}
  .logo{width:72px;height:72px;border-radius:14px;background:linear-gradient(135deg,var(--accentA),var(--accentB));display:flex;align-items:center;justify-content:center;color:#012226;font-weight:900;font-family:Poppins;font-size:22px;box-shadow:0 18px 60px rgba(0,240,255,0.06)}
  .title h1{margin:0;font-size:20px}
  .title p{margin:0;color:var(--muted);font-size:13px}
  .main{display:grid;grid-template-columns:1fr 380px;gap:18px;align-items:start}
  .panel{background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);border-radius:var(--card-radius);padding:16px;border:1px solid rgba(255,255,255,0.04);box-shadow:0 18px 60px rgba(0,0,0,0.6)}
  .tasks-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px;margin-top:12px}
  .task{border-radius:12px;padding:12px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);border:1px solid rgba(255,255,255,0.02);cursor:pointer;transition:transform .18s,box-shadow .18s}
  .task:hover{transform:translateY(-8px);box-shadow:0 30px 60px rgba(0,0,0,0.6)}
  .profile{display:flex;flex-direction:column;gap:12px}
  .profile-top{display:flex;gap:12px;align-items:center;position:relative}
  .avatar{width:84px;height:84px;border-radius:14px;background:linear-gradient(135deg,#04202a,#05202a);display:flex;align-items:center;justify-content:center;color:var(--accentA);font-weight:900;font-size:22px;border:4px solid rgba(0,255,200,0.03)}
  .profile-info .name{font-weight:800}
  .profile-info .handle{color:var(--muted);font-size:13px}
  .support-small{position:absolute;right:0;top:0;width:40px;height:40px;border-radius:10px;background:linear-gradient(90deg,var(--accentA),var(--accentB));display:flex;align-items:center;justify-content:center;color:#012226;cursor:pointer}
  .history{max-height:300px;overflow:auto;margin-top:8px;border-top:1px dashed rgba(255,255,255,0.03);padding-top:10px}
  .history-item{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px dashed rgba(255,255,255,0.02)}
  .bottom-nav{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;width:420px;max-width:94%;height:72px;border-radius:14px;background:linear-gradient(180deg,#051425,#02121a);display:flex;align-items:center;justify-content:space-around;box-shadow:0 22px 80px rgba(0,0,0,0.7);border:1px solid rgba(255,255,255,0.03)}
  .nav-button{display:flex;flex-direction:column;align-items:center;gap:6px;color:var(--muted);cursor:pointer;padding:8px 12px;border-radius:10px;transition:all .18s}
  .nav-button.active{color:var(--accentA);background:linear-gradient(90deg, rgba(0,240,255,0.04), rgba(0,255,157,0.02));transform:translateY(-6px)}
  .hide{display:none}
  @media(max-width:1000px){ .main{grid-template-columns:1fr} .profile{order:2} }
</style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">RC</div>
      <div class="title"><h1>ReviewCash</h1><p>–ö—Ä–∞—Å–∏–≤–æ, —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ, –ø–ª–∞–≤–Ω–æ</p></div>
      <div style="margin-left:auto"><button id="refresh" style="padding:8px;border-radius:10px;background:linear-gradient(90deg,#00f0ff,#00ff9d);border:none;color:#012226;cursor:pointer">–û–±–Ω–æ–≤–∏—Ç—å</button></div>
    </header>

    <div class="main">
      <!-- Tasks panel -->
      <div class="panel" id="tasksPanel">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><h2 style="margin:0">–ó–∞–¥–∞–Ω–∏—è</h2><div style="color:var(--muted);font-size:13px">–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞–Ω–∏–µ</div></div>
          <div><input id="searchInput" placeholder="–ü–æ–∏—Å–∫..." style="padding:8px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:#eaf7fb"/></div>
        </div>
        <div id="tasksGrid" class="tasks-grid" aria-live="polite"></div>
      </div>

      <!-- Profile panel -->
      <aside class="panel profile" id="profilePanel">
        <div class="profile-top">
          <div class="avatar" id="avatar">RC</div>
          <div class="profile-info">
            <div class="name" id="nameDisplay">–ü—Ä–æ—Ñ–∏–ª—å —Å–∫—Ä—ã—Ç</div>
            <div class="handle" id="handleDisplay">–ù–∞–∂–º–∏—Ç–µ ¬´–ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å¬ª —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å</div>
            <div style="margin-top:8px"><button id="revealProfile" style="padding:8px;border-radius:10px;border:none;background:linear-gradient(90deg,#00f0ff,#00ff9d);color:#012226;cursor:pointer">–ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button></div>
          </div>
          <div class="support-small" id="supportSmall" title="–ü–æ–¥–¥–µ—Ä–∂–∫–∞">üéß</div>
        </div>

        <div style="margin-top:10px">
          <h3 style="margin:0">–ò—Å—Ç–æ—Ä–∏—è</h3>
          <div id="history" class="history"><div style="color:var(--muted)">–ò—Å—Ç–æ—Ä–∏—è —Å–∫—Ä—ã—Ç–∞ –ø–æ–∫–∞ –ø—Ä–æ—Ñ–∏–ª—å –Ω–µ –æ—Ç–∫—Ä—ã—Ç</div></div>
        </div>

        <div style="margin-top:12px;display:flex;gap:8px">
          <button id="topupBtn" style="padding:10px;border-radius:10px;border:none;background:linear-gradient(90deg,#00f0ff,#00ff9d);color:#012226;cursor:pointer">–ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>
          <button id="withdrawBtn" style="padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:#eaf7fb;cursor:pointer">–í—ã–≤–µ—Å—Ç–∏</button>
        </div>
      </aside>
    </div>

    <!-- Bottom nav -->
    <div class="bottom-nav" id="bottomNav">
      <div class="nav-button active" id="navTasks" data-view="tasks"><svg width="20" height="20" viewBox="0 0 24 24" fill="none"><rect x="9" y="2" width="6" height="4" rx="1" stroke="currentColor" stroke-width="1.4"/><path d="M7 8h10v12a1 1 0 0 1-1 1H8a1 1 0 0 1-1-1V8z" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg><div>–ó–∞–¥–∞–Ω–∏—è</div></div>
      <div class="nav-button" id="navProfile" data-view="profile"><svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" stroke="currentColor" stroke-width="1.4"/><circle cx="12" cy="7" r="4" stroke="currentColor" stroke-width="1.4"/></svg><div>–ü—Ä–æ—Ñ–∏–ª—å</div></div>
    </div>
  </div>

<!-- Minimal modals: we'll use simple prompts for support and maintain polished UX -->
<script>
/* Smooth view toggling */
const navTasks = document.getElementById('navTasks');
const navProfile = document.getElementById('navProfile');
const tasksPanel = document.getElementById('tasksPanel');
const profilePanel = document.getElementById('profilePanel');
const bottomNav = document.getElementById('bottomNav');

function activate(view){
  if(view === 'tasks'){
    navTasks.classList.add('active'); navProfile.classList.remove('active');
    // show tasks panel, hide profile on small screens
    if(window.innerWidth <= 1000){
      tasksPanel.classList.remove('hide'); profilePanel.classList.add('hide');
    }
  } else {
    navProfile.classList.add('active'); navTasks.classList.remove('active');
    if(window.innerWidth <= 1000){
      profilePanel.classList.remove('hide'); tasksPanel.classList.add('hide');
    }
  }
  // small fade effect
  [tasksPanel, profilePanel].forEach(el => { el.style.opacity = 0.0; setTimeout(()=> el.style.opacity = 1, 60); });
}

navTasks.addEventListener('click', ()=> activate('tasks'));
navProfile.addEventListener('click', ()=> activate('profile'));
window.addEventListener('resize', ()=> { if(window.innerWidth > 1000){ tasksPanel.classList.remove('hide'); profilePanel.classList.remove('hide'); } else { activate(navTasks.classList.contains('active') ? 'tasks' : 'profile'); } });

/* Load tasks (simple) */
async function loadTasks(){
  const grid = document.getElementById('tasksGrid');
  grid.innerHTML = '';
  for(let i=0;i<6;i++){
    const sk = document.createElement('div'); sk.className = 'task';
    sk.innerHTML = `<div style="height:14px;background:linear-gradient(90deg,#ffffff06,#ffffff03,#ffffff06);border-radius:8px;margin-bottom:8px"></div><div style="height:12px;background:linear-gradient(90deg,#ffffff06,#ffffff03,#ffffff06);border-radius:6px;width:70%"></div>`;
    grid.appendChild(sk);
  }
  try {
    const res = await fetch('/api/tasks_public');
    const data = await res.json();
    grid.innerHTML = '';
    if(!data || data.length === 0){
      grid.innerHTML = '<div style="color:#9fb6c6">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π</div>'; return;
    }
    data.forEach(t => {
      const el = document.createElement('div'); el.className = 'task';
      el.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div style="font-weight:700">${t.title || t.id}</div><div style="color:#9fb6c6">${t.budget ? t.budget+' ‚ÇΩ' : ''}</div></div><div style="margin-top:8px;color:#9fb6c6;font-size:13px">${t.link||''}</div>`;
      grid.appendChild(el);
    });
  } catch(e){ grid.innerHTML = '<div style="color:#9fb6c6">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>'; }
}
loadTasks();

/* Profile reveal: default hides personal data until user explicitly clicks */
const revealBtn = document.getElementById('revealProfile');
revealBtn.addEventListener('click', async ()=>{
  // when clicked, attempt to fetch profile via WebApp initData (or just reveal)
  let initData = null;
  try { if(window.Telegram && Telegram.WebApp && Telegram.WebApp.initData) initData = Telegram.WebApp.initData; } catch(e){}
  if(!initData){
    // fallback: simple reveal message
    document.getElementById('nameDisplay').textContent = '–ì–æ—Å—Ç—å';
    document.getElementById('handleDisplay').textContent = '–ü—Ä–æ—Ñ–∏–ª—å –æ—Ç–∫—Ä—ã—Ç –ª–æ–∫–∞–ª—å–Ω–æ';
    revealBtn.style.display = 'none';
    return;
  }
  try {
    const res = await fetch('/api/profile_me', { headers: { 'X-Tg-InitData': initData }});
    const j = await res.json();
    if(j.ok){
      // show sanitized data only (we no longer auto display username if you asked to hide; here user explicitly asked)
      document.getElementById('nameDisplay').textContent = j.user.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
      document.getElementById('handleDisplay').textContent = j.user.username ? '@' + j.user.username : 'UID: ' + j.user.id;
      document.getElementById('balance').textContent = (j.balance||0) + ' ‚ÇΩ';
      if(j.photo_url){
        const av = document.getElementById('avatar'); av.innerHTML = '';
        const img = document.createElement('img');
        img.src = j.photo_url; img.style.width='84px'; img.style.height='84px'; img.style.borderRadius='14px';
        av.appendChild(img);
      }
      revealBtn.style.display = 'none';
      // load history now that user revealed profile
      loadHistory(j.user.id);
    } else {
      alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å: ' + (j.reason||''));
    }
  } catch(e){
    console.error('profile_me', e);
    alert('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è');
  }
});

/* Load history by uid */
async function loadHistory(uid){
  const list = document.getElementById('history');
  list.innerHTML = '';
  try {
    const res = await fetch(`/api/user_history?uid=${encodeURIComponent(uid)}&page=1&page_size=8`);
    const j = await res.json();
    if(!j.ok){ list.innerHTML = '<div style="color:#9fb6c6">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</div>'; return; }
    if(!j.items || j.items.length === 0){ list.innerHTML = '<div style="color:#9fb6c6">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</div>'; return; }
    j.items.forEach(it=>{
      const row = document.createElement('div'); row.className = 'history-item';
      row.innerHTML = `<div class="left"><div class="title">${(it.type||'').toUpperCase()} ‚Äî ${it.id}</div><div class="small" style="color:#9fb6c6">${it.summary||''}</div></div><div class="right"><div class="amount">${it.amount ? it.amount + ' ‚ÇΩ' : ''}</div><div class="small" style="color:#9fb6c6">${it.created_at||''}</div></div>`;
      list.appendChild(row);
    });
  } catch(e){
    list.innerHTML = '<div style="color:#9fb6c6">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏</div>';
  }
}

/* Small handlers for topup/withdraw/support using prompts for simplicity and perfect UX can be added later */
document.getElementById('topupBtn').addEventListener('click', ()=> {
  const s = prompt('–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è (–º–∏–Ω. 100 ‚ÇΩ):');
  if(!s) return;
  const amount = parseFloat(s.replace(',','.'));
  if(isNaN(amount) || amount < 100){ alert('–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ 100 ‚ÇΩ'); return; }
  // call API
  (async ()=>{
    try {
      const headers = {'Content-Type':'application/json'};
      if(window.Telegram && Telegram.WebApp && Telegram.WebApp.initData) headers['X-Tg-InitData'] = Telegram.WebApp.initData;
      const res = await fetch('/api/topups_public', { method:'POST', headers, body: JSON.stringify({ amount })});
      const j = await res.json();
      if(j.ok){
        alert(`–°–æ–∑–¥–∞–Ω–æ: –∫–æ–¥ ${j.topup.code}. –ü–µ—Ä–µ–≤–µ–¥–∏—Ç–µ ${amount} ‚ÇΩ –Ω–∞ –Ω–æ–º–µ—Ä ${j.bank.phone} —Å –∫–æ–¥–æ–º –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏.`);
      } else alert('–û—à–∏–±–∫–∞: ' + (j.reason||''));
    } catch(e){ alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'); }
  })();
});

document.getElementById('withdrawBtn').addEventListener('click', async ()=>{
  const s = prompt('–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –≤—ã–≤–æ–¥–∞ (–º–∏–Ω. 250 ‚ÇΩ):');
  if(!s) return;
  const amt = parseFloat(s.replace(',','.'));
  if(isNaN(amt) || amt < 250){ alert('–ú–∏–Ω. 250 ‚ÇΩ'); return; }
  const name = prompt('–í–≤–µ–¥–∏—Ç–µ –§–ò–û –∏–ª–∏ –Ω–∏–∫ –≤ –±–∞–Ω–∫–µ:');
  if(!name) return;
  const bank = prompt('–í–≤–µ–¥–∏—Ç–µ –±–∞–Ω–∫ / —Ä–µ–∫–≤–∏–∑–∏—Ç—ã:');
  if(!bank) return;
  try {
    const headers = {'Content-Type':'application/json'};
    if(window.Telegram && Telegram.WebApp && Telegram.WebApp.initData) headers['X-Tg-InitData'] = Telegram.WebApp.initData;
    const res = await fetch('/api/withdraw_public', { method:'POST', headers, body: JSON.stringify({ amount: amt, name, bank })});
    const j = await res.json();
    if(j.ok) alert('–ó–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞. –í —Ç–µ—á–µ–Ω–∏–µ 24 —á–∞—Å–æ–≤ –ø–µ—Ä–µ–≤–µ–¥—ë–º —Å—É–º–º—É.');
    else if(j.reason === 'insufficient_balance') alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤. –ë–∞–ª–∞–Ω—Å: ' + (j.balance||0) + ' ‚ÇΩ');
    else alert('–û—à–∏–±–∫–∞: ' + (j.reason||''));
  } catch(e){ alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'); }
});

/* Support small button */
document.getElementById('supportSmall').addEventListener('click', ()=> {
  const text = prompt('–û–ø–∏—à–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—É –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏:');
  if(!text) return;
  (async ()=>{
    try {
      const headers = {'Content-Type':'application/json'};
      if(window.Telegram && Telegram.WebApp && Telegram.WebApp.initData) headers['X-Tg-InitData'] = Telegram.WebApp.initData;
      const res = await fetch('/api/support', { method:'POST', headers, body: JSON.stringify({ message: text })});
      const j = await res.json();
      if(j.ok) alert('–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É');
      else alert('–û—à–∏–±–∫–∞: ' + (j.reason||''));
    } catch(e){ alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'); }
  })();
});
</script>
</body>
</html>
