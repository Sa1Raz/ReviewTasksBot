<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ReviewCash — WebApp</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
<style>
  :root{
    --bg:#0a0014;--glass:rgba(15,10,45,0.98);--neon:#00ffff;--green:#00ff88;--gold:#ffd700;--muted:#88c0d0;--red:#ff3366;
  }
  *{box-sizing:border-box}
  body{background:linear-gradient(135deg,#0a0014,#001133);color:#e6fbff;font-family:Inter,system-ui,-apple-system;padding:14px;min-height:100vh;margin:0;}
  .container{max-width:420px;margin:0 auto;}
  .header{text-align:center;margin:18px 0;}
  h1{font-size:34px;background:linear-gradient(90deg,#00ffff,#00ff88);-webkit-background-clip:text;color:transparent;margin:0;}
  .role-switch{display:flex;background:rgba(20,20,50,0.9);border:3px solid rgba(0,255,255,0.12);border-radius:32px;padding:6px;gap:6px;margin:12px 0;}
  .role-btn{flex:1;padding:10px;border-radius:26px;text-align:center;font-weight:900;cursor:pointer;color:var(--muted);background:transparent;border:none}
  .role-btn.active{background:linear-gradient(135deg,var(--neon),var(--green));color:#001;box-shadow:0 10px 40px rgba(0,255,255,0.06)}
  /* create form */
  .create-form{background:var(--glass);border:2px solid rgba(0,255,255,0.06);padding:14px;border-radius:14px;margin-bottom:12px;display:none}
  .create-form.active{display:block}
  input,select,textarea{width:100%;padding:12px;border-radius:12px;background:#001;border:1px solid rgba(255,255,255,0.04);color:#fff;margin-top:10px}
  .price-buttons{display:flex;gap:8px;overflow-x:auto;padding:10px 0}
  .price-btn{padding:10px 14px;border-radius:12px;background:rgba(0,255,255,0.04);border:1px solid rgba(0,255,255,0.06);cursor:pointer;font-weight:900}
  .price-btn.active{background:linear-gradient(45deg,var(--neon),var(--green));color:#001;transform:scale(1.05)}
  .btn-primary{background:linear-gradient(45deg,var(--neon),var(--green));color:#001;flex:1;padding:12px;border-radius:12px;border:none;font-weight:900;cursor:pointer}
  .btn-outline{padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--muted);cursor:pointer}
  .card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:12px;border-radius:12px;border:1px solid rgba(0,255,255,0.06);margin-bottom:12px;}
  .task-title{font-weight:900;font-size:18px;margin-bottom:6px;}
  .task-meta{color:var(--muted);font-size:13px;margin-bottom:8px;}
  .filter-bar{display:flex;gap:8px;overflow-x:auto;padding:8px 0;margin:10px 0}
  .filter-btn{padding:10px 12px;border-radius:12px;background:rgba(0,255,255,0.04);border:1px solid rgba(0,255,255,0.06);cursor:pointer;color:#fff;font-weight:900}
  .filter-btn.active{background:linear-gradient(45deg,var(--neon),var(--green));color:#001}
  .small{font-size:13px;color:var(--muted)}
  .instr{background:rgba(0,0,0,0.35);padding:10px;border-radius:8px;margin-top:8px;font-size:14px;color:#e6fbff}
  .bottom-nav{position:fixed;left:16px;right:16px;bottom:18px;background:rgba(15,15,45,0.98);backdrop-filter:blur(20px);border-radius:40px;padding:10px;border:3px solid rgba(0,255,255,0.06);display:flex;gap:8px;box-shadow:0 30px 80px rgba(0,0,0,0.7)}
  .nav-btn{flex:1;padding:12px;border-radius:26px;border:none;background:transparent;color:var(--muted);font-weight:900;cursor:pointer}
  .nav-btn.active{background:linear-gradient(45deg,var(--neon),var(--green));color:#001;transform:translateY(-6px)}
  /* modal fallback */
  .rc-modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:4000}
  .rc-modal{width:92%;max-width:480px;background:linear-gradient(180deg,#071426,#081a33);padding:16px;border-radius:12px;border:2px solid rgba(0,255,255,0.06);color:#e6fbff;position:relative}
  .rc-modal .rc-close{position:absolute;right:12px;top:8px;cursor:pointer;font-weight:900;color:#fff}
  .profile-avatar{width:120px;height:120px;border-radius:50%;border:6px solid var(--neon);object-fit:cover;background:#001}
  .requests-list .card{padding:8px;margin-bottom:8px}
</style>
</head>
<body>
  <div class="container" id="main-page">
    <div class="header"><h1>REVIEWCASH</h1></div>

    <div class="role-switch" role="tablist" aria-label="Роль">
      <button class="role-btn active" data-role="employer" aria-pressed="true">РАБОТОДАТЕЛЬ</button>
      <button class="role-btn" data-role="worker" aria-pressed="false">ИСПОЛНИТЕЛЬ</button>
    </div>

    <!-- EMPLOYER: create task -->
    <div id="employer-panel">
      <div style="text-align:center;margin-bottom:10px;">
        <button id="create-task-toggle" class="btn-outline">+ СОЗДАТЬ ЗАДАНИЕ</button>
      </div>

      <div class="create-form" id="create-form" aria-hidden="true">
        <input id="task-title" placeholder="Название задания">
        <input id="task-link" placeholder="Ссылка на отзыв / канал">
        <select id="task-type" aria-label="Тип задания">
          <option value="">Выберите тип</option>
          <option value="yandex">Яндекс Отзыв — 100 ₽</option>
          <option value="google">Google Отзыв — 65 ₽</option>
          <option value="telegram">Telegram Подписка — 10 ₽</option>
        </select>
        <input id="task-budget" type="number" placeholder="Бюджет (макс. 15 000 ₽)" min="100" max="15000">
        <div class="price-buttons" id="priceButtons" aria-hidden="false">
          <button class="price-btn" data-amount="1000">1 000 ₽</button>
          <button class="price-btn" data-amount="3000">3 000 ₽</button>
          <button class="price-btn" data-amount="5000">5 000 ₽</button>
          <button class="price-btn" data-amount="10000">10 000 ₽</button>
          <button class="price-btn" data-amount="15000">15 000 ₽</button>
        </div>
        <div style="margin-top:8px;font-weight:900;color:var(--gold)" id="budget-result">Выберите тип и бюджет</div>
        <div style="display:flex;gap:8px;margin-top:12px;">
          <button id="publish-task" class="btn-primary">ОПУБЛИКОВАТЬ</button>
          <button id="cancel-create" class="btn-outline">ОТМЕНИТЬ</button>
        </div>
      </div>
    </div>

    <!-- WORKER: filters + tasks -->
    <div id="worker-panel" style="display:none">
      <div class="filter-bar" id="filterBar" role="toolbar" aria-label="Фильтр">
        <button class="filter-btn active" data-filter="all">ВСЕ</button>
        <button class="filter-btn" data-filter="yandex">ЯНДЕКС</button>
        <button class="filter-btn" data-filter="google">GOOGLE</button>
        <button class="filter-btn" data-filter="telegram">TG</button>
      </div>

      <div style="margin:8px 0;display:flex;gap:8px;align-items:center;">
        <input id="searchInput" class="search" placeholder="Поиск заданий">
        <button id="refreshBtn" class="btn-outline">Обновить</button>
      </div>

      <div id="tasksList" aria-live="polite"></div>
    </div>

  </div>

  <div class="container" id="profile-page" style="display:none;">
    <div class="card" style="position:relative;">
      <div style="position:absolute;right:12px;top:12px;">
        <button id="supportBtn" class="btn-outline" title="Поддержка"><i class="fas fa-headset"></i></button>
      </div>
      <div style="display:flex;flex-direction:column;align-items:center;text-align:center;padding:18px;">
        <img id="user-avatar" class="profile-avatar" src="" alt="avatar">
        <div id="user-name" style="font-weight:900;font-size:20px;margin-top:10px">Пользователь</div>
        <div id="user-username" class="small" style="margin-bottom:12px">@username</div>
        <div class="small" style="margin-bottom:6px">Доступно для вывода</div>
        <div class="small" id="user-balance" style="font-size:28px;font-weight:900;color:var(--green)">0 ₽</div>
        <div style="width:100%;margin-top:12px;">
          <button id="topup-btn" class="btn-primary" style="width:100%;margin-bottom:8px;padding:12px">ПОПОЛНИТЬ БАЛАНС</button>
          <button id="withdraw-btn" class="btn-outline" style="width:100%;padding:12px">ВЫВЕСТИ СРЕДСТВА</button>
        </div>
      </div>
      <div style="margin-top:12px;">
        <div class="small">Мои заявки</div>
        <div id="my-requests" class="requests-list" style="margin-top:8px"></div>
      </div>
    </div>
  </div>

  <div class="bottom-nav" role="navigation" aria-label="Навигация">
    <button class="nav-btn active" data-page="main">Задания</button>
    <button class="nav-btn" data-page="profile">Профиль</button>
  </div>

<script>
/* Robust index.html JS
   - Safe wrappers for Telegram WebApp
   - Employer (create task) + Worker (filters + list)
   - Profile with topup/withdraw modals and local UX fallback
   - All event handlers checked for element existence before use
*/

const tg = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;
try { tg?.ready?.(); tg?.expand?.(); } catch(e){ /* ignore */ }

// Utility helpers
function escapeHtml(s){ if(s===undefined||s===null) return ''; return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]); }
function showAlert(text){ try{ if(tg && typeof tg.showAlert === 'function') return tg.showAlert(text); }catch(e){} alert(text); }
function showPopup(opts){ // opts: {title,message,buttons}
  try{
    if(tg && typeof tg.showPopup === 'function') return tg.showPopup(opts);
  }catch(e){}
  // fallback modal
  const overlay = document.createElement('div'); overlay.className = 'rc-modal-overlay';
  const html = `<div class="rc-modal"><div style="font-weight:900;color:#00ffcc;margin-bottom:8px">${escapeHtml(opts.title||'')}</div><div>${opts.message||''}</div><div style="text-align:right;margin-top:10px">${(opts.buttons||[]).map((b,i)=>`<button data-idx="${i}" style="margin-left:6px;padding:8px;border-radius:8px;background:${b.type==='close'?'#444':'#00aaee'};color:#fff;border:none">${escapeHtml(b.text||'OK')}</button>`).join('')}</div><div class="rc-close">✕</div></div>`;
  overlay.innerHTML = html; document.body.appendChild(overlay);
  overlay.querySelector('.rc-close').addEventListener('click', ()=> overlay.remove());
  overlay.addEventListener('click', e=> { if(e.target === overlay) overlay.remove(); });
  overlay.querySelectorAll('button[data-idx]').forEach(btn => btn.addEventListener('click', ev => {
    const idx = +btn.dataset.idx; const b = (opts.buttons||[])[idx];
    if(b && typeof b.onClick === 'function') { try{ b.onClick(); }catch(e){ console.error(e); } }
    if(b && b.type === 'close') overlay.remove();
  }));
  return { close: ()=> overlay.remove() };
}
function copy(text){ if(!text) return; if(navigator.clipboard && navigator.clipboard.writeText){ navigator.clipboard.writeText(text).then(()=> showAlert('Скопировано!')).catch(()=> showAlert('Скопировано!')); } else { try{ const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); showAlert('Скопировано!'); }catch(e){ showAlert('Скопировано!'); } } }
window.copy = copy;

// App state
const TASKS_API = '/api/tasks_public'; // should return array of tasks {id,title,link,type,budget,status,owner,...}
const rc_prices = { yandex:100, google:65, telegram:10 };
const user = (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) ? tg.initDataUnsafe.user : { id:null, username:null, first_name:null, photo_url:null };
const currentUid = user.id || ('guest_' + Math.floor(Math.random()*100000));
let localBalance = parseInt(localStorage.getItem('rc_balance_' + currentUid) || '0', 10);

// Initialize profile info
const avatarEl = document.getElementById('user-avatar');
if(avatarEl) avatarEl.src = user.photo_url || ('https://api.dicebear.com/7.x/avataaars/svg?seed=' + encodeURIComponent(user.username || String(user.id || 'guest')));
if(document.getElementById('user-name')) document.getElementById('user-name').innerText = user.first_name || 'Пользователь';
if(document.getElementById('user-username')) document.getElementById('user-username').innerText = user.username ? '@' + user.username : '—';
function renderBalance(){ const el = document.getElementById('user-balance'); if(el) el.innerText = (localBalance || 0).toLocaleString('ru-RU') + ' ₽'; }
renderBalance();

// Role switching
document.querySelectorAll('.role-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.role-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    const role = btn.dataset.role;
    const emp = document.getElementById('employer-panel');
    const work = document.getElementById('worker-panel');
    if(role === 'employer'){ if(emp) emp.style.display = 'block'; if(work) work.style.display = 'none'; }
    else { if(emp) emp.style.display = 'none'; if(work) work.style.display = 'block'; }
  });
});

// Create form toggles
const createToggle = document.getElementById('create-task-toggle');
const createForm = document.getElementById('create-form');
if(createToggle && createForm){
  createToggle.addEventListener('click', () => {
    createForm.classList.toggle('active');
    createForm.setAttribute('aria-hidden', !createForm.classList.contains('active'));
  });
}
const cancelCreate = document.getElementById('cancel-create');
if(cancelCreate && createForm){
  cancelCreate.addEventListener('click', () => { createForm.classList.remove('active'); createForm.setAttribute('aria-hidden','true'); });
}

// Price quick buttons
document.querySelectorAll('.price-btn').forEach(btn => btn.addEventListener('click', ()=>{
  document.querySelectorAll('.price-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  const v = btn.dataset.amount;
  const budgetInput = document.getElementById('task-budget');
  if(budgetInput) budgetInput.value = v;
  updateBudgetPreview();
}));

function validateLinkForType(link, type){
  if(!link || !type) return true;
  if(type === 'yandex' && !link.includes('yandex')) return false;
  if(type === 'google' && !link.includes('google.com') && !link.includes('goo.gl')) return false;
  if(type === 'telegram' && !link.includes('t.me')) return false;
  return true;
}
function updateBudgetPreview(){
  const type = document.getElementById('task-type')?.value;
  let budget = parseInt(document.getElementById('task-budget')?.value || '0', 10);
  if(!type){ const br=document.getElementById('budget-result'); if(br) br.innerText = 'Выберите тип и бюджет'; return; }
  const min = rc_prices[type] || 0;
  if(budget < min) budget = min;
  if(budget > 15000) budget = 15000;
  const count = Math.floor(budget / rc_prices[type]);
  const rounded = count * rc_prices[type];
  const budgetInput = document.getElementById('task-budget');
  if(budgetInput) budgetInput.value = rounded;
  const br = document.getElementById('budget-result');
  if(br) br.innerHTML = `За <b style="color:#00ff88">${rounded.toLocaleString('ru-RU')} ₽</b> → <b style="color:#ffd700;font-size:20px">${count}</b> ${type==='telegram'?'подписок':'отзывов'}`;
}
document.getElementById('task-type')?.addEventListener('change', updateBudgetPreview);
document.getElementById('task-budget')?.addEventListener('input', ()=> setTimeout(updateBudgetPreview, 400));

// Publish task (employer)
document.getElementById('publish-task')?.addEventListener('click', ()=>{
  const title = (document.getElementById('task-title')?.value || '').trim();
  const link = (document.getElementById('task-link')?.value || '').trim();
  const type = document.getElementById('task-type')?.value;
  const budget = parseInt(document.getElementById('task-budget')?.value || '0',10);
  if(!title) return showAlert('Введите название задания');
  if(!type) return showAlert('Выберите тип задания');
  if(!validateLinkForType(link, type)) return showAlert('Неверная ссылка для выбранного типа');
  if(budget < 100) return showAlert('Минимум 100 ₽');
  const payload = { action: 'publish_task', title, link, type, budget };
  try {
    if(tg && typeof tg.sendData === 'function'){ tg.sendData(JSON.stringify(payload)); showAlert('Задание отправлено'); createForm.classList.remove('active'); renderTasks(); }
    else {
      fetch('/api/publish_task',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)})
        .then(res=>res.json()).then(r=>{ showAlert(r.message || 'Задание опубликовано'); createForm.classList.remove('active'); renderTasks(); })
        .catch(()=> showAlert('Ошибка отправки задания'));
    }
  } catch (e){ console.error(e); showAlert('Ошибка отправки задания'); }
});

// Fetch & render tasks (worker)
async function fetchTasks(){
  try{
    const res = await fetch(TASKS_API, {cache:'no-store'});
    if(!res.ok) return [];
    return await res.json();
  }catch(e){ console.error(e); return []; }
}

let currentFilter = 'all';
document.querySelectorAll('.filter-btn').forEach(b=> b.addEventListener('click', ()=>{
  document.querySelectorAll('.filter-btn').forEach(x=> x.classList.remove('active'));
  b.classList.add('active');
  currentFilter = b.dataset.filter || 'all';
  renderTasks(document.getElementById('searchInput')?.value || '');
}));

document.getElementById('refreshBtn')?.addEventListener('click', ()=> renderTasks(document.getElementById('searchInput')?.value || ''));
document.getElementById('searchInput')?.addEventListener('input', (e)=> setTimeout(()=> renderTasks(e.target.value || ''), 200));

function instructionTextFor(type){
  if(type === 'yandex') return `<b>Инструкция (Яндекс)</b><ul style="padding-left:18px;margin:6px 0"><li>Откройте ссылку, авторизуйтесь в Яндексе.</li><li>Оставьте честный отзыв, желательно с кодом RC####.</li><li>Ограничение: Я.К. — 1 раз в 3 дня.</li></ul>`;
  if(type === 'google') return `<b>Инструкция (Google)</b><ul style="padding-left:18px;margin:6px 0"><li>Откройте Google Maps, оставьте отзыв.</li><li>Можно вставить код RC####.</li><li>Ограничение: Google — 1 раз в 1 день.</li></ul>`;
  if(type === 'telegram') return `<b>Инструкция (Telegram)</b><ul style="padding-left:18px;margin:6px 0"><li>Подпишитесь на канал указанного работодателя.</li><li>Подписки без ограничений.</li></ul>`;
  return `<div>Инструкция: выполните задание и отправьте выполнение.</div>`;
}

function createTaskCard(task){
  const el = document.createElement('div'); el.className = 'card';
  const count = Math.floor((task.budget||0) / (rc_prices[task.type] || 1));
  el.innerHTML = `
    <div class="task-title">${escapeHtml(task.title||'Без названия')}</div>
    <div class="task-meta">${escapeHtml(task.type||'')} · Бюджет: ${(task.budget||0).toLocaleString('ru-RU')} ₽</div>
    <div class="small">Кол-во: <b>${count}</b> ${task.type==='telegram'?'подписок':'отзывов'}</div>
    <div style="display:flex;gap:8px;margin-top:8px;">
      <button class="btn-primary btn-do" data-id="${escapeHtml(task.id)}" data-type="${escapeHtml(task.type||'')}">Выполнить</button>
      <button class="btn-outline btn-instr">Инструкция</button>
    </div>
    <div class="instr" style="display:none">${instructionTextFor(task.type)}</div>
  `;
  el.querySelector('.btn-instr')?.addEventListener('click', ()=> {
    const instr = el.querySelector('.instr'); instr.style.display = instr.style.display === 'none' ? 'block' : 'none';
  });
  el.querySelector('.btn-do')?.addEventListener('click', (e)=> {
    openPerformModal(task.id, task.title, task.type);
  });
  return el;
}

async function renderTasks(q=''){
  const list = document.getElementById('tasksList');
  if(!list) return;
  list.innerHTML = '<div class="small">Загрузка...</div>';
  const tasks = await fetchTasks();
  let arr = (tasks||[]).filter(t => t.status === 'active');
  if(currentFilter !== 'all') arr = arr.filter(t => t.type === currentFilter);
  if(q) arr = arr.filter(t => (t.title||'').toLowerCase().includes(q.toLowerCase()) || (t.type||'').toLowerCase().includes(q.toLowerCase()));
  list.innerHTML = '';
  if(arr.length === 0){ list.innerHTML = '<div class="small">Нет доступных заданий</div>'; return; }
  arr.forEach(t => list.appendChild(createTaskCard(t)));
}

// Perform modal (submit_work)
function openPerformModal(taskId, title, platform){
  const overlay = document.createElement('div'); overlay.className = 'rc-modal-overlay';
  overlay.innerHTML = `<div class="rc-modal">
    <div style="display:flex;justify-content:space-between;align-items:center"><div style="font-weight:900">Выполнение</div><div class="rc-close">✕</div></div>
    <div style="margin-top:8px" class="small">Задание: ${escapeHtml(title)}</div>
    <div style="margin-top:10px"><textarea id="rcText" placeholder="Текст/Комментарий" style="width:100%;height:120px;padding:8px;border-radius:8px;background:#001;color:#fff;border:1px solid rgba(255,255,255,0.04)"></textarea></div>
    <div style="margin-top:8px"><input id="rcLink" placeholder="Ссылка (если есть)" style="width:100%;padding:8px;border-radius:8px;background:#001;color:#fff;border:1px solid rgba(255,255,255,0.04)"></div>
    <div style="display:flex;gap:8px;margin-top:12px"><button id="rcSubmit" style="flex:1;padding:10px;border-radius:8px;background:linear-gradient(45deg,var(--neon),var(--green));border:none;color:#001;font-weight:900">Отправить</button><button id="rcHelp" style="padding:10px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:#fff">Помощь</button></div>
  </div>`;
  document.body.appendChild(overlay);
  overlay.querySelector('.rc-close')?.addEventListener('click', ()=> overlay.remove());
  overlay.querySelector('#rcHelp')?.addEventListener('click', ()=> showAlert(platform === 'yandex' ? 'Оставьте код RC#### в тексте отзыва и дождитесь публикации.' : platform === 'google' ? 'Оставьте код RC#### в тексте и проверьте публикацию.' : 'Подпишитесь на канал и убедитесь в подписке.'));
  overlay.querySelector('#rcSubmit')?.addEventListener('click', ()=> {
    const text = overlay.querySelector('#rcText')?.value.trim() || '';
    const link = overlay.querySelector('#rcLink')?.value.trim() || '';
    if(!text && !link) return showAlert('Введите текст или ссылку.');
    const payload = { action: 'submit_work', task_id: taskId, platform, text, link };
    try {
      if(tg && typeof tg.sendData === 'function'){ tg.sendData(JSON.stringify(payload)); showAlert('Заявка отправлена. Обычные админы проверят работу.'); }
      else { fetch('/api/submit_work', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) }).then(()=> showAlert('Заявка отправлена')); }
      // local UX copy for immediate visibility
      const arr = JSON.parse(localStorage.getItem('rc_works_' + currentUid) || '[]'); arr.push({ task_id: taskId, task_title: title, platform, text, link, amount:0, status:'pending', created_at: new Date().toISOString() }); localStorage.setItem('rc_works_' + currentUid, JSON.stringify(arr));
      overlay.remove();
      renderMyRequests();
    } catch(e){ console.error(e); showAlert('Ошибка отправки'); }
  });
}

// Profile: topup & withdraw (fallback + sendData)
document.getElementById('topup-btn')?.addEventListener('click', ()=> {
  showPopup({ title:'Пополнение', message:`<div style="padding:6px"><input id="topupAmount" type="number" placeholder="Сумма ≥100" style="width:100%;padding:8px;border-radius:8px;background:#001;color:#fff;border:1px solid rgba(255,255,255,0.04)"><div style="margin-top:8px"><button id="topupNext" style="width:100%;padding:10px;border-radius:8px;background:linear-gradient(45deg,var(--neon),var(--green));border:none;color:#001;font-weight:900">Далее</button></div></div>`, buttons:[{type:'close',text:'Закрыть'}]});
  requestAnimationFrame(()=> {
    const next = document.getElementById('topupNext'); if(!next) return;
    next.onclick = ()=> {
      const amount = parseInt(document.getElementById('topupAmount')?.value || '0',10);
      if(amount < 100) return showAlert('Минимум 100 ₽');
      const code = 'RC' + Math.floor(1000 + Math.random()*9000);
      showPopup({
        title:'Перевод',
        message: `<div style="text-align:center"><div style="margin-bottom:8px">Переведите <b style="color:#00ff88">${amount.toLocaleString('ru-RU')} ₽</b></div>
                  <div class="copy-block" onclick="copy('+79600738559')"><div class="copy-text">+7 960 073 85 59</div><div class="small">Нажмите чтобы скопировать</div></div>
                  <div style="margin-top:8px">Код: <div class="copy-block" onclick="copy('${code}')"><div class="copy-text">${code}</div></div></div>
                  <div style="margin-top:10px"><button id="topupSubmit" style="width:100%;padding:10px;border-radius:8px;background:linear-gradient(45deg,var(--neon),var(--green));border:none;color:#001;font-weight:900">Отправить заявку</button></div></div>`,
        buttons:[{type:'close',text:'Закрыть'}]
      });
      requestAnimationFrame(()=> {
        const submit = document.getElementById('topupSubmit'); if(!submit) return;
        submit.onclick = ()=> {
          if(!confirm(`Отправить заявку на пополнение ${amount.toLocaleString('ru-RU')} ₽?`)) return;
          const payload = { action:'request_topup', amount, code };
          if(tg && typeof tg.sendData === 'function') tg.sendData(JSON.stringify(payload));
          else fetch('/api/request_topup',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
          // local UX
          const arr = JSON.parse(localStorage.getItem('rc_topups_' + currentUid) || '[]'); arr.push({ amount, code, status:'pending', created_at: new Date().toISOString() }); localStorage.setItem('rc_topups_' + currentUid, JSON.stringify(arr));
          showAlert('Заявка отправлена');
          renderMyRequests();
        };
      });
    };
  });
});

document.getElementById('withdraw-btn')?.addEventListener('click', ()=> {
  showPopup({ title:'Вывод', message:`<div style="padding:6px"><input id="withdrawAmount" type="number" placeholder="Сумма ≥250" style="width:100%;padding:8px;border-radius:8px;background:#001;color:#fff;border:1px solid rgba(255,255,255,0.04)"><div style="margin-top:8px"><button id="withdrawNext" style="width:100%;padding:10px;border-radius:8px;background:linear-gradient(45deg,var(--red),#ff1a50);border:none;color:#fff;font-weight:900">Далее</button></div></div>`, buttons:[{type:'close',text:'Закрыть'}]});
  requestAnimationFrame(()=> {
    const next = document.getElementById('withdrawNext'); if(!next) return;
    next.onclick = ()=> {
      const amount = parseInt(document.getElementById('withdrawAmount')?.value || '0',10);
      if(amount < 250) return showAlert('Минимум 250 ₽');
      if(amount > (localBalance || 0)) return showAlert('Недостаточно средств');
      showPopup({ title:'Реквизиты', message:`<div style="padding:6px"><input id="wName" placeholder="ФИО" style="width:100%;padding:8px;border-radius:8px;background:#001;color:#fff;border:1px solid rgba(255,255,255,0.04);margin-bottom:6px"><input id="wCard" placeholder="Номер карты" style="width:100%;padding:8px;border-radius:8px;background:#001;color:#fff;border:1px solid rgba(255,255,255,0.04);margin-bottom:6px"><input id="wBank" placeholder="Банк" style="width:100%;padding:8px;border-radius:8px;background:#001;color:#fff;border:1px solid rgba(255,255,255,0.04)"><div style="margin-top:8px"><button id="withdrawSubmit" style="width:100%;padding:10px;border-radius:8px;background:linear-gradient(45deg,var(--red),#ff1a50);border:none;color:#fff;font-weight:900">Отправить заявку</button></div></div>`, buttons:[{type:'close',text:'Закрыть'}]});
      requestAnimationFrame(()=> {
        const submit = document.getElementById('withdrawSubmit'); if(!submit) return;
        submit.onclick = ()=> {
          const name = (document.getElementById('wName')||{}).value || ''; const card = (document.getElementById('wCard')||{}).value||''; const bank = (document.getElementById('wBank')||{}).value||'';
          if(!name || !card) return showAlert('Укажите ФИО и реквизиты');
          if(!confirm(`Вывести ${amount.toLocaleString('ru-RU')} ₽ на ${card}?`)) return;
          const payload = { action:'request_withdraw', amount, name, card, bank };
          if(tg && typeof tg.sendData === 'function') tg.sendData(JSON.stringify(payload));
          else fetch('/api/request_withdraw',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
          // local UX
          localBalance = Math.max(0, (localBalance || 0) - amount); localStorage.setItem('rc_balance_' + currentUid, String(localBalance)); renderBalance();
          const arr = JSON.parse(localStorage.getItem('rc_withdraws_' + currentUid) || '[]'); arr.push({ amount, card, status:'pending', created_at: new Date().toISOString() }); localStorage.setItem('rc_withdraws_' + currentUid, JSON.stringify(arr));
          showAlert('Заявка отправлена');
          renderMyRequests();
        };
      });
    };
  });
});

// Render "My requests" from local fallback
function renderMyRequests(){
  const c = document.getElementById('my-requests'); if(!c) return;
  c.innerHTML = '';
  const topups = JSON.parse(localStorage.getItem('rc_topups_' + currentUid) || '[]');
  const withdraws = JSON.parse(localStorage.getItem('rc_withdraws_' + currentUid) || '[]');
  const works = JSON.parse(localStorage.getItem('rc_works_' + currentUid) || '[]');
  if(!topups.length && !withdraws.length && !works.length){ c.innerHTML = '<div class="small">Заявок нет</div>'; return; }
  if(topups.length){ const h = document.createElement('div'); h.className='small'; h.innerText='Пополнения'; c.appendChild(h); topups.slice().reverse().forEach(t => { const d = document.createElement('div'); d.className='card'; d.innerHTML = `<div><b>${(t.amount||0).toLocaleString('ru-RU')} ₽</b> · <span class="small">${t.status||'pending'}</span></div><div class="small">Код: ${escapeHtml(t.code||'')}</div>`; c.appendChild(d); }); }
  if(withdraws.length){ const h = document.createElement('div'); h.className='small'; h.innerText='Выводы'; c.appendChild(h); withdraws.slice().reverse().forEach(w => { const d = document.createElement('div'); d.className='card'; d.innerHTML = `<div><b>${(w.amount||0).toLocaleString('ru-RU')} ₽</b> · <span class="small">${w.status||'pending'}</span></div><div class="small">Карта: ${escapeHtml(w.card||'-')}</div>`; c.appendChild(d); }); }
  if(works.length){ const h = document.createElement('div'); h.className='small'; h.innerText='Выполнения'; c.appendChild(h); works.slice().reverse().forEach(w => { const d = document.createElement('div'); d.className='card'; d.innerHTML = `<div><b>${(w.amount||0).toLocaleString('ru-RU')} ₽</b> · <span class="small">${w.status||'pending'}</span></div><div class="small">${escapeHtml(w.task_title||'')}</div>`; c.appendChild(d); }); }
}

// Navigation
document.querySelectorAll('.nav-btn').forEach(btn => btn.addEventListener('click', ()=>{
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active');
  const page = btn.dataset.page;
  document.getElementById('main-page').style.display = page === 'main' ? 'block' : 'none';
  document.getElementById('profile-page').style.display = page === 'profile' ? 'block' : 'none';
  // show correct panels when returning to main
  const activeRole = document.querySelector('.role-btn.active')?.dataset.role || 'employer';
  if(page === 'main'){
    document.getElementById('employer-panel').style.display = (activeRole === 'employer') ? 'block' : 'none';
    document.getElementById('worker-panel').style.display = (activeRole === 'worker') ? 'block' : 'none';
  }
  if(page === 'profile') renderMyRequests();
}));

// Support button
document.getElementById('supportBtn')?.addEventListener('click', ()=> {
  try{ if(tg && typeof tg.openTelegramLink === 'function') tg.openTelegramLink('https://t.me/RapiHappy'); else window.open('https://t.me/RapiHappy','_blank'); }catch(e){ window.open('https://t.me/RapiHappy','_blank'); }
});

// Initial load
(async function init(){
  await renderTasks();
  renderMyRequests();
  renderBalance();
})();

</script>
</body>
</html>
