<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ReviewCash — App</title>

<!-- Socket.IO client (modern) -->
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;600;800;900&display=swap" rel="stylesheet">
<style>
  :root{
    --bg-dark:#071027; --bg-dark-2:#061425; --card-dark:#081426;
    --bg-light:#f6fbff; --card-light:#ffffff;
    --accent:#00e7c0; --danger:#ff5b6e; --muted:#9fb6c7;
    --radius:12px; --glass: rgba(255,255,255,0.03);
  }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,var(--bg-dark),#030617);color:#eafaff;-webkit-font-smoothing:antialiased}
  .wrap{max-width:980px;margin:18px auto;padding:14px;min-height:calc(100vh - 32px)}
  .header{display:flex;align-items:center;gap:12px}
  .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(90deg,var(--accent),#00b4ff);display:flex;align-items:center;justify-content:center;font-weight:900;color:#001}
  .h-title{font-weight:900}
  .small{font-size:13px;color:var(--muted)}
  .card{margin-top:14px;padding:12px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.005));border:1px solid rgba(255,255,255,0.02)}
  .grid{display:grid;grid-template-columns:1fr 320px;gap:12px}
  .task{padding:12px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));margin-bottom:10px;border:1px solid rgba(255,255,255,0.02)}
  .btn{padding:10px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:800;background:linear-gradient(90deg,var(--accent),#00b4ff);color:#001}
  .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#eafaff;padding:8px 10px}
  .btn-danger{background:linear-gradient(90deg,#ff9aa5,#ff5b6e);color:#100}
  .actions{display:flex;gap:8px;flex-wrap:wrap}
  .bottom-nav{position:fixed;left:0;right:0;bottom:12px;display:flex;justify-content:center;pointer-events:auto}
  .nav-wrap{width:100%;max-width:980px;margin:0 auto;display:flex;justify-content:space-around;gap:8px;padding:10px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:999px;border:1px solid rgba(255,255,255,0.03)}
  .nav-btn{flex:1;padding:10px;border-radius:999px;background:transparent;border:none;color:#eafaff;font-weight:700;cursor:pointer}
  .nav-btn.active{box-shadow:0 6px 20px rgba(0,0,0,0.5);background:linear-gradient(90deg,rgba(255,255,255,0.03),rgba(255,255,255,0.01));color:var(--accent)}
  /* theme switch */
  .theme-toggle{margin-left:auto}
  /* loading */
  .loading-screen{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg, rgba(0,0,0,0.6), rgba(0,0,0,0.2));z-index:9999;transition:opacity .3s}
  .spinner{width:64px;height:64px;border-radius:50%;border:6px solid rgba(255,255,255,0.06);border-top-color:var(--accent);animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  /* modals */
  .modal-back{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.5);z-index:200}
  .modal{width:100%;max-width:720px;background:var(--card-dark);border-radius:14px;padding:16px;border:1px solid rgba(255,255,255,0.03)}
  .input{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
  .row{display:flex;gap:8px}
  .muted{color:var(--muted);font-size:13px}
  .ok{color:#06e58a;font-weight:800}
  .bad{color:#ff7b9a;font-weight:800}
  /* dark theme button outlines */
  .dark-theme .btn-ghost{border:1px solid rgba(255,255,255,0.14)}
  .dark-theme .btn{outline:2px solid rgba(0,0,0,0.12)}
  /* responsive */
  @media(max-width:880px){
    .grid{grid-template-columns:1fr}
    .logo{display:none}
  }
</style>
</head>
<body>
<div class="loading-screen" id="loadingScreen"><div style="text-align:center"><div class="spinner"></div><div class="muted" style="margin-top:8px">Загрузка приложения…</div></div></div>

<div class="wrap" id="app" style="opacity:0;transition:opacity .3s">
  <div class="header">
    <div class="logo">RC</div>
    <div>
      <div class="h-title">ReviewCash</div>
      <div class="small" id="userName">—</div>
    </div>

    <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
      <button id="btnSupport" class="btn-ghost">Поддержка</button>
      <button id="btnTheme" class="btn-ghost theme-toggle">Тема</button>
      <button id="btnTopup" class="btn">Пополнить</button>
    </div>
  </div>

  <div class="card grid" style="min-height:360px">
    <div>
      <div style="display:flex;align-items:center;justify-content:space-between">
        <div style="font-weight:900">Задания</div>
        <div class="small">Баланс: <b id="balance">—</b> ₽</div>
      </div>

      <div id="tasksList" style="margin-top:12px">
        <!-- tasks injected here -->
      </div>

      <div style="margin-top:8px">
        <button id="btnCreateTask" class="btn-ghost">+ Создать задание</button>
      </div>
    </div>

    <div>
      <div class="small">Профиль</div>
      <div class="card" style="margin-top:8px">
        <div id="profileBlock">
          <div><b id="profileName">—</b></div>
          <div class="muted" id="profileUid">UID: —</div>
          <div style="margin-top:8px">
            <button id="btnWithdraw" class="btn btn-danger">Вывести</button>
            <button id="btnHistory" class="btn-ghost">История</button>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div style="font-weight:900">Проверка ссылок</div>
        <div style="margin-top:8px" class="row">
          <input id="checkUrl" class="input" placeholder="Вставьте ссылку (https://...)">
          <button id="btnCheckUrl" class="btn-ghost">Проверить</button>
        </div>
        <div style="margin-top:8px" id="checkResult" class="muted"></div>
      </div>
    </div>
  </div>
</div>

<!-- Bottom nav -->
<div class="bottom-nav">
  <div class="nav-wrap" role="navigation">
    <button class="nav-btn active" data-page="tasks">Задания</button>
    <button class="nav-btn" data-page="profile">Профиль</button>
    <button class="nav-btn" data-page="more">Ещё</button>
  </div>
</div>

<!-- Modals -->
<div class="modal-back" id="modalCreate">
  <div class="modal">
    <h3>Создать задание</h3>
    <div class="row" style="margin-top:8px">
      <input id="taskTitle" class="input" placeholder="Название">
      <input id="taskPrice" class="input" placeholder="Цена (₽)" style="width:140px" type="number">
    </div>
    <textarea id="taskDesc" class="input" style="margin-top:8px;height:86px" placeholder="Описание"></textarea>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
      <div class="muted">Создавая задание вы подтверждаете условия</div>
      <div style="display:flex;gap:8px">
        <button id="createTaskBtn" class="btn">Создать</button>
        <button id="closeCreate" class="btn-ghost">Закрыть</button>
      </div>
    </div>
  </div>
</div>

<div class="modal-back" id="modalTopup">
  <div class="modal">
    <h3>Пополнить баланс</h3>
    <div style="display:flex;gap:8px;margin-top:8px">
      <input id="topupAmount" class="input" placeholder="Сумма, ₽" type="number">
      <select id="topupMethod" class="input" style="width:200px">
        <option value="card">Карта</option>
        <option value="qiwi">Qiwi</option>
        <option value="tinkoff">Tinkoff / Ссылка</option>
      </select>
    </div>
    <div style="margin-top:8px" class="muted">Ссылку пополнения можно сгенерировать и открыть в отдельной вкладке.</div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
      <button id="generateTopup" class="btn">Создать ссылку</button>
      <button id="closeTopup" class="btn-ghost">Отмена</button>
    </div>
    <div id="topupResult" style="margin-top:12px"></div>
  </div>
</div>

<div class="modal-back" id="modalWithdraw">
  <div class="modal">
    <h3>Запрос на вывод</h3>
    <input id="wdName" class="input" placeholder="Кому (ФИО / платёж)"><br>
    <input id="wdDetails" class="input" placeholder="Реквизиты (карта / кошелек)"><br>
    <input id="wdAmount" class="input" placeholder="Сумма" type="number"><br>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
      <button id="submitWithdraw" class="btn btn-danger">Отправить</button>
      <button id="closeWithdraw" class="btn-ghost">Отмена</button>
    </div>
    <div id="withdrawResult" style="margin-top:10px"></div>
  </div>
</div>

<div class="modal-back" id="modalSupport">
  <div class="modal">
    <h3>Поддержка</h3>
    <div class="muted">Опишите проблему, мы ответим в чат / email (демо).</div>
    <textarea id="supportText" class="input" style="height:100px;margin-top:8px"></textarea>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
      <button id="sendSupport" class="btn">Отправить</button>
      <button id="closeSupport" class="btn-ghost">Закрыть</button>
    </div>
    <div id="supportResult" style="margin-top:8px"></div>
  </div>
</div>

<script>
(() => {
  const API = (path, opts={}) => {
    const url = path.startsWith("/") ? path : "/" + path;
    const fetchOpts = Object.assign({headers: {}}, opts);
    // If sending JSON body, stringify
    if (fetchOpts.json) {
      fetchOpts.method = fetchOpts.method || "POST";
      fetchOpts.headers["Content-Type"] = "application/json";
      fetchOpts.body = JSON.stringify(fetchOpts.json);
      delete fetchOpts.json;
    }
    // append cache buster for GET sometimes:
    const finalUrl = url + (url.includes("?") ? "&" : "?") + "t=" + Date.now();
    return fetch(finalUrl, fetchOpts).then(async r => {
      // when server not reachable, fetch will reject
      try {
        const text = await r.text();
        try { return JSON.parse(text); } catch(e) { return {ok:true, text}; }
      } catch(e) { return {ok:false, errmsg:"invalid response"} }
    });
  };

  // socket
  let socket;
  function initSocket(){
    try {
      socket = io({transports:['websocket']});
      socket.on("connect", ()=> console.log("ws connected", socket.id));
      socket.on("task_update", data => { console.log("task_update", data); loadTasks(); });
      socket.on("new_topup", d => { console.log("new_topup", d); /* show notice */ });
      socket.on("user_update", d => { if (d.user_id === currentUser.id) { currentUser.balance = d.balance; renderProfile(); }});
    } catch(e){ console.error("socket init failed", e); }
  }

  // app state
  let currentUser = { id: "guest_1", name: "Гость", balance: 0 };
  const qsToken = new URLSearchParams(location.search).get("token") || "";

  // UI refs
  const loadingScreen = document.getElementById("loadingScreen");
  const appEl = document.getElementById("app");
  const tasksList = document.getElementById("tasksList");
  const balanceEl = document.getElementById("balance");
  const profileName = document.getElementById("profileName");
  const profileUid = document.getElementById("profileUid");
  const userName = document.getElementById("userName");
  const checkResult = document.getElementById("checkResult");

  // initial
  async function boot(){
    showLoading(true);
    initSocket();
    await loadProfile();
    await loadTasks();
    showLoading(false);
    appEl.style.opacity = 1;
    restoreTheme();
  }

  function showLoading(on){
    loadingScreen.style.display = on ? "flex" : "none";
  }

  // load profile
  async function loadProfile(){
    try {
      const r = await API(`/api/profile_me?uid=${encodeURIComponent(currentUser.id)}`);
      if (r && r.ok && r.user){
        currentUser = r.user;
        renderProfile();
      } else {
        console.warn("profile load failed", r);
      }
    } catch(e){
      console.error("profile load error", e);
      showToast("Нет соединения с сервером");
    }
  }
  function renderProfile(){
    profileName.textContent = currentUser.name || currentUser.username || "Пользователь";
    profileUid.textContent = "UID: " + (currentUser.id || "—");
    balanceEl.textContent = (currentUser.balance||0).toFixed(2);
    userName.textContent = "Вы: " + (currentUser.name || "Пользователь");
  }

  // tasks
  async function loadTasks(){
    tasksList.innerHTML = '<div class="muted">Загрузка...</div>';
    try {
      const r = await API('/api/tasks/list');
      if (!r || !r.ok) { tasksList.innerHTML = '<div class="muted">Ошибка загрузки</div>'; return; }
      const items = r.tasks || [];
      if (!items.length) { tasksList.innerHTML = '<div class="muted">Нет заданий</div>'; return; }
      tasksList.innerHTML = '';
      items.forEach(t => {
        const el = document.createElement('div'); el.className='task';
        el.innerHTML = `<div style="display:flex;justify-content:space-between">
            <div><b>${escapeHtml(t.title)}</b><div class="muted" style="font-size:13px">${escapeHtml(t.description||'')}</div></div>
            <div style="text-align:right">
              <div class="muted">Цена</div><div style="font-weight:900">${t.unit_price} ₽</div>
            </div>
          </div>
          <div style="margin-top:8px" class="actions">
            <button class="btn" data-id="${t.id}" data-action="accept">Выполнить</button>
            <button class="btn-ghost" data-id="${t.id}" data-action="view">Открыть</button>
          </div>`;
        tasksList.appendChild(el);
      });
      // attach listeners
      tasksList.querySelectorAll('button').forEach(b=>{
        b.addEventListener('click', onTaskBtn);
      });
    } catch(e){
      tasksList.innerHTML = '<div class="muted">Нет соединения</div>';
      console.error(e);
    }
  }

  function onTaskBtn(ev){
    const btn = ev.currentTarget;
    const id = btn.dataset.id;
    const action = btn.dataset.action;
    if (action === 'view'){
      showToast('Открыть задачу ' + id);
    } else if (action === 'accept'){
      showToast('Действие выполнить (демо).');
    }
  }

  // create task modal
  const modalCreate = document.getElementById("modalCreate");
  document.getElementById("btnCreateTask").addEventListener('click', ()=> modalCreate.style.display='flex');
  document.getElementById("closeCreate").addEventListener('click', ()=> modalCreate.style.display='none');
  document.getElementById("createTaskBtn").addEventListener('click', async ()=>{
    const t = document.getElementById("taskTitle").value.trim();
    const price = parseFloat(document.getElementById("taskPrice").value || 0);
    const desc = document.getElementById("taskDesc").value.trim();
    if (!t || !price) return alert("Заполните название и цену");
    try {
      const r = await API('/api/tasks/create', {json:{title:t, reward:price, desc:desc, owner_uid: currentUser.id}});
      if (r && r.ok){ showToast("Задание создано"); modalCreate.style.display='none'; loadTasks(); }
      else showToast("Ошибка создания");
    } catch(e){ showToast("Нет связи с сервером"); }
  });

  // topup modal
  const modalTopup = document.getElementById("modalTopup");
  document.getElementById("btnTopup").addEventListener('click', ()=> modalTopup.style.display='flex');
  document.getElementById("closeTopup").addEventListener('click', ()=> modalTopup.style.display='none');
  document.getElementById("generateTopup").addEventListener('click', async ()=>{
    const amount = parseFloat(document.getElementById("topupAmount").value || 0);
    if (!amount || amount <= 0) return alert("Введите сумму");
    const method = document.getElementById("topupMethod").value;
    // call API
    try {
      const r = await API('/api/user/topup-link', {json:{uid: currentUser.id, amount}});
      if (!r){ showToast("Ошибка сети/сервер"); return; }
      if (r.ok){
        const out = document.getElementById("topupResult");
        out.innerHTML = `<div>Ссылка: <a href="${r.topup.pay_link}" target="_blank" rel="noreferrer">${r.topup.pay_link}</a></div>
          <div class="muted">Код: <code>${r.manual_code}</code></div>
          <div style="margin-top:8px"><button id="openPay" class="btn">Открыть ссылку</button></div>`;
        document.getElementById("openPay").addEventListener('click', ()=> window.open(r.topup.pay_link,'_blank'));
        showToast("Ссылка создана");
      } else {
        showToast(r.errmsg || "Ошибка");
      }
    } catch(e){
      console.error(e);
      showToast("Нет соединения / сервер недоступен");
    }
  });

  // withdraw modal
  const modalWithdraw = document.getElementById("modalWithdraw");
  document.getElementById("btnWithdraw").addEventListener('click', ()=> modalWithdraw.style.display='flex');
  document.getElementById("closeWithdraw").addEventListener('click', ()=> modalWithdraw.style.display='none');
  document.getElementById("submitWithdraw").addEventListener('click', async ()=>{
    const name = document.getElementById("wdName").value.trim();
    const details = document.getElementById("wdDetails").value.trim();
    const amount = parseFloat(document.getElementById("wdAmount").value || 0);
    if (!name || !details || !amount) return alert("Заполните все поля");
    try {
      const r = await API('/api/user/withdraw', {json:{uid: currentUser.id, amount, name, details}});
      if (!r) return showToast("Ошибка сети");
      if (r.ok){
        document.getElementById("withdrawResult").innerHTML = "<div class='ok'>Заявка отправлена</div>";
        loadProfile();
        modalWithdraw.style.display='none';
      } else showToast(r.errmsg || "Ошибка");
    } catch(e){ showToast("Нет соединения"); }
  });

  // support modal
  const modalSupport = document.getElementById("modalSupport");
  document.getElementById("btnSupport").addEventListener('click', ()=> modalSupport.style.display='flex');
  document.getElementById("closeSupport").addEventListener('click', ()=> modalSupport.style.display='none');
  document.getElementById("sendSupport").addEventListener('click', async ()=>{
    const txt = document.getElementById("supportText").value.trim();
    if (!txt) return alert("Опишите проблему");
    // demo: just show success
    document.getElementById("supportResult").innerHTML = "<div class='ok'>Отправлено — ответ в демо-режиме</div>";
    setTimeout(()=> modalSupport.style.display='none', 1000);
  });

  // Check URL with animation -> fetch HEAD
  document.getElementById("btnCheckUrl").addEventListener('click', async ()=>{
    const url = document.getElementById("checkUrl").value.trim();
    if (!url) return;
    checkResult.innerHTML = '<span class="muted">Проверка…</span> <span class="spinner" style="width:18px;height:18px;border-width:3px"></span>';
    try {
      const controller = new AbortController();
      const id = setTimeout(()=> controller.abort(), 8000);
      // Try HEAD first
      let ok = false;
      try {
        const res = await fetch(url, {method:'HEAD', mode:'cors', signal:controller.signal});
        ok = res && (res.status >= 200 && res.status < 400);
      } catch(e){
        // fallback: try GET with no-cors (opaque) — resolves if network reachable but we can't read status
        try {
          await fetch(url, {method:'GET', mode:'no-cors', signal:controller.signal});
          ok = true;
        } catch(err2){
          ok = false;
        }
      } finally { clearTimeout(id); }
      if (ok) checkResult.innerHTML = '<span class="ok">✅ Ссылка доступна</span>';
      else checkResult.innerHTML = '<span class="bad">❌ Ссылка недоступна или блокируется CORS</span>';
    } catch(e){
      checkResult.innerHTML = '<span class="bad">Ошибка проверки (нет сети или таймаут)</span>';
    }
  });

  // nav pages (simple: show/hide blocks)
  const navBtns = document.querySelectorAll('.nav-btn');
  navBtns.forEach(b=> b.addEventListener('click', ()=>{
    navBtns.forEach(x=>x.classList.remove('active')); b.classList.add('active');
    const page = b.dataset.page;
    // simple behavior: switch focus
    if (page === 'tasks') { window.scrollTo({top:0,behavior:'smooth'}); }
    if (page === 'profile') { window.scrollTo({top:0,behavior:'smooth'}); }
    if (page === 'more') { showToast('Ещё: настройки, реферальная система (демо)'); }
  }));

  // theme: toggle dark / light
  const btnTheme = document.getElementById("btnTheme");
  btnTheme.addEventListener('click', ()=>{
    const isDark = document.documentElement.classList.toggle('dark-theme');
    localStorage.setItem('rc_theme',''+(isDark? 'dark':'light'));
  });
  function restoreTheme(){
    const t = localStorage.getItem('rc_theme') || 'dark';
    document.documentElement.classList.toggle('dark-theme', t==='dark');
  }

  // utils
  function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
  function showToast(msg){ console.log(msg); /* small temporary UI: use alert for demo */ alert(msg); }

  // start
  boot();
})();
</script>
</body>
</html>
