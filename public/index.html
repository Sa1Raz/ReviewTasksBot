<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>ReviewCash • Кабинет</title>
  <!-- Google Fonts for beauty -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&display=swap">
  <!-- Telegram WebApp -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <!-- Socket.IO -->
  <script src="/socket.io/socket.io.js"></script>
  <style>
    :root {
      --bg: linear-gradient(180deg, #f0f4f8, #ffffff); --panel: rgba(255,255,255,0.9); --accent1: #4CAF50; --accent2: #8BC34A;
      --muted: #555555; --text: #333333; --glass: 1px solid rgba(0,0,0,0.05);
      --radius: 20px; --shadow: 0 4px 20px rgba(0,0,0,0.1); --transition: all 0.3s ease; --animation-timing: cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }
    * { box-sizing: border-box; transition: var(--transition); }
    body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); -webkit-font-smoothing: antialiased; min-height: 100vh; padding: 16px; touch-action: manipulation; -webkit-tap-highlight-color: transparent; overflow-x: hidden; }
    .wrap { max-width: 820px; margin: 0 auto; padding: 12px; display: none; }
    .card { background: var(--panel); border-radius: var(--radius); padding: 20px; border: var(--glass); box-shadow: var(--shadow); margin-bottom: 16px; animation: fadeIn 0.4s var(--animation-timing); opacity: 1; transform: translateY(0); position: relative; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes scaleIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    .row { display: flex; gap: 14px; align-items: center; }
    .avatar { width: 80px; height: 80px; border-radius: 50%; overflow: hidden; border: 3px solid var(--accent1); box-shadow: var(--shadow); }
    .avatar img { width: 100%; height: 100%; object-fit: cover; }
    .title { font-weight: 800; font-size: 20px; text-shadow: 0 1px 2px rgba(0,0,0,0.1); }
    .muted { color: var(--muted); font-size: 14px; }
    .balance { font-weight: 900; font-size: 36px; background: linear-gradient(90deg, var(--accent1), var(--accent2)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .btn { display: inline-block; padding: 14px 20px; border-radius: 14px; border: none; background: linear-gradient(90deg, var(--accent1), var(--accent2)); color: #fff; font-weight: 800; cursor: pointer; margin-top: 12px; min-width: 140px; text-align: center; box-shadow: var(--shadow); position: relative; overflow: hidden; }
    .btn:hover { transform: scale(1.05); box-shadow: 0 6px 25px rgba(76,175,80,0.3); }
    .btn.ghost { background: transparent; border: 1px solid var(--accent1); color: var(--accent1); }
    .btn.ghost:hover { background: rgba(76,175,80,0.1); }
    .sub-tabs { display: flex; gap: 10px; margin-bottom: 14px; }
    .sub-tab { flex: 1; padding: 12px; border-radius: 999px; text-align: center; background: rgba(0,0,0,0.05); cursor: pointer; font-weight: 800; color: var(--text); }
    .sub-tab.active { background: linear-gradient(90deg, var(--accent1), var(--accent2)); color: #fff; }
    .task-item { display: flex; justify-content: space-between; align-items: center; padding: 14px; border-radius: 12px; background: rgba(255,255,255,0.8); margin-bottom: 10px; box-shadow: var(--shadow); position: relative; overflow: hidden; }
    .task-item:hover { transform: translateY(-2px); box-shadow: 0 6px 25px rgba(0,0,0,0.15); }
    .small { font-size: 14px; color: var(--muted); }
    .progress { background: rgba(0,0,0,0.1); border-radius: 10px; height: 8px; margin-top: 6px; }
    .progress-bar { background: var(--accent1); height: 100%; border-radius: 10px; transition: width 0.3s ease; }
    .fab { position: fixed; right: 20px; bottom: 100px; width: 64px; height: 64px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: linear-gradient(90deg, var(--accent1), var(--accent2)); color: #fff; font-weight: 900; font-size: 24px; cursor: pointer; box-shadow: 0 6px 25px rgba(76,175,80,0.3); }
    .fab:hover { transform: scale(1.1); }
    .tabbar { position: fixed; left: 50%; transform: translateX(-50%); bottom: 20px; background: rgba(255,255,255,0.9); padding: 10px; border-radius: 999px; border: var(--glass); display: flex; gap: 10px; box-shadow: var(--shadow); }
    .nav-item { padding: 10px 16px; border-radius: 999px; color: var(--muted); cursor: pointer; font-weight: 700; }
    .nav-item.active { background: linear-gradient(90deg, var(--accent1), var(--accent2)); color: #fff; }
    .modal-bg { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.5); z-index: 9999; opacity: 0; transition: opacity 0.3s ease; }
    .modal-bg.open { display: flex; opacity: 1; }
    .modal { width: 100%; max-width: 680px; background: var(--panel); padding: 20px; border-radius: 20px; border: var(--glass); box-shadow: var(--shadow); transform: scale(1); animation: scaleIn 0.3s ease; }
    .type-btn { padding: 12px; border-radius: 14px; border: 1px solid rgba(0,0,0,0.05); background: rgba(255,255,255,0.8); cursor: pointer; margin-top: 10px; display: flex; justify-content: space-between; align-items: center; box-shadow: var(--shadow); }
    .type-btn.active { border: 2px solid var(--accent1); background: rgba(76,175,80,0.1); }
    .type-btn:hover { transform: scale(1.02); }
    input, textarea { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid rgba(0,0,0,0.1); background: #ffffff; color: var(--text); margin-top: 10px; font-size: 16px; box-shadow: inset 0 1px 3px rgba(0,0,0,0.05); }
    input:focus, textarea:focus { border-color: var(--accent1); outline: none; }
    .qr { display: block; margin: 14px auto; max-width: 240px; border-radius: 12px; box-shadow: var(--shadow); }
    .note { font-size: 14px; color: var(--muted); margin-top: 10px; }
    /* loader */
    .loader { position: fixed; inset: 0; background: var(--bg); display: flex; align-items: center; justify-content: center; z-index: 10000; opacity: 1; transition: opacity 0.5s ease; }
    .loader.hidden { opacity: 0; pointer-events: none; display: none; }
    canvas#particleCanvas { width: 240px; height: 240px; border-radius: 50%; background: radial-gradient(circle at 30% 0, rgba(76,175,80,0.1), transparent 40%); box-shadow: var(--shadow); }
    .error { color: #ff5252; }
    .ok { color: #4CAF50; }
    @media (max-width: 520px) {
      .card { padding: 16px; }
      .btn { min-width: 120px; font-size: 15px; }
      .fab { width: 56px; height: 56px; }
    }
  </style>
</head>
<body>
  <!-- Loader -->
  <div class="loader" id="appLoader">
    <canvas id="particleCanvas" width="240" height="240"></canvas>
  </div>
  <!-- Main app content -->
  <div class="wrap" id="appContent" aria-hidden="true">
    <!-- PROFILE CARD (always visible, but content switches) -->
    <div class="card" id="profileCard">
      <div class="row">
        <div class="avatar"><img id="avatar" src="" alt="avatar"></div>
        <div style="flex:1">
          <div class="title" id="userName">Загрузка...</div>
          <div class="muted" id="userHandle">@user</div>
          <div style="margin-top:14px">
            <div class="small">Баланс</div>
            <div class="balance" id="balance">0 ₽</div>
          </div>
        </div>
        <div style="text-align:right">
          <button class="btn" id="topupBtn">Пополнить</button><br>
          <button class="btn ghost" id="withdrawBtn">Вывести</button>
        </div>
      </div>
    </div>
    <!-- CONTENT CARD -->
    <div class="card">
      <!-- TASKS PANEL -->
      <div id="tasksPanel" style="display:block">
        <div class="sub-tabs" id="subTabs" style="display:none">
          <div class="sub-tab active" data-sub="my">Мои задания</div>
          <div class="sub-tab" data-sub="perform">Выполнить задания</div>
        </div>
        <div style="display:flex;gap:10px;margin-bottom:12px">
          <input id="filterInput" placeholder="Поиск по заданиям" style="flex:1">
          <button class="btn" id="searchBtn">Поиск</button>
          <button class="btn ghost" id="newTaskBtn">Создать задание</button>
        </div>
        <div id="tasksList">
          <div class="small">Загрузка…</div>
        </div>
      </div>
      <!-- PROFILE PANEL -->
      <div id="profilePanel" style="display:none; position:relative">
        <button id="supportBtn" style="position:absolute;top:10px;right:10px;background:transparent;border:none;font-size:24px;cursor:pointer;color:var(--accent1)">❓</button>
        <div class="small">Имя</div>
        <div style="font-weight:800;font-size:20px" id="pName">—</div>
        <div class="small" style="margin-top:10px">История операций</div>
        <div id="history" style="margin-top:10px"></div>
      </div>
    </div>
  </div>
  <div class="fab" id="fab">+</div>
  <div class="tabbar" role="navigation">
    <div class="nav-item active" data-nav="tasks">Задания</div>
    <div class="nav-item" data-nav="profile">Профиль</div>
  </div>
  <!-- TOPUP Modal -->
  <div id="topupModal" class="modal-bg" aria-hidden="true">
    <div class="modal">
      <button id="closeTopup" style="float:right;background:transparent;border:none;color:var(--muted);font-size:24px;cursor:pointer">×</button>
      <h3>Пополнение через SBP / QR</h3>
      <div class="note">Минимум <b id="minTopup">150</b> ₽</div>
      <div style="display:flex;gap:10px;margin-top:12px">
        <input id="topupAmount" type="number" placeholder="Сумма" min="150" style="flex:1" />
        <button class="btn" id="createTopupBtn">Создать заявку</button>
      </div>
      <div id="topupStep" style="display:none;margin-top:14px">
        <div class="note">Ссылка для оплаты / QR (скопируйте комментарий)</div>
        <img id="qrImg" class="qr" src="" alt="QR" />
        <input id="manualCode" readonly />
        <div style="display:flex;gap:10px;margin-top:10px">
          <a id="payLink" class="btn" target="_blank" rel="noopener noreferrer">Открыть банк</a>
          <button class="btn ghost" id="confirmPaidBtn">Я оплатил</button>
        </div>
        <div class="note" id="topupMsg"></div>
      </div>
    </div>
  </div>
  <!-- WITHDRAW Modal -->
  <div id="withdrawModal" class="modal-bg" aria-hidden="true">
    <div class="modal">
      <button id="closeWithdraw" style="float:right;background:transparent;border:none;color:var(--muted);font-size:24px;cursor:pointer">×</button>
      <h3>Вывести средства</h3>
      <div class="note">Мин. 300 ₽</div>
      <input id="wAmount" type="number" placeholder="Сумма" />
      <input id="wName" type="text" placeholder="ФИО или ник (получатель)" />
      <input id="wDetails" type="text" placeholder="Реквизиты (карта / СБП)" />
      <button class="btn" id="sendWithdraw">Отправить заявку</button>
      <div id="withdrawMsg" class="note"></div>
    </div>
  </div>
  <!-- CREATE TASK Modal -->
  <div id="createModal" class="modal-bg" aria-hidden="true">
    <div class="modal">
      <button id="closeCreate" style="float:right;background:transparent;border:none;color:var(--muted);font-size:24px;cursor:pointer">×</button>
      <h3>Создать задание</h3>
      <div class="note">Выберите тип — цена проставится автоматически</div>
      <div id="typesBox" style="margin-top:10px"></div>
      <input id="taskUrl" placeholder="Ссылка (проверьте)" />
      <input id="taskQty" type="number" placeholder="Количество" min="1" value="1" />
      <div id="totalPrice" class="note" style="animation: scaleIn 0.3s ease;"></div>
      <div style="display:flex;gap:10px;margin-top:12px">
        <button class="btn" id="submitTask">Создать</button>
        <button class="btn ghost" id="cancelCreate">Отмена</button>
      </div>
      <div id="createMsg" class="note"></div>
    </div>
  </div>
<script>
(() => {
  // Basic safe helpers
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  // Telegram init
  const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
  try { tg?.ready?.(); tg?.expand?.(); } catch(e){ /* ignore */ }
  // IDs and DOM
  const appLoader = $('#appLoader');
  const appContent = $('#appContent');
  const avatar = $('#avatar');
  const userName = $('#userName');
  const userHandle = $('#userHandle');
  const balanceEl = $('#balance');
  const pName = $('#pName');
  const tasksList = $('#tasksList');
  const filterInput = $('#filterInput');
  const historyBox = $('#history');
  const subTabs = $('#subTabs');
  // modals
  const topupModal = $('#topupModal');
  const withdrawModal = $('#withdrawModal');
  const createModal = $('#createModal');
  // topup elements
  const topupAmountInput = $('#topupAmount');
  const createTopupBtn = $('#createTopupBtn');
  const topupStep = $('#topupStep');
  const qrImg = $('#qrImg');
  const manualCodeInput = $('#manualCode');
  const payLink = $('#payLink');
  const confirmPaidBtn = $('#confirmPaidBtn');
  const topupMsg = $('#topupMsg');
  // create task elements
  const typesBox = $('#typesBox');
  const submitTaskBtn = $('#submitTask');
  const cancelCreateBtn = $('#cancelCreate');
  const taskUrlInput = $('#taskUrl');
  const taskQtyInput = $('#taskQty');
  const totalPriceEl = $('#totalPrice');
  // withdraw elements
  const wAmount = $('#wAmount');
  const wName = $('#wName');
  const wDetails = $('#wDetails');
  const sendWithdrawBtn = $('#sendWithdraw');
  const withdrawMsg = $('#withdrawMsg');
  // support btn
  const supportBtn = $('#supportBtn');
  // profile from Telegram or fallback
  const tgUser = (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) ? tg.initDataUnsafe.user : {};
  const uid = tgUser.id ? String(tgUser.id) : (new URLSearchParams(location.search)).get('uid') || 'guest_' + String(Math.floor(Math.random()*99999));
  avatar.src = tgUser.photo_url || `https://api.dicebear.com/8.x/thumbs/svg?seed=${encodeURIComponent(uid)}`;
  userName.textContent = tgUser.first_name || 'Пользователь';
  userHandle.textContent = tgUser.username ? '@' + tgUser.username : '';
  pName.textContent = userName.textContent;
  // Particles loader (light theme)
  const canvas = $('#particleCanvas');
  const ctx = canvas.getContext('2d');
  function resizeCanvas() { canvas.width = 240; canvas.height = 240; }
  resizeCanvas();
  let particles = [];
  class Particle {
    constructor() {
      this.x = Math.random() * canvas.width;
      this.y = Math.random() * canvas.height;
      this.size = Math.random() * 4 + 1;
      this.vx = Math.random() * 2 - 1;
      this.vy = Math.random() * 2 - 1;
      this.c = `rgba(76,175,80,${Math.random()*0.6+0.2})`;
    }
    update() {
      this.x += this.vx; this.y += this.vy;
      if (this.x < 0 || this.x > canvas.width) this.vx *= -1;
      if (this.y < 0 || this.y > canvas.height) this.vy *= -1;
      this.size = Math.max(0.5, this.size - 0.01);
    }
    draw() {
      ctx.fillStyle = this.c;
      ctx.beginPath();
      ctx.arc(this.x, this.y, this.size, 0, Math.PI*2);
      ctx.fill();
    }
  }
  function animateParticles() {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    if (particles.length < 80) particles.push(new Particle());
    particles.forEach(p => { p.update(); p.draw(); });
    particles = particles.filter(p => p.size > 0.6);
    requestAnimationFrame(animateParticles);
  }
  animateParticles();
  // Socket.IO
  let socket = null;
  try {
    socket = io();
    socket.on('connect', ()=> console.log('WS connected', socket.id));
    socket.on('user_update', data => {
      if (!data) return;
      if (String(data.user_id) === String(uid)) {
        if (typeof data.balance !== 'undefined') {
          renderBalance(Number(data.balance));
        } else {
          loadProfile();
        }
      }
    });
    socket.on('task_update', () => loadTasks());
  } catch(e){ console.warn('Socket init failed', e); }
  // Utilities
  function showLoader(bool) {
    if (bool) { appLoader.classList.remove('hidden'); appContent.style.display = 'none'; appContent.setAttribute('aria-hidden', 'true'); }
    else { appLoader.classList.add('hidden'); appContent.style.display = 'block'; appContent.removeAttribute('aria-hidden'); }
  }
  function renderBalance(bal) {
    balanceEl.textContent = Number(bal||0).toLocaleString('ru-RU') + ' ₽';
    const headerBalanceText = $('#headerBalanceText');
    if (headerBalanceText) headerBalanceText.textContent = Number(bal||0).toLocaleString('ru-RU') + ' ₽';
    window.__USER_BALANCE = Number(bal||0);
  }
  // Load profile
  async function loadProfile() {
    try {
      const res = await fetch(`/api/profile_me?uid=${encodeURIComponent(uid)}`);
      if (!res.ok) throw new Error('Bad response');
      const j = await res.json();
      if (j && j.ok && j.user) {
        const user = j.user;
        renderBalance(user.balance || 0);
        pName.textContent = user.name || user.first_name || userHandle.textContent || 'Пользователь';
        const hist = (user.history || []).slice(0, 10);
        historyBox.innerHTML = hist.length ? hist.map(h => `<div style="padding:10px;border-radius:12px;background:rgba(0,0,0,0.05);margin-bottom:8px"><div style="font-weight:700">${h.type||h.note||''}</div><div class="small">${h.amount ? (h.amount+' ₽') : ''} ${h.note||''}</div></div>`).join('') : '<div class="small">История пуста</div>';
      } else {
        renderBalance(0);
        historyBox.innerHTML = '<div class="small error">Не удалось загрузить профиль</div>';
      }
    } catch (e) {
      console.warn(e);
      renderBalance(0);
      historyBox.innerHTML = '<div class="small error">Ошибка сети</div>';
    }
  }
  // Tasks loading
  let allTasks = [];
  async function loadTasks() {
    try {
      let res = await fetch('/api/tasks/list').catch(()=>null);
      if (!res || !res.ok) res = await fetch('/api/tasks_public').catch(()=>null);
      if (!res) throw new Error('No tasks endpoint');
      const j = await res.json();
      allTasks = j.tasks || j || [];
      renderTasks();
    } catch (e) {
      console.warn('loadTasks error', e);
      tasksList.innerHTML = '<div class="small error">Не удалось загрузить задания</div>';
    }
  }
  let currentSub = 'my';
  function renderTasks() {
    const q = (filterInput.value || '').toLowerCase();
    let filtered = allTasks.filter(t => {
      const title = (t.title || t.name || '').toLowerCase();
      const descr = (t.description || t.desc || '').toLowerCase();
      return !q || title.includes(q) || descr.includes(q);
    });
    if (currentSub === 'my') {
      filtered = filtered.filter(t => t.owner_uid === uid);
    } else {
      filtered = filtered.filter(t => t.owner_uid !== uid);
    }
    if (filtered.length === 0) { tasksList.innerHTML = '<div class="small">Нет заданий</div>'; return; }
    tasksList.innerHTML = '';
    filtered.forEach(t => {
      const el = document.createElement('div');
      el.className = 'task-item';
      const completed = Number(t.completed_qty || 0);
      const qty = Number(t.qty || 1);
      const progressWidth = (completed / qty) * 100;
      el.innerHTML = `<div style="flex:1"><div style="font-weight:800">${escapeHtml(t.title || t.name || 'Задание')}</div><div class="small">${escapeHtml(t.description || t.desc || '')}</div>
                      ${currentSub === 'my' ? `<div class="small">Выполнено: ${completed}/${qty}</div><div class="progress"><div class="progress-bar" style="width:${progressWidth}%"></div></div>` : ''}
                      </div><div style="text-align:right"><div style="font-weight:900">${Number(t.unit_price || t.reward || 0).toLocaleString('ru-RU')} ₽</div><div class="small">${qty} шт</div></div>`;
      tasksList.appendChild(el);
    });
  }
  // escape helper
  function escapeHtml(s='') { return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
  // Nav
  $$('.nav-item').forEach(n => n.addEventListener('click', () => {
    $$('.nav-item').forEach(x=>x.classList.remove('active'));
    n.classList.add('active');
    const nav = n.dataset.nav;
    $('#tasksPanel').style.display = nav === 'tasks' ? 'block' : 'none';
    $('#profilePanel').style.display = nav === 'profile' ? 'block' : 'none';
    subTabs.style.display = nav === 'tasks' ? 'flex' : 'none';
    if (nav === 'tasks') renderTasks();
    window.scrollTo({top:0,behavior:'smooth'});
  }));
  // Sub-tabs for tasks
  $$('.sub-tab').forEach(el => el.addEventListener('click', () => {
    $$('.sub-tab').forEach(x=>x.classList.remove('active'));
    el.classList.add('active');
    currentSub = el.dataset.sub;
    renderTasks();
  }));
  // FAB and create
  $('#fab').addEventListener('click', openCreate);
  $('#newTaskBtn').addEventListener('click', openCreate);
  $('#cancelCreate').addEventListener('click', closeCreate);
  $('#closeCreate').addEventListener('click', closeCreate);
  // Types loading
  let types = [];
  let selectedType = null;
  async function loadTypes(){
    try {
      const res = await fetch('/api/task_types').catch(()=>null);
      if (res && res.ok) types = await res.json() || [];
      else {
        const res2 = await fetch('/task_types.json').catch(()=>null);
        if (res2 && res2.ok) types = await res2.json();
      }
    } catch(e) { console.warn('loadTypes', e); types = []; }
    if (!types.length) {
      types = [
        {id:"ya_review", name:"Отзыв — Яндекс Карты", unit_price:85},
        {id:"gmaps_review", name:"Отзыв — Google Maps", unit_price:50},
        {id:"tg_sub", name:"Подписка — Telegram канал", unit_price:5}
      ];
    }
    renderTypes();
  }
  function renderTypes(){
    typesBox.innerHTML = '';
    types.forEach((t, idx) => {
      const div = document.createElement('div');
      div.className = 'type-btn';
      div.innerHTML = `<div style="font-weight:700">${escapeHtml(t.name)}</div><div style="font-weight:800">${Number(t.unit_price||0)} ₽</div>`;
      div.addEventListener('click', () => {
        selectedType = t;
        $$('.type-btn').forEach(x=>x.classList.remove('active'));
        div.classList.add('active');
        updateTotal();
      });
      typesBox.appendChild(div);
      if (idx === 0 && !selectedType) { selectedType = t; div.classList.add('active'); }
    });
  }
  function openCreate() {
    createModal.classList.add('open'); createModal.style.display = 'flex';
    loadTypes();
    $('#createMsg').textContent = '';
    updateTotal();
  }
  function closeCreate() {
    createModal.classList.remove('open'); createModal.style.display = 'none';
    selectedType = null;
    taskUrlInput.value = '';
    taskQtyInput.value = 1;
    totalPriceEl.textContent = '';
  }
  function updateTotal() {
    if (selectedType) {
      const qty = Number(taskQtyInput.value) || 1;
      const total = qty * selectedType.unit_price;
      totalPriceEl.textContent = `Общая цена: ${total} ₽`;
      totalPriceEl.style.animation = 'scaleIn 0.3s ease';
    }
  }
  taskQtyInput.addEventListener('input', updateTotal);
  async function checkUrl(url) {
    if (!url) return { ok: false, message: 'Пустая ссылка' };
    if (!url.startsWith('http://') && !url.startsWith('https://')) return { ok: false, message: 'Ссылка должна начинаться с http:// или https://' };
    if (url.length > 2048) return { ok: false, message: 'Ссылка слишком длинная' };
    try {
      const res = await fetch(url, { method: 'HEAD' });
      return { ok: res.ok, message: res.ok ? '' : 'Ссылка не работает (ошибка ' + res.status + ')' };
    } catch (e) {
      return { ok: false, message: 'Не удалось проверить ссылку (ошибка сети или CORS)' };
    }
  }
  submitTaskBtn.addEventListener('click', async () => {
    const url = taskUrlInput.value.trim();
    const qty = Number(taskQtyInput.value || 0);
    if (!selectedType) return alert('Выберите тип задания');
    if (!url) return alert('Введите ссылку');
    if (!qty || qty < 1) return alert('Укажите корректное количество');
    const chk = await checkUrl(url);
    if (!chk.ok) return alert(chk.message + '. Исправьте ссылку.');
    try {
      const body = {
        title: selectedType.name,
        description: selectedType.name,
        unit_price: selectedType.unit_price || 0,
        qty,
        url,
        type_id: selectedType.id,
        owner_uid: uid
      };
      const res = await fetch('/api/tasks/create', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
      const j = await res.json();
      if (j && j.ok) {
        closeCreate();
        await loadTasks();
        alert('Задание создано');
      } else {
        alert((j && j.errmsg) || 'Ошибка создания');
      }
    } catch (e) {
      console.error(e); alert('Ошибка сети');
    }
  });
  // TOPUP flow
  const minTopup = 150;
  $('#minTopup').textContent = minTopup;
  $('#topupBtn').addEventListener('click', openTopupModal);
  $('#closeTopup').addEventListener('click', ()=> { topupModal.classList.remove('open'); topupModal.style.display = 'none'; });
  function openTopupModal(){
    topupAmountInput.value = minTopup;
    topupStep.style.display = 'none';
    topupModal.classList.add('open'); topupModal.style.display = 'flex';
    topupMsg.textContent = '';
  }
  const topupState = { current: null, manual_code: null, amount: 0 };
  createTopupBtn.addEventListener('click', async () => {
    const amount = Number(topupAmountInput.value || 0);
    if (!amount || amount < minTopup) return alert('Мин. ' + minTopup + ' ₽');
    try {
      const res = await fetch('/api/user/topup-link', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ uid, amount }) });
      const j = await res.json();
      if (j && j.ok) {
        topupStep.style.display = 'block';
        manualCodeInput.value = j.manual_code || (j.topup && j.topup.manual_code) || '';
        qrImg.src = j.qr_base64 ? `data:image/png;base64,${j.qr_base64}` : (j.qr_url || '');
        payLink.href = j.pay_link || (j.topup && j.topup.pay_link) || '#';
        topupState.current = (j.topup && j.topup.id) || j.id || null;
        topupState.manual_code = manualCodeInput.value;
        topupState.amount = amount;
        topupMsg.textContent = 'Скопируйте комментарий и оплатите. Нажмите "Я оплатил" для проверки.';
      } else {
        alert((j && j.errmsg) || 'Ошибка');
      }
    } catch (e) {
      console.error(e); alert('Ошибка сети');
    }
  });
  confirmPaidBtn.addEventListener('click', async () => {
    if (!topupState.current) return alert('Пересоздайте заявку');
    try {
      const res = await fetch('/api/user/topup-confirm', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ topup_id: topupState.current, uid }) });
      const j = await res.json();
      if (j && j.ok) {
        alert('Заявка на проверку');
        topupModal.classList.remove('open'); topupModal.style.display = 'none';
      } else {
        alert((j && j.errmsg) || 'Ошибка');
      }
    } catch (e) {
      console.error(e); alert('Ошибка сети');
    }
  });
  // WITHDRAW flow
  $('#withdrawBtn').addEventListener('click', ()=> { withdrawModal.classList.add('open'); withdrawModal.style.display = 'flex'; withdrawMsg.textContent = ''; });
  $('#closeWithdraw').addEventListener('click', ()=> { withdrawModal.classList.remove('open'); withdrawModal.style.display = 'none'; });
  sendWithdrawBtn.addEventListener('click', async () => {
    const amount = Number(wAmount.value || 0);
    const name = wName.value.trim();
    const details = wDetails.value.trim();
    if (!amount || amount < 300) return alert('Мин. 300 ₽');
    if (amount > (window.__USER_BALANCE || 0)) return alert('Недостаточно средств');
    if (!name || !details) return alert('Заполните поля');
    try {
      const res = await fetch('/api/user/withdraw', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ uid, amount, name, details }) });
      const j = await res.json();
      if (j && j.ok) {
        withdrawMsg.textContent = 'Заявка отправлена';
        withdrawModal.classList.remove('open'); withdrawModal.style.display = 'none';
        fetch('/api/notify_bot', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ uid, msg:`Заявка на вывод ${amount} ₽` }) }).catch(()=>{});
      } else {
        withdrawMsg.textContent = (j && j.errmsg) || 'Ошибка';
      }
    } catch (e) {
      console.error(e);
      withdrawMsg.textContent = 'Ошибка сети';
    }
  });
  // Search
  $('#searchBtn').addEventListener('click', renderTasks);
  filterInput.addEventListener('keyup', e => { if (e.key === 'Enter') renderTasks(); });
  // Support chat
  supportBtn.addEventListener('click', () => {
    if (tg) tg.openTelegramLink('tg://user?id=7233175676');
    else window.open('https://t.me/user?id=7233175676', '_blank');
  });
  // Initial load
  (async function init() {
    showLoader(true);
    await Promise.allSettled([ loadProfile(), loadTasks(), loadTypes() ]);
    setTimeout(()=> showLoader(false), 600);
  })();
  window.addEventListener('resize', () => {});
  window.loadProfile = loadProfile;
  window.loadTasks = loadTasks;
  window.loadTypes = loadTypes;
})();
</script>
</body>
</html>
