<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ReviewCash ‚Äî –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
<script src="https://unpkg.com/lottie-web@5.8.1/build/player/lottie.min.js"></script>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<style>
/* ===========================
   Theme variables (light/dark)
   =========================== */
:root{
  --bg-0: #f6f8fb;
  --bg-1: #061426;
  --bg-2: #031827;
  --card: rgba(255,255,255,0.03);
  --glass: rgba(255,255,255,0.04);
  --muted: #9fb6c6;
  --accentA: #00f0ff;
  --accentB: #00ff9d;
  --neon: rgba(0,240,255,0.12);
  --radius: 14px;
  --text: #eaf7fb;
  --glass-blur: 8px;
  --shadow-1: 0 8px 24px rgba(0,0,0,0.35);
  --shadow-2: 0 18px 60px rgba(0,0,0,0.55);
  --cursor-image: auto; /* fallback default cursor */
}

/* Light theme overrides */
:root[data-theme="light"]{
  --bg-1: #f4f7fb;
  --bg-2: #eaf0f6;
  --card: rgba(2,6,12,0.03);
  --glass: rgba(0,0,0,0.04);
  --muted: #546c7a;
  --text: #071426;
  --neon: rgba(0,120,255,0.06);
  --shadow-1: 0 8px 24px rgba(2,8,20,0.06);
  --shadow-2: 0 18px 60px rgba(2,8,20,0.09);
}

/* Global layout and typography */
*{box-sizing:border-box}
html{scroll-behavior:smooth}
body{
  margin:0;
  min-height:100vh;
  font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  color:var(--text);
  background:
    radial-gradient(900px 400px at 10% 10%, rgba(0,240,255,0.02), transparent),
    linear-gradient(180deg, var(--bg-1), var(--bg-2));
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  transition: background .45s ease, color .35s ease;
  cursor: var(--cursor-image);
}

/* Container */
.app{
  max-width:1200px;
  margin:28px auto;
  padding:20px;
  display:grid;
  grid-template-columns: 1fr 360px;
  gap:22px;
  align-items:start;
}

/* Header */
.header{
  grid-column:1/-1;
  display:flex;
  gap:12px;
  align-items:center;
}
.logo{
  width:64px;height:64px;border-radius:14px;
  background:linear-gradient(135deg,var(--accentA),var(--accentB));
  display:flex;align-items:center;justify-content:center;color:#012226;font-weight:900;font-size:20px;
  box-shadow:0 18px 60px rgba(0,240,255,0.06);
  transform: translateZ(0);
  will-change: transform;
}
.header .title h1{margin:0;font-size:20px}
.header .title p{margin:0;color:var(--muted);font-size:13px}
.header-actions{margin-left:auto;display:flex;gap:10px;align-items:center}

/* Main cards */
.panel{
  background: linear-gradient(180deg, rgba(255,255,255,0.01), transparent);
  border-radius: var(--radius);
  padding:16px;
  border:1px solid var(--glass);
  box-shadow: var(--shadow-1);
  transition: transform .28s cubic-bezier(.2,.9,.25,1), box-shadow .28s;
  transform-style: preserve-3d;
  will-change: transform, box-shadow;
}
.panel:hover{ transform: translateY(-6px); box-shadow: var(--shadow-2); }

/* Grid for tasks */
.tasks-grid{
  display:grid;
  grid-template-columns: repeat(auto-fill, minmax(220px,1fr));
  gap:14px;
  margin-top:12px;
}

/* Task card (microinteraction + neon glow + hover) */
.task{
  border-radius:12px;padding:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);
  border:1px solid rgba(255,255,255,0.02);cursor:pointer;transition:transform .22s ease, box-shadow .22s ease;
  will-change: transform, box-shadow;
}
.task:hover{
  transform: translateY(-8px) scale(1.02);
  box-shadow: 0 30px 60px rgba(0,0,0,0.5), 0 10px 20px rgba(0,0,0,0.25);
  animation: glow 1.8s ease-in-out infinite alternate;
}
@keyframes glow {
  from{ box-shadow: 0 12px 30px rgba(0,240,255,0.06), 0 0 14px rgba(0,240,255,0.04);}
  to{ box-shadow: 0 18px 40px rgba(0,255,157,0.06), 0 0 30px rgba(0,255,157,0.03);}
}

/* Buttons: microinteractions, pulse on click */
.btn{
  display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:12px;border:none;cursor:pointer;
  font-weight:700;color:#012226;background:linear-gradient(90deg,var(--accentA),var(--accentB));
  transition: transform .12s cubic-bezier(.2,.9,.3,1), box-shadow .12s;
  box-shadow: 0 10px 30px rgba(0,0,0,0.25);
  will-change: transform, box-shadow;
}
.btn:active{ animation: btnPulse .36s ease; transform: scale(.985); }
@keyframes btnPulse{ 0%{ transform: scale(1); } 50%{ transform: scale(.98); } 100%{ transform: scale(1); } }

/* Ghost button */
.btn-ghost{ background:transparent;color:var(--text); border:1px solid rgba(255,255,255,0.04); font-weight:600 }

/* Navigation bottom (mobile) */
.bottom-nav{
  position:fixed;left:50%;transform:translateX(-50%);bottom:18px;width:420px;max-width:94%;height:68px;border-radius:14px;
  display:flex;align-items:center;justify-content:space-around;gap:8px;padding:8px;background:linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0.16));
  border:1px solid rgba(255,255,255,0.03);box-shadow:0 18px 60px rgba(0,0,0,0.5);
}
.nav-button{display:flex;flex-direction:column;align-items:center;gap:6px;color:var(--muted);cursor:pointer;padding:6px;border-radius:10px;transition:all .25s cubic-bezier(.2,.9,.3,1);backface-visibility:hidden}
.nav-button.active{ color:var(--accentA); transform:translateY(-6px); background:linear-gradient(90deg, rgba(0,240,255,0.05), rgba(0,255,157,0.02)); box-shadow:0 10px 30px rgba(0,240,255,0.05); }

/* Skeleton placeholders (animated) */
.skeleton { height:12px;border-radius:8px;background:linear-gradient(90deg,#ffffff06,#ffffff02,#ffffff06); animation: skeletonPulse 1.6s linear infinite; }
@keyframes skeletonPulse { 0%{ opacity:.6 } 50%{ opacity:1 } 100%{ opacity:.6 } }

/* Parallax layers - background elements */
.parallax-layer{
  position:fixed;left:0;right:0;top:0;bottom:0;pointer-events:none;z-index:-1;transform:translate3d(0,0,0);
  transition: transform .12s ease-out;
}
.parallax-blob{
  position:absolute;width:700px;height:700px;border-radius:50%;
  filter: blur(80px) saturate(110%);
  opacity:.12;
  background: radial-gradient(circle at 30% 30%, var(--accentA), transparent 30%), radial-gradient(circle at 70% 70%, var(--accentB), transparent 30%);
}

/* Neon borderline for important elements */
.neon {
  box-shadow: 0 6px 18px rgba(0,240,255,0.06), inset 0 1px 0 rgba(255,255,255,0.02);
  border:1px solid rgba(0,240,255,0.06);
}

/* Tooltips (simple) */
.tooltip{ position:relative; display:inline-block }
.tooltip .tooltip-text{
  position:absolute;left:50%;transform:translateX(-50%);bottom:calc(100% + 10px);background:rgba(0,0,0,0.75);color:#fff;padding:8px;border-radius:8px;font-size:13px;white-space:nowrap;opacity:0;pointer-events:none;transition:opacity .12s;
}
.tooltip:hover .tooltip-text{ opacity:1; }

/* Progress overlay for long operations */
.progress-overlay{
  position:fixed;inset:0;background:linear-gradient(180deg,rgba(2,6,12,0.5),rgba(2,6,12,0.6));display:none;align-items:center;justify-content:center;z-index:9999;
}
.progress-card{background:linear-gradient(180deg,#061426,#031827);padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);display:flex;flex-direction:column;gap:10px;align-items:center}
.progress-bar{width:320px;height:10px;border-radius:10px;background:rgba(255,255,255,0.04);overflow:hidden}
.progress-fill{height:100%;width:0%;background:linear-gradient(90deg,var(--accentA),var(--accentB));transition:width .4s ease}

/* Responsive typography (clamp) */
h1{font-size:clamp(18px, 2.2vw, 24px)}
h2{font-size:clamp(16px, 1.6vw, 18px)}
p, .muted{font-size:clamp(13px, 1.2vw, 15px)}

/* Performance hints */
.will-change-transform{ will-change: transform }
.use-3d{ transform: translateZ(0) }

/* Custom cursor for interactive areas */
.interactive{ cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"><circle cx="12" cy="12" r="10" fill="%2300f0ff"/></svg>') 12 12, pointer; }

/* Accessibility focus */
button:focus, a:focus{ outline:2px dashed var(--accentA); outline-offset:4px }
</style>
</head>
<body>
  <!-- Parallax background layers -->
  <div class="parallax-layer" id="parallax">
    <div class="parallax-blob" id="blob1" style="left:-200px;top:-200px;width:800px;height:800px;opacity:0.12"></div>
    <div class="parallax-blob" id="blob2" style="right:-260px;bottom:-240px;width:600px;height:600px;opacity:0.09"></div>
  </div>

  <div class="app" id="app">
    <div class="header">
      <div class="logo interactive" title="ReviewCash">RC</div>
      <div class="title">
        <h1>ReviewCash</h1>
        <p>–ö—Ä–∞—Å–∏–≤—ã–π —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å ‚Äî –∑–∞–¥–∞–Ω–∏—è –∏ –ø—Ä–æ—Ñ–∏–ª—å</p>
      </div>

      <div class="header-actions">
        <div class="tooltip">
          <button id="themeToggle" class="btn-ghost interactive" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">–¢–µ–º–∞</button>
          <div class="tooltip-text">–°–≤–µ—Ç–ª–∞—è / –¢—ë–º–Ω–∞—è —Ç–µ–º–∞</div>
        </div>
        <button id="openAdmin" class="btn interactive">–ê–¥–º–∏–Ω</button>
      </div>
    </div>

    <!-- MAIN CONTENT -->
    <main class="panel will-change-transform" id="mainPanel">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <h2 style="margin:0">–ó–∞–¥–∞–Ω–∏—è</h2>
          <div class="muted">–°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∑–∞–¥–∞—á —Å –∫—Ä–∞—Å–∏–≤—ã–º–∏ –∞–Ω–∏–º–∞—Ü–∏—è–º–∏</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="search" placeholder="–ü–æ–∏—Å–∫..." style="padding:8px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--text)" />
          <button id="refresh" class="btn interactive tooltip"><span>–û–±–Ω–æ–≤–∏—Ç—å</span><div class="tooltip-text">–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</div></button>
        </div>
      </div>

      <div id="tasksGrid" class="tasks-grid" aria-live="polite">
        <!-- skeleton placeholders until tasks loaded -->
        <div><div class="task skeleton" style="height:84px"></div></div>
        <div><div class="task skeleton" style="height:84px"></div></div>
        <div><div class="task skeleton" style="height:84px"></div></div>
      </div>
    </main>

    <!-- PROFILE SIDEBAR -->
    <aside class="panel will-change-transform" id="sidebar">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div id="avatar" style="width:72px;height:72px;border-radius:12px;background:linear-gradient(135deg,#04202a,#05202a);display:flex;align-items:center;justify-content:center;font-weight:800">RC</div>
        </div>
        <div style="flex:1;margin-left:12px">
          <div id="fullname" style="font-weight:800">–ü—Ä–æ—Ñ–∏–ª—å —Å–∫—Ä—ã—Ç</div>
          <div id="handle" class="muted">–ù–∞–∂–º–∏—Ç–µ –ø–æ–∫–∞–∑–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</div>
          <div style="margin-top:8px">
            <button id="revealProfile" class="btn-ghost interactive">–ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
          </div>
        </div>
        <div>
          <button id="supportBtn" class="btn-ghost interactive tooltip" aria-label="–ü–æ–¥–¥–µ—Ä–∂–∫–∞">üéß
            <div class="tooltip-text">–ù–∞–ø–∏—Å–∞—Ç—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É</div>
          </button>
        </div>
      </div>

      <div style="margin-top:12px">
        <h3 style="margin:6px 0">–ò—Å—Ç–æ—Ä–∏—è</h3>
        <div id="history" style="max-height:260px;overflow:auto">
          <div class="muted">–°–∫—Ä—ã—Ç–æ –¥–æ –æ—Ç–∫—Ä—ã—Ç–∏—è –ø—Ä–æ—Ñ–∏–ª—è</div>
        </div>
      </div>

      <div style="margin-top:12px;display:flex;gap:8px">
        <button id="btnTopup" class="btn interactive">–ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>
        <button id="btnWithdraw" class="btn-ghost interactive">–í—ã–≤–µ—Å—Ç–∏</button>
      </div>
    </aside>
  </div>

  <!-- Progress overlay -->
  <div class="progress-overlay" id="progressOverlay" role="status" aria-hidden="true">
    <div class="progress-card">
      <div class="muted">–û–ø–µ—Ä–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è...</div>
      <div class="progress-bar"><div id="progressFill" class="progress-fill"></div></div>
      <div class="muted" id="progressText">0%</div>
    </div>
  </div>

<script>
/* ============================
   Theme toggle (dark/light)
   ============================ */
(function(){
  const root = document.documentElement;
  const themeToggle = document.getElementById('themeToggle');
  const stored = localStorage.getItem('rc_theme');
  if(stored) root.setAttribute('data-theme', stored);
  else {
    // default to prefers-color-scheme
    if(window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches) root.setAttribute('data-theme','light');
  }
  themeToggle.addEventListener('click', ()=>{
    const cur = root.getAttribute('data-theme');
    const next = (cur === 'light') ? 'dark' : 'light';
    root.setAttribute('data-theme', next);
    localStorage.setItem('rc_theme', next);
  });
})();

/* ============================
   Parallax effect (pointer)
   ============================ */
(function(){
  const parallax = document.getElementById('parallax');
  const blob1 = document.getElementById('blob1');
  const blob2 = document.getElementById('blob2');
  const speed1 = 0.02, speed2 = 0.03;
  document.addEventListener('mousemove', (e)=>{
    const cx = e.clientX - window.innerWidth/2;
    const cy = e.clientY - window.innerHeight/2;
    blob1.style.transform = `translate(${cx*speed1}px, ${cy*speed1}px)`;
    blob2.style.transform = `translate(${cx*-speed2}px, ${cy*-speed2}px)`;
  });
  // subtle motion on scroll
  window.addEventListener('scroll', ()=>{
    const s = window.scrollY;
    parallax.style.transform = `translateY(${s*0.08}px)`;
  }, {passive:true});
})();

/* ============================
   Load tasks + skeleton animation + progressive reveal
   ============================ */
async function loadTasks(){
  const grid = document.getElementById('tasksGrid');
  // keep skeleton while loading
  grid.innerHTML = '';
  for(let i=0;i<6;i++){
    const s = document.createElement('div');
    s.innerHTML = '<div class="task skeleton" style="height:84px"></div>';
    grid.appendChild(s);
  }
  try {
    const res = await fetch('/api/tasks_public');
    const tasks = await res.json();
    // progressive reveal: render in small batches
    grid.innerHTML = '';
    if(!Array.isArray(tasks) || tasks.length === 0){
      grid.innerHTML = '<div class="muted">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π</div>';
      return;
    }
    // Render with slight delay per item for micro-animations
    for(let i=0;i<tasks.length;i++){
      const t = tasks[i];
      const el = document.createElement('div');
      el.className = 'fadeIn will-change-transform';
      el.innerHTML = `<div class="task interactive task-glow" role="button" tabindex="0">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:700">${escapeHtml(t.title||t.id)}</div>
          <div style="color:var(--muted)">${t.budget? t.budget+' ‚ÇΩ':''}</div>
        </div>
        <div style="margin-top:8px;color:var(--muted);font-size:13px">${escapeHtml(t.link||'')}</div>
      </div>`;
      grid.appendChild(el);
      // microinteraction: click ripple/pulse
      const card = el.querySelector('.task');
      card.addEventListener('click', ()=> { pulse(card); openTask(t); });
      // progressive delay
      await sleep(70);
    }
  } catch(e){
    console.error('loadTasks error', e);
    grid.innerHTML = '<div class="muted">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞–Ω–∏–π</div>';
  }
}
function escapeHtml(s){ return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
function openTask(t){ alert('–û—Ç–∫—Ä—ã—Ç–æ –∑–∞–¥–∞–Ω–∏–µ: '+(t.title||t.id)); }

/* ============================
   Button pulse microinteraction
   ============================ */
function pulse(el){
  el.animate([{ transform: 'scale(1)' }, { transform: 'scale(.98)' }, { transform: 'scale(1)' }], { duration: 260, easing:'ease-out' });
}

/* ============================
   Reveal profile + load profile_me + responsive typography
   ============================ */
document.getElementById('revealProfile').addEventListener('click', async ()=>{
  try {
    const tgInit = window.Telegram && Telegram.WebApp && Telegram.WebApp.initData ? Telegram.WebApp.initData : null;
    if(!tgInit){
      // local reveal only
      document.getElementById('fullname').textContent = '–ì–æ—Å—Ç—å';
      document.getElementById('handle').textContent = '–ü—Ä–æ—Ñ–∏–ª—å –æ—Ç–∫—Ä—ã—Ç –ª–æ–∫–∞–ª—å–Ω–æ';
      return;
    }
    const res = await fetch('/api/profile_me', { headers: { 'X-Tg-InitData': tgInit }});
    const j = await res.json();
    if(!j.ok){ alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å: '+(j.reason||'')); return; }
    document.getElementById('fullname').textContent = j.user.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
    document.getElementById('handle').textContent = j.user.username ? '@'+j.user.username : 'UID: '+j.user.id;
    if(j.photo_url){
      const av = document.getElementById('avatar');
      av.innerHTML = '';
      const img = document.createElement('img'); img.src = j.photo_url; img.style.width='72px'; img.style.height='72px'; img.style.borderRadius='12px';
      av.appendChild(img);
    }
    // load history
    loadHistory(j.user.id);
  } catch(e){
    console.error('revealProfile error', e); alert('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è');
  }
});

/* ============================
   History loader
   ============================ */
async function loadHistory(uid){
  const list = document.getElementById('history');
  list.innerHTML = '';
  try {
    const res = await fetch(`/api/user_history?uid=${encodeURIComponent(uid)}&page=1&page_size=6`);
    const j = await res.json();
    if(!j.ok || !j.items || j.items.length === 0){ list.innerHTML = '<div class="muted">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</div>'; return; }
    j.items.forEach(it=>{
      const row = document.createElement('div');
      row.style.display='flex';row.style.justifyContent='space-between';row.style.padding='8px 0';row.style.borderBottom='1px dashed rgba(255,255,255,0.03)';
      row.innerHTML = `<div><div style="font-weight:700">${escapeHtml((it.type||'').toUpperCase())} ‚Äî ${escapeHtml(it.id||'')}</div><div class="muted" style="font-size:13px">${escapeHtml(it.summary||'')}</div></div><div style="text-align:right"><div style="font-weight:800">${it.amount? it.amount+' ‚ÇΩ': ''}</div><div class="muted" style="font-size:12px">${escapeHtml(it.created_at||'')}</div></div>`;
      list.appendChild(row);
    });
  } catch(e){ list.innerHTML = '<div class="muted">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏</div>'; }
}

/* ============================
   Support, Topup, Withdraw (simplified prompts + progress)
   ============================ */
function showProgress(){
  const overlay = document.getElementById('progressOverlay');
  overlay.style.display = 'flex';
  const fill = document.getElementById('progressFill');
  const text = document.getElementById('progressText');
  fill.style.width = '0%'; text.textContent = '0%';
  let pct = 0;
  const id = setInterval(()=>{ pct = Math.min(95, pct + Math.floor(Math.random()*8)+4); fill.style.width = pct+'%'; text.textContent = pct+'%'; }, 300);
  return {
    done: (finalPct=100)=>{ clearInterval(id); fill.style.width = finalPct+'%'; text.textContent = finalPct+'%'; setTimeout(()=> overlay.style.display='none', 700); }
  };
}

document.getElementById('btnTopup').addEventListener('click', async ()=>{
  const s = prompt('–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è (–º–∏–Ω. 100 ‚ÇΩ):');
  if(!s) return;
  const amount = parseFloat(s.replace(',','.'));
  if(isNaN(amount) || amount < 100){ alert('–ú–∏–Ω. 100 ‚ÇΩ'); return; }
  const p = showProgress();
  try {
    const headers = {'Content-Type':'application/json'};
    if(window.Telegram && Telegram.WebApp && Telegram.WebApp.initData) headers['X-Tg-InitData'] = Telegram.WebApp.initData;
    const res = await fetch('/api/topups_public', { method:'POST', headers, body: JSON.stringify({ amount })});
    const data = await res.json();
    p.done();
    if(!data.ok) return alert('–û—à–∏–±–∫–∞: '+(data.reason||''));
    alert(`–°–æ–∑–¥–∞–Ω–æ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ. –ö–æ–¥: ${data.topup.code}. –ü–µ—Ä–µ–≤–µ–¥–∏—Ç–µ ${amount} ‚ÇΩ –Ω–∞ ${data.bank.phone} –∏ —É–∫–∞–∂–∏—Ç–µ –∫–æ–¥.`);
    loadTasks();
  } catch(e){ p.done(100); alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'); }
});

document.getElementById('btnWithdraw').addEventListener('click', async ()=>{
  const s = prompt('–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –≤—ã–≤–æ–¥–∞ (–º–∏–Ω. 250 ‚ÇΩ):');
  if(!s) return;
  const amount = parseFloat(s.replace(',','.'));
  if(isNaN(amount) || amount < 250){ alert('–ú–∏–Ω. 250 ‚ÇΩ'); return; }
  const name = prompt('–í–≤–µ–¥–∏—Ç–µ –§–ò–û / –Ω–∏–∫ –≤ –±–∞–Ω–∫–µ:'); if(!name) return;
  const bank = prompt('–í–≤–µ–¥–∏—Ç–µ –±–∞–Ω–∫ / —Ä–µ–∫–≤–∏–∑–∏—Ç—ã:'); if(!bank) return;
  const p = showProgress();
  try {
    const headers = {'Content-Type':'application/json'};
    if(window.Telegram && Telegram.WebApp && Telegram.WebApp.initData) headers['X-Tg-InitData'] = Telegram.WebApp.initData;
    const res = await fetch('/api/withdraw_public', { method:'POST', headers, body: JSON.stringify({ amount, name, bank })});
    const data = await res.json();
    p.done();
    if(!data.ok){
      if(data.reason === 'insufficient_balance') alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤: '+(data.balance||0)+' ‚ÇΩ');
      else alert('–û—à–∏–±–∫–∞: '+(data.reason||''));
      return;
    }
    alert('–ó–∞—è–≤–∫–∞ –Ω–∞ –≤—ã–≤–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞. –í —Ç–µ—á–µ–Ω–∏–µ 24 —á–∞—Å–æ–≤ –ø–µ—Ä–µ–≤–µ–¥—ë–º —Å—É–º–º—É.');
  } catch(e){ p.done(100); alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'); }
});

/* Support small button */
document.getElementById('supportBtn').addEventListener('click', async ()=>{
  const text = prompt('–û–ø–∏—à–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—É:');
  if(!text) return;
  const p = showProgress();
  try {
    const headers = {'Content-Type':'application/json'};
    if(window.Telegram && Telegram.WebApp && Telegram.WebApp.initData) headers['X-Tg-InitData'] = Telegram.WebApp.initData;
    const res = await fetch('/api/support', { method:'POST', headers, body: JSON.stringify({ message: text })});
    const data = await res.json();
    p.done();
    if(!data.ok) alert('–û—à–∏–±–∫–∞: '+(data.reason||'')); else alert('–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É');
  } catch(e){ p.done(100); alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'); }
});

/* ============================
   Initial load
   ============================ */
document.getElementById('refresh').addEventListener('click', ()=> { pulse(document.getElementById('refresh')); loadTasks(); });
loadTasks();

/* ============================
   Accessibility helpers (keyboard)
   ============================ */
document.addEventListener('keydown', (e)=>{
  if(e.key === '/' && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA'){
    e.preventDefault(); document.getElementById('search').focus();
  }
});
</script>
</body>
</html>
