<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ReviewCash — Профиль и задания</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
<script src="https://unpkg.com/lottie-web@5.8.1/build/player/lottie.min.js"></script>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<style>
  :root{--bg1:#031025;--bg2:#072233;--accentA:#00f0ff;--accentB:#00ff9d;--muted:#9fb6c6;--gold:#ffd166}
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,Arial;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:#eaf7fb}
  .wrap{max-width:1100px;margin:28px auto;padding:18px;display:grid;grid-template-columns:1fr 380px;gap:18px}
  .card{background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);border-radius:12px;padding:14px;border:1px solid rgba(255,255,255,0.03)}
  .logo{width:72px;height:72px;border-radius:12px;background:linear-gradient(135deg,var(--accentA),var(--accentB));display:flex;align-items:center;justify-content:center;color:#012226;font-weight:900}
  .profile{display:flex;gap:12px;align-items:center}
  .avatar{width:84px;height:84px;border-radius:12px;background:#05292f;display:flex;align-items:center;justify-content:center;font-weight:800}
  .btn{padding:8px 10px;border-radius:8px;background:linear-gradient(90deg,var(--accentA),var(--accentB));color:#012226;border:none;cursor:pointer}
  .modal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:520px;max-width:94%;background:#041726;border-radius:12px;padding:16px;z-index:10000;border:1px solid rgba(255,255,255,0.03)}
  .backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;z-index:9999}
  .sublabel{color:#9fb6c6;font-size:13px}
  .input,textarea,select{width:100%;padding:10px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.03);color:#eaf7fb}
  .small{font-size:13px;color:#9fb6c6}
</style>
</head>
<body>
<div class="wrap">
  <div>
    <div class="card">
      <div style="display:flex;align-items:center;gap:12px">
        <div class="logo">RC</div>
        <div>
          <h2 style="margin:0">ReviewCash</h2>
          <div class="small">Выполняйте задания и управляйте балансом</div>
        </div>
        <div style="margin-left:auto">
          <button id="openAdmin" class="btn">Админ</button>
        </div>
      </div>

      <div style="margin-top:14px">
        <h3>Задания</h3>
        <div id="tasks" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px;margin-top:8px"></div>
      </div>
    </div>
  </div>

  <aside>
    <div class="card profile">
      <div style="display:flex;gap:12px;align-items:center">
        <div id="avatar" class="avatar">RC</div>
        <div>
          <div id="fullname" style="font-weight:800">Гость</div>
          <div id="handle" class="small">@guest</div>
          <div style="margin-top:8px;font-weight:800;font-size:18px;color:var(--gold)" id="balance">0 ₽</div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <strong>Действия</strong>
      <div style="margin-top:8px;display:flex;flex-direction:column;gap:8px">
        <button id="btnTopup" class="btn">Пополнить</button>
        <button id="btnWithdraw" class="btn">Вывести</button>
        <button id="openSupport" class="btn">Поддержка</button>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <strong>История</strong>
      <div id="history" style="margin-top:8px;color:#9fb6c6;max-height:260px;overflow:auto"></div>
    </div>
  </aside>
</div>

<!-- BACKDROPS & MODALS -->
<div id="backdrop" class="backdrop"></div>

<!-- Topup modal -->
<div id="modalTopup" class="modal" style="display:none">
  <h3>Пополнение баланса</h3>
  <div class="small">Минимальная сумма — 100 ₽</div>
  <div style="margin-top:10px">
    <label>Сумма</label>
    <input id="topupAmount" class="input" placeholder="Сумма в ₽" />
  </div>
  <div style="margin-top:10px">
    <div class="small">Мои данные для перевода (Тинькофф):</div>
    <div style="margin-top:6px"><strong>Раяз Н.</strong> <div class="small">Номер: <span id="bankPhone">+79600738559</span> (можно скопировать)</div></div>
  </div>
  <div style="margin-top:10px">
    <div class="small">После отправки система сгенерирует одноразовый код — укажите его в комментарии при переводе.</div>
  </div>
  <div style="margin-top:12px;display:flex;gap:8px">
    <button id="sendTopup" class="btn">Отправить заявку</button>
    <button id="closeTopup" class="btn" style="background:transparent;color:#eaf7fb;border:1px solid rgba(255,255,255,0.03)">Отмена</button>
  </div>
  <div id="topupResult" style="margin-top:12px"></div>
</div>

<!-- Withdraw modal -->
<div id="modalWithdraw" class="modal" style="display:none">
  <h3>Заявка на вывод</h3>
  <div class="small">Минимальная сумма — 250 ₽. Проверка баланса выполняется при отправке заявки.</div>
  <div style="margin-top:10px">
    <label>Сумма</label>
    <input id="wdAmount" class="input" placeholder="Сумма в ₽" />
  </div>
  <div style="margin-top:10px">
    <label>ФИО / Ник (как в банке)</label>
    <input id="wdName" class="input" placeholder="ФИО или ник в банке" />
  </div>
  <div style="margin-top:10px">
    <label>Банк / Реквизиты</label>
    <input id="wdBank" class="input" placeholder="Название банка / реквизиты" />
  </div>
  <div style="margin-top:12px;display:flex;gap:8px">
    <button id="sendWithdraw" class="btn">Отправить заявку</button>
    <button id="closeWithdraw" class="btn" style="background:transparent;border:1px solid rgba(255,255,255,0.03)">Отмена</button>
  </div>
  <div id="withdrawResult" style="margin-top:12px"></div>
</div>

<!-- Support modal -->
<div id="modalSupport" class="modal" style="display:none">
  <h3>Поддержка</h3>
  <textarea id="supportText" placeholder="Опишите проблему..." style="margin-top:10px"></textarea>
  <div style="margin-top:8px;display:flex;gap:8px">
    <button id="sendSupport" class="btn">Отправить</button>
    <button id="closeSupport" class="btn" style="background:transparent;border:1px solid rgba(255,255,255,0.03)">Отмена</button>
  </div>
  <div id="supportResult" style="margin-top:10px"></div>
</div>

<script>
const WEBAPP_URL = new URL(window.location.href).origin; // not used on backend
const token = new URLSearchParams(location.search).get('token') || '';

function showModal(sel){ document.getElementById('backdrop').style.display='block'; document.getElementById(sel).style.display='block'; }
function hideAll(){ document.getElementById('backdrop').style.display='none'; ['modalTopup','modalWithdraw','modalSupport'].forEach(id=>document.getElementById(id).style.display='none'); }

document.getElementById('btnTopup').onclick = ()=> showModal('modalTopup');
document.getElementById('closeTopup').onclick = hideAll;
document.getElementById('btnWithdraw').onclick = ()=> showModal('modalWithdraw');
document.getElementById('closeWithdraw').onclick = hideAll;
document.getElementById('openSupport').onclick = ()=> showModal('modalSupport');
document.getElementById('closeSupport').onclick = hideAll;

document.getElementById('openAdmin').onclick = ()=>{
  if(!token){ alert('Требуется токен админа. Получите ссылку через бота (/mainadmin).'); return; }
  window.open('/mainadmin?token=' + encodeURIComponent(token), '_blank');
};

/* Lottie hero */
try{
  lottie.loadAnimation({container: document.getElementById('avatar'), renderer:'svg', loop:true, autoplay:true, path:'https://assets3.lottiefiles.com/packages/lf20_o1x7f9yk.json'});
} catch(e){}

/* load profile */
async function loadProfileFromWebApp(){
  // try to use Telegram.WebApp.initDataUnsafe if available
  try {
    if(window.Telegram && Telegram.WebApp && Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.user){
      const u = Telegram.WebApp.initDataUnsafe.user;
      document.getElementById('fullname').textContent = (u.first_name || 'Пользователь');
      document.getElementById('handle').textContent = u.username ? '@'+u.username : 'UID: ' + u.id;
      document.getElementById('avatar').textContent = (u.first_name||'P').slice(0,2).toUpperCase();
      // call profile_me to get balance and photo (if bot configured)
      try {
        const initData = Telegram.WebApp.initData;
        const res = await fetch('/api/profile_me', { headers: { 'X-Tg-InitData': initData }});
        const j = await res.json();
        if(j.ok){
          document.getElementById('balance').textContent = (j.balance || 0) + ' ₽';
          if(j.photo_url){
            const img = document.createElement('img'); img.src = j.photo_url; img.style.width='84px'; img.style.height='84px'; img.style.borderRadius='12px';
            const av = document.getElementById('avatar'); av.innerHTML=''; av.appendChild(img);
          }
        }
      } catch(e){}
    }
  } catch(e){}
}
loadProfileFromWebApp();

/* Load tasks (simple) */
async function loadTasks(){
  const el = document.getElementById('tasks'); el.innerHTML='';
  try {
    const res = await fetch('/api/tasks_public');
    const data = await res.json();
    if(!data || !data.length) el.innerHTML = '<div class="small">Нет задач</div>';
    else data.forEach(t=>{
      const d = document.createElement('div'); d.className='card';
      d.style.cursor='pointer';
      d.innerHTML = `<div style="font-weight:700">${t.title||t.id}</div><div class="small">${t.budget? t.budget+' ₽':''}</div>`;
      el.appendChild(d);
    });
  } catch(e){ el.innerHTML = '<div class="small">Ошибка загрузки</div>'; }
}
loadTasks();

/* Topup: send request to server; server returns code and bank info */
document.getElementById('sendTopup').onclick = async ()=>{
  const amt = parseFloat((document.getElementById('topupAmount').value||'').replace(',', '.')) || 0;
  if(amt < 100){ alert('Минимальная сумма пополнения 100 ₽'); return; }
  let headers = {'Content-Type':'application/json'};
  // try to forward init_data if inside WebApp
  try{ if(window.Telegram && Telegram.WebApp && Telegram.WebApp.initData) headers['X-Tg-InitData'] = Telegram.WebApp.initData } catch(e){}
  try {
    const res = await fetch('/api/topups_public', { method:'POST', headers, body: JSON.stringify({ amount: amt }) });
    const j = await res.json();
    if(!j.ok){ alert('Ошибка: ' + (j.reason||'')); return; }
    const top = j.topup;
    const bank = j.bank || {};
    document.getElementById('topupResult').innerHTML = `<div class="small">Скопируйте данные и переведите указанную сумму:</div>
      <div style="margin-top:6px"><strong>${bank.bank_name}</strong><div class="small">Номер: <span id="resPhone">${bank.phone}</span></div></div>
      <div style="margin-top:6px"><div class="small">Код для комментария перевода: <strong id="resCode">${top.code}</strong></div></div>
      <div style="margin-top:8px" class="small">После перевода нажмите «Отправлено» и ожидайте — в течение 24 часов пополнение будет подтверждено.</div>`;
  } catch(e){ alert('Ошибка сети'); }
};

/* Withdraw: send request (server reserves funds) */
document.getElementById('sendWithdraw').onclick = async ()=>{
  const amt = parseFloat((document.getElementById('wdAmount').value||'').replace(',','.'))||0;
  const name = document.getElementById('wdName').value.trim();
  const bank = document.getElementById('wdBank').value.trim();
  if(amt < 250){ alert('Минимальная сумма вывода 250 ₽'); return; }
  if(!name || !bank){ alert('Заполните все поля'); return; }
  let headers = {'Content-Type':'application/json'};
  try{ if(window.Telegram && Telegram.WebApp && Telegram.WebApp.initData) headers['X-Tg-InitData'] = Telegram.WebApp.initData } catch(e){}
  try {
    const res = await fetch('/api/withdraw_public', { method:'POST', headers, body: JSON.stringify({ amount: amt, name: name, bank: bank })});
    const j = await res.json();
    if(!j.ok){
      if(j.reason === 'insufficient_balance') alert('Недостаточно средств на балансе: ' + (j.balance||0) + ' ₽');
      else alert('Ошибка: ' + (j.reason||''));
      return;
    }
    document.getElementById('withdrawResult').innerHTML = `<div class="small">Ваша заявка отправлена. В течение 24 часов мы переведём сумму.</div>`;
    // update balance shown
    if(j.balance_after !== undefined) document.getElementById('balance').textContent = j.balance_after + ' ₽';
  } catch(e){ alert('Ошибка сети'); }
};

/* Support */
document.getElementById('sendSupport').onclick = async ()=>{
  const txt = document.getElementById('supportText').value.trim();
  if(!txt){ alert('Напишите сообщение'); return; }
  try {
    const res = await fetch('/api/support', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ message: txt }) });
    const j = await res.json();
    if(j.ok){
      document.getElementById('supportResult').textContent = 'Сообщение отправлено в поддержку.';
    } else {
      document.getElementById('supportResult').textContent = 'Ошибка: ' + (j.reason||'');
    }
  } catch(e){ document.getElementById('supportResult').textContent = 'Ошибка сети'; }
};

</script>
</body>
</html>
