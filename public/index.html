<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>‚úÖ ReviewCash ‚Äî –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</title>
<!-- –®—Ä–∏—Ñ—Ç—ã -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet"/>
<!-- QRCode.js -->
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<!-- –°—Ç–∏–ª—å –¥–ª—è UI (–±–æ–ª–µ–µ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π, –ø–ª–∞–≤–Ω—ã–π, –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π) -->
<style>
  * {
    margin: 0; padding: 0; box-sizing: border-box;
  }
  body {
    font-family: 'Inter', sans-serif;
    background: linear-gradient(135deg, #1a2a6c, #4e4376);
    color: #e2f3ff;
  }

  /* –û–±—â–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä */
.wrapper {
  max-width: 800px;
  margin: 0 auto;
  padding: 20px;
  display: flex;
  flex-direction: column;
  gap: 20px;
}

/* –®–∞–ø–∫–∞ –∏ –ø–∞–Ω–µ–ª—å */
.header {
  display: flex; justify-content: space-between; align-items: center;
  background: rgba(255,255,255,0.05);
  padding: 14px 20px; border-radius: 20px; box-shadow: 0 4px 16px rgba(0,0,0,0.2);
}
.header h1 {
  font-size: 1.8em; font-weight: 700;
}
.balance-display {
  display: flex; flex-direction: column; align-items: center;
}
.balance {
  font-size: 2em; font-weight: 700; padding: 10px; border-radius:20px; background: rgba(255,255,255,0.1); min-width:140px; text-align:center;
  box-shadow: inset 0 0 8px rgba(255,255,255,0.15);
}

/* Tabs */
.tabs {
  display: flex; justify-content: space-around; gap: 10px;
}
.tab {
  flex:1; padding:12px; border-radius:20px; background: rgba(255,255,255,0.1);
  cursor:pointer; font-weight: 600; text-align:center; transition: background 0.2s, transform 0.2s;
}
.tab:hover { background: rgba(255,255,255,0.2); }
.tab.active {
  background: linear-gradient(90deg, #38bdf8, #3b82f6);
  color:#fff;
}
.section {
  display: none; /* –ø–æ–∫–∞ –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞ */
  animation: fadeIn 0.3s ease;
}
.section.active {
  display: block;
}

/* –ö–∞—Ä—Ç–æ—á–∫–∏ –∏ –±–ª–æ–∫–∏ */
.card {
  background: rgba(255,255,255,0.05);
  border-radius: 15px; padding:20px; box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  transition: box-shadow 0.2s, transform 0.2s;
}
.card:hover {
  box-shadow: 0 8px 24px rgba(0,0,0,0.3);
}

/* –¢–∞–±–ª–∏—Ü—ã */
table {
  width: 100%; border-collapse: collapse; margin-top: 10px;
}
th, td {
  padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1);
  font-size: 13px;
}
th {
  background: rgba(255,255,255,0.1); font-weight: 600; text-align: left;
}

/* –ö–Ω–æ–ø–∫–∏ */
.btn {
  padding:14px 20px; border-radius:20px; border:none; background:linear-gradient(90deg, #38bdf8, #3b82f6);
  color:#fff; font-weight:600; cursor:pointer; transition: transform 0.2s, box-shadow 0.2s;
}
.btn:hover {
  box-shadow: 0 4px 12px rgba(0,0,0,0.2); transform: scale(1.02);
}

/* –ú–æ–¥–∞–ª–∫–∏ –∏ –æ–≤–µ—Ä–ª–µ–∏ */
#modalOverlay {
  display: none; position:fixed; inset:0; background: rgba(0,0,0,0.6); align-items: center; justify-content: center; z-index:9999;
}
#modal {
  background:#222; padding:20px; border-radius:15px; max-width:400px; width:90%; position:relative; box-shadow:0 4px 20px rgba(0,0,0,0.3);
}
#closeModalBtn {
  position:absolute; top:10px; right:10px; font-size:20px; background:none; border:none; color:#777; cursor:pointer;
}
@keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
/* –î–ª—è –∫—Ä–∞—Å–∏–≤—ã—Ö –∏–∫–æ–Ω–æ–∫ –∏ SVG –º–æ–∂–Ω–æ –ø–æ–¥–∫–ª—é—á–∏—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π CDN, –µ—Å–ª–∏ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è */
</style>
</head>
<body>
<div class="wrapper">
  <!-- –®–∞–ø–∫–∞ –∏ –±–∞–ª–∞–Ω—Å -->
  <div class="header">
    <h1>‚úÖ ReviewCash</h1>
    <div class="balance-display">
      <div style="font-size:14px; color:#aaa;">–í–∞—à –±–∞–ª–∞–Ω—Å</div>
      <div id="balanceAmount">0 ‚ÇΩ</div>
    </div>
    <button class="btn" onclick="showAuthDialog()">üîì –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ WebApp</button>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <div class="tab active" data-tab="tasks">üìù –ó–∞–¥–∞–Ω–∏—è</div>
    <div class="tab" data-tab="history">üïí –ò—Å—Ç–æ—Ä–∏—è</div>
    <div class="tab" data-tab="subscription">üåê –ü–æ–¥–ø–∏—Å–∫–∞</div>
  </div>

  <!-- –ö–æ–Ω—Ç–µ–Ω—Ç —Ä–∞–∑–¥–µ–ª–æ–≤ -->
  <div class="section active" id="section-tasks">
    <div class="card">
      <h3>–ú–æ–∏ –∑–∞–¥–∞–Ω–∏—è</h3>
      <div id="tasks-list"></div>
      <button class="btn" onclick="showCreateTaskModal()">–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ</button>
    </div>
  </div>
  <div class="section" id="section-history">
    <div class="card">
      <h3>–ò—Å—Ç–æ—Ä–∏—è</h3>
      <div id="history-log"></div>
    </div>
  </div>
  <div class="section" id="section-subscription">
    <div class="card">
      <h3>–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∫–∞–Ω–∞–ª</h3>
      <div id="sub-status">–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏...</div>
      <button class="btn" onclick="checkSubscription()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–ø–∏—Å—å</button>
    </div>
  </div>
</div>

<!-- QR-–∫–æ–¥ -->
<div id="qrModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); align-items:center; justify-content:center; z-index:99999;">
  <div style="background:#222; padding:20px; border-radius:15px; width:300px; text-align:center; position:relative;">
    <button style="position:absolute; top:10px; right:10px; background:none; border:none; font-size:20px; color:#777; cursor:pointer;" onclick="hideQR()">√ó</button>
    <h3>–û–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ QR-–∫–æ–¥</h3>
    <div id="qrcode"></div>
    <p style="margin-top:10px;">–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ –¥–ª—è –æ–ø–ª–∞—Ç—ã</p>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∏ -->
<div id="modalOverlay"></div>
<div id="modal" style="display:none;">
  <button id="closeModalBtn" onclick="hideModal()">√ó</button>
  <div id="modalContent"></div>
</div>

<!-- –°–∫—Ä–∏–ø—Ç—ã: -->
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script>
let userId=null;
let userBalance=0;

// --- WebApp –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è ---
function showAuthDialog() {
  alert("–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è ‚Äî –æ—Ç–∫—Ä–æ–π—Ç–µ WebApp —Å PhoneTelegram");
  // –í real-world ‚Äî –≤—ã–∑–æ–≤–∏—Ç–µ window.Telegram.WebApp
  initWebAppUser(); 
}
// –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –∏–º–∏—Ç–∞—Ü–∏—è –≤—Ö–æ–¥–∞ (–ø—Ä–∏ —Ä–µ–∞–ª—å–Ω—ã—Ö —É—Å–ª–æ–≤–∏—è—Ö ‚Äî –≤—ã–∑–æ–≤ –∏–∑ WebApp)
function initWebAppUser() {
  // –Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ API WebApp
  if(window.Telegram && window.Telegram.WebApp){
    let user=window.Telegram.WebApp.initDataUnsafe?.user;
    userId=user?.id || 'test-user-'+Math.floor(Math.random()*1000);
  } else {
    userId='test-'+Math.floor(Math.random()*9000);
  }
  document.querySelector('.btn').style.display='none'; // —Å–∫—Ä—ã—Ç—å –∫–Ω–æ–ø–∫—É –≤—Ö–æ–¥–∞
  loadUserData();
}

// --- –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ---
function loadUserData() {
  fetch('/api/profile_me?uid='+userId)
  .then(r=>r.json())
  .then(d=>{
    if(d.ok){
      userBalance= d.user.balance || 0;
      document.getElementById('balanceAmount').textContent= userBalance+' ‚ÇΩ';
      document.getElementById('sub-status').textContent= d.user.subscribed?'–ü–æ–¥–ø–∏—Å–∞–Ω':'–ù–µ –ø–æ–¥–ø–∏—Å–∞–Ω';
      document.getElementById('main-content').style.display='block';
    }
  });
}

// --- –ù–∞–≤–∏–≥–∞—Ü–∏—è –∏ —Ç–∞–±—ã ---
const tabs=document.querySelectorAll('.tab');
let currentSection='tasks';

tabs.forEach(t=>{
  t.onclick=()=>{
    document.querySelectorAll('.tab').forEach(t2=>t2.classList.remove('active'));
    t.classList.add('active');
    currentSection=''+t.dataset['tab'];
    document.querySelectorAll('.section').forEach(s=>s.style.display='none');
    document.getElementById('section-'+currentSection).style.display='block';
    if(currentSection==='tasks') loadTasks();
    if(currentSection==='history') loadHistory();
  }
});
loadTasks(); // –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ

// --- –ó–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–¥–∞—á–∏ ---
function loadTasks() {
  fetch('/api/tasks/list')
  .then(r=>r.json())
  .then(d=>{
    const container=document.getElementById('tasks-list');
    container.innerHTML='';
    if(d.ok && d.tasks){
      d.tasks.forEach(t=>{
        const div=document.createElement('div');
        div.style.background='#2a3448'; div.style.borderRadius='10px'; div.style.padding='10px'; div.style.margin='8px 0';
        div.innerHTML=`<b>${t.title}</b><div style="font-size:12px;margin-top:4px;">–¶–µ–Ω–∞:${t.unit_price} ‚ÇΩ, –û—Å—Ç–∞–ª–æ—Å—å:${t.qty - t.done}</div>`;
        container.appendChild(div);
      });
    }
  });
}
// --- –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é ---
function loadHistory() {
  fetch('/api/profile_me?uid='+userId)
  .then(r=>r.json())
  .then(d=>{
    const log=document.getElementById('history-log');
    log.innerHTML='';
    // –ø—Ä–∏–º–µ—Ä, –º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä—è—Ç—å
    d.user.history?.forEach(h=>{
      const div=document.createElement('div');
      div.style.background='#222'; div.style.margin='6px 0'; div.style.padding='8px'; div.style.borderRadius='8px';
      div.innerHTML=`${h.date} : ${h.note} (${h.amount} ‚ÇΩ)`;
      log.appendChild(div);
    });
  });
}

// --- –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è ---
function showCreateTaskModal() {
  showModal('–°–æ–∑–¥–∞–π—Ç–µ –∑–∞–¥–∞–Ω–∏–µ —Ç—É—Ç', ()=> {
    // —Ñ–æ—Ä–º–∞
    let title=prompt('–ó–∞–≥–æ–ª–æ–≤–æ–∫ –∑–∞–¥–∞–Ω–∏—è');
    let desc=prompt('–û–ø–∏—Å–∞–Ω–∏–µ');
    let price=prompt('–¶–µ–Ω–∞ –∑–∞ 1 (—á–∏—Å–ª–æ–º)');
    let qty=prompt('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ');
    if(title && price && qty && !isNaN(price) && !isNaN(qty)){
      fetch('/api/tasks/create',{method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({title, description:desc, type_id:'custom', unit_price:parseFloat(price), qty:parseInt(qty)})})
        .then(r=>r.json())
        .then(d=>{ if(d.ok) {alert('–°–æ–∑–¥–∞–Ω–æ!'); loadTasks();} else alert('–û—à–∏–±–∫–∞'); });
    }
  });
}

// --- –í—Å–ø–ª—ã–≤–∞—é—â–µ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ ---
function showModal(title, onConfirm) {
  document.getElementById('modal').style.display='flex';
  document.getElementById('modalContent').innerHTML=`
    <h3>${title}</h3>
    <button class="btn" onclick="closeModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
  `;
  window._modalFunc=onConfirm;
}
function closeModal() {
  document.getElementById('modal').style.display='none';
  if(window._modalFunc) { window._modalFunc(); window._modalFunc=null; }
}

// --- –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ ---
function showTopUp() {
  const amount=prompt('–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É (–º–∏–Ω–∏–º—É–º 150 ‚ÇΩ)', '150');
  if(amount && !isNaN(amount) && parseFloat(amount)>=150){
    fetch('/api/user/topup',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({uid:userId, amount:parseFloat(amount)})})
    .then(r=>r.json()).then(d=>{if(d.ok) alert('–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞');});
  }
}
// --- –í—ã–≤–æ–¥ ---
function showWithdraw() {
  const amount=prompt('–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É (–º–∏–Ω–∏–º—É–º 300 ‚ÇΩ)', '300');
  const details=prompt('–†–µ–∫–≤–∏–∑–∏—Ç—ã');
  if(amount && !isNaN(amount) && parseFloat(amount)>=300 && details){
    fetch('/api/user/withdraw',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({uid:userId, amount:parseFloat(amount), details})})
    .then(r=>r.json()).then(d=>{if(d.ok) alert('–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞');});
  }
}

// --- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ ---
function checkSubscription() {
  // –≤—ã–∑–æ–≤ API –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏
  fetch('/api/check_subscribe?uid='+userId)
  .then(r=>r.json()).then(d=>{ alert('–ü–æ–¥–ø–∏—Å–∫–∞: '+(d.subscribed?'–î–∞':'–ù–µ—Ç')); });
}

// --- –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å QR ---
function showQR(code) {
  QRCode.toCanvas(document.getElementById('qrcode').innerHTML='');
  QRCode.toCanvas(document.getElementById('qrcode'), code, {width:200});
  document.getElementById('qrModal').style.display='flex';
}
function hideQR(){ document.getElementById('qrModal').style.display='none'; }
</script>
</body>
</html>
